<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶ å¹•è¦–çª—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #00FF00;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: 'Microsoft JhengHei', sans-serif;
        }

        /* å¯æ‹–æ›³å¯ç¸®æ”¾å®¹å™¨ */
        .draggable {
            position: absolute;
            cursor: move;
            user-select: none;
        }

        /* 8å€‹èª¿æ•´é» */
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #fff;
            border: 2px solid #4ecca3;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
        }

        .draggable:hover .resize-handle,
        .debug-mode .resize-handle {
            opacity: 1;
        }

        /* å››å€‹è§’ */
        .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }

        /* å››å€‹é‚Š */
        .resize-handle.n { top: -6px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
        .resize-handle.s { bottom: -6px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
        .resize-handle.w { left: -6px; top: 50%; transform: translateY(-50%); cursor: w-resize; }
        .resize-handle.e { right: -6px; top: 50%; transform: translateY(-50%); cursor: e-resize; }

        /* è½‰ç›¤å®¹å™¨ */
        .wheel-container {
            top: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: 350px;
            height: 350px;
        }

        .wheel-container.hidden {
            display: none;
        }

        #wheelCanvas {
            width: 100%;
            height: 100%;
        }

        /* å½±ç‰‡å®¹å™¨ */
        .video-container {
            position: absolute;
            width: 300px;
            height: 200px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .video-container.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        .video-container .thumbnail-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        .video-container.playing .thumbnail-video {
            display: none !important;
            visibility: hidden !important;
        }

        .video-container .video-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 2;
            display: none;
            visibility: hidden;
        }

        .video-container.playing .video-player {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 999 !important;
        }

        /* èª¿è©¦é¢æ¿ */
        .debug-panel {
            position: fixed;
            top: 0;
            right: -380px;
            width: 380px;
            height: 100vh;
            background: rgba(22, 27, 34, 0.98);
            border-left: 2px solid rgba(78, 204, 163, 0.5);
            padding: 20px;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            color: #f0f6fc;
        }

        .debug-panel.visible {
            right: 0;
        }

        .debug-panel h3 {
            color: #4ecca3;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }

        .debug-section {
            margin-bottom: 20px;
        }

        .debug-section h4 {
            color: #00d9ff;
            margin-bottom: 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .debug-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .debug-label {
            font-size: 13px;
            color: #8b949e;
        }

        .debug-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4ecca3, #3db892);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .debug-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(78, 204, 163, 0.4);
        }

        .debug-btn.small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .debug-btn.danger {
            background: linear-gradient(135deg, #e94560, #d63950);
        }

        .debug-btn.secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .debug-btn:disabled {
            background: #444;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .debug-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .debug-toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: #21262d;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .debug-toggle.active {
            background: #4ecca3;
        }

        .debug-toggle::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: left 0.2s;
        }

        .debug-toggle.active::after {
            left: 23px;
        }

        /* å½±ç‰‡åˆ—è¡¨ */
        .video-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .video-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .video-item.hidden-item {
            opacity: 0.5;
        }

        .video-thumbnail {
            width: 80px;
            height: 60px;
            background: #000;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }

        .video-thumbnail video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-thumbnail .no-video {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 24px;
        }

        .video-info {
            flex: 1;
            min-width: 0;
        }

        .video-name {
            font-size: 13px;
            font-weight: bold;
            color: #f0f6fc;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-type {
            font-size: 11px;
            color: #8b949e;
        }

        .video-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .video-actions button {
            padding: 5px 10px;
            font-size: 11px;
            min-width: 60px;
        }

        .empty-list {
            text-align: center;
            color: #8b949e;
            padding: 30px;
            font-size: 13px;
        }

        .refresh-btn {
            font-size: 12px;
            padding: 4px 8px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: #8b949e;
            cursor: pointer;
            border-radius: 4px;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #f0f6fc;
        }

        /* è¦–çª—æ§åˆ¶åˆ— */
        .window-controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            z-index: 9999;
            -webkit-app-region: drag;
            opacity: 0.3;
            transition: opacity 0.3s;
        }

        /* 3ç§’å¾Œè‡ªå‹•éš±è— */
        .window-controls.auto-hide {
            opacity: 0;
        }

        .window-controls:hover,
        .window-controls.auto-hide:hover,
        .debug-mode .window-controls {
            opacity: 1;
        }

        .window-controls .title {
            color: #fff;
            font-size: 12px;
            pointer-events: none;
        }

        .window-controls .buttons {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
        }

        .window-controls .btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .window-controls .btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .window-controls .btn.close:hover {
            background: #e94560;
        }

        /* æç¤º */
        .debug-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .debug-hint.visible {
            opacity: 1;
        }

        /* å³éµé¸å–® */
        .context-menu {
            display: none;
            position: fixed;
            background: rgba(22, 27, 34, 0.95);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 180px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .context-menu.visible {
            display: block;
        }

        .context-menu-item {
            padding: 10px 20px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .context-menu-item:hover {
            background: rgba(78, 204, 163, 0.2);
        }

        .context-menu-item .checkmark {
            width: 16px;
            color: #4ecca3;
        }

        /* æ»¾å‹•æ¢ */
        .debug-panel::-webkit-scrollbar,
        .video-list::-webkit-scrollbar {
            width: 6px;
        }

        .debug-panel::-webkit-scrollbar-track,
        .video-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .debug-panel::-webkit-scrollbar-thumb,
        .video-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        /* å…¨å±é€²å ´å½±ç‰‡å®¹å™¨ */
        .entry-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2000;
            background: transparent;
        }

        .entry-container.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .entry-video {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        /* å¯æ‹–æ›³é€²å ´å½±ç‰‡å®¹å™¨ */
        .entry-video-container {
            position: absolute;
            width: 400px;
            height: 300px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            top: 100px;
            left: 100px;
        }

        .entry-video-container.hidden {
            display: none !important;
            visibility: hidden !important;
        }

        .entry-video-container .entry-thumbnail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        .entry-video-container.playing .entry-thumbnail {
            display: none !important;
        }

        .entry-video-container .entry-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 2;
            display: none;
        }

        .entry-video-container.playing .entry-player {
            display: block !important;
        }

        .entry-audio {
            display: none;
        }

        /* é€²å ´æ–‡å­—å®¹å™¨ */
        .entry-text-container {
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 200px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2500;  /* æ¯”å½±ç‰‡å®¹å™¨(2000)æ›´é«˜ï¼Œç¢ºä¿æ–‡å­—åœ¨ä¸Šé¢ */
        }

        .entry-text-container.hidden {
            display: none !important;
        }

        .entry-text {
            font-weight: bold;
            text-shadow:
                3px 3px 6px rgba(0,0,0,0.8),
                -1px -1px 0 rgba(0,0,0,0.5),
                1px -1px 0 rgba(0,0,0,0.5),
                -1px 1px 0 rgba(0,0,0,0.5),
                1px 1px 0 rgba(0,0,0,0.5);
            white-space: nowrap;
            animation: entryTextFadeIn 0.5s ease-out;
        }

        @keyframes entryTextFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes entryTextFadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(1.1);
            }
        }

        .entry-text.fade-out {
            animation: entryTextFadeOut 0.5s ease-in forwards;
        }

        /* ç›²ç›’å®¹å™¨ */
        .giftbox-container {
            top: 150px;
            right: 50px;
            width: 200px;
            height: 200px;
        }

        .giftbox-container.hidden {
            display: none;
        }

        .giftbox-box {
            position: relative;
            width: 100%;
            height: 100%;
            perspective: 1000px;
        }

        .giftbox-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 100px;
            background: linear-gradient(135deg, #e94560, #c13550);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .giftbox-base::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 100%;
            background: linear-gradient(135deg, #ffd93d, #f5c800);
        }

        .giftbox-lid {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 40px;
            background: linear-gradient(135deg, #e94560, #c13550);
            border-radius: 10px 10px 0 0;
            transform-origin: bottom center;
            transition: transform 0.5s ease;
        }

        .giftbox-lid::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 30px;
            background: linear-gradient(135deg, #ffd93d, #f5c800);
            border-radius: 50% 50% 0 0;
        }

        .giftbox-box.opening .giftbox-lid {
            transform: translateX(-50%) rotateX(-120deg);
        }

        .giftbox-box.rolling {
            animation: box-shake 0.15s ease-in-out infinite;
        }

        @keyframes box-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px) rotate(-1deg); }
            75% { transform: translateX(3px) rotate(1deg); }
        }

        .giftbox-result {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            padding: 15px 30px;
            background: linear-gradient(135deg, #4ecca3, #38b892);
            color: white;
            font-size: 24px;
            font-weight: bold;
            border-radius: 10px;
            white-space: nowrap;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(78, 204, 163, 0.5);
        }

        .giftbox-box.rolling .giftbox-result {
            transform: translateX(-50%) scale(1);
            opacity: 1;
            animation: roll-flip 0.1s ease-out;
        }

        @keyframes roll-flip {
            0% {
                transform: translateX(-50%) scale(0.8) translateY(10px);
                opacity: 0.5;
            }
            100% {
                transform: translateX(-50%) scale(1) translateY(0);
                opacity: 1;
            }
        }

        .giftbox-box.showing-result .giftbox-result {
            transform: translateX(-50%) scale(1.2);
            opacity: 1;
            animation: result-bounce 0.5s ease-out, result-glow 1.5s ease-in-out infinite;
        }

        @keyframes result-bounce {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.4); }
            100% { transform: translateX(-50%) scale(1.2); }
        }

        @keyframes result-glow {
            0%, 100% {
                box-shadow: 0 5px 20px rgba(78, 204, 163, 0.5),
                            0 0 30px rgba(255, 255, 255, 0.3);
            }
            50% {
                box-shadow: 0 5px 30px rgba(78, 204, 163, 0.8),
                            0 0 50px rgba(255, 255, 255, 0.5),
                            0 0 80px rgba(78, 204, 163, 0.4);
            }
        }

        /* ç›²ç›’å½©å¸¶æ•ˆæœ */
        .giftbox-confetti {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(200px) rotate(720deg);
                opacity: 0;
            }
        }

        /* ç›²ç›’å€’æ•¸è¨ˆæ™‚ */
        .giftbox-countdown {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            font-size: 72px;
            font-weight: bold;
            color: #ffd93d;
            text-shadow: 0 0 20px rgba(255, 217, 61, 0.8), 0 4px 8px rgba(0,0,0,0.5);
            opacity: 0;
            z-index: 10;
        }

        .giftbox-countdown.active {
            animation: countdown-pop 1s ease-out;
        }

        @keyframes countdown-pop {
            0% {
                transform: translateX(-50%) scale(0);
                opacity: 0;
            }
            30% {
                transform: translateX(-50%) scale(1.3);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) scale(1);
                opacity: 0;
            }
        }

        /* ç›²ç›’å½±ç‰‡å®¹å™¨ */
        .giftbox-video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 100;
        }

        .giftbox-video-container.active {
            display: block;
        }

        .giftbox-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ç›²ç›’è‡ªå‹•é¡¯ç¤ºç‹€æ…‹ */
        .giftbox-container.auto-hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: scale(0.8);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0s 0.3s;
        }

        .giftbox-container.auto-hidden.triggered {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: scale(1);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0s 0s;
        }
    </style>
</head>
<body>
    <!-- è¦–çª—æ§åˆ¶åˆ— (æ»‘é¼ ç§»åˆ°é ‚éƒ¨é¡¯ç¤º) -->
    <div class="window-controls" id="windowControls">
        <span class="title">ç¶ å¹•è¦–çª— (æŒ‰ Tab èª¿æ•´è¨­å®š)</span>
        <div class="buttons">
            <button class="btn" onclick="minimizeWindow()" title="æœ€å°åŒ–">â”€</button>
            <button class="btn" onclick="toggleMaximize()" title="æœ€å¤§åŒ–/é‚„åŸ">â–¡</button>
            <button class="btn close" onclick="closeWindow()" title="é—œé–‰">âœ•</button>
        </div>
    </div>

    <!-- å…¨å±é€²å ´å®¹å™¨ -->
    <div class="entry-container" id="entryContainer">
        <video class="entry-video" id="entryVideo"></video>
        <audio class="entry-audio" id="entryAudio"></audio>
    </div>

    <!-- é€²å ´æ–‡å­— -->
    <div class="draggable entry-text-container hidden" id="entryTextContainer">
        <span class="entry-text" id="entryText"></span>
        <div class="resize-handle nw"></div>
        <div class="resize-handle n"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle se"></div>
    </div>

    <!-- é€²å ´å½±ç‰‡å®¹å™¨ -->
    <div class="draggable entry-video-container hidden" id="entryVideoContainer">
        <video class="entry-thumbnail" id="entryThumbnail" muted preload="metadata"></video>
        <video class="entry-player" id="entryPlayer"></video>
        <audio class="entry-player-audio" id="entryPlayerAudio"></audio>
        <div class="resize-handle nw"></div>
        <div class="resize-handle n"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle se"></div>
    </div>

    <!-- è½‰ç›¤ -->
    <div class="draggable wheel-container" id="wheelContainer">
        <canvas id="wheelCanvas" width="350" height="350"></canvas>
        <div class="resize-handle nw"></div>
        <div class="resize-handle n"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle se"></div>
    </div>

    <!-- ç›²ç›’ -->
    <div class="draggable giftbox-container" id="giftboxContainer">
        <div class="giftbox-box" id="giftboxBox">
            <div class="giftbox-confetti" id="giftboxConfetti"></div>
            <div class="giftbox-base"></div>
            <div class="giftbox-lid"></div>
            <div class="giftbox-result" id="giftboxResult"></div>
            <div class="giftbox-countdown" id="giftboxCountdown">3</div>
        </div>
        <div class="giftbox-video-container" id="giftboxVideoContainer">
            <video class="giftbox-video" id="giftboxVideo"></video>
        </div>
        <div class="resize-handle nw"></div>
        <div class="resize-handle n"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle se"></div>
    </div>

    <!-- å½±ç‰‡å®¹å™¨å€åŸŸ - å‹•æ…‹ç”Ÿæˆ -->
    <div id="videoContainersArea"></div>

    <!-- èª¿è©¦é¢æ¿ -->
    <div class="debug-panel" id="debugPanel">
        <h3>ğŸ› ï¸ èª¿è©¦é¢æ¿</h3>

        <div class="debug-section">
            <h4>æ¨¡çµ„æ§åˆ¶</h4>
            <div class="debug-row">
                <span class="debug-label">é¡¯ç¤ºè½‰ç›¤</span>
                <div class="debug-toggle active" id="toggleWheel" onclick="toggleWheelVisibility()"></div>
            </div>
            <div class="debug-row">
                <span class="debug-label">é¡¯ç¤ºç›²ç›’</span>
                <div class="debug-toggle active" id="toggleGiftbox" onclick="toggleGiftboxVisibility()"></div>
            </div>
            <div class="debug-row">
                <span class="debug-label">ç›²ç›’è‡ªå‹•éš±è—</span>
                <div class="debug-toggle" id="toggleGiftboxAutoHide" onclick="toggleGiftboxAutoHide()"></div>
            </div>
            <div class="debug-row">
                <span class="debug-label">é¡¯ç¤ºå½±ç‰‡å€</span>
                <div class="debug-toggle active" id="toggleVideo" onclick="toggleVideoVisibility()"></div>
            </div>
            <div class="debug-row">
                <span class="debug-label">é¡¯ç¤ºé€²å ´å½±ç‰‡</span>
                <div class="debug-toggle" id="toggleEntryVideo" onclick="toggleEntryVideoVisibility()"></div>
            </div>
            <div style="margin-top: 15px;">
                <button class="debug-btn" id="testWheelBtn" onclick="testWheelSpin()" style="width: 100%;">ğŸ¡ æ¸¬è©¦è½‰ç›¤</button>
            </div>
            <div style="margin-top: 10px;">
                <button class="debug-btn" id="testGiftboxBtn" onclick="testGiftboxOpen()" style="width: 100%;">ğŸ æ¸¬è©¦ç›²ç›’</button>
            </div>
            <div style="margin-top: 10px;">
                <button class="debug-btn" onclick="testEntryText()" style="width: 100%;">ğŸ“ æ¸¬è©¦é€²å ´æ–‡å­—</button>
            </div>
            <div style="margin-top: 10px;">
                <button class="debug-btn" onclick="testEntryVideo()" style="width: 100%;">ğŸ¬ æ¸¬è©¦é€²å ´å½±ç‰‡</button>
            </div>
            <div style="margin-top: 10px;">
                <button class="debug-btn secondary" onclick="reloadAllThumbnails()" style="width: 100%;">ğŸ–¼ï¸ é‡æ–°è¼‰å…¥ç¸®åœ–</button>
            </div>
            <div style="margin-top: 10px;">
                <button class="debug-btn danger" onclick="resetAllCropStates()" style="width: 100%;">ğŸ”„ é‡ç½®æ‰€æœ‰è£åˆ‡</button>
            </div>
        </div>

        <div class="debug-section">
            <h4>
                é€²å ´æ•ˆæœåˆ—è¡¨
                <button class="refresh-btn" onclick="loadEntryList()">ğŸ”„ é‡æ–°æ•´ç†</button>
            </h4>
            <div class="video-list" id="entryList">
                <div class="empty-list">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div class="debug-section">
            <h4>
                å½±ç‰‡åˆ—è¡¨
                <button class="refresh-btn" onclick="loadVideoGifts()">ğŸ”„ é‡æ–°æ•´ç†</button>
            </h4>
            <div class="video-list" id="videoList">
                <div class="empty-list">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- æç¤º -->
    <div class="debug-hint" id="debugHint">æŒ‰ Tab éµé–‹å•Ÿèª¿è©¦é¢æ¿</div>

    <!-- å³éµé¸å–® -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="toggleWheelVisibility()">
            <span class="checkmark" id="wheelCheck">âœ“</span>
            <span>é¡¯ç¤ºè½‰ç›¤</span>
        </div>
        <div class="context-menu-item" onclick="toggleGiftboxVisibility()">
            <span class="checkmark" id="giftboxCheck">âœ“</span>
            <span>é¡¯ç¤ºç›²ç›’</span>
        </div>
        <div class="context-menu-item" onclick="toggleGiftboxAutoHide()">
            <span class="checkmark" id="giftboxAutoHideCheck"></span>
            <span>ç›²ç›’è‡ªå‹•éš±è—</span>
        </div>
        <div class="context-menu-item" onclick="toggleVideoVisibility()">
            <span class="checkmark" id="videoCheck">âœ“</span>
            <span>é¡¯ç¤ºå½±ç‰‡</span>
        </div>
        <div class="context-menu-item" onclick="toggleDebugPanel()">
            <span class="checkmark" id="debugCheck"></span>
            <span>é–‹å•Ÿèª¿è©¦é¢æ¿</span>
        </div>
    </div>

    <script>
        // === å…¨åŸŸè®Šæ•¸ ===
        let wheelOptions = [];
        let giftboxOptions = [];
        let videoGifts = [];
        let wheelAngle = 0;
        let wheelVisible = true;
        let giftboxVisible = true;
        let giftboxAutoHide = false;  // ç›²ç›’è‡ªå‹•éš±è—æ¨¡å¼
        let videoVisible = true;
        let wheelModuleEnabled = true;  // è½‰ç›¤æ¨¡çµ„æ˜¯å¦å•Ÿç”¨
        let giftboxModuleEnabled = false;  // ç›²ç›’æ¨¡çµ„æ˜¯å¦å•Ÿç”¨
        let isSpinning = false;
        let isGiftboxOpening = false;
        let debugPanelVisible = false;

        // å½±ç‰‡å®¹å™¨è³‡æ–™ (æ¯å€‹å½±ç‰‡ä¸€å€‹å®¹å™¨)
        let videoContainers = {};  // { index: { visible, width, height, left, top } }

        // å„å®¹å™¨çš„æ’­æ”¾ç‹€æ…‹
        let containerPlayingState = {};  // { index: { isPlaying, queue, wasHidden } }

        // æ¯å€‹å½±ç‰‡å®¹å™¨çš„è£åˆ‡ç‹€æ…‹
        let videoCropState = {};  // { index: { cropLeft, cropTop, originalWidth, originalHeight } }

        // å„²å­˜çš„ä½ç½®è³‡æ–™ï¼ˆå¾é…ç½®è¼‰å…¥ï¼‰
        let savedPositions = null;

        // === åˆå§‹åŒ– ===
        document.addEventListener('DOMContentLoaded', async () => {
            await waitForPywebview();

            // 1. å…ˆè¼‰å…¥å„²å­˜çš„ä½ç½®è³‡æ–™
            savedPositions = await loadSavedPositions();

            // 2. è¼‰å…¥è½‰ç›¤é¸é …ã€ç›²ç›’é¸é …ã€å½±ç‰‡åˆ—è¡¨å’Œé€²å ´åˆ—è¡¨
            await loadWheelOptions();
            await loadGiftboxOptions();
            await loadVideoGifts();  // é€™è£¡æœƒç”Ÿæˆå®¹å™¨ä¸¦å¥—ç”¨ä½ç½®
            await loadEntryList();   // è¼‰å…¥é€²å ´æ•ˆæœåˆ—è¡¨

            // 3. å¥—ç”¨è½‰ç›¤ã€ç›²ç›’ã€é€²å ´æ–‡å­—ã€é€²å ´å½±ç‰‡ä½ç½®
            applyWheelPosition();
            applyGiftboxPosition();
            applyEntryTextPosition();
            applyEntryVideoPosition();

            // 4. æª¢æŸ¥æ¨¡çµ„ç‹€æ…‹
            await loadModuleStatus();

            // 5. åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
            drawWheel();
            initDraggable();
            initResizable();
            initContextMenu();
            initMessageListener();
            initKeyboardShortcuts();
            showHint();

            // 3ç§’å¾Œè‡ªå‹•éš±è—è¦–çª—æ§åˆ¶åˆ—ï¼ˆä½†æ»‘é¼ ç§»ä¸Šå»é‚„æ˜¯æœƒé¡¯ç¤ºï¼‰
            setTimeout(() => {
                const controls = document.getElementById('windowControls');
                if (controls) {
                    controls.classList.add('auto-hide');
                }
            }, 3000);

            // å»¶é²é‡æ–°è¼‰å…¥ç¸®åœ–
            setTimeout(() => {
                console.log('[åˆå§‹åŒ–] å®Œæˆï¼Œé‡è¼‰ç¸®åœ–');
                reloadAllThumbnails();
            }, 500);
        });

        // è¼‰å…¥å„²å­˜çš„ä½ç½®è³‡æ–™
        async function loadSavedPositions() {
            try {
                if (window.pywebview && window.pywebview.api) {
                    const positions = await pywebview.api.get_greenscreen_positions();
                    console.log('[ä½ç½®] è¼‰å…¥å„²å­˜è³‡æ–™:', positions ? 'æœ‰è³‡æ–™' : 'ç„¡è³‡æ–™');
                    return positions || null;
                }
            } catch (e) {
                console.error('[ä½ç½®] è¼‰å…¥å¤±æ•—:', e);
            }
            return null;
        }

        // å¥—ç”¨è½‰ç›¤ä½ç½®
        function applyWheelPosition() {
            if (!savedPositions || !savedPositions.wheel) {
                console.log('[è½‰ç›¤] ä½¿ç”¨é è¨­ä½ç½®');
                return;
            }

            const wheel = document.getElementById('wheelContainer');
            const canvas = document.getElementById('wheelCanvas');
            const data = savedPositions.wheel;

            // å¥—ç”¨å°ºå¯¸å’Œä½ç½®
            const w = Math.max(50, data.width || 350);
            const h = Math.max(50, data.height || 350);
            wheel.style.width = w + 'px';
            wheel.style.height = h + 'px';
            wheel.style.left = (data.left || 0) + 'px';
            wheel.style.top = (data.top || 150) + 'px';
            wheel.style.transform = 'none';
            canvas.width = w;
            canvas.height = h;

            // å¥—ç”¨é¡¯ç¤ºç‹€æ…‹
            if (data.visible === false) {
                wheelVisible = false;
                setElementVisible(wheel, false);
                document.getElementById('wheelCheck').textContent = '';
                document.getElementById('toggleWheel').classList.remove('active');
            } else {
                wheelVisible = true;
                setElementVisible(wheel, true);
                document.getElementById('wheelCheck').textContent = 'âœ“';
                document.getElementById('toggleWheel').classList.add('active');
            }

            console.log('[è½‰ç›¤] å·²å¥—ç”¨ä½ç½®:', w, 'x', h, 'é¡¯ç¤º:', wheelVisible);
        }

        // é€šç”¨çš„é¡¯ç¤º/éš±è—å‡½æ•¸
        function setElementVisible(el, visible) {
            if (visible) {
                el.classList.remove('hidden');
                el.style.display = 'block';
                el.style.visibility = 'visible';
                el.style.opacity = '1';
            } else {
                el.classList.add('hidden');
                el.style.display = 'none';
                el.style.visibility = 'hidden';
                el.style.opacity = '0';
            }
        }

        // å¥—ç”¨ç›²ç›’ä½ç½®
        function applyGiftboxPosition() {
            const giftbox = document.getElementById('giftboxContainer');
            if (!giftbox) return;

            if (savedPositions && savedPositions.giftbox) {
                const data = savedPositions.giftbox;
                const w = Math.max(50, data.width || 200);
                const h = Math.max(50, data.height || 200);
                giftbox.style.width = w + 'px';
                giftbox.style.height = h + 'px';
                giftbox.style.left = (data.left || 0) + 'px';
                giftbox.style.top = (data.top || 150) + 'px';
                giftbox.style.right = 'auto';
                giftbox.style.transform = 'none';

                if (data.visible === false) {
                    giftboxVisible = false;
                    setElementVisible(giftbox, false);
                    document.getElementById('giftboxCheck').textContent = '';
                    document.getElementById('toggleGiftbox').classList.remove('active');
                } else {
                    giftboxVisible = true;
                    setElementVisible(giftbox, true);
                    document.getElementById('giftboxCheck').textContent = 'âœ“';
                    document.getElementById('toggleGiftbox').classList.add('active');
                }

                // è‡ªå‹•éš±è—æ¨¡å¼
                if (data.autoHide === true) {
                    giftboxAutoHide = true;
                    giftbox.classList.add('auto-hidden');
                    document.getElementById('giftboxAutoHideCheck').textContent = 'âœ“';
                    document.getElementById('toggleGiftboxAutoHide').classList.add('active');
                } else {
                    giftboxAutoHide = false;
                    giftbox.classList.remove('auto-hidden');
                    document.getElementById('giftboxAutoHideCheck').textContent = '';
                    document.getElementById('toggleGiftboxAutoHide').classList.remove('active');
                }

                console.log('[ç›²ç›’] å·²å¥—ç”¨ä½ç½®:', w, 'x', h, 'é¡¯ç¤º:', giftboxVisible, 'è‡ªå‹•éš±è—:', giftboxAutoHide);
            } else {
                console.log('[ç›²ç›’] ä½¿ç”¨é è¨­ä½ç½®');
                giftbox.style.right = '50px';
                giftbox.style.left = 'auto';
            }
        }

        // å¥—ç”¨é€²å ´æ–‡å­—ä½ç½®
        function applyEntryTextPosition() {
            const entryText = document.getElementById('entryTextContainer');
            if (!entryText) return;

            if (savedPositions && savedPositions.entryText) {
                const data = savedPositions.entryText;
                entryText.style.left = (data.left || 0) + 'px';
                entryText.style.top = (data.top || 50) + 'px';
                entryText.style.transform = 'none';
                console.log('[é€²å ´æ–‡å­—] å·²å¥—ç”¨ä½ç½®:', data.left, ',', data.top);
            } else {
                console.log('[é€²å ´æ–‡å­—] ä½¿ç”¨é è¨­ä½ç½®');
                // é è¨­ç½®ä¸­
                entryText.style.left = '50%';
                entryText.style.top = '50px';
                entryText.style.transform = 'translateX(-50%)';
            }
        }

        function applyEntryVideoPosition() {
            const entryVideo = document.getElementById('entryVideoContainer');
            if (!entryVideo) return;

            if (savedPositions && savedPositions.entryVideo) {
                const data = savedPositions.entryVideo;
                entryVideo.style.width = (data.width || 400) + 'px';
                entryVideo.style.height = (data.height || 300) + 'px';
                entryVideo.style.left = (data.left || 100) + 'px';
                entryVideo.style.top = (data.top || 100) + 'px';

                // è¨­å®šé¡¯ç¤ºç‹€æ…‹
                entryVideoVisible = data.visible || false;
                setElementVisible(entryVideo, entryVideoVisible);
                document.getElementById('toggleEntryVideo')?.classList.toggle('active', entryVideoVisible);

                // æ›´æ–°é€²å ´åˆ—è¡¨ä¸­çš„æŒ‰éˆ•ç‹€æ…‹
                updateEntryVisibilityButtons();

                console.log('[é€²å ´å½±ç‰‡] å·²å¥—ç”¨ä½ç½®:', data);
            } else {
                console.log('[é€²å ´å½±ç‰‡] ä½¿ç”¨é è¨­ä½ç½®');
                entryVideo.style.width = '400px';
                entryVideo.style.height = '300px';
                entryVideo.style.left = '100px';
                entryVideo.style.top = '100px';
                setElementVisible(entryVideo, false);
            }
        }

        // è¼‰å…¥ç›²ç›’é¸é …
        async function loadGiftboxOptions() {
            try {
                if (window.pywebview && window.pywebview.api) {
                    giftboxOptions = await pywebview.api.get_giftbox_options();
                } else {
                    giftboxOptions = [
                        { name: 'å¤§ç', color: '#ffd93d', weight: 1 },
                        { name: 'ä¸­ç', color: '#4ecca3', weight: 2 },
                        { name: 'å°ç', color: '#00d9ff', weight: 3 },
                        { name: 'è¬è¬åƒèˆ‡', color: '#e94560', weight: 4 }
                    ];
                }
            } catch (e) {
                giftboxOptions = [
                    { name: 'å¤§ç', color: '#ffd93d', weight: 1 },
                    { name: 'ä¸­ç', color: '#4ecca3', weight: 2 },
                    { name: 'å°ç', color: '#00d9ff', weight: 3 },
                    { name: 'è¬è¬åƒèˆ‡', color: '#e94560', weight: 4 }
                ];
            }
        }

        // è¼‰å…¥æ¨¡çµ„ç‹€æ…‹ï¼ˆä¸»æ§å°çš„æ¨¡çµ„é–‹é—œï¼‰
        async function loadModuleStatus() {
            try {
                if (window.pywebview && window.pywebview.api) {
                    const status = await pywebview.api.get_module_status();

                    wheelModuleEnabled = status.wheel_enabled;
                    giftboxModuleEnabled = status.giftbox_enabled;
                    updateWheelTestButton();
                    updateGiftboxTestButton();

                    // å¦‚æœä¸»æ§å°é—œé–‰äº†è½‰ç›¤æ¨¡çµ„ï¼Œå¼·åˆ¶éš±è—
                    if (!status.wheel_enabled) {
                        wheelVisible = false;
                        setElementVisible(document.getElementById('wheelContainer'), false);
                        document.getElementById('wheelCheck').textContent = '';
                        document.getElementById('toggleWheel').classList.remove('active');
                    }

                    // å¦‚æœä¸»æ§å°é—œé–‰äº†ç›²ç›’æ¨¡çµ„ï¼Œå¼·åˆ¶éš±è—
                    if (!status.giftbox_enabled) {
                        giftboxVisible = false;
                        setElementVisible(document.getElementById('giftboxContainer'), false);
                        document.getElementById('giftboxCheck').textContent = '';
                        document.getElementById('toggleGiftbox').classList.remove('active');
                    }

                    // å¦‚æœä¸»æ§å°é—œé–‰äº†å½±ç‰‡æ¨¡çµ„ï¼Œå¼·åˆ¶éš±è—æ‰€æœ‰å½±ç‰‡å®¹å™¨
                    if (!status.video_enabled) {
                        videoVisible = false;
                        document.querySelectorAll('.video-container').forEach(vc => {
                            setElementVisible(vc, false);
                        });
                        document.getElementById('videoCheck').textContent = '';
                        document.getElementById('toggleVideo').classList.remove('active');
                    }
                }
            } catch (e) {
                console.error('[æ¨¡çµ„ç‹€æ…‹] è¼‰å…¥å¤±æ•—:', e);
            }
        }

        // è¼‰å…¥å½±ç‰‡åˆ—è¡¨ä¸¦ç”Ÿæˆå®¹å™¨
        async function loadVideoGifts() {
            try {
                if (window.pywebview && window.pywebview.api) {
                    const config = await pywebview.api.get_config();
                    videoGifts = config.video_gifts || [];
                    renderVideoList();
                    generateVideoContainers();
                }
            } catch (e) {
                console.error('è¼‰å…¥å½±ç‰‡åˆ—è¡¨å¤±æ•—:', e);
                document.getElementById('videoList').innerHTML = '<div class="empty-list">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        // ç”Ÿæˆå½±ç‰‡å®¹å™¨
        function generateVideoContainers() {
            const area = document.getElementById('videoContainersArea');
            area.innerHTML = '';

            // å¾ savedPositions å–å¾—å½±ç‰‡å®¹å™¨è³‡æ–™
            const savedVideoData = (savedPositions && savedPositions.videoContainers) || {};

            videoGifts.forEach((gift, index) => {
                if (!gift.video_path) return;

                // å–å¾—å„²å­˜çš„è³‡æ–™
                const saved = savedVideoData[index] || {};

                // è¨ˆç®—å®¹å™¨å±¬æ€§ï¼ˆå„ªå…ˆä½¿ç”¨å„²å­˜çš„å€¼ï¼‰
                const width = Math.max(50, saved.width || 300);
                const height = Math.max(50, saved.height || 200);
                const left = saved.left ?? (50 + (index % 3) * 320);
                const top = saved.top ?? (100 + Math.floor(index / 3) * 220);
                const visible = (saved.visible !== false) && (gift.visible !== false);

                // è£åˆ‡ç‹€æ…‹
                const cropLeft = saved.cropLeft || 0;
                const cropTop = saved.cropTop || 0;
                const originalWidth = saved.originalWidth || width;
                const originalHeight = saved.originalHeight || height;

                // å„²å­˜åˆ° videoContainers ä¾›å¾ŒçºŒä½¿ç”¨
                videoContainers[index] = {
                    visible, width, height, left, top,
                    cropLeft, cropTop, originalWidth, originalHeight
                };

                // å„²å­˜è£åˆ‡ç‹€æ…‹
                videoCropState[index] = { cropLeft, cropTop, originalWidth, originalHeight };

                console.log(`[å®¹å™¨ ${index}] å°ºå¯¸:${width}x${height} ä½ç½®:(${left},${top}) é¡¯ç¤º:${visible} è£åˆ‡:(${cropLeft},${cropTop}) åŸå§‹:${originalWidth}x${originalHeight}`);

                // å»ºç«‹å®¹å™¨å…ƒç´ 
                const container = document.createElement('div');
                container.className = 'draggable video-container';
                container.id = `videoContainer_${index}`;
                container.dataset.index = index;
                container.style.width = width + 'px';
                container.style.height = height + 'px';
                container.style.left = left + 'px';
                container.style.top = top + 'px';

                // æ˜ç¢ºè¨­å®šé¡¯ç¤ºç‹€æ…‹
                setElementVisible(container, visible);

                container.innerHTML = `
                    <video class="thumbnail-video" muted preload="metadata" src="${formatVideoPath(gift.video_path)}"></video>
                    <video class="video-player"></video>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle n"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle se"></div>
                `;

                area.appendChild(container);

                // è¨­å®šç¸®åœ–å’Œå½±ç‰‡çš„è£åˆ‡æ¨£å¼
                const thumbnail = container.querySelector('.thumbnail-video');
                const player = container.querySelector('.video-player');

                thumbnail.style.width = originalWidth + 'px';
                thumbnail.style.height = originalHeight + 'px';
                thumbnail.style.left = -cropLeft + 'px';
                thumbnail.style.top = -cropTop + 'px';
                thumbnail.style.position = 'absolute';

                player.style.width = originalWidth + 'px';
                player.style.height = originalHeight + 'px';
                player.style.left = -cropLeft + 'px';
                player.style.top = -cropTop + 'px';
                player.style.position = 'absolute';

                // è¨­å®šç¸®åœ–è¼‰å…¥äº‹ä»¶
                thumbnail.onloadedmetadata = () => {
                    console.log(`[ç¸®åœ–] å®¹å™¨ ${index} è¼‰å…¥æˆåŠŸ`);
                    try { thumbnail.currentTime = 1; } catch (e) {}
                };
                thumbnail.onerror = (e) => {
                    console.error(`[ç¸®åœ–] å®¹å™¨ ${index} è¼‰å…¥å¤±æ•—:`, thumbnail.src, e);
                    thumbnail.style.display = 'none';
                    container.style.background = 'rgba(255, 0, 0, 0.3)';
                };
            });

            // é‡æ–°åˆå§‹åŒ–æ‹–æ›³å’Œç¸®æ”¾
            initDraggable();
            initResizable();
        }

        // æ¸²æŸ“å½±ç‰‡åˆ—è¡¨
        function renderVideoList() {
            const container = document.getElementById('videoList');

            if (videoGifts.length === 0) {
                container.innerHTML = '<div class="empty-list">å°šç„¡å½±ç‰‡è¨­å®š<br><small>è«‹åœ¨ä¸»æ§å°æ–°å¢å½±ç‰‡è§¸ç™¼</small></div>';
                return;
            }

            const typeLabels = { gift: 'ç¦®ç‰©', chat: 'å½ˆå¹•', like: 'é»è®š' };

            container.innerHTML = videoGifts.map((gift, index) => {
                const isVisible = gift.visible !== false;
                const videoPath = gift.video_path || '';

                return `
                    <div class="video-item ${!isVisible ? 'hidden-item' : ''}" data-index="${index}">
                        <div class="video-thumbnail">
                            ${videoPath ? `<video src="${formatVideoPath(videoPath)}" muted preload="metadata" onloadedmetadata="this.currentTime=1" onerror="console.error('[åˆ—è¡¨ç¸®åœ–] è¼‰å…¥å¤±æ•—:', this.src); this.parentElement.innerHTML='<div class=\\'no-video\\'>âŒ</div>'"></video>` : '<div class="no-video">ğŸ¬</div>'}
                        </div>
                        <div class="video-info">
                            <div class="video-name">${gift.name || 'æœªå‘½å'}</div>
                            <div class="video-type">${typeLabels[gift.trigger_type] || 'ç¦®ç‰©'}</div>
                        </div>
                        <div class="video-actions">
                            <button class="debug-btn small" onclick="testVideoByIndex(${index})">â–¶ï¸ æ¸¬è©¦</button>
                            <button class="debug-btn small ${isVisible ? 'secondary' : 'danger'}" onclick="toggleVideoGiftVisible(${index})">
                                ${isVisible ? 'ğŸ‘ï¸ é¡¯ç¤º' : 'ğŸš« éš±è—'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ ¼å¼åŒ–å½±ç‰‡è·¯å¾‘ - ä½¿ç”¨æœ¬åœ°æª”æ¡ˆä¼ºæœå™¨
        const FILE_SERVER_PORT = 18888;

        function formatVideoPath(path) {
            if (!path) return '';
            // ä½¿ç”¨æœ¬åœ°ä¼ºæœå™¨æä¾›å½±ç‰‡ (æ³¨æ„: /media è·¯å¾‘)
            return `http://127.0.0.1:${FILE_SERVER_PORT}/media?path=${encodeURIComponent(path)}`;
        }

        // æ¸¬è©¦å–®å€‹å½±ç‰‡
        async function testVideoByIndex(index) {
            const gift = videoGifts[index];
            if (!gift || !gift.video_path) return;

            triggerVideoInContainer(index, {
                path: gift.video_path,
                speed: gift.video_speed || 1.0,
                volume: gift.video_volume || 100,
                seconds: gift.video_seconds || 0,
                repeat: 1
            });
        }

        // åœ¨æŒ‡å®šå®¹å™¨æ’­æ”¾å½±ç‰‡
        function triggerVideoInContainer(index, videoData) {
            console.log(`[DEBUG] triggerVideoInContainer è¢«å‘¼å«: index=${index}, path=${videoData.path}, count=${videoData.count || 1}`);

            const container = document.getElementById(`videoContainer_${index}`);
            if (!container) {
                console.error(`[ERROR] æ‰¾ä¸åˆ°å½±ç‰‡å®¹å™¨: videoContainer_${index}`);
                // åˆ—å‡ºæ‰€æœ‰ç¾æœ‰å®¹å™¨
                const allContainers = document.querySelectorAll('.video-container');
                console.log(`[DEBUG] ç¾æœ‰å®¹å™¨æ•¸é‡: ${allContainers.length}`);
                allContainers.forEach(c => console.log(`  - ${c.id}`));
                return;
            }

            console.log(`[DEBUG] æ‰¾åˆ°å®¹å™¨: ${container.id}, å°ºå¯¸: ${container.offsetWidth}x${container.offsetHeight}`);

            // åˆå§‹åŒ–å®¹å™¨ç‹€æ…‹
            if (!containerPlayingState[index]) {
                containerPlayingState[index] = { isPlaying: false, queue: [], wasHidden: false };
            }

            const state = containerPlayingState[index];

            // æª¢æŸ¥å®¹å™¨æ˜¯å¦è¢«éš±è—ï¼Œå¦‚æœæ˜¯çš„è©±è¨˜éŒ„ä¸¦æš«æ™‚é¡¯ç¤º
            if (container.classList.contains('hidden') && !state.isPlaying) {
                state.wasHidden = true;
                // æš«æ™‚é¡¯ç¤ºå®¹å™¨
                container.classList.remove('hidden');
                container.style.display = 'block';
                container.style.visibility = 'visible';
                container.style.opacity = '1';
                console.log(`å®¹å™¨ [${index}] åŸæœ¬éš±è—ï¼Œæš«æ™‚é¡¯ç¤ºä»¥æ’­æ”¾å½±ç‰‡`);
            }

            // æ ¹æ“š count åŠ å…¥ä½‡åˆ—ï¼ˆé€å¹¾å€‹ç¦®ç‰©å°±æ’­æ”¾å¹¾æ¬¡ï¼‰
            const playCount = Math.min(videoData.count || 1, 100);  // æœ€å¤š 100 æ¬¡ï¼Œé¿å…éå¤š
            const priority = videoData.priority || 1;  // é è¨­å„ªå…ˆç´š 1

            for (let i = 0; i < playCount; i++) {
                const newItem = {...videoData, count: 1, priority: priority};

                // æ ¹æ“šå„ªå…ˆç´šæ’å…¥ä½‡åˆ—ï¼ˆæ•¸å­—è¶Šå¤§å„ªå…ˆç´šè¶Šé«˜ï¼Œæ’è¶Šå‰é¢ï¼‰
                let inserted = false;
                for (let j = 0; j < state.queue.length; j++) {
                    if (priority > (state.queue[j].priority || 1)) {
                        state.queue.splice(j, 0, newItem);
                        inserted = true;
                        break;
                    }
                }
                if (!inserted) {
                    state.queue.push(newItem);
                }
            }
            console.log(`[DEBUG] åŠ å…¥ä½‡åˆ— ${playCount} æ¬¡ (å„ªå…ˆç´š: ${priority})ï¼Œç›®å‰ä½‡åˆ—é•·åº¦: ${state.queue.length}`);

            // å¦‚æœæœ‰å¼·åˆ¶æ’éšŠä¸”æ­£åœ¨æ’­æ”¾ï¼Œåœæ­¢ç•¶å‰æ’­æ”¾
            if (videoData.force_interrupt && state.isPlaying) {
                stopVideoInContainer(index);
            }

            playNextVideoInContainer(index);
        }

        // æ’­æ”¾å®¹å™¨ä¸­çš„ä¸‹ä¸€å€‹å½±ç‰‡
        function playNextVideoInContainer(index) {
            const state = containerPlayingState[index];
            if (!state || state.isPlaying || state.queue.length === 0) return;

            const container = document.getElementById(`videoContainer_${index}`);
            if (!container) {
                console.error(`æ‰¾ä¸åˆ°å®¹å™¨: videoContainer_${index}`);
                return;
            }

            const data = state.queue.shift();
            if (!data.path) {
                playNextVideoInContainer(index);
                return;
            }

            state.isPlaying = true;

            const videoPlayer = container.querySelector('.video-player');
            const thumbnail = container.querySelector('.thumbnail-video');
            const videoSrc = formatVideoPath(data.path);

            console.log(`æº–å‚™æ’­æ”¾å½±ç‰‡ [${index}]:`, videoSrc);

            // æ¸…é™¤èˆŠçš„äº‹ä»¶
            videoPlayer.onloadedmetadata = null;
            videoPlayer.oncanplay = null;
            videoPlayer.onended = null;
            videoPlayer.onerror = null;
            videoPlayer.onloadeddata = null;

            let currentRepeat = 0;
            const maxRepeat = data.repeat || 1;
            let hasStarted = false;

            const startPlayback = () => {
                if (hasStarted) return;
                hasStarted = true;

                console.log(`[DEBUG] é–‹å§‹æ’­æ”¾å½±ç‰‡ [${index}]`);
                console.log(`[DEBUG] å®¹å™¨ç‹€æ…‹: display=${container.style.display}, visibility=${container.style.visibility}, hidden=${container.classList.contains('hidden')}`);

                // ç¢ºä¿å®¹å™¨å¯è¦‹
                if (container.classList.contains('hidden')) {
                    container.classList.remove('hidden');
                    container.style.display = 'block';
                    container.style.visibility = 'visible';
                    container.style.opacity = '1';
                }

                // ç¢ºä¿å®¹å™¨æœ‰ playing class
                container.classList.add('playing');
                console.log(`[DEBUG] å®¹å™¨ playing class å·²æ·»åŠ : ${container.classList.contains('playing')}`);

                // éš±è—ç¸®åœ–
                if (thumbnail) {
                    thumbnail.style.display = 'none';
                    thumbnail.style.visibility = 'hidden';
                }

                // ç¢ºä¿å½±ç‰‡æ’­æ”¾å™¨é¡¯ç¤º
                videoPlayer.style.display = 'block';
                videoPlayer.style.visibility = 'visible';
                videoPlayer.style.opacity = '1';
                videoPlayer.style.zIndex = '999';
                console.log(`[DEBUG] æ’­æ”¾å™¨æ¨£å¼å·²è¨­ç½®: display=${videoPlayer.style.display}, visibility=${videoPlayer.style.visibility}`);

                // ç¢ºä¿æ’­æ”¾å™¨æœ‰æ­£ç¢ºçš„å°ºå¯¸å’Œä½ç½®ï¼ˆç¹¼æ‰¿è£åˆ‡ç‹€æ…‹ï¼‰
                const cropState = videoCropState[index];
                let playerWidth = container.offsetWidth || 300;
                let playerHeight = container.offsetHeight || 200;
                let playerLeft = 0;
                let playerTop = 0;

                if (cropState && cropState.originalWidth > 50 && cropState.originalHeight > 50) {
                    playerWidth = cropState.originalWidth;
                    playerHeight = cropState.originalHeight;
                    playerLeft = -(cropState.cropLeft || 0);
                    playerTop = -(cropState.cropTop || 0);
                }

                console.log(`[DEBUG] æ’­æ”¾å½±ç‰‡ [${index}] å°ºå¯¸: ${playerWidth}x${playerHeight}, åç§»: ${playerLeft},${playerTop}`);

                videoPlayer.style.position = 'absolute';
                videoPlayer.style.width = playerWidth + 'px';
                videoPlayer.style.height = playerHeight + 'px';
                videoPlayer.style.left = playerLeft + 'px';
                videoPlayer.style.top = playerTop + 'px';

                if (data.seconds > 0) {
                    setTimeout(() => {
                        if (state.isPlaying) {
                            videoPlayer.pause();
                            handleVideoEndInContainer(index);
                        }
                    }, data.seconds * 1000);
                }

                videoPlayer.play().then(() => {
                    console.log(`å½±ç‰‡æ’­æ”¾ä¸­ [${index}]`);
                }).catch((err) => {
                    console.error(`å½±ç‰‡æ’­æ”¾å¤±æ•— [${index}]:`, err);
                    handleVideoEndInContainer(index);
                });
            };

            videoPlayer.onloadedmetadata = () => {
                console.log(`å½±ç‰‡ metadata å·²è¼‰å…¥ [${index}]`);
                startPlayback();
            };

            videoPlayer.onloadeddata = () => {
                console.log(`å½±ç‰‡è³‡æ–™å·²è¼‰å…¥ [${index}]`);
                startPlayback();
            };

            videoPlayer.oncanplay = () => {
                console.log(`å½±ç‰‡å¯æ’­æ”¾ [${index}]`);
                startPlayback();
            };

            videoPlayer.onended = () => {
                console.log(`å½±ç‰‡æ’­æ”¾çµæŸ [${index}]`);
                currentRepeat++;
                if (currentRepeat < maxRepeat) {
                    videoPlayer.currentTime = 0;
                    videoPlayer.play();
                } else {
                    handleVideoEndInContainer(index);
                }
            };

            videoPlayer.onerror = (e) => {
                console.error(`å½±ç‰‡è¼‰å…¥éŒ¯èª¤ [${index}]:`, e);
                handleVideoEndInContainer(index, true);  // å‚³é isError = true
            };

            // è¨­å®šå½±ç‰‡æº
            videoPlayer.src = videoSrc;
            videoPlayer.playbackRate = data.speed || 1.0;
            videoPlayer.volume = (data.volume || 100) / 100;
            videoPlayer.muted = false;
            videoPlayer.load();

            // å‚™ç”¨ï¼šå¦‚æœ 1 ç§’å¾Œé‚„æ²’é–‹å§‹æ’­æ”¾ï¼Œå¼·åˆ¶å˜—è©¦
            setTimeout(() => {
                if (!hasStarted && state.isPlaying) {
                    console.log(`å¼·åˆ¶å˜—è©¦æ’­æ”¾ [${index}]`);
                    startPlayback();
                }
            }, 1000);
        }

        // è™•ç†å®¹å™¨å½±ç‰‡çµæŸ
        function handleVideoEndInContainer(index, isError = false) {
            const state = containerPlayingState[index];
            if (!state) return;

            // é˜²æ­¢é‡è¤‡è§¸ç™¼
            if (!state.isPlaying) return;
            state.isPlaying = false;

            const container = document.getElementById(`videoContainer_${index}`);
            if (container) {
                container.classList.remove('playing');

                // éš±è—æ’­æ”¾å™¨ï¼Œé¡¯ç¤ºç¸®åœ–
                const videoPlayer = container.querySelector('.video-player');
                const thumbnail = container.querySelector('.thumbnail-video');

                if (videoPlayer) {
                    // å…ˆæ¸…é™¤æ‰€æœ‰äº‹ä»¶ï¼Œé˜²æ­¢ src='' è§¸ç™¼ onerror
                    videoPlayer.onloadedmetadata = null;
                    videoPlayer.onloadeddata = null;
                    videoPlayer.oncanplay = null;
                    videoPlayer.onended = null;
                    videoPlayer.onerror = null;

                    videoPlayer.pause();
                    videoPlayer.removeAttribute('src');
                    videoPlayer.load();  // é‡ç½®å½±ç‰‡å…ƒç´ 
                    videoPlayer.style.display = 'none';
                }

                if (thumbnail) {
                    // å®Œæ•´é‡ç½®ç¸®åœ–é¡¯ç¤ºç‹€æ…‹
                    thumbnail.style.display = 'block';
                    thumbnail.style.visibility = 'visible';
                    thumbnail.style.opacity = '1';

                    // é‡æ–°è¨­å®š currentTime ä»¥é¡¯ç¤ºç¸®åœ–ç•«é¢
                    // ï¼ˆæ’­æ”¾å™¨å¯èƒ½å½±éŸ¿äº†ç¸®åœ–çš„æ™‚é–“ä½ç½®ï¼‰
                    try {
                        if (thumbnail.readyState >= 1) {
                            thumbnail.currentTime = 1;
                        } else {
                            // å¦‚æœç¸®åœ–å°šæœªè¼‰å…¥ï¼Œé‡æ–°è¼‰å…¥
                            const src = thumbnail.src;
                            if (src) {
                                thumbnail.onloadedmetadata = () => {
                                    thumbnail.currentTime = 1;
                                };
                                thumbnail.load();
                            }
                        }
                    } catch (e) {
                        console.warn(`[WARN] é‡ç½®ç¸®åœ–æ™‚é–“å¤±æ•— [${index}]:`, e);
                    }
                }
            }

            console.log(`å½±ç‰‡å®¹å™¨ [${index}] æ’­æ”¾å®Œæˆ${isError ? ' (ç™¼ç”ŸéŒ¯èª¤)' : ''}`);

            // å¦‚æœæ˜¯éŒ¯èª¤ï¼Œæ¸…ç©ºä½‡åˆ—é¿å…ç„¡é™é‡è©¦
            if (isError) {
                state.queue = [];
            }

            // æª¢æŸ¥ä½‡åˆ—æ˜¯å¦é‚„æœ‰å½±ç‰‡
            if (state.queue.length > 0) {
                // é‚„æœ‰å½±ç‰‡è¦æ’­æ”¾ï¼Œå»¶é²ä¸€ä¸‹å†æ’­æ”¾
                setTimeout(() => playNextVideoInContainer(index), 100);
            } else {
                // ä½‡åˆ—å·²ç©ºï¼Œå¦‚æœåŸæœ¬æ˜¯éš±è—çš„ï¼Œæ¢å¾©éš±è—ç‹€æ…‹
                if (state.wasHidden && container) {
                    container.classList.add('hidden');
                    container.style.display = 'none';
                    container.style.visibility = 'hidden';
                    container.style.opacity = '0';
                    console.log(`å®¹å™¨ [${index}] æ’­æ”¾å®Œæˆï¼Œæ¢å¾©éš±è—ç‹€æ…‹`);
                }
                // é‡ç½® wasHidden ç‹€æ…‹
                state.wasHidden = false;
            }
        }

        // åœæ­¢å®¹å™¨ä¸­çš„å½±ç‰‡
        function stopVideoInContainer(index) {
            const container = document.getElementById(`videoContainer_${index}`);
            if (!container) return;

            const videoPlayer = container.querySelector('.video-player');
            const thumbnail = container.querySelector('.thumbnail-video');

            if (videoPlayer) {
                // å…ˆæ¸…é™¤æ‰€æœ‰äº‹ä»¶
                videoPlayer.onloadedmetadata = null;
                videoPlayer.onloadeddata = null;
                videoPlayer.oncanplay = null;
                videoPlayer.onended = null;
                videoPlayer.onerror = null;

                videoPlayer.pause();
                videoPlayer.removeAttribute('src');
                videoPlayer.load();
                videoPlayer.style.display = 'none';
            }

            if (thumbnail) {
                // å®Œæ•´é‡ç½®ç¸®åœ–é¡¯ç¤ºç‹€æ…‹
                thumbnail.style.display = 'block';
                thumbnail.style.visibility = 'visible';
                thumbnail.style.opacity = '1';

                // é‡æ–°è¨­å®š currentTime ä»¥é¡¯ç¤ºç¸®åœ–ç•«é¢
                try {
                    if (thumbnail.readyState >= 1) {
                        thumbnail.currentTime = 1;
                    }
                } catch (e) {
                    console.warn(`[WARN] åœæ­¢æ™‚é‡ç½®ç¸®åœ–æ™‚é–“å¤±æ•— [${index}]:`, e);
                }
            }

            container.classList.remove('playing');

            const state = containerPlayingState[index];
            if (state) {
                state.isPlaying = false;
                // åœæ­¢æ™‚ä¸æ¢å¾©éš±è—ç‹€æ…‹ï¼ˆå› ç‚ºæ˜¯å¼·åˆ¶ä¸­æ–·ï¼Œæœƒç«‹å³æ’­æ”¾ä¸‹ä¸€å€‹ï¼‰
            }
        }

        // åˆ‡æ›å½±ç‰‡é¡¯ç¤º/éš±è—
        async function toggleVideoGiftVisible(index) {
            if (!videoGifts[index]) return;

            const gift = videoGifts[index];
            gift.visible = gift.visible === false ? true : false;

            // æ›´æ–°å®¹å™¨ç‹€æ…‹
            if (videoContainers[index]) {
                videoContainers[index].visible = gift.visible;
            }

            // æ›´æ–°ç¶ å¹•ä¸Šçš„å®¹å™¨
            const container = document.getElementById(`videoContainer_${index}`);
            if (container) {
                setElementVisible(container, gift.visible);
            }

            // é‡è¦ï¼šå…ˆä¿å­˜ç•¶å‰æ‰€æœ‰å®¹å™¨çš„ä½ç½®å’Œè£åˆ‡ç‹€æ…‹
            // é€™æ¨£ç•¶ configUpdated è§¸ç™¼ regenerate æ™‚ï¼Œæœƒä½¿ç”¨æœ€æ–°çš„ç‹€æ…‹
            await savePositions();

            try {
                if (window.pywebview && window.pywebview.api) {
                    // æ¨™è¨˜é€™æ˜¯åƒ…å¯è¦‹æ€§æ›´æ–°ï¼Œä¸éœ€è¦é‡æ–°ç”Ÿæˆå®¹å™¨
                    window._skipContainerRegeneration = true;
                    await pywebview.api.update_config({ video_gifts: videoGifts });
                    // å»¶é²é‡ç½®æ¨™è¨˜ï¼Œç¢ºä¿ configUpdated äº‹ä»¶å·²è™•ç†
                    setTimeout(() => { window._skipContainerRegeneration = false; }, 100);
                }
            } catch (e) {
                console.error('æ›´æ–°å¤±æ•—:', e);
                window._skipContainerRegeneration = false;
            }

            renderVideoList();
        }

        function waitForPywebview() {
            return new Promise((resolve) => {
                // æª¢æŸ¥ API æ˜¯å¦å®Œå…¨å¯ç”¨ï¼ˆåŒ…æ‹¬å…·é«”æ–¹æ³•ï¼‰
                const checkApi = () => {
                    if (window.pywebview && window.pywebview.api &&
                        typeof window.pywebview.api.get_greenscreen_positions === 'function') {
                        console.log('[DEBUG] pywebview API å·²å°±ç·’');
                        resolve();
                        return true;
                    }
                    return false;
                };

                if (checkApi()) return;

                // ç›£è½ pywebviewready äº‹ä»¶
                window.addEventListener('pywebviewready', () => {
                    // äº‹ä»¶è§¸ç™¼å¾Œä»éœ€ç­‰å¾… API æ–¹æ³•ç¶å®š
                    let attempts = 0;
                    const waitInterval = setInterval(() => {
                        attempts++;
                        if (checkApi() || attempts > 50) {
                            clearInterval(waitInterval);
                            if (attempts > 50) {
                                console.warn('[WARN] ç­‰å¾… pywebview API è¶…æ™‚');
                                resolve();
                            }
                        }
                    }, 100);
                });

                // å‚™ç”¨ï¼šè¼ªè©¢æª¢æŸ¥
                let pollAttempts = 0;
                const pollInterval = setInterval(() => {
                    pollAttempts++;
                    if (checkApi() || pollAttempts > 50) {
                        clearInterval(pollInterval);
                        if (pollAttempts > 50) {
                            console.warn('[WARN] è¼ªè©¢ç­‰å¾… pywebview API è¶…æ™‚');
                            resolve();
                        }
                    }
                }, 100);
            });
        }

        // === è¦–çª—æ§åˆ¶ ===
        function closeWindow() {
            if (window.electronAPI && window.electronAPI.closeGreenScreen) {
                window.electronAPI.closeGreenScreen();
            } else {
                window.close();
            }
        }

        function minimizeWindow() {
            if (window.electronAPI && window.electronAPI.minimizeGreenScreen) {
                window.electronAPI.minimizeGreenScreen();
            }
        }

        function toggleMaximize() {
            if (window.electronAPI && window.electronAPI.toggleMaximizeGreenScreen) {
                window.electronAPI.toggleMaximizeGreenScreen();
            }
        }

        // é¡¯ç¤ºæç¤º
        function showHint() {
            const hint = document.getElementById('debugHint');
            hint.classList.add('visible');
            setTimeout(() => hint.classList.remove('visible'), 3000);
        }

        // éµç›¤å¿«æ·éµ
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    toggleDebugPanel();
                }
            });
        }

        // åˆ‡æ›èª¿è©¦é¢æ¿
        function toggleDebugPanel() {
            debugPanelVisible = !debugPanelVisible;
            const panel = document.getElementById('debugPanel');
            const check = document.getElementById('debugCheck');
            panel.classList.toggle('visible', debugPanelVisible);
            check.textContent = debugPanelVisible ? 'âœ“' : '';

            if (debugPanelVisible) {
                document.body.classList.add('debug-mode');
                // åªæ›´æ–°åˆ—è¡¨ï¼Œä¸é‡æ–°ç”Ÿæˆå®¹å™¨
                refreshVideoListOnly();
            } else {
                document.body.classList.remove('debug-mode');
            }
        }

        // åªæ›´æ–°å½±ç‰‡åˆ—è¡¨ UIï¼Œä¸é‡æ–°ç”Ÿæˆå®¹å™¨
        async function refreshVideoListOnly() {
            try {
                if (window.pywebview && window.pywebview.api) {
                    const config = await pywebview.api.get_config();
                    videoGifts = config.video_gifts || [];
                    renderVideoList();
                }
            } catch (e) {
                console.error('æ›´æ–°å½±ç‰‡åˆ—è¡¨å¤±æ•—:', e);
            }
        }

        // ç›£è½è¨Šæ¯
        function initMessageListener() {
            console.log('=== åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨ ===');

            // ç›£è½ä¾†è‡ª Electron ä¸»é€²ç¨‹çš„äº‹ä»¶
            if (window.electronAPI && window.electronAPI.onGreenScreenEvent) {
                console.log('è¨­å®š electronAPI äº‹ä»¶ç›£è½');
                window.electronAPI.onGreenScreenEvent((event, data) => {
                    console.log('æ”¶åˆ°ä¸»é€²ç¨‹äº‹ä»¶:', event, data);
                    // æ´¾ç™¼å°æ‡‰çš„è‡ªå®šç¾©äº‹ä»¶
                    window.dispatchEvent(new CustomEvent(event, { detail: data }));
                });
            } else {
                console.warn('electronAPI.onGreenScreenEvent ä¸å¯ç”¨');
            }

            // ç›£è½é…ç½®æ›´æ–° - å³æ™‚åŒæ­¥ä¸éœ€é‡é–‹
            // é…ç½®æ›´æ–°ç¯€æµï¼ˆé¿å…é »ç¹æ›´æ–°é€ æˆå¡é “ï¼‰
            let configUpdateTimer = null;
            if (window.electronAPI && window.electronAPI.onConfigUpdate) {
                console.log('è¨­å®šé…ç½®æ›´æ–°ç›£è½');
                window.electronAPI.onConfigUpdate(async (config) => {
                    // ä½¿ç”¨ç¯€æµï¼Œ300ms å…§åªè™•ç†æœ€å¾Œä¸€æ¬¡
                    if (configUpdateTimer) clearTimeout(configUpdateTimer);
                    configUpdateTimer = setTimeout(async () => {
                        console.log('[é…ç½®æ›´æ–°] æ”¶åˆ°é…ç½®è®Šæ›´ï¼Œå³æ™‚åŒæ­¥...');
                        // é‡æ–°è¼‰å…¥é€²å ´åˆ—è¡¨
                        await loadEntryList();
                        // é‡æ–°è¼‰å…¥å½±ç‰‡åˆ—è¡¨
                        await loadVideoGifts();
                        // é‡æ–°è¼‰å…¥è½‰ç›¤é¸é …
                        await loadWheelOptions();
                        // é‡æ–°è¼‰å…¥ç›²ç›’é¸é …
                        await loadGiftboxOptions();
                        console.log('[é…ç½®æ›´æ–°] åŒæ­¥å®Œæˆ');
                    }, 300);
                });
            }

            window.addEventListener('triggerWheel', (event) => {
                const data = event.detail;
                console.log('æ”¶åˆ°è½‰ç›¤äº‹ä»¶:', data);
                triggerWheel(data.spins);
            });

            window.addEventListener('triggerVideo', (event) => {
                const data = event.detail;
                console.log('æ”¶åˆ°å½±ç‰‡äº‹ä»¶:', data);
                triggerVideo(data);
            });

            // é€²å ´æ•ˆæœäº‹ä»¶
            window.addEventListener('triggerEntry', (event) => {
                const data = event.detail;
                console.log('æ”¶åˆ°é€²å ´äº‹ä»¶:', data);
                triggerEntry(data);
            });

            // ç›²ç›’äº‹ä»¶
            window.addEventListener('triggerGiftbox', (event) => {
                const data = event.detail;
                console.log('æ”¶åˆ°ç›²ç›’äº‹ä»¶:', data);
                triggerGiftbox(data.opens);
            });

            // å…¨åŸŸæ¸¬è©¦å‡½æ•¸ - å¯å¾æ§åˆ¶å°å‘¼å«
            window.testTriggerVideo = function(index) {
                console.log('æ¸¬è©¦è§¸ç™¼å½±ç‰‡:', index);
                if (videoGifts[index]) {
                    triggerVideoInContainer(index, {
                        path: videoGifts[index].video_path,
                        speed: 1.0,
                        volume: 100,
                        seconds: 0,
                        repeat: 1
                    });
                }
            };

            console.log('äº‹ä»¶ç›£è½å™¨å·²è¨»å†Šï¼ŒvideoGifts:', videoGifts);

            // ç›£è½æ¨¡çµ„ç‹€æ…‹è®ŠåŒ–
            window.addEventListener('moduleStatusChanged', (event) => {
                const data = event.detail;
                console.log('æ¨¡çµ„ç‹€æ…‹è®ŠåŒ–:', data);

                if (data.module === 'wheel') {
                    wheelModuleEnabled = data.enabled;
                    updateWheelTestButton();

                    const wc = document.getElementById('wheelContainer');
                    if (data.enabled) {
                        wheelVisible = true;
                        wc.classList.remove('hidden');
                        wc.style.display = 'block';
                        document.getElementById('wheelCheck').textContent = 'âœ“';
                        document.getElementById('toggleWheel').classList.add('active');
                    } else {
                        wheelVisible = false;
                        wc.classList.add('hidden');
                        wc.style.display = 'none';
                        document.getElementById('wheelCheck').textContent = '';
                        document.getElementById('toggleWheel').classList.remove('active');
                    }
                }

                if (data.module === 'video') {
                    if (data.enabled) {
                        videoVisible = true;
                        document.querySelectorAll('.video-container').forEach(vc => {
                            const idx = vc.dataset.index;
                            // åªé¡¯ç¤ºæœªè¢«å–®ç¨éš±è—çš„å®¹å™¨
                            if (videoGifts[idx]?.visible !== false) {
                                vc.classList.remove('hidden');
                                vc.style.display = 'block';
                                vc.style.visibility = 'visible';
                                vc.style.opacity = '1';
                            }
                        });
                        document.getElementById('videoCheck').textContent = 'âœ“';
                        document.getElementById('toggleVideo').classList.add('active');
                    } else {
                        videoVisible = false;
                        document.querySelectorAll('.video-container').forEach(vc => {
                            vc.classList.add('hidden');
                            vc.style.display = 'none';
                            vc.style.visibility = 'hidden';
                            vc.style.opacity = '0';
                        });
                        document.getElementById('videoCheck').textContent = '';
                        document.getElementById('toggleVideo').classList.remove('active');
                    }
                }
            });

            // ç›£è¯é…ç½®æ›´æ–°
            window.addEventListener('configUpdated', async () => {
                console.log('[DEBUG] æ”¶åˆ° configUpdated äº‹ä»¶');

                // å¦‚æœæ˜¯åƒ…å¯è¦‹æ€§æ›´æ–°ï¼Œè·³éå®¹å™¨é‡æ–°ç”Ÿæˆ
                if (window._skipContainerRegeneration) {
                    console.log('[DEBUG] è·³éå®¹å™¨é‡æ–°ç”Ÿæˆï¼ˆåƒ…å¯è¦‹æ€§æ›´æ–°ï¼‰');
                    // åªæ›´æ–°å½±ç‰‡åˆ—è¡¨ UIï¼Œä¸é‡æ–°ç”Ÿæˆå®¹å™¨
                    await refreshVideoListOnly();
                    return;
                }

                // ä¿å­˜ç•¶å‰å®¹å™¨ä½ç½®åˆ° savedPositionsï¼Œé¿å…é‡æ–°ç”Ÿæˆæ™‚ä½ç½®è¢«é‡ç½®
                if (savedPositions) {
                    // å¾ DOM å’Œ videoCropState æ”¶é›†æœ€æ–°ç‹€æ…‹
                    const currentVideoData = {};
                    document.querySelectorAll('.video-container').forEach(vc => {
                        const idx = parseInt(vc.dataset.index);
                        const crop = videoCropState[idx] || {};
                        const cached = videoContainers[idx] || {};

                        currentVideoData[idx] = {
                            width: vc.offsetWidth || parseInt(vc.style.width) || cached.width || 300,
                            height: vc.offsetHeight || parseInt(vc.style.height) || cached.height || 200,
                            left: vc.offsetLeft || parseInt(vc.style.left) || cached.left || 0,
                            top: vc.offsetTop || parseInt(vc.style.top) || cached.top || 0,
                            visible: !vc.classList.contains('hidden'),
                            cropLeft: crop.cropLeft || 0,
                            cropTop: crop.cropTop || 0,
                            originalWidth: crop.originalWidth || cached.originalWidth || vc.offsetWidth || 300,
                            originalHeight: crop.originalHeight || cached.originalHeight || vc.offsetHeight || 200
                        };
                        console.log(`[DEBUG] å®¹å™¨ ${idx} ç‹€æ…‹:`, currentVideoData[idx]);
                    });

                    // æ›´æ–° videoContainers å’Œ savedPositions
                    Object.assign(videoContainers, currentVideoData);
                    savedPositions.videoContainers = currentVideoData;
                    console.log('[DEBUG] å·²ä¿å­˜ç•¶å‰å®¹å™¨ä½ç½®å’Œè£åˆ‡ç‹€æ…‹åˆ° savedPositions');
                }

                console.log('[DEBUG] é‡æ–°è¼‰å…¥å½±ç‰‡è¨­å®š');
                await loadVideoGifts();
                // å»¶é²å¾Œé‡æ–°è¼‰å…¥ç¸®åœ–ï¼Œç¢ºä¿ DOM å·²æ›´æ–°
                setTimeout(() => {
                    console.log('[DEBUG] å»¶é²é‡è¼‰ç¸®åœ–');
                    reloadAllThumbnails();
                }, 300);
            });

            window.addEventListener('message', (event) => {
                const data = event.data;
                if (!data || !data.type) return;

                if (data.type === 'wheel') {
                    triggerWheel(data.spins);
                } else if (data.type === 'video') {
                    triggerVideo(data);
                }
            });
        }

        async function loadWheelOptions() {
            try {
                if (window.pywebview && window.pywebview.api) {
                    wheelOptions = await pywebview.api.get_wheel_options();
                } else {
                    wheelOptions = [
                        { name: 'é¸é …A', color: '#e94560', weight: 1 },
                        { name: 'é¸é …B', color: '#4ecca3', weight: 1 },
                        { name: 'é¸é …C', color: '#00d9ff', weight: 1 },
                        { name: 'é¸é …D', color: '#ffd93d', weight: 1 }
                    ];
                }
            } catch (e) {
                wheelOptions = [
                    { name: 'é¸é …A', color: '#e94560', weight: 1 },
                    { name: 'é¸é …B', color: '#4ecca3', weight: 1 },
                    { name: 'é¸é …C', color: '#00d9ff', weight: 1 },
                    { name: 'é¸é …D', color: '#ffd93d', weight: 1 }
                ];
            }
        }

        // === é¡¯ç¤ºæ§åˆ¶ ===
        function toggleWheelVisibility() {
            wheelVisible = !wheelVisible;
            setElementVisible(document.getElementById('wheelContainer'), wheelVisible);
            document.getElementById('wheelCheck').textContent = wheelVisible ? 'âœ“' : '';
            document.getElementById('toggleWheel').classList.toggle('active', wheelVisible);
            savePositions();
        }

        function toggleGiftboxVisibility() {
            giftboxVisible = !giftboxVisible;
            setElementVisible(document.getElementById('giftboxContainer'), giftboxVisible);
            document.getElementById('giftboxCheck').textContent = giftboxVisible ? 'âœ“' : '';
            document.getElementById('toggleGiftbox').classList.toggle('active', giftboxVisible);
            savePositions();
        }

        function toggleGiftboxAutoHide() {
            giftboxAutoHide = !giftboxAutoHide;
            const container = document.getElementById('giftboxContainer');
            container.classList.toggle('auto-hidden', giftboxAutoHide);
            document.getElementById('giftboxAutoHideCheck').textContent = giftboxAutoHide ? 'âœ“' : '';
            document.getElementById('toggleGiftboxAutoHide').classList.toggle('active', giftboxAutoHide);
            savePositions();
        }

        function toggleVideoVisibility() {
            videoVisible = !videoVisible;
            document.querySelectorAll('.video-container').forEach(vc => {
                const idx = parseInt(vc.dataset.index);
                // åªé¡¯ç¤ºæœªè¢«å–®ç¨éš±è—çš„å®¹å™¨
                const shouldShow = videoVisible && (videoGifts[idx]?.visible !== false);
                setElementVisible(vc, shouldShow);
            });
            document.getElementById('videoCheck').textContent = videoVisible ? 'âœ“' : '';
            document.getElementById('toggleVideo').classList.toggle('active', videoVisible);
            savePositions();
        }

        // é€²å ´å½±ç‰‡å®¹å™¨ç›¸é—œ
        let entryVideoVisible = false;
        let entryList = [];

        function toggleEntryVideoVisibility() {
            entryVideoVisible = !entryVideoVisible;
            const container = document.getElementById('entryVideoContainer');
            if (container) {
                setElementVisible(container, entryVideoVisible);
            }
            document.getElementById('toggleEntryVideo').classList.toggle('active', entryVideoVisible);

            // æ›´æ–°æ‰€æœ‰é€²å ´åˆ—è¡¨ä¸­çš„é¡¯ç¤º/éš±è—æŒ‰éˆ•ç‹€æ…‹
            updateEntryVisibilityButtons();

            savePositions();
        }

        // æ›´æ–°æ‰€æœ‰é€²å ´æ•ˆæœçš„é¡¯ç¤º/éš±è—æŒ‰éˆ•ç‹€æ…‹
        function updateEntryVisibilityButtons() {
            // æ›´æ–°å°ˆå±¬é€²å ´çš„æŒ‰éˆ•
            entryList.forEach((entry, index) => {
                const btn = document.getElementById(`entryVisBtn_${index}`);
                if (btn) {
                    btn.className = `debug-btn small ${entryVideoVisible ? 'secondary' : 'danger'}`;
                    btn.innerHTML = entryVideoVisible ? 'ğŸ‘ï¸' : 'ğŸš«';
                }
            });

            // æ›´æ–°å…¨å±€é€²å ´çš„æŒ‰éˆ•
            const globalBtn = document.getElementById('entryVisBtn_global');
            if (globalBtn) {
                globalBtn.className = `debug-btn small ${entryVideoVisible ? 'secondary' : 'danger'}`;
                globalBtn.innerHTML = entryVideoVisible ? 'ğŸ‘ï¸' : 'ğŸš«';
            }
        }

        async function loadEntryList() {
            try {
                const config = await pywebview.api.get_config();
                entryList = config.entry_list || [];
                const entryConfig = config.entry_config || {};

                const container = document.getElementById('entryList');
                if (!container) return;

                if (entryList.length === 0 && !entryConfig.media_path) {
                    container.innerHTML = '<div class="empty-list">å°šæœªè¨­å®šé€²å ´æ•ˆæœ</div>';
                    return;
                }

                let html = '';

                // é¡¯ç¤ºå°ˆå±¬é€²å ´åˆ—è¡¨
                entryList.forEach((entry, index) => {
                    if (!entry.media_path) return;
                    const isVideo = /\.(mp4|avi|mov|mkv|webm)$/i.test(entry.media_path);
                    const enabled = entry.enabled !== false;
                    html += `
                        <div class="video-item ${enabled ? '' : 'disabled'}">
                            <div class="video-thumbnail">
                                ${isVideo
                                    ? `<video src="${formatVideoPath(entry.media_path)}" muted preload="metadata"></video>`
                                    : `<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#333;color:#fff;">ğŸµ</div>`
                                }
                            </div>
                            <div class="video-info">
                                <div class="video-name">ğŸ‘¤ ${entry.username || 'æœªå‘½å'}</div>
                                <div class="video-path">${entry.media_path.split('\\').pop()}</div>
                            </div>
                            <button class="debug-btn small" onclick="testEntryByIndex(${index})">â–¶ï¸</button>
                            <button class="debug-btn small ${entryVideoVisible ? 'secondary' : 'danger'}" onclick="toggleEntryVideoVisibility()" id="entryVisBtn_${index}">
                                ${entryVideoVisible ? 'ğŸ‘ï¸' : 'ğŸš«'}
                            </button>
                        </div>
                    `;
                });

                // é¡¯ç¤ºå…¨å±€é€²å ´ï¼ˆå¦‚æœæœ‰è¨­å®šï¼‰
                if (entryConfig.media_path) {
                    const isVideo = /\.(mp4|avi|mov|mkv|webm)$/i.test(entryConfig.media_path);
                    const enabled = entryConfig.enabled !== false;
                    html += `
                        <div class="video-item ${enabled ? '' : 'disabled'}">
                            <div class="video-thumbnail">
                                ${isVideo
                                    ? `<video src="${formatVideoPath(entryConfig.media_path)}" muted preload="metadata"></video>`
                                    : `<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#333;color:#fff;">ğŸµ</div>`
                                }
                            </div>
                            <div class="video-info">
                                <div class="video-name">ğŸŒ å…¨å±€é€²å ´</div>
                                <div class="video-path">${entryConfig.media_path.split('\\').pop()}</div>
                            </div>
                            <button class="debug-btn small" onclick="testGlobalEntry()">â–¶ï¸</button>
                            <button class="debug-btn small ${entryVideoVisible ? 'secondary' : 'danger'}" onclick="toggleEntryVideoVisibility()" id="entryVisBtn_global">
                                ${entryVideoVisible ? 'ğŸ‘ï¸' : 'ğŸš«'}
                            </button>
                        </div>
                    `;
                }

                container.innerHTML = html || '<div class="empty-list">å°šæœªè¨­å®šé€²å ´æ•ˆæœ</div>';

                // æ›´æ–°é€²å ´ç¸®åœ–
                updateEntryThumbnail();
            } catch (e) {
                console.error('[é€²å ´åˆ—è¡¨] è¼‰å…¥å¤±æ•—:', e);
            }
        }

        function updateEntryThumbnail() {
            const thumbnail = document.getElementById('entryThumbnail');
            if (!thumbnail) return;

            // ä½¿ç”¨ç¬¬ä¸€å€‹å°ˆå±¬é€²å ´æˆ–å…¨å±€é€²å ´çš„å½±ç‰‡ä½œç‚ºç¸®åœ–
            let videoPath = '';
            for (const entry of entryList) {
                if (entry.media_path && /\.(mp4|avi|mov|mkv|webm)$/i.test(entry.media_path)) {
                    videoPath = entry.media_path;
                    break;
                }
            }

            if (videoPath) {
                thumbnail.src = formatVideoPath(videoPath);
            }
        }

        async function testEntryByIndex(index) {
            if (!entryList[index]) return;
            const entry = entryList[index];
            const isAudio = /\.(mp3|wav|ogg|m4a|aac)$/i.test(entry.media_path);

            triggerEntry({
                username: entry.username || 'æ¸¬è©¦ç”¨æˆ¶',
                level: 30,
                path: entry.media_path,
                volume: entry.volume || 100,
                force_interrupt: entry.force_interrupt !== false,
                is_audio: isAudio,
                show_text: entry.show_text || false,
                text: entry.text || '',
                text_size: entry.text_size || 48,
                text_color: entry.text_color || '#ffffff',
                text_duration: entry.text_duration || 5,
                is_specific: true
            });
        }

        async function testGlobalEntry() {
            const config = await pywebview.api.get_config();
            const entry = config.entry_config || {};
            if (!entry.media_path) return;

            const isAudio = /\.(mp3|wav|ogg|m4a|aac)$/i.test(entry.media_path);
            triggerEntry({
                username: 'æ¸¬è©¦ç”¨æˆ¶',
                level: 0,
                path: entry.media_path,
                volume: entry.volume || 100,
                force_interrupt: entry.force_interrupt !== false,
                is_audio: isAudio,
                show_text: false,
                is_specific: false
            });
        }

        // ä¿å­˜ä½ç½®å’Œç‹€æ…‹ï¼ˆä½¿ç”¨ API ä¿å­˜åˆ°é…ç½®æ–‡ä»¶ï¼Œç¢ºä¿æŒä¹…åŒ–ï¼‰
        // ä¿å­˜æ‰€æœ‰ä½ç½®å’Œç‹€æ…‹
        // ç¯€æµç‰ˆæœ¬çš„ savePositionsï¼ˆé¿å…é »ç¹èª¿ç”¨é€ æˆå¡é “ï¼‰
        let savePositionsTimer = null;
        function savePositionsDebounced() {
            if (savePositionsTimer) clearTimeout(savePositionsTimer);
            savePositionsTimer = setTimeout(() => {
                savePositions();
            }, 300);
        }

        async function savePositions() {
            const wheel = document.getElementById('wheelContainer');
            const giftbox = document.getElementById('giftboxContainer');
            const entryText = document.getElementById('entryTextContainer');
            const entryVideo = document.getElementById('entryVideoContainer');

            // æ”¶é›†å½±ç‰‡å®¹å™¨è³‡æ–™
            const videoData = {};
            document.querySelectorAll('.video-container').forEach(vc => {
                const idx = parseInt(vc.dataset.index);
                const cached = videoContainers[idx] || {};
                const crop = videoCropState[idx] || {};

                // å–å¾—å°ºå¯¸ï¼ˆéš±è—æ™‚å¯èƒ½æ˜¯0ï¼Œç”¨ style æˆ–å¿«å–å€¼ï¼‰
                let w = vc.offsetWidth || parseInt(vc.style.width) || cached.width || 300;
                let h = vc.offsetHeight || parseInt(vc.style.height) || cached.height || 200;

                videoData[idx] = {
                    width: Math.max(50, w),
                    height: Math.max(50, h),
                    left: vc.offsetLeft || parseInt(vc.style.left) || cached.left || 0,
                    top: vc.offsetTop || parseInt(vc.style.top) || cached.top || 0,
                    visible: !vc.classList.contains('hidden'),
                    cropLeft: crop.cropLeft || 0,
                    cropTop: crop.cropTop || 0,
                    originalWidth: crop.originalWidth || w,
                    originalHeight: crop.originalHeight || h
                };
            });

            // çµ„åˆå®Œæ•´è³‡æ–™
            const positions = {
                wheel: {
                    width: Math.max(50, wheel.offsetWidth || 350),
                    height: Math.max(50, wheel.offsetHeight || 350),
                    left: wheel.offsetLeft || 0,
                    top: wheel.offsetTop || 150,
                    visible: wheelVisible
                },
                giftbox: {
                    width: Math.max(50, giftbox.offsetWidth || 200),
                    height: Math.max(50, giftbox.offsetHeight || 200),
                    left: giftbox.offsetLeft || parseInt(giftbox.style.left) || 0,
                    top: giftbox.offsetTop || parseInt(giftbox.style.top) || 150,
                    visible: giftboxVisible,
                    autoHide: giftboxAutoHide
                },
                entryText: {
                    left: entryText ? (entryText.offsetLeft || parseInt(entryText.style.left) || 0) : 0,
                    top: entryText ? (entryText.offsetTop || parseInt(entryText.style.top) || 50) : 50
                },
                entryVideo: {
                    width: entryVideo ? Math.max(50, entryVideo.offsetWidth || parseInt(entryVideo.style.width) || 400) : 400,
                    height: entryVideo ? Math.max(50, entryVideo.offsetHeight || parseInt(entryVideo.style.height) || 300) : 300,
                    left: entryVideo ? (entryVideo.offsetLeft || parseInt(entryVideo.style.left) || 100) : 100,
                    top: entryVideo ? (entryVideo.offsetTop || parseInt(entryVideo.style.top) || 100) : 100,
                    visible: entryVideoVisible
                },
                videoContainers: videoData,
                videoModuleVisible: videoVisible
            };

            // ä¿å­˜åˆ°é…ç½®æ–‡ä»¶
            try {
                if (window.pywebview && window.pywebview.api) {
                    await pywebview.api.save_greenscreen_positions(positions);
                    // åŒæ­¥æ›´æ–° savedPositionsï¼Œç¢ºä¿ä¸‹æ¬¡é‡æ–°ç”Ÿæˆå®¹å™¨æ™‚ä½ç½®æ­£ç¢º
                    savedPositions = positions;
                    console.log('[ä¿å­˜] ç¶ å¹•ä½ç½®å·²ä¿å­˜');
                }
            } catch (e) {
                console.error('[ä¿å­˜] å¤±æ•—:', e);
            }
        }

        // (å·²ç§»é™¤ - ä½ç½®ç¾åœ¨åœ¨ applyWheelPosition å’Œ generateVideoContainers ä¸­ç›´æ¥å¥—ç”¨)

        // === æ¸¬è©¦åŠŸèƒ½ ===
        function updateWheelTestButton() {
            const btn = document.getElementById('testWheelBtn');
            if (btn) {
                btn.disabled = !wheelModuleEnabled;
                btn.textContent = wheelModuleEnabled ? 'ğŸ¡ æ¸¬è©¦è½‰ç›¤' : 'ğŸ¡ æ¨¡çµ„å·²é—œé–‰';
            }
        }

        function updateGiftboxTestButton() {
            const btn = document.getElementById('testGiftboxBtn');
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'ğŸ æ¸¬è©¦ç›²ç›’';
            }
        }

        function testGiftboxOpen() {
            console.log('[ç›²ç›’æ¸¬è©¦] è§¸ç™¼');
            triggerGiftbox(1);
        }

        function testEntryText() {
            console.log('[é€²å ´æ–‡å­—æ¸¬è©¦] è§¸ç™¼');
            showEntryText({
                username: 'æ¸¬è©¦ç”¨æˆ¶',
                text: 'æ­¡è¿ {name} é€²å…¥ç›´æ’­é–“ï¼',
                text_size: 48,
                text_color: '#ffffff',
                text_duration: 5
            });
        }

        async function testEntryVideo() {
            console.log('[é€²å ´å½±ç‰‡æ¸¬è©¦] è§¸ç™¼');
            try {
                // å¾é…ç½®ç²å–é€²å ´åˆ—è¡¨
                const config = await pywebview.api.get_config();
                const entryList = config.entry_list || [];
                const entryConfig = config.entry_config || {};

                // å„ªå…ˆä½¿ç”¨å°ˆå±¬é€²å ´åˆ—è¡¨ä¸­çš„ç¬¬ä¸€å€‹
                let testEntry = null;
                if (entryList.length > 0 && entryList[0].media_path) {
                    testEntry = entryList[0];
                } else if (entryConfig.media_path) {
                    testEntry = entryConfig;
                }

                if (!testEntry || !testEntry.media_path) {
                    alert('æ²’æœ‰è¨­å®šé€²å ´æ•ˆæœï¼è«‹å…ˆåœ¨ä¸»ä»‹é¢è¨­å®šé€²å ´åª’é«”ã€‚');
                    return;
                }

                const isAudio = /\.(mp3|wav|ogg|m4a|aac)$/i.test(testEntry.media_path);

                triggerEntry({
                    username: 'æ¸¬è©¦ç”¨æˆ¶',
                    level: 30,
                    path: testEntry.media_path,
                    volume: testEntry.volume || 100,
                    force_interrupt: testEntry.force_interrupt !== false,
                    is_audio: isAudio,
                    show_text: testEntry.show_text || false,
                    text: testEntry.text || '',
                    text_size: testEntry.text_size || 48,
                    text_color: testEntry.text_color || '#ffffff',
                    text_duration: testEntry.text_duration || 5,
                    is_specific: true
                });
            } catch (e) {
                console.error('[é€²å ´å½±ç‰‡æ¸¬è©¦] éŒ¯èª¤:', e);
                alert('æ¸¬è©¦å¤±æ•—: ' + e.message);
            }
        }

        // === ç›²ç›’åŠŸèƒ½ ===
        function triggerGiftbox(opens) {
            console.log('[ç›²ç›’] è§¸ç™¼ï¼Œé¸é …æ•¸é‡:', giftboxOptions.length, 'æ­£åœ¨é–‹ç›’:', isGiftboxOpening);

            if (isGiftboxOpening) {
                console.log('[ç›²ç›’] æ­£åœ¨é–‹ç›’ä¸­ï¼Œå¿½ç•¥');
                return;
            }

            // å¦‚æœæ²’æœ‰é¸é …ï¼Œä½¿ç”¨é è¨­é¸é …é€²è¡Œæ¸¬è©¦
            if (giftboxOptions.length === 0) {
                console.log('[ç›²ç›’] æ²’æœ‰é¸é …ï¼Œä½¿ç”¨é è¨­');
                giftboxOptions = [
                    { name: 'å¤§ç', color: '#ffd93d', weight: 1 },
                    { name: 'ä¸­ç', color: '#4ecca3', weight: 2 },
                    { name: 'å°ç', color: '#00d9ff', weight: 3 }
                ];
            }

            isGiftboxOpening = true;
            const container = document.getElementById('giftboxContainer');
            const box = document.getElementById('giftboxBox');
            const resultEl = document.getElementById('giftboxResult');
            const confettiEl = document.getElementById('giftboxConfetti');
            const countdownEl = document.getElementById('giftboxCountdown');
            const videoContainer = document.getElementById('giftboxVideoContainer');
            const videoEl = document.getElementById('giftboxVideo');

            // é¡¯ç¤ºç›²ç›’å®¹å™¨ï¼ˆå¦‚æœæ˜¯éš±è—çš„ï¼‰
            if (!giftboxVisible) {
                setElementVisible(container, true);
            }

            // å¦‚æœæ˜¯è‡ªå‹•éš±è—æ¨¡å¼ï¼Œå…ˆé¡¯ç¤ºç›²ç›’
            if (giftboxAutoHide) {
                // æ¸…é™¤å¼·åˆ¶éš±è—çš„ inline style
                container.style.opacity = '';
                container.style.visibility = '';
                container.style.pointerEvents = '';
                container.classList.add('triggered');
            }

            // éš¨æ©Ÿé¸æ“‡çµæœï¼ˆæ ¹æ“šæ¬Šé‡ï¼‰
            const totalWeight = giftboxOptions.reduce((sum, opt) => sum + (opt.weight || 1), 0);
            let random = Math.random() * totalWeight;
            let selectedOption = giftboxOptions[0];
            for (const opt of giftboxOptions) {
                random -= (opt.weight || 1);
                if (random <= 0) {
                    selectedOption = opt;
                    break;
                }
            }

            // é–‹ç›’å‹•ç•«
            box.classList.add('opening');

            // å‰µå»ºå½©å¸¶æ•ˆæœï¼ˆå…ˆæº–å‚™å¥½ï¼Œä½†ä¸å•Ÿå‹•ï¼‰
            confettiEl.innerHTML = '';
            const colors = ['#e94560', '#4ecca3', '#ffd93d', '#00d9ff', '#ff6b9d'];
            for (let i = 0; i < 20; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                piece.style.left = Math.random() * 100 + '%';
                piece.style.animationDelay = Math.random() * 0.5 + 's';
                piece.style.animationDuration = (1 + Math.random()) + 's';
                confettiEl.appendChild(piece);
            }

            // 0.3ç§’å¾Œé–‹å§‹æ»¾å‹•å‹•ç•«
            setTimeout(() => {
                box.classList.add('rolling');

                // æ»¾å‹•åƒæ•¸
                let currentIndex = 0;
                let interval = 50;  // åˆå§‹é€Ÿåº¦ï¼ˆæ¯«ç§’ï¼‰
                const maxInterval = 400;  // æœ€æ…¢é€Ÿåº¦
                const acceleration = 1.15;  // æ¸›é€Ÿä¿‚æ•¸
                const minSpins = 15;  // æœ€å°‘æ»¾å‹•æ¬¡æ•¸
                let spinCount = 0;

                // æ‰¾åˆ°é¸ä¸­é¸é …çš„ç´¢å¼•
                const selectedIndex = giftboxOptions.indexOf(selectedOption);

                const spin = () => {
                    // é¡¯ç¤ºç•¶å‰é¸é …ï¼ˆé‡ç½®å‹•ç•«ï¼‰
                    const currentOption = giftboxOptions[currentIndex];
                    resultEl.style.animation = 'none';
                    void resultEl.offsetWidth;  // å¼·åˆ¶é‡ç¹ª
                    resultEl.style.animation = '';
                    resultEl.textContent = currentOption.name;
                    resultEl.style.backgroundColor = currentOption.color || '#4ecca3';

                    // ç§»å‹•åˆ°ä¸‹ä¸€å€‹é¸é …
                    currentIndex = (currentIndex + 1) % giftboxOptions.length;
                    spinCount++;

                    // æ¸›é€Ÿ
                    interval = Math.min(interval * acceleration, maxInterval);

                    // åˆ¤æ–·æ˜¯å¦åœæ­¢ï¼šå·²ç¶“è½‰å¤ äº†ï¼Œé€Ÿåº¦å¤ æ…¢ï¼Œä¸”åœåœ¨é¸ä¸­çš„é¸é …ä¸Š
                    if (spinCount >= minSpins && interval >= maxInterval &&
                        currentIndex === (selectedIndex + 1) % giftboxOptions.length) {
                        // åœæ­¢æ»¾å‹•ï¼Œé¡¯ç¤ºæœ€çµ‚çµæœ
                        resultEl.textContent = selectedOption.name;
                        resultEl.style.backgroundColor = selectedOption.color || '#4ecca3';

                        // åˆ‡æ›åˆ°é¡¯ç¤ºçµæœç‹€æ…‹
                        box.classList.remove('rolling');
                        box.classList.add('showing-result');

                        // å•Ÿå‹•å½©å¸¶å‹•ç•«
                        confettiEl.querySelectorAll('.confetti-piece').forEach(piece => {
                            piece.style.animation = `confetti-fall ${1 + Math.random()}s ease-out forwards`;
                        });

                        console.log('ç›²ç›’çµæœ:', selectedOption.name);

                        // æ»¾å‹•å®Œæˆå¾Œï¼Œå¦‚æœæœ‰å½±ç‰‡è¨­å®šï¼Œå•Ÿå‹•å€’æ•¸è¨ˆæ™‚
                        if (selectedOption.video_path) {
                            // å»¶é²0.5ç§’è®“çµæœå½ˆè·³å‹•ç•«å®Œæˆï¼Œå†é–‹å§‹å€’æ•¸
                            setTimeout(() => {
                                startGiftboxCountdown(selectedOption);
                            }, 500);
                        } else {
                            // æ²’æœ‰å½±ç‰‡ï¼Œ3ç§’å¾Œé‡ç½®
                            setTimeout(() => {
                                resetGiftbox();
                            }, 3000);
                        }
                    } else {
                        // ç¹¼çºŒæ»¾å‹•
                        setTimeout(spin, interval);
                    }
                };

                // é–‹å§‹æ»¾å‹•
                spin();
            }, 300);
        }

        // ç›²ç›’å€’æ•¸è¨ˆæ™‚
        function startGiftboxCountdown(option) {
            const countdownEl = document.getElementById('giftboxCountdown');
            let count = 3;

            const doCountdown = () => {
                countdownEl.textContent = count;
                countdownEl.classList.remove('active');
                // å¼·åˆ¶é‡ç¹ªä»¥é‡æ–°è§¸ç™¼å‹•ç•«
                void countdownEl.offsetWidth;
                countdownEl.classList.add('active');

                if (count > 1) {
                    count--;
                    setTimeout(doCountdown, 1000);
                } else {
                    // å€’æ•¸å®Œæˆï¼Œæ’­æ”¾å½±ç‰‡
                    setTimeout(() => {
                        countdownEl.classList.remove('active');
                        playGiftboxVideo(option);
                    }, 1000);
                }
            };

            doCountdown();
        }

        // æ’­æ”¾ç›²ç›’å½±ç‰‡
        function playGiftboxVideo(option) {
            const box = document.getElementById('giftboxBox');
            const videoContainer = document.getElementById('giftboxVideoContainer');
            const videoEl = document.getElementById('giftboxVideo');

            // éš±è—ç›’å­ï¼Œé¡¯ç¤ºå½±ç‰‡
            box.style.display = 'none';
            videoContainer.classList.add('active');

            // è¨­å®šå½±ç‰‡
            const videoSrc = formatVideoPath(option.video_path);
            videoEl.src = videoSrc;
            videoEl.volume = (option.video_volume || 100) / 100;
            videoEl.muted = false;

            // è¨­å®šæ’­æ”¾æ™‚é•·é™åˆ¶
            const videoSeconds = option.video_seconds || 0;
            let playTimeout = null;

            videoEl.onloadeddata = () => {
                videoEl.play().then(() => {
                    console.log('ç›²ç›’å½±ç‰‡é–‹å§‹æ’­æ”¾');

                    if (videoSeconds > 0) {
                        playTimeout = setTimeout(() => {
                            videoEl.pause();
                            endGiftboxVideo();
                        }, videoSeconds * 1000);
                    }
                }).catch(e => {
                    console.error('ç›²ç›’å½±ç‰‡æ’­æ”¾å¤±æ•—:', e);
                    endGiftboxVideo();
                });
            };

            videoEl.onended = () => {
                if (playTimeout) clearTimeout(playTimeout);
                endGiftboxVideo();
            };

            videoEl.onerror = () => {
                console.error('ç›²ç›’å½±ç‰‡è¼‰å…¥éŒ¯èª¤');
                endGiftboxVideo();
            };

            videoEl.load();
        }

        // çµæŸç›²ç›’å½±ç‰‡æ’­æ”¾
        function endGiftboxVideo() {
            console.log('[ç›²ç›’] å½±ç‰‡çµæŸï¼Œé–‹å§‹é‡ç½®');
            const videoContainer = document.getElementById('giftboxVideoContainer');
            const videoEl = document.getElementById('giftboxVideo');
            const box = document.getElementById('giftboxBox');

            videoEl.pause();
            videoEl.removeAttribute('src');
            videoEl.load();
            videoContainer.classList.remove('active');
            box.style.display = '';

            resetGiftbox();
        }

        // é‡ç½®ç›²ç›’ç‹€æ…‹
        function resetGiftbox() {
            const container = document.getElementById('giftboxContainer');
            const box = document.getElementById('giftboxBox');
            const confettiEl = document.getElementById('giftboxConfetti');
            const resultEl = document.getElementById('giftboxResult');
            const countdownEl = document.getElementById('giftboxCountdown');
            const videoContainer = document.getElementById('giftboxVideoContainer');
            const videoEl = document.getElementById('giftboxVideo');

            box.classList.remove('opening', 'rolling', 'showing-result');
            box.style.display = '';
            confettiEl.innerHTML = '';

            // é‡ç½®å½±ç‰‡å®¹å™¨
            videoContainer.classList.remove('active');
            videoEl.pause();
            videoEl.removeAttribute('src');

            // é‡ç½®çµæœå’Œå€’æ•¸é¡¯ç¤º
            resultEl.textContent = '';
            resultEl.style.animation = '';
            resultEl.style.backgroundColor = '';
            countdownEl.classList.remove('active');
            countdownEl.textContent = '3';

            // å¦‚æœæ˜¯è‡ªå‹•éš±è—æ¨¡å¼ï¼Œéš±è—ç›²ç›’
            if (giftboxAutoHide) {
                console.log('[ç›²ç›’] è‡ªå‹•éš±è— - å¼·åˆ¶éš±è—');
                container.classList.remove('triggered');
                // å¼·åˆ¶éš±è—
                container.style.opacity = '0';
                container.style.visibility = 'hidden';
                container.style.pointerEvents = 'none';
            }

            isGiftboxOpening = false;
            console.log('[ç›²ç›’] å·²é‡ç½®');
        }

        // é‡æ–°è¼‰å…¥æ‰€æœ‰ç¸®åœ–
        function reloadAllThumbnails() {
            console.log('[DEBUG] é‡æ–°è¼‰å…¥æ‰€æœ‰ç¸®åœ–');

            document.querySelectorAll('.video-container').forEach((container, i) => {
                const thumbnail = container.querySelector('.thumbnail-video');
                if (!thumbnail) return;

                const idx = container.dataset.index;
                const src = thumbnail.src || thumbnail.getAttribute('src');

                console.log(`[DEBUG] é‡æ–°è¼‰å…¥ç¸®åœ– [${idx}], src=${src ? src.substring(0, 80) : 'empty'}`);

                if (!src || src === 'undefined' || src === '') {
                    console.warn(`[WARN] ç¸®åœ– [${idx}] æ²’æœ‰æœ‰æ•ˆçš„ src`);
                    container.style.background = 'rgba(255, 165, 0, 0.3)';  // æ©™è‰²è¡¨ç¤ºç„¡ src
                    return;
                }

                // é‡ç½®å®¹å™¨èƒŒæ™¯ï¼ˆå¦‚æœä¹‹å‰é¡¯ç¤ºéŒ¯èª¤ï¼‰
                container.style.background = 'rgba(0, 0, 0, 0.3)';
                thumbnail.style.display = 'block';
                thumbnail.style.visibility = 'visible';
                thumbnail.style.opacity = '1';

                // æ¸…é™¤èˆŠäº‹ä»¶
                thumbnail.onloadedmetadata = null;
                thumbnail.onloadeddata = null;
                thumbnail.onerror = null;
                thumbnail.oncanplay = null;

                // å¼·åˆ¶é‡æ–°è¼‰å…¥
                thumbnail.removeAttribute('src');

                // è¨­å®šäº‹ä»¶è™•ç†
                thumbnail.onloadedmetadata = () => {
                    console.log(`[DEBUG] ç¸®åœ–é‡è¼‰ metadata æˆåŠŸ [${idx}], readyState=${thumbnail.readyState}`);
                    try {
                        thumbnail.currentTime = 1;
                    } catch (e) {
                        console.warn(`[WARN] è¨­å®šç¸®åœ–æ™‚é–“å¤±æ•— [${idx}]:`, e);
                    }
                };

                thumbnail.onloadeddata = () => {
                    console.log(`[DEBUG] ç¸®åœ–é‡è¼‰ data æˆåŠŸ [${idx}], readyState=${thumbnail.readyState}, currentTime=${thumbnail.currentTime}`);
                    if (thumbnail.currentTime === 0) {
                        try {
                            thumbnail.currentTime = 1;
                        } catch (e) {
                            console.warn(`[WARN] è¨­å®šç¸®åœ–æ™‚é–“å¤±æ•— (loadeddata) [${idx}]:`, e);
                        }
                    }
                };

                thumbnail.oncanplay = () => {
                    console.log(`[DEBUG] ç¸®åœ–å¯æ’­æ”¾ [${idx}], currentTime=${thumbnail.currentTime}`);
                };

                thumbnail.onerror = (e) => {
                    console.error(`[ERROR] ç¸®åœ–é‡è¼‰å¤±æ•— [${idx}]:`, e, thumbnail.error);
                    thumbnail.style.display = 'none';
                    container.style.background = 'rgba(255, 0, 0, 0.3)';
                };

                // é‡æ–°è¨­å®š src ä¸¦è¼‰å…¥
                setTimeout(() => {
                    console.log(`[DEBUG] è¨­å®šç¸®åœ– src [${idx}]`);
                    thumbnail.src = src;
                    thumbnail.load();
                }, 50 * i);  // éŒ¯é–‹è¼‰å…¥æ™‚é–“
            });

            console.log('[DEBUG] ç¸®åœ–é‡è¼‰å·²è§¸ç™¼');
        }

        // é‡ç½®æ‰€æœ‰è£åˆ‡ç‹€æ…‹
        async function resetAllCropStates() {
            console.log('[DEBUG] é‡ç½®æ‰€æœ‰è£åˆ‡ç‹€æ…‹');

            // é‡ç½®æ¯å€‹å®¹å™¨
            document.querySelectorAll('.video-container').forEach(vc => {
                const idx = vc.dataset.index;
                const width = 300;
                const height = 200;

                // é‡ç½®è£åˆ‡ç‹€æ…‹
                videoCropState[idx] = {
                    cropLeft: 0,
                    cropTop: 0,
                    originalWidth: width,
                    originalHeight: height
                };

                // æ›´æ–°å®¹å™¨å°ºå¯¸
                vc.style.width = width + 'px';
                vc.style.height = height + 'px';

                // é‡ç½®ç¸®åœ–å’Œæ’­æ”¾å™¨
                const thumbnail = vc.querySelector('.thumbnail-video');
                const player = vc.querySelector('.video-player');

                if (thumbnail) {
                    thumbnail.style.width = width + 'px';
                    thumbnail.style.height = height + 'px';
                    thumbnail.style.left = '0px';
                    thumbnail.style.top = '0px';
                }
                if (player) {
                    player.style.width = width + 'px';
                    player.style.height = height + 'px';
                    player.style.left = '0px';
                    player.style.top = '0px';
                }

                // æ›´æ–°å®¹å™¨è³‡æ–™
                if (videoContainers[idx]) {
                    videoContainers[idx].width = width;
                    videoContainers[idx].height = height;
                    videoContainers[idx].cropLeft = 0;
                    videoContainers[idx].cropTop = 0;
                    videoContainers[idx].originalWidth = width;
                    videoContainers[idx].originalHeight = height;
                }
            });

            // ä¿å­˜åˆ°é…ç½®æ–‡ä»¶
            await savePositions();
            console.log('[DEBUG] è£åˆ‡ç‹€æ…‹å·²é‡ç½®ä¸¦ä¿å­˜');
            alert('è£åˆ‡ç‹€æ…‹å·²é‡ç½®ï¼');
        }

        function testWheelSpin() {
            if (!wheelModuleEnabled) return;
            triggerWheel(1);
        }

        // === è½‰ç›¤ç¹ªè£½ ===
        function drawWheel() {
            const canvas = document.getElementById('wheelCanvas');
            const ctx = canvas.getContext('2d');
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const radius = Math.max(10, Math.min(cx, cy) - 15);

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (wheelOptions.length === 0 || radius < 10) return;

            const totalWeight = wheelOptions.reduce((sum, opt) => sum + opt.weight, 0);
            let startAngle = (wheelAngle * Math.PI / 180);

            wheelOptions.forEach(opt => {
                const sweep = (2 * Math.PI * opt.weight / totalWeight);

                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.arc(cx, cy, radius, startAngle, startAngle + sweep);
                ctx.closePath();
                ctx.fillStyle = opt.color;
                ctx.fill();

                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.lineWidth = 2;
                ctx.stroke();

                const textAngle = startAngle + sweep / 2;
                const textRadius = radius * 0.65;
                const textX = cx + textRadius * Math.cos(textAngle);
                const textY = cy + textRadius * Math.sin(textAngle);

                ctx.save();
                ctx.translate(textX, textY);
                ctx.rotate(textAngle + Math.PI / 2);
                ctx.fillStyle = '#000';
                ctx.font = `bold ${Math.max(12, radius / 12)}px Microsoft JhengHei`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(opt.name, 0, 0);
                ctx.restore();

                startAngle += sweep;
            });

            // ä¸­å¿ƒåœ“
            ctx.beginPath();
            ctx.arc(cx, cy, radius * 0.1, 0, Math.PI * 2);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 3;
            ctx.stroke();

            // æŒ‡é‡
            const pointerSize = radius * 0.12;
            ctx.beginPath();
            ctx.moveTo(cx - pointerSize, 10);
            ctx.lineTo(cx + pointerSize, 10);
            ctx.lineTo(cx, 10 + pointerSize * 2);
            ctx.closePath();
            ctx.fillStyle = '#e94560';
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // === è½‰ç›¤å‹•ç•« ===
        function triggerWheel(spins) {
            if (isSpinning) return;
            spinWheel(spins);
        }

        function spinWheel(spins) {
            if (isSpinning || wheelOptions.length === 0) return;

            isSpinning = true;

            const startAngle = wheelAngle;
            const extraSpins = 5 + Math.floor(Math.random() * 3);
            const targetAngle = startAngle + 360 * extraSpins + Math.random() * 360;
            const duration = 4000;
            const startTime = Date.now();

            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                wheelAngle = startAngle + (targetAngle - startAngle) * eased;

                drawWheel();

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    isSpinning = false;
                    wheelAngle = wheelAngle % 360;
                    const result = getWheelResult();
                    console.log('è½‰ç›¤çµæœ:', result);
                }
            }

            requestAnimationFrame(animate);
        }

        function getWheelResult() {
            const pointerAngle = (270 - wheelAngle % 360 + 360) % 360;
            const totalWeight = wheelOptions.reduce((sum, opt) => sum + opt.weight, 0);

            let cumAngle = 0;
            for (const opt of wheelOptions) {
                const optAngle = 360 * opt.weight / totalWeight;
                if (pointerAngle >= cumAngle && pointerAngle < cumAngle + optAngle) {
                    return opt;
                }
                cumAngle += optAngle;
            }
            return wheelOptions[0];
        }

        // === å½±ç‰‡æ’­æ”¾ ===
        // æ ¹æ“šå½±ç‰‡è·¯å¾‘æ‰¾åˆ°å°æ‡‰çš„å®¹å™¨ä¸¦æ’­æ”¾
        function triggerVideo(videoData) {
            if (!videoData.path) return;

            // æ‰¾åˆ°å°æ‡‰çš„å®¹å™¨ (æ ¹æ“šè·¯å¾‘åŒ¹é…)
            let foundIndex = -1;
            for (let i = 0; i < videoGifts.length; i++) {
                if (videoGifts[i].video_path === videoData.path) {
                    foundIndex = i;
                    break;
                }
            }

            if (foundIndex === -1) {
                console.warn('æ‰¾ä¸åˆ°å°æ‡‰çš„å½±ç‰‡å®¹å™¨:', videoData.path);
                return;
            }

            // ä½¿ç”¨å°æ‡‰å®¹å™¨æ’­æ”¾
            triggerVideoInContainer(foundIndex, videoData);
        }

        // === é€²å ´æ•ˆæœ ===
        let entryPlaying = false;

        function triggerEntry(data) {
            console.log('[ENTRY] è§¸ç™¼é€²å ´æ•ˆæœ:', data);

            // æ±ºå®šä½¿ç”¨å“ªå€‹å®¹å™¨ï¼ˆç¸®åœ–å®¹å™¨æˆ–å…¨å±å®¹å™¨ï¼‰
            const useSmallContainer = entryVideoVisible && !data.is_audio;

            const fullContainer = document.getElementById('entryContainer');
            const fullVideo = document.getElementById('entryVideo');
            const audio = document.getElementById('entryAudio');

            const smallContainer = document.getElementById('entryVideoContainer');
            const smallPlayer = document.getElementById('entryPlayer');
            const smallAudio = document.getElementById('entryPlayerAudio');

            // å¦‚æœè¨­å®šå¼·åˆ¶ä¸­æ–·ï¼Œå…ˆåœæ­¢æ‰€æœ‰å…¶ä»–å½±ç‰‡
            if (data.force_interrupt) {
                console.log('[ENTRY] å¼·åˆ¶ä¸­æ–·å…¶ä»–æ’­æ”¾');
                // åœæ­¢æ‰€æœ‰å½±ç‰‡å®¹å™¨
                document.querySelectorAll('.video-container').forEach(vc => {
                    const idx = vc.dataset.index;
                    if (idx !== undefined) {
                        stopVideoInContainer(parseInt(idx));
                    }
                });
            }

            // æº–å‚™å½±ç‰‡è·¯å¾‘
            const videoSrc = formatVideoPath(data.path);

            if (data.is_audio) {
                // éŸ³æ•ˆæ¨¡å¼ - ä½¿ç”¨ç¸®åœ–å®¹å™¨çš„ audio æˆ–å…¨å±å®¹å™¨çš„ audio
                const targetAudio = entryVideoVisible ? smallAudio : audio;
                if (!targetAudio) {
                    console.error('[ENTRY] æ‰¾ä¸åˆ°éŸ³è¨Šå…ƒç´ ');
                    return;
                }
                targetAudio.src = videoSrc;
                targetAudio.volume = (data.volume || 100) / 100;
                targetAudio.onended = () => {
                    console.log('[ENTRY] éŸ³æ•ˆæ’­æ”¾çµæŸ');
                    entryPlaying = false;
                };
                targetAudio.onerror = (e) => {
                    console.error('[ENTRY] éŸ³æ•ˆæ’­æ”¾éŒ¯èª¤:', e);
                    entryPlaying = false;
                };
                targetAudio.play().catch(e => {
                    console.error('[ENTRY] éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', e);
                });
                entryPlaying = true;
            } else if (useSmallContainer && smallContainer && smallPlayer) {
                // å½±ç‰‡æ¨¡å¼ - åœ¨ç¸®åœ–å®¹å™¨ä¸­æ’­æ”¾
                console.log('[ENTRY] ä½¿ç”¨ç¸®åœ–å®¹å™¨æ’­æ”¾');
                smallPlayer.src = videoSrc;
                smallPlayer.volume = (data.volume || 100) / 100;
                smallPlayer.muted = false;

                smallPlayer.onloadedmetadata = () => {
                    console.log('[ENTRY] å½±ç‰‡å·²è¼‰å…¥ï¼ˆç¸®åœ–å®¹å™¨ï¼‰');
                };

                smallPlayer.onended = () => {
                    console.log('[ENTRY] å½±ç‰‡æ’­æ”¾çµæŸï¼ˆç¸®åœ–å®¹å™¨ï¼‰');
                    smallContainer.classList.remove('playing');
                    smallPlayer.src = '';
                    entryPlaying = false;
                };

                smallPlayer.onerror = (e) => {
                    console.error('[ENTRY] å½±ç‰‡æ’­æ”¾éŒ¯èª¤ï¼ˆç¸®åœ–å®¹å™¨ï¼‰:', e);
                    smallContainer.classList.remove('playing');
                    smallPlayer.src = '';
                    entryPlaying = false;
                };

                // é¡¯ç¤ºå®¹å™¨ä¸¦æ’­æ”¾
                smallContainer.classList.add('playing');
                entryPlaying = true;

                smallPlayer.play().then(() => {
                    console.log('[ENTRY] å½±ç‰‡é–‹å§‹æ’­æ”¾ï¼ˆç¸®åœ–å®¹å™¨ï¼‰');
                }).catch(e => {
                    console.error('[ENTRY] å½±ç‰‡æ’­æ”¾å¤±æ•—ï¼ˆç¸®åœ–å®¹å™¨ï¼‰:', e);
                    smallContainer.classList.remove('playing');
                    entryPlaying = false;
                });
            } else {
                // å½±ç‰‡æ¨¡å¼ - å…¨å±é¡¯ç¤º
                if (!fullContainer || !fullVideo) {
                    console.error('[ENTRY] æ‰¾ä¸åˆ°å…¨å±é€²å ´å®¹å™¨');
                    return;
                }
                fullVideo.src = videoSrc;
                fullVideo.volume = (data.volume || 100) / 100;
                fullVideo.muted = false;

                fullVideo.onloadedmetadata = () => {
                    console.log('[ENTRY] å½±ç‰‡å·²è¼‰å…¥');
                };

                fullVideo.onended = () => {
                    console.log('[ENTRY] å½±ç‰‡æ’­æ”¾çµæŸ');
                    fullContainer.classList.remove('active');
                    fullVideo.src = '';
                    entryPlaying = false;
                };

                fullVideo.onerror = (e) => {
                    console.error('[ENTRY] å½±ç‰‡æ’­æ”¾éŒ¯èª¤:', e);
                    fullContainer.classList.remove('active');
                    fullVideo.src = '';
                    entryPlaying = false;
                };

                // é¡¯ç¤ºå®¹å™¨ä¸¦æ’­æ”¾
                fullContainer.classList.add('active');
                entryPlaying = true;

                fullVideo.play().then(() => {
                    console.log('[ENTRY] å½±ç‰‡é–‹å§‹æ’­æ”¾');
                }).catch(e => {
                    console.error('[ENTRY] å½±ç‰‡æ’­æ”¾å¤±æ•—:', e);
                    fullContainer.classList.remove('active');
                    entryPlaying = false;
                });
            }

            // é¡¯ç¤ºé€²å ´æ–‡å­—
            if (data.show_text && data.text) {
                showEntryText(data);
            }
        }

        // é€²å ´æ–‡å­—è¨ˆæ™‚å™¨
        let entryTextTimer = null;

        function showEntryText(data) {
            const textContainer = document.getElementById('entryTextContainer');
            const textElement = document.getElementById('entryText');

            if (!textContainer || !textElement) return;

            // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
            if (entryTextTimer) {
                clearTimeout(entryTextTimer);
                entryTextTimer = null;
            }

            // æ›¿æ› {name} ç‚ºç”¨æˆ¶å
            const displayText = (data.text || '').replace(/\{name\}/g, data.username || '');

            // è¨­å®šæ–‡å­—æ¨£å¼
            textElement.textContent = displayText;
            textElement.style.fontSize = (data.text_size || 48) + 'px';
            textElement.style.color = data.text_color || '#ffffff';
            textElement.classList.remove('fade-out');

            // é¡¯ç¤ºå®¹å™¨
            textContainer.classList.remove('hidden');

            // è¨­å®šè‡ªå‹•éš±è—
            const duration = (data.text_duration || 5) * 1000;
            entryTextTimer = setTimeout(() => {
                hideEntryText();
            }, duration);

            console.log('[ENTRY] é¡¯ç¤ºé€²å ´æ–‡å­—:', displayText);
        }

        function hideEntryText() {
            const textContainer = document.getElementById('entryTextContainer');
            const textElement = document.getElementById('entryText');

            if (!textElement) return;

            // æ·»åŠ æ·¡å‡ºå‹•ç•«
            textElement.classList.add('fade-out');

            // å‹•ç•«çµæŸå¾Œéš±è—
            setTimeout(() => {
                if (textContainer) {
                    textContainer.classList.add('hidden');
                }
                textElement.classList.remove('fade-out');
            }, 500);
        }

        // åœæ­¢é€²å ´æ•ˆæœ
        function stopEntry() {
            const container = document.getElementById('entryContainer');
            const video = document.getElementById('entryVideo');
            const audio = document.getElementById('entryAudio');

            if (video) {
                video.pause();
                video.src = '';
            }
            if (audio) {
                audio.pause();
                audio.src = '';
            }
            if (container) {
                container.classList.remove('active');
            }
            entryPlaying = false;
        }

        // === æ‹–æ›³åŠŸèƒ½ ===
        let dragState = { active: false, elem: null, offsetX: 0, offsetY: 0 };

        function initDraggable() {
            const draggables = document.querySelectorAll('.draggable');

            draggables.forEach(elem => {
                // ç§»é™¤èˆŠçš„ç›£è½å™¨ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                elem.removeEventListener('mousedown', handleDragStart);
                elem.addEventListener('mousedown', handleDragStart);
            });
        }

        function handleDragStart(e) {
            if (e.button !== 0) return;
            if (e.target.classList.contains('resize-handle')) return;

            const elem = e.currentTarget;
            dragState.active = true;
            dragState.elem = elem;
            dragState.offsetX = e.clientX - elem.offsetLeft;
            dragState.offsetY = e.clientY - elem.offsetTop;
            elem.style.transform = 'none';
            e.preventDefault();
        }

        // å…¨åŸŸæ‹–æ›³äº‹ä»¶ï¼ˆåªè¨»å†Šä¸€æ¬¡ï¼‰
        document.addEventListener('mousemove', (e) => {
            if (!dragState.active || !dragState.elem) return;
            dragState.elem.style.left = (e.clientX - dragState.offsetX) + 'px';
            dragState.elem.style.top = (e.clientY - dragState.offsetY) + 'px';
        });

        document.addEventListener('mouseup', () => {
            if (dragState.active) {
                dragState.active = false;
                dragState.elem = null;
                savePositionsDebounced();
            }
        });

        // === ç¸®æ”¾åŠŸèƒ½ï¼ˆ8å€‹æ–¹å‘ï¼‰ ===
        let resizeState = {
            active: false,
            elem: null,
            direction: '',
            startX: 0, startY: 0,
            startWidth: 0, startHeight: 0,
            startLeft: 0, startTop: 0,
            // è£åˆ‡ç”¨
            videoIndex: -1,
            startCropLeft: 0,
            startCropTop: 0,
            originalWidth: 0,
            originalHeight: 0
        };

        function initResizable() {
            const draggables = document.querySelectorAll('.draggable');

            draggables.forEach(elem => {
                const handles = elem.querySelectorAll('.resize-handle');

                handles.forEach(handle => {
                    // ç§»é™¤èˆŠçš„ç›£è½å™¨
                    handle.removeEventListener('mousedown', handleResizeStart);
                    handle.addEventListener('mousedown', handleResizeStart);
                });
            });
        }

        function handleResizeStart(e) {
            e.stopPropagation();
            e.preventDefault();

            const handle = e.currentTarget;
            const elem = handle.parentElement;

            // å–å¾—æ–¹å‘
            let direction = '';
            const classes = handle.className.split(' ');
            for (const c of classes) {
                if (['nw', 'n', 'ne', 'w', 'e', 'sw', 's', 'se'].includes(c)) {
                    direction = c;
                    break;
                }
            }

            resizeState.active = true;
            resizeState.elem = elem;
            resizeState.direction = direction;
            resizeState.startX = e.clientX;
            resizeState.startY = e.clientY;
            resizeState.startWidth = elem.offsetWidth;
            resizeState.startHeight = elem.offsetHeight;
            resizeState.startLeft = elem.offsetLeft;
            resizeState.startTop = elem.offsetTop;
            elem.style.transform = 'none';

            // å½±ç‰‡å®¹å™¨çš„è£åˆ‡ç‹€æ…‹
            if (elem.classList.contains('video-container')) {
                const idx = parseInt(elem.dataset.index);
                resizeState.videoIndex = idx;

                // åˆå§‹åŒ–è£åˆ‡ç‹€æ…‹
                if (!videoCropState[idx]) {
                    videoCropState[idx] = {
                        cropLeft: 0,
                        cropTop: 0,
                        originalWidth: elem.offsetWidth,
                        originalHeight: elem.offsetHeight
                    };
                }

                resizeState.startCropLeft = videoCropState[idx].cropLeft;
                resizeState.startCropTop = videoCropState[idx].cropTop;
                resizeState.originalWidth = videoCropState[idx].originalWidth;
                resizeState.originalHeight = videoCropState[idx].originalHeight;
            } else {
                resizeState.videoIndex = -1;
            }
        }

        // å…¨åŸŸç¸®æ”¾äº‹ä»¶ï¼ˆåªè¨»å†Šä¸€æ¬¡ï¼‰
        document.addEventListener('mousemove', (e) => {
            if (!resizeState.active || !resizeState.elem) return;

            const deltaX = e.clientX - resizeState.startX;
            const deltaY = e.clientY - resizeState.startY;
            const direction = resizeState.direction;
            const elem = resizeState.elem;

            let newWidth = resizeState.startWidth;
            let newHeight = resizeState.startHeight;
            let newLeft = resizeState.startLeft;
            let newTop = resizeState.startTop;

            const isVideoContainer = elem.classList.contains('video-container');
            const isSingleSide = ['w', 'e', 'n', 's'].includes(direction);

            if (isVideoContainer && isSingleSide) {
                // å½±ç‰‡å®¹å™¨çš„å–®é‚Šèª¿æ•´ = è£åˆ‡æ¨¡å¼
                const idx = resizeState.videoIndex;
                const cropState = videoCropState[idx];
                const thumbnail = elem.querySelector('.thumbnail-video');
                const player = elem.querySelector('.video-player');

                if (direction === 'e') {
                    // å³é‚Šè£åˆ‡
                    newWidth = Math.max(50, resizeState.startWidth + deltaX);
                    newWidth = Math.min(newWidth, resizeState.originalWidth - cropState.cropLeft);
                }
                if (direction === 'w') {
                    // å·¦é‚Šè£åˆ‡
                    const newCropLeft = Math.max(0, Math.min(resizeState.startCropLeft + deltaX, resizeState.originalWidth - 50));
                    cropState.cropLeft = newCropLeft;
                    newWidth = Math.max(50, resizeState.startWidth - deltaX);
                    newWidth = Math.min(newWidth, resizeState.originalWidth - newCropLeft);
                    newLeft = resizeState.startLeft + deltaX;

                    if (thumbnail) thumbnail.style.left = -newCropLeft + 'px';
                    if (player) player.style.left = -newCropLeft + 'px';
                }
                if (direction === 's') {
                    // ä¸‹é‚Šè£åˆ‡
                    newHeight = Math.max(50, resizeState.startHeight + deltaY);
                    newHeight = Math.min(newHeight, resizeState.originalHeight - cropState.cropTop);
                }
                if (direction === 'n') {
                    // ä¸Šé‚Šè£åˆ‡
                    const newCropTop = Math.max(0, Math.min(resizeState.startCropTop + deltaY, resizeState.originalHeight - 50));
                    cropState.cropTop = newCropTop;
                    newHeight = Math.max(50, resizeState.startHeight - deltaY);
                    newHeight = Math.min(newHeight, resizeState.originalHeight - newCropTop);
                    newTop = resizeState.startTop + deltaY;

                    if (thumbnail) thumbnail.style.top = -newCropTop + 'px';
                    if (player) player.style.top = -newCropTop + 'px';
                }
            } else {
                // ä¸€èˆ¬ç¸®æ”¾æ¨¡å¼
                const isCorner = ['nw', 'ne', 'sw', 'se'].includes(direction);

                if (isCorner) {
                    // å››å€‹è§’è½ï¼šç­‰æ¯”ä¾‹ç¸®æ”¾
                    const aspectRatio = resizeState.startWidth / resizeState.startHeight;

                    // æ ¹æ“šæ»‘é¼ ç§»å‹•æ–¹å‘æ±ºå®šç¸®æ”¾åŸºæº–
                    let scale;
                    if (direction === 'se') {
                        // å³ä¸‹è§’ï¼šå–è¼ƒå¤§çš„ç¸®æ”¾å€¼
                        const scaleX = (resizeState.startWidth + deltaX) / resizeState.startWidth;
                        const scaleY = (resizeState.startHeight + deltaY) / resizeState.startHeight;
                        scale = Math.max(scaleX, scaleY);
                        newWidth = Math.max(50, resizeState.startWidth * scale);
                        newHeight = Math.max(50, newWidth / aspectRatio);
                    } else if (direction === 'sw') {
                        // å·¦ä¸‹è§’
                        const scaleX = (resizeState.startWidth - deltaX) / resizeState.startWidth;
                        const scaleY = (resizeState.startHeight + deltaY) / resizeState.startHeight;
                        scale = Math.max(scaleX, scaleY);
                        newWidth = Math.max(50, resizeState.startWidth * scale);
                        newHeight = Math.max(50, newWidth / aspectRatio);
                        newLeft = resizeState.startLeft + resizeState.startWidth - newWidth;
                    } else if (direction === 'ne') {
                        // å³ä¸Šè§’
                        const scaleX = (resizeState.startWidth + deltaX) / resizeState.startWidth;
                        const scaleY = (resizeState.startHeight - deltaY) / resizeState.startHeight;
                        scale = Math.max(scaleX, scaleY);
                        newWidth = Math.max(50, resizeState.startWidth * scale);
                        newHeight = Math.max(50, newWidth / aspectRatio);
                        newTop = resizeState.startTop + resizeState.startHeight - newHeight;
                    } else if (direction === 'nw') {
                        // å·¦ä¸Šè§’
                        const scaleX = (resizeState.startWidth - deltaX) / resizeState.startWidth;
                        const scaleY = (resizeState.startHeight - deltaY) / resizeState.startHeight;
                        scale = Math.max(scaleX, scaleY);
                        newWidth = Math.max(50, resizeState.startWidth * scale);
                        newHeight = Math.max(50, newWidth / aspectRatio);
                        newLeft = resizeState.startLeft + resizeState.startWidth - newWidth;
                        newTop = resizeState.startTop + resizeState.startHeight - newHeight;
                    }
                } else {
                    // å››å€‹é‚Šï¼šå–®å‘ç¸®æ”¾
                    if (direction === 'e') {
                        newWidth = Math.max(50, resizeState.startWidth + deltaX);
                    }
                    if (direction === 'w') {
                        newWidth = Math.max(50, resizeState.startWidth - deltaX);
                        newLeft = resizeState.startLeft + deltaX;
                        if (newWidth <= 50) newLeft = resizeState.startLeft + resizeState.startWidth - 50;
                    }
                    if (direction === 's') {
                        newHeight = Math.max(50, resizeState.startHeight + deltaY);
                    }
                    if (direction === 'n') {
                        newHeight = Math.max(50, resizeState.startHeight - deltaY);
                        newTop = resizeState.startTop + deltaY;
                        if (newHeight <= 50) newTop = resizeState.startTop + resizeState.startHeight - 50;
                    }
                }

                // å½±ç‰‡å®¹å™¨è§’è½èª¿æ•´æ™‚ï¼Œæ›´æ–°åŸå§‹å°ºå¯¸ä¸¦é‡ç½®è£åˆ‡
                if (isVideoContainer) {
                    const idx = resizeState.videoIndex;
                    videoCropState[idx] = {
                        cropLeft: 0,
                        cropTop: 0,
                        originalWidth: newWidth,
                        originalHeight: newHeight
                    };

                    const thumbnail = elem.querySelector('.thumbnail-video');
                    const player = elem.querySelector('.video-player');
                    if (thumbnail) {
                        thumbnail.style.left = '0px';
                        thumbnail.style.top = '0px';
                        thumbnail.style.width = newWidth + 'px';
                        thumbnail.style.height = newHeight + 'px';
                    }
                    if (player) {
                        player.style.left = '0px';
                        player.style.top = '0px';
                        player.style.width = newWidth + 'px';
                        player.style.height = newHeight + 'px';
                    }
                }
            }

            // è½‰ç›¤ä¿æŒæ­£æ–¹å½¢
            if (elem.id === 'wheelContainer') {
                const size = Math.max(newWidth, newHeight);
                newWidth = size;
                newHeight = size;
            }

            elem.style.width = newWidth + 'px';
            elem.style.height = newHeight + 'px';
            elem.style.left = newLeft + 'px';
            elem.style.top = newTop + 'px';

            // æ›´æ–°è½‰ç›¤ canvas
            if (elem.id === 'wheelContainer') {
                const canvas = document.getElementById('wheelCanvas');
                canvas.width = newWidth;
                canvas.height = newHeight;
                drawWheel();
            }
        });

        document.addEventListener('mouseup', () => {
            if (resizeState.active) {
                resizeState.active = false;
                resizeState.elem = null;
                savePositionsDebounced();
            }
        });

        // === å³éµé¸å–® ===
        function initContextMenu() {
            const menu = document.getElementById('contextMenu');

            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                menu.style.left = e.clientX + 'px';
                menu.style.top = e.clientY + 'px';
                menu.classList.add('visible');
            });

            document.addEventListener('click', () => {
                menu.classList.remove('visible');
            });
        }

        // æš´éœ²çµ¦å¤–éƒ¨çš„å‡½æ•¸
        window.triggerWheel = triggerWheel;
        window.triggerVideo = triggerVideo;
        window.triggerVideoInContainer = triggerVideoInContainer;
    </script>
</body>
</html>
