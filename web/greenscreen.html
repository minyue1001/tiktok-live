<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á∂†ÂπïË¶ñÁ™ó</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #00FF00;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: 'Microsoft JhengHei', sans-serif;
        }

        /* ÂèØÊãñÊõ≥ÂèØÁ∏ÆÊîæÂÆπÂô® */
        .draggable {
            position: absolute;
            cursor: move;
            user-select: none;
        }

        /* ÂàùÂßãÂåñÊúüÈñìÈö±ËóèÊâÄÊúâÂÖÉÁ¥†ÔºåÈò≤Ê≠¢ÈñÉÁàç */
        body.initializing .draggable:not(.debug-panel):not(.window-controls) {
            opacity: 0 !important;
            visibility: hidden !important;
            transition: none !important;
        }

        /* ÂàùÂßãÂåñÂÆåÊàêÂæåÁöÑÊ∑°ÂÖ•ÊïàÊûú */
        body:not(.initializing) .draggable {
            transition: opacity 0.3s ease;
        }

        /* 8ÂÄãË™øÊï¥Èªû */
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #fff;
            border: 2px solid #4ecca3;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
        }

        .draggable:hover .resize-handle,
        .debug-mode .resize-handle {
            opacity: 1;
        }

        /* ÂõõÂÄãËßí */
        .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }

        /* ÂõõÂÄãÈÇä */
        .resize-handle.n { top: -6px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
        .resize-handle.s { bottom: -6px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
        .resize-handle.w { left: -6px; top: 50%; transform: translateY(-50%); cursor: w-resize; }
        .resize-handle.e { right: -6px; top: 50%; transform: translateY(-50%); cursor: e-resize; }

        /* ËΩâÁõ§ÂÆπÂô® */
        .wheel-container {
            top: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: 350px;
            height: 350px;
        }

        .wheel-container.hidden {
            display: none;
        }

        #wheelCanvas {
            width: 100%;
            height: 100%;
        }

        /* ÂΩ±ÁâáÂÆπÂô® */
        .video-container {
            position: absolute;
            width: 300px;
            height: 200px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .video-container.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        .video-container .thumbnail-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            z-index: 1;
        }

        .video-container.playing .thumbnail-video {
            display: none !important;
            visibility: hidden !important;
        }

        .video-container .video-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            z-index: 2;
            display: none;
            visibility: hidden;
        }

        .video-container.playing .video-player {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 999 !important;
        }

        /* Ë™øË©¶Èù¢Êùø */
        .debug-panel {
            position: fixed;
            top: 0;
            right: -280px;
            width: 280px;
            height: 100vh;
            background: rgba(22, 27, 34, 0.98);
            border-left: 2px solid rgba(78, 204, 163, 0.5);
            padding: 15px;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            color: #f0f6fc;
        }

        .debug-panel.visible {
            right: 0;
        }

        .debug-panel h3 {
            color: #4ecca3;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .debug-hint-text {
            font-size: 10px;
            font-weight: 400;
            opacity: 0.5;
        }

        .debug-quick-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .debug-btn-mini {
            flex: 1;
            padding: 6px 8px;
            font-size: 11px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 6px;
            color: #f0f6fc;
            cursor: pointer;
            transition: all 0.2s;
        }

        .debug-btn-mini:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(78, 204, 163, 0.5);
        }

        .debug-section {
            margin-bottom: 12px;
        }

        .debug-section h4 {
            color: #00d9ff;
            margin-bottom: 10px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: default;
        }

        .debug-section.collapsible h4 {
            cursor: pointer;
            padding: 5px 0;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .debug-section.collapsible h4:hover {
            background: rgba(255,255,255,0.05);
        }

        .debug-section.collapsible .collapse-icon {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .debug-section.collapsible.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .debug-section.collapsible.collapsed .section-content {
            display: none;
        }

        /* È°ØÁ§∫ÊéßÂà∂Á∂≤Ê†º */
        .debug-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .debug-chip {
            padding: 8px 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: #8b949e;
        }

        .debug-chip:hover {
            background: rgba(255,255,255,0.1);
        }

        .debug-chip.active {
            background: rgba(78, 204, 163, 0.2);
            border-color: rgba(78, 204, 163, 0.5);
            color: #4ecca3;
        }

        /* ÊåâÈàïÁ∂≤Ê†º */
        .debug-btn-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .debug-btn {
            padding: 8px 12px;
            background: linear-gradient(135deg, #4ecca3, #3db892);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .debug-btn.compact {
            padding: 8px 6px;
            font-size: 11px;
        }

        .debug-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(78, 204, 163, 0.4);
        }

        .debug-btn.danger {
            background: linear-gradient(135deg, #e94560, #d63950);
        }

        .debug-btn.secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .debug-btn:disabled {
            background: #444;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .debug-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .video-list.compact {
            max-height: 200px;
            overflow-y: auto;
        }

        .video-list.compact .video-item {
            padding: 8px;
            gap: 8px;
            margin-bottom: 6px;
        }

        .video-list.compact .video-thumbnail {
            width: 50px;
            height: 38px;
        }

        .video-list.compact .video-name {
            font-size: 12px;
            margin-bottom: 2px;
        }

        .video-list.compact .video-type {
            font-size: 10px;
        }

        .video-list.compact .video-actions {
            flex-direction: row;
            gap: 4px;
        }

        .video-list.compact .video-actions button {
            padding: 4px 8px;
            font-size: 10px;
            min-width: auto;
        }

        .debug-toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: #21262d;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .debug-toggle.active {
            background: #4ecca3;
        }

        .debug-toggle::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: left 0.2s;
        }

        .debug-toggle.active::after {
            left: 23px;
        }

        /* ÂΩ±ÁâáÂàóË°® */
        .video-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .video-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .video-item.hidden-item {
            opacity: 0.5;
        }

        .video-thumbnail {
            width: 80px;
            height: 60px;
            background: #000;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }

        .video-thumbnail video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-thumbnail .no-video {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 24px;
        }

        .video-info {
            flex: 1;
            min-width: 0;
        }

        .video-name {
            font-size: 13px;
            font-weight: bold;
            color: #f0f6fc;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-type {
            font-size: 11px;
            color: #8b949e;
        }

        .video-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .video-actions button {
            padding: 5px 10px;
            font-size: 11px;
            min-width: 60px;
        }

        .empty-list {
            text-align: center;
            color: #8b949e;
            padding: 30px;
            font-size: 13px;
        }

        .video-list.compact .empty-list {
            padding: 15px 10px;
            font-size: 11px;
        }

        .refresh-btn {
            font-size: 12px;
            padding: 4px 8px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: #8b949e;
            cursor: pointer;
            border-radius: 4px;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #f0f6fc;
        }

        /* Ë¶ñÁ™óÊéßÂà∂Âàó */
        .window-controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            z-index: 9999;
            -webkit-app-region: drag;
            opacity: 0.3;
            transition: opacity 0.3s;
        }

        /* 3ÁßíÂæåËá™ÂãïÈö±Ëóè */
        .window-controls.auto-hide {
            opacity: 0;
        }

        .window-controls:hover,
        .window-controls.auto-hide:hover,
        .debug-mode .window-controls {
            opacity: 1;
        }

        .window-controls .title {
            color: #fff;
            font-size: 12px;
            pointer-events: none;
        }

        .window-controls .buttons {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
        }

        .window-controls .btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .window-controls .btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .window-controls .btn.close:hover {
            background: #e94560;
        }

        /* ÊèêÁ§∫ */
        .debug-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .debug-hint.visible {
            opacity: 1;
        }

        /* Âè≥ÈçµÈÅ∏ÂñÆ */
        .context-menu {
            display: none;
            position: fixed;
            background: rgba(22, 27, 34, 0.95);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 180px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .context-menu.visible {
            display: block;
        }

        .context-menu-item {
            padding: 10px 20px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .context-menu-item:hover {
            background: rgba(78, 204, 163, 0.2);
        }

        .context-menu-item .checkmark {
            width: 16px;
            color: #4ecca3;
        }

        .context-menu-item .menu-icon {
            width: 20px;
            text-align: center;
        }

        .context-menu-header {
            padding: 8px 16px;
            color: #8b949e;
            font-size: 12px;
            font-weight: 600;
        }

        .context-menu-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 4px 0;
        }

        /* ÊªæÂãïÊ¢ù */
        .debug-panel::-webkit-scrollbar,
        .video-list::-webkit-scrollbar {
            width: 6px;
        }

        .debug-panel::-webkit-scrollbar-track,
        .video-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .debug-panel::-webkit-scrollbar-thumb,
        .video-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        /* ÂÖ®Â±èÈÄ≤Â†¥ÂΩ±ÁâáÂÆπÂô® */
        .entry-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2000;
            background: transparent;
        }

        .entry-container.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .entry-video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Èö®Ê©üÂΩ±ÁâáÂ∞àÁî®ÂÆπÂô®ÔºàÂèØÊãñÊõ≥Á∏ÆÂúñÁâàÔºâ */
        .random-video-box {
            position: absolute;
            width: 300px;
            height: 200px;
            left: 50px;
            top: 400px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 8px;
            overflow: hidden;
            z-index: 100;
        }

        .random-video-box.hidden {
            display: none !important;
        }

        .random-video-box.playing .random-video-placeholder {
            display: none;
        }

        .random-video-box.playing .random-video-player {
            display: block;
        }

        .random-video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.2));
        }

        .random-video-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .random-video-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: bold;
        }

        .random-video-player {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* ÊäìÈ¥®Â≠êÂΩ±ÁâáÂÆπÂô® */
        .duck-video-box {
            position: absolute;
            width: 300px;
            height: 200px;
            left: 400px;
            top: 400px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 193, 7, 0.6);
            border-radius: 8px;
            overflow: hidden;
            z-index: 100;
        }

        .duck-video-box.hidden {
            display: none !important;
        }

        .duck-video-box.playing .duck-video-placeholder {
            display: none;
        }

        .duck-video-box.playing .duck-video-player {
            display: block;
        }

        .duck-video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 152, 0, 0.2));
        }

        .duck-video-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .duck-video-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: bold;
        }

        .duck-video-player {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* GPU Âä†ÈÄü */
            transform: translateZ(0);
            will-change: contents;
        }

        /* È¥®Â≠êË®àÊï∏È°ØÁ§∫ */
        .scalable-box {
            overflow: visible;
        }

        .scalable-box .scalable-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            white-space: nowrap;
        }

        .duck-counter-box {
            position: absolute;
            width: 200px;
            height: 100px;
            left: 50px;
            top: 50px;
            z-index: 200;
        }

        .duck-counter-box .scalable-content {
            min-width: 200px;
            height: 100px;
            padding: 0 25px;
            background: rgba(0, 0, 0, 0.5);
            border: 5px solid rgba(255, 193, 7, 0.9);
            border-radius: 20px;
            gap: 12px;
            box-shadow: 0 4px 20px rgba(255, 193, 7, 0.3);
        }

        .duck-counter-box.hidden {
            display: none !important;
        }

        .duck-counter-icon {
            font-size: 48px;
            animation: duckBounce 2s ease-in-out infinite;
            filter: hue-rotate(180deg);
        }

        @keyframes duckBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .duck-counter-value {
            font-size: 64px;
            font-weight: bold;
            color: #ffc107;
            text-shadow: 0 0 20px rgba(255, 193, 7, 0.8), 2px 2px 4px rgba(0, 0, 0, 0.8);
            font-family: 'Arial Black', sans-serif;
        }

        .duck-counter-add {
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 32px;
            font-weight: bold;
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.8), 2px 2px 4px rgba(0, 0, 0, 0.8);
            font-family: 'Arial Black', sans-serif;
            opacity: 0;
            pointer-events: none;
        }

        .duck-counter-add.show {
            animation: duckAddPop 1.5s ease-out forwards;
        }

        @keyframes duckAddPop {
            0% {
                opacity: 0;
                transform: translateY(10px) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translateY(-5px) scale(1.2);
            }
            40% {
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-30px) scale(0.8);
            }
        }

        /* ‰øùÂ∫ïË®àÊï∏È°ØÁ§∫ */
        .pity-counter-box {
            position: absolute;
            width: 180px;
            height: 80px;
            left: 50px;
            top: 170px;
            z-index: 200;
        }

        .pity-counter-box .scalable-content {
            min-width: 180px;
            height: 80px;
            padding: 0 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 4px solid rgba(147, 51, 234, 0.9);
            border-radius: 16px;
            flex-direction: column;
            gap: 4px;
            box-shadow: 0 4px 20px rgba(147, 51, 234, 0.3);
        }

        .pity-counter-box.hidden {
            display: none !important;
        }

        .pity-counter-label {
            font-size: 22px;
            font-weight: bold;
            color: #c084fc;
            text-shadow: 0 0 10px rgba(192, 132, 252, 0.5);
        }

        .pity-counter-value {
            font-size: 28px;
            font-weight: bold;
            color: #a855f7;
            text-shadow: 0 0 15px rgba(168, 85, 247, 0.8), 2px 2px 4px rgba(0, 0, 0, 0.8);
            font-family: 'Arial Black', sans-serif;
        }

        .pity-counter-value.stage2 {
            color: #f59e0b;
            text-shadow: 0 0 15px rgba(245, 158, 11, 0.8), 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .pity-counter-stage {
            font-size: 12px;
            color: #fbbf24;
            text-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
        }

        /* ÊéíË°åÊ¶úÈ°ØÁ§∫ */
        .leaderboard-box {
            position: absolute;
            width: 280px;
            height: 120px;
            right: 50px;
            top: 50px;
            z-index: 200;
        }

        .leaderboard-box.hidden {
            display: none !important;
        }

        /* ÈúìËôπÈÇäÊ°ÜÂãïÁï´ */
        @keyframes neonPulse {
            0%, 100% {
                box-shadow: 0 0 5px #ffc107, 0 0 10px #ffc107, 0 0 20px #ffc107, 0 0 40px #ff9800;
            }
            50% {
                box-shadow: 0 0 10px #ffc107, 0 0 20px #ffc107, 0 0 40px #ffc107, 0 0 80px #ff9800;
            }
        }

        @keyframes neonAvatarPulse {
            0%, 100% {
                box-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff, 0 0 15px #00ffff;
            }
            50% {
                box-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff, 0 0 30px #00ffff;
            }
        }

        .leaderboard-box .scalable-content {
            min-width: 320px;
            height: 100px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(20, 10, 40, 0.95));
            border: 2px solid transparent;
            border-image: linear-gradient(135deg, #ffc107, #ff6b6b, #a855f7) 1;
            border-radius: 12px;
            gap: 6px;
            padding: 10px 15px;
            flex-direction: column;
        }

        .leaderboard-box .scalable-content.neon-border {
            animation: neonPulse 2s ease-in-out infinite;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.4), inset 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .lb-row {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .lb-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
            filter: drop-shadow(0 0 5px currentColor);
        }

        .lb-icon.gold { color: #ffc107; }
        .lb-icon.purple { color: #a855f7; }

        .lb-avatar-mini {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid;
            object-fit: cover;
            flex-shrink: 0;
        }

        .lb-avatar-mini.gold-border { border-color: #ffc107; box-shadow: 0 0 8px rgba(255, 193, 7, 0.5); }
        .lb-avatar-mini.purple-border { border-color: #a855f7; box-shadow: 0 0 8px rgba(168, 85, 247, 0.5); }

        .lb-avatar-mini.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            font-size: 20px;
        }

        .lb-name {
            font-size: 13px;
            color: #fff;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }

        .lb-value {
            font-size: 18px;
            font-weight: bold;
            font-family: 'Arial Black', sans-serif;
            white-space: nowrap;
            text-shadow: 0 0 10px currentColor, 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .lb-value.gold { color: #ffc107; }
        .lb-value.purple { color: #a855f7; }

        /* ÊéíË°åÊ¶úÊõ¥Êñ∞ÂãïÁï´ */
        @keyframes lbUpdate {
            0% { transform: scale(1); }
            30% { transform: scale(1.15); filter: brightness(1.5); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        .lb-row.updating {
            animation: lbUpdate 0.5s ease-out;
        }

        .lb-row.updating .lb-value {
            animation: lbUpdate 0.5s ease-out;
        }

        .leaderboard-header {
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.3), rgba(245, 158, 11, 0.2));
            border-bottom: 2px solid rgba(255, 193, 7, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .leaderboard-title {
            font-size: 18px;
            font-weight: bold;
            color: #ffc107;
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
        }

        .leaderboard-tabs-gs {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
        }

        .leaderboard-tab-gs {
            flex: 1;
            padding: 6px 10px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .leaderboard-tab-gs:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .leaderboard-tab-gs.active {
            background: linear-gradient(135deg, #ffc107, #f59e0b);
            color: #1a1a24;
            font-weight: bold;
        }

        .leaderboard-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
        }

        .leaderboard-scroll.hidden {
            display: none;
        }

        .lb-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: all 0.2s;
        }

        .lb-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .lb-item.top-1 {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 193, 7, 0.15));
            border: 1px solid rgba(255, 215, 0, 0.5);
        }

        .lb-item.first-only {
            padding: 12px 15px;
            margin-bottom: 0;
        }

        .lb-item.first-only .lb-rank {
            font-size: 28px;
        }

        .lb-item.first-only .lb-avatar {
            width: 48px;
            height: 48px;
        }

        .lb-item.first-only .lb-name {
            font-size: 18px;
        }

        .lb-item.first-only .lb-score {
            font-size: 20px;
        }

        .lb-item.top-2 {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.2), rgba(169, 169, 169, 0.1));
            border: 1px solid rgba(192, 192, 192, 0.4);
        }

        .lb-item.top-3 {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.2), rgba(184, 115, 51, 0.1));
            border: 1px solid rgba(205, 127, 50, 0.4);
        }

        .lb-rank {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            flex-shrink: 0;
        }

        .lb-item.top-1 .lb-rank {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: #1a1a24;
            font-size: 16px;
        }

        .lb-item.top-2 .lb-rank {
            background: linear-gradient(135deg, #c0c0c0, #a9a9a9);
            color: #1a1a24;
        }

        .lb-item.top-3 .lb-rank {
            background: linear-gradient(135deg, #cd7f32, #b8732d);
            color: #1a1a24;
        }

        .lb-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            background: rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .lb-avatar.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .lb-info {
            flex: 1;
            min-width: 0;
        }

        .lb-name {
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .lb-score {
            font-weight: bold;
            font-size: 16px;
            color: #ffc107;
            white-space: nowrap;
            text-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
        }

        .lb-empty {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            padding: 20px;
            font-size: 14px;
        }

        /* Á¶ÆÁâ©ÂúñÈ°ØÁ§∫ÂçÄÂüü */
        .gift-image-display {
            position: absolute;
            z-index: 250;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            min-width: 100px;
            min-height: 50px;
            overflow: hidden;
        }

        .gift-image-display .gift-image-wrapper {
            transform-origin: top left;
            display: inline-block;
        }

        .gift-image-display .gift-image-content {
            display: grid;
            border-radius: 16px;
            overflow: hidden;
        }

        .gift-image-display .gift-image-grid-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .gift-image-display .gift-image-grid-item img {
            object-fit: contain;
        }

        .gift-image-display .gift-label {
            white-space: nowrap;
        }

        /* ÈáåÁ®ãÁ¢ëÊÖ∂Á•ùÂÆπÂô® */
        .milestone-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: none;
            pointer-events: none;
        }

        .milestone-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .milestone-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            z-index: 1;
        }

        .milestone-content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            animation: milestonePopIn 0.5s ease-out;
        }

        @keyframes milestonePopIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .milestone-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid gold;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.5);
            object-fit: cover;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
        }

        .milestone-avatar.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            background: linear-gradient(135deg, #ffd700, #ff8c00);
        }

        .milestone-badge {
            padding: 10px 30px;
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            border-radius: 30px;
            font-size: 24px;
            font-weight: bold;
            color: #1a1a2e;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.5);
        }

        .milestone-title {
            font-size: 48px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 4px 8px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .milestone-name {
            font-size: 36px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.6), 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .milestone-amount {
            font-size: 64px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .milestone-amount span {
            font-size: 48px;
        }

        /* ÂèØÊãñÊõ≥ÈÄ≤Â†¥ÂΩ±ÁâáÂÆπÂô® */
        .entry-video-container {
            position: absolute;
            width: 400px;
            height: 300px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            top: 100px;
            left: 100px;
        }

        .entry-video-container.hidden {
            display: none !important;
            visibility: hidden !important;
        }

        .entry-video-container .entry-thumbnail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            z-index: 1;
        }

        .entry-video-container.playing .entry-thumbnail {
            display: none !important;
        }

        .entry-video-container .entry-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            z-index: 2;
            display: none;
        }

        .entry-video-container.playing .entry-player {
            display: block !important;
        }

        .entry-audio {
            display: none;
        }

        /* ÈÄ≤Â†¥ÊñáÂ≠óÂÆπÂô® */
        .entry-text-container {
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 200px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2500;  /* ÊØîÂΩ±ÁâáÂÆπÂô®(2000)Êõ¥È´òÔºåÁ¢∫‰øùÊñáÂ≠óÂú®‰∏äÈù¢ */
        }

        .entry-text-container.hidden {
            display: none !important;
        }

        .entry-text {
            font-weight: bold;
            text-shadow:
                3px 3px 6px rgba(0,0,0,0.8),
                -1px -1px 0 rgba(0,0,0,0.5),
                1px -1px 0 rgba(0,0,0,0.5),
                -1px 1px 0 rgba(0,0,0,0.5),
                1px 1px 0 rgba(0,0,0,0.5);
            white-space: nowrap;
            animation: entryTextFadeIn 0.5s ease-out;
        }

        @keyframes entryTextFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes entryTextFadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(1.1);
            }
        }

        .entry-text.fade-out {
            animation: entryTextFadeOut 0.5s ease-in forwards;
        }

        /* Áõ≤ÁõíÂÆπÂô® */
        .giftbox-container {
            position: absolute;
            top: 150px;
            right: 50px;
            width: 200px;
            height: 200px;
            z-index: 50;
        }

        .giftbox-container.hidden {
            display: none;
        }

        .giftbox-box {
            position: relative;
            width: 100%;
            height: 100%;
            perspective: 1000px;
        }

        .giftbox-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 100px;
            background: linear-gradient(135deg, #e94560, #c13550);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .giftbox-base::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 100%;
            background: linear-gradient(135deg, #ffd93d, #f5c800);
        }

        .giftbox-lid {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 40px;
            background: linear-gradient(135deg, #e94560, #c13550);
            border-radius: 10px 10px 0 0;
            transform-origin: bottom center;
            transition: transform 0.5s ease;
        }

        .giftbox-lid::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 30px;
            background: linear-gradient(135deg, #ffd93d, #f5c800);
            border-radius: 50% 50% 0 0;
        }

        .giftbox-box.opening .giftbox-lid {
            transform: translateX(-50%) rotateX(-120deg);
        }

        .giftbox-box.rolling {
            animation: box-shake 0.15s ease-in-out infinite;
        }

        @keyframes box-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px) rotate(-1deg); }
            75% { transform: translateX(3px) rotate(1deg); }
        }

        .giftbox-result {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            padding: 15px 30px;
            background: linear-gradient(135deg, #4ecca3, #38b892);
            color: white;
            font-size: 24px;
            font-weight: bold;
            border-radius: 10px;
            white-space: nowrap;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(78, 204, 163, 0.5);
        }

        .giftbox-box.rolling .giftbox-result {
            transform: translateX(-50%) scale(1);
            opacity: 1;
            animation: roll-flip 0.1s ease-out;
        }

        @keyframes roll-flip {
            0% {
                transform: translateX(-50%) scale(0.8) translateY(10px);
                opacity: 0.5;
            }
            100% {
                transform: translateX(-50%) scale(1) translateY(0);
                opacity: 1;
            }
        }

        .giftbox-box.showing-result .giftbox-result {
            transform: translateX(-50%) scale(1.2);
            opacity: 1;
            animation: result-bounce 0.5s ease-out, result-glow 1.5s ease-in-out infinite;
        }

        @keyframes result-bounce {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.4); }
            100% { transform: translateX(-50%) scale(1.2); }
        }

        @keyframes result-glow {
            0%, 100% {
                box-shadow: 0 5px 20px rgba(78, 204, 163, 0.5),
                            0 0 30px rgba(255, 255, 255, 0.3);
            }
            50% {
                box-shadow: 0 5px 30px rgba(78, 204, 163, 0.8),
                            0 0 50px rgba(255, 255, 255, 0.5),
                            0 0 80px rgba(78, 204, 163, 0.4);
            }
        }

        /* Áõ≤ÁõíÂΩ©Â∏∂ÊïàÊûú */
        .giftbox-confetti {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(200px) rotate(720deg);
                opacity: 0;
            }
        }

        /* Áõ≤ÁõíÂÄíÊï∏Ë®àÊôÇ */
        .giftbox-countdown {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            font-size: 72px;
            font-weight: bold;
            color: #ffd93d;
            text-shadow: 0 0 20px rgba(255, 217, 61, 0.8), 0 4px 8px rgba(0,0,0,0.5);
            opacity: 0;
            z-index: 10;
        }

        .giftbox-countdown.active {
            animation: countdown-pop 1s ease-out;
        }

        @keyframes countdown-pop {
            0% {
                transform: translateX(-50%) scale(0);
                opacity: 0;
            }
            30% {
                transform: translateX(-50%) scale(1.3);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) scale(1);
                opacity: 0;
            }
        }

        /* Áõ≤ÁõíÂΩ±ÁâáÂÆπÂô® */
        .giftbox-video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 100;
        }

        .giftbox-video-container.active {
            display: block;
        }

        .giftbox-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Áõ≤ÁõíËá™ÂãïÈ°ØÁ§∫ÁãÄÊÖã */
        .giftbox-container.auto-hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: scale(0.8);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0s 0.3s;
        }

        .giftbox-container.auto-hidden.triggered {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: scale(1);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0s 0s;
        }
    </style>
</head>
<body class="initializing">
    <!-- Ë¶ñÁ™óÊéßÂà∂Âàó (ÊªëÈº†ÁßªÂà∞È†ÇÈÉ®È°ØÁ§∫) -->
    <div class="window-controls" id="windowControls">
        <span class="title">Á∂†ÂπïË¶ñÁ™ó (Êåâ Tab Ë™øÊï¥Ë®≠ÂÆö)</span>
        <div class="buttons">
            <button class="btn" onclick="minimizeWindow()" title="ÊúÄÂ∞èÂåñ">‚îÄ</button>
            <button class="btn" onclick="toggleMaximize()" title="ÊúÄÂ§ßÂåñ/ÈÇÑÂéü">‚ñ°</button>
            <button class="btn close" onclick="closeWindow()" title="ÈóúÈñâ">‚úï</button>
        </div>
    </div>

    <!-- ÂÖ®Â±èÈÄ≤Â†¥ÂÆπÂô® -->
    <div class="entry-container" id="entryContainer">
        <video class="entry-video" id="entryVideo"></video>
        <audio class="entry-audio" id="entryAudio"></audio>
    </div>

    <!-- Èö®Ê©üÂΩ±ÁâáÂ∞àÁî®ÂÆπÂô®ÔºàÂèØÊãñÊõ≥Á∏ÆÂúñÁâàÔºâ -->
    <div class="draggable random-video-box" id="randomVideoContainer">
        <div class="random-video-placeholder">
            <span class="random-video-icon">üé≤</span>
            <span class="random-video-label">Èö®Ê©üÂΩ±Áâá</span>
        </div>
        <video class="random-video-player" id="randomVideoPlayer"></video>
        <div class="resize-handle nw"></div>
        <div class="resize-handle n"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle se"></div>
    </div>

    <!-- ÊäìÈ¥®Â≠êÂΩ±ÁâáÂÆπÂô® -->
    <div class="draggable duck-video-box" id="duckVideoContainer">
        <div class="duck-video-placeholder">
            <span class="duck-video-icon">ü¶Ü</span>
            <span class="duck-video-label">ÊäìÈ¥®Â≠ê</span>
        </div>
        <video class="duck-video-player" id="duckVideoPlayer" preload="auto" playsinline disablepictureinpicture></video>
        <div class="resize-handle nw"></div>
        <div class="resize-handle n"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle se"></div>
    </div>

    <!-- È¥®Â≠êË®àÊï∏È°ØÁ§∫ -->
    <div class="draggable duck-counter-box scalable-box" id="duckCounterBox" data-base-width="200" data-base-height="100">
        <div class="scalable-content">
            <span class="duck-counter-icon">ü¶Ü</span>
            <span class="duck-counter-value" id="duckCounterValue">0</span>
            <span class="duck-counter-add" id="duckCounterAdd"></span>
        </div>
        <div class="resize-handle nw"></div>
        <div class="resize-handle n"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle se"></div>
    </div>

    <!-- ‰øùÂ∫ïË®àÊï∏È°ØÁ§∫ -->
    <div class="draggable pity-counter-box scalable-box hidden" id="pityCounterBox" data-base-width="180" data-base-height="80">
        <div class="scalable-content">
            <span class="pity-counter-label">üé∞ ‰øùÂ∫ïÈÄ≤Â∫¶</span>
            <span class="pity-counter-value" id="pityCounterValue">0 / 1000</span>
            <span class="pity-counter-stage" id="pityCounterStage"></span>
        </div>
        <div class="resize-handle nw"></div>
        <div class="resize-handle n"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle se"></div>
    </div>

    <!-- ÊéíË°åÊ¶ú -->
    <div class="draggable leaderboard-box scalable-box hidden" id="leaderboardBox" data-base-width="320" data-base-height="100">
        <div class="scalable-content lb-simple neon-border" id="gsLeaderboardSimple">
            <div class="lb-row">
                <span class="lb-icon gold">üëë</span>
                <div class="lb-avatar-mini gold-border placeholder">ü¶Ü</div>
                <span class="lb-name">---</span>
                <span class="lb-value gold">0ü¶Ü</span>
            </div>
            <div class="lb-row">
                <span class="lb-icon purple">‚≠ê</span>
                <div class="lb-avatar-mini purple-border placeholder">ü¶Ü</div>
                <span class="lb-name">---</span>
                <span class="lb-value purple">0ü¶Ü</span>
            </div>
        </div>
        <div class="resize-handle nw"></div>
        <div class="resize-handle n"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle se"></div>
    </div>

    <!-- Á¶ÆÁâ©ÂúñÈ°ØÁ§∫ÂçÄÂüü -->
    <div class="draggable gift-image-display" id="giftImageDisplay" style="display: none;">
        <div class="gift-image-wrapper" id="giftImageWrapper">
            <div class="gift-image-content" id="giftImageContent"></div>
        </div>
        <div class="resize-handle nw"></div>
        <div class="resize-handle n"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle se"></div>
    </div>

    <!-- ÈáåÁ®ãÁ¢ëÊÖ∂Á•ù -->
    <div class="milestone-overlay" id="milestoneOverlay">
        <video class="milestone-video" id="milestoneVideo" muted></video>
        <div class="milestone-content">
            <div class="milestone-badge" id="milestoneBadge">üèÜ Á¥ØË®àÁ¨¨‰∏Ä</div>
            <img class="milestone-avatar" id="milestoneAvatar" src="" alt="">
            <div class="milestone-title">üéâ ÊÅ≠Âñú üéâ</div>
            <div class="milestone-name" id="milestoneName">Áî®Êà∂ÂêçÁ®±</div>
            <div class="milestone-amount"><span id="milestoneAmount">10,000</span>ü¶Ü</div>
        </div>
    </div>

    <!-- ÈÄ≤Â†¥ÊñáÂ≠ó -->
    <div class="draggable entry-text-container hidden" id="entryTextContainer">
        <span class="entry-text" id="entryText"></span>
        <div class="resize-handle nw"></div>
        <div class="resize-handle n"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle se"></div>
    </div>

    <!-- ÈÄ≤Â†¥ÂΩ±ÁâáÂÆπÂô® -->
    <div class="draggable entry-video-container hidden" id="entryVideoContainer">
        <video class="entry-thumbnail" id="entryThumbnail" muted preload="metadata"></video>
        <video class="entry-player" id="entryPlayer"></video>
        <audio class="entry-player-audio" id="entryPlayerAudio"></audio>
        <div class="resize-handle nw"></div>
        <div class="resize-handle n"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle se"></div>
    </div>

    <!-- ËΩâÁõ§ -->
    <div class="draggable wheel-container" id="wheelContainer">
        <canvas id="wheelCanvas" width="350" height="350"></canvas>
        <div class="resize-handle nw"></div>
        <div class="resize-handle n"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle se"></div>
    </div>

    <!-- Áõ≤Áõí -->
    <div class="draggable giftbox-container" id="giftboxContainer">
        <div class="giftbox-box" id="giftboxBox">
            <div class="giftbox-confetti" id="giftboxConfetti"></div>
            <div class="giftbox-base"></div>
            <div class="giftbox-lid"></div>
            <div class="giftbox-result" id="giftboxResult"></div>
            <div class="giftbox-countdown" id="giftboxCountdown">3</div>
        </div>
        <div class="giftbox-video-container" id="giftboxVideoContainer">
            <video class="giftbox-video" id="giftboxVideo"></video>
        </div>
        <div class="resize-handle nw"></div>
        <div class="resize-handle n"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle se"></div>
    </div>

    <!-- ÂΩ±ÁâáÂÆπÂô®ÂçÄÂüü - ÂãïÊÖãÁîüÊàê -->
    <div id="videoContainersArea"></div>

    <!-- Ë™øË©¶Èù¢Êùø -->
    <div class="debug-panel" id="debugPanel">
        <h3>ÊéßÂà∂Èù¢Êùø <span class="debug-hint-text">Tab ÈóúÈñâ</span></h3>

        <!-- Âø´ÈÄüÊìç‰Ωú -->
        <div class="debug-quick-actions">
            <button class="debug-btn-mini" onclick="hideAllElements()" title="Èö±ËóèÂÖ®ÈÉ®">üëÅÔ∏è‚Äçüó®Ô∏è ÂÖ®ÈÉ®Èö±Ëóè</button>
            <button class="debug-btn-mini" onclick="showAllElements()" title="È°ØÁ§∫ÂÖ®ÈÉ®">üëÅÔ∏è ÂÖ®ÈÉ®È°ØÁ§∫</button>
        </div>

        <div class="debug-section">
            <h4>üéÆ ÈÅäÊà≤ÂÖÉÁ¥†</h4>
            <div class="debug-grid">
                <div class="debug-chip" id="toggleWheel" onclick="toggleWheelVisibility()">üé° ËΩâÁõ§</div>
                <div class="debug-chip" id="toggleGiftbox" onclick="toggleGiftboxVisibility()">üéÅ Áõ≤Áõí</div>
                <div class="debug-chip" id="toggleGiftboxAutoHide" onclick="toggleGiftboxAutoHide()">‚è±Ô∏è Áõ≤ÁõíËá™ÂãïÈö±Ëóè</div>
            </div>
        </div>

        <div class="debug-section">
            <h4>üé¨ ÂΩ±ÁâáÊéßÂà∂</h4>
            <div class="debug-grid">
                <div class="debug-chip" id="toggleVideo" onclick="toggleVideoVisibility()">üìπ Á¶ÆÁâ©ÂΩ±Áâá</div>
                <div class="debug-chip" id="toggleEntryVideo" onclick="toggleEntryVideoVisibility()">üëã ÈÄ≤Â†¥ÂΩ±Áâá</div>
                <div class="debug-chip" id="toggleRandomVideo" onclick="toggleRandomVideoVisible(); document.getElementById('toggleRandomVideo').classList.toggle('active', randomVideoVisible);">üé≤ Èö®Ê©üÂΩ±Áâá</div>
                <div class="debug-chip" id="toggleDuckVideo" onclick="toggleDuckVideoVisible(); document.getElementById('toggleDuckVideo').classList.toggle('active', duckVideoVisible);">ü¶Ü ÊäìÈ¥®ÂΩ±Áâá</div>
            </div>
        </div>

        <div class="debug-section">
            <h4>üìä Áµ±Ë®àÈ°ØÁ§∫</h4>
            <div class="debug-grid">
                <div class="debug-chip" id="toggleDuckCounter" onclick="toggleDuckCounterVisible(); document.getElementById('toggleDuckCounter').classList.toggle('active', duckCounterVisible);">ü¶Ü È¥®Â≠êË®àÊï∏</div>
                <div class="debug-chip" id="togglePityCounter" onclick="togglePityCounterVisible(); document.getElementById('togglePityCounter').classList.toggle('active', pityCounterVisible);">üé∞ ‰øùÂ∫ïË®àÊï∏</div>
                <div class="debug-chip" id="toggleLeaderboard" onclick="toggleLeaderboardVisible(); document.getElementById('toggleLeaderboard').classList.toggle('active', leaderboardVisible);">üèÜ ÊéíË°åÊ¶ú</div>
            </div>
        </div>

        <div class="debug-section">
            <h4>üß™ Ê∏¨Ë©¶ÂäüËÉΩ</h4>
            <div class="debug-btn-grid">
                <button class="debug-btn compact" id="testWheelBtn" onclick="testWheelSpin()">üé° ËΩâÁõ§</button>
                <button class="debug-btn compact" id="testGiftboxBtn" onclick="testGiftboxOpen()">üéÅ Áõ≤Áõí</button>
                <button class="debug-btn compact" onclick="testEntryText()">üìù ÊñáÂ≠ó</button>
                <button class="debug-btn compact" onclick="testEntryVideo()">üé¨ ÈÄ≤Â†¥</button>
            </div>
            <div class="debug-btn-grid" style="margin-top: 6px;">
                <button class="debug-btn compact secondary" onclick="reloadAllThumbnails()">üîÑ ÈáçËºâÁ∏ÆÂúñ</button>
                <button class="debug-btn compact danger" onclick="resetAllCropStates()">‚úÇÔ∏è ÈáçÁΩÆË£ÅÂàá</button>
            </div>
        </div>

        <div class="debug-section collapsible">
            <h4 onclick="toggleSection(this)">
                <span>üìã ÂΩ±ÁâáÂàóË°®</span>
                <span class="collapse-icon">‚ñº</span>
            </h4>
            <div class="section-content">
                <div class="video-list compact" id="videoList">
                    <div class="empty-list">ËºâÂÖ•‰∏≠...</div>
                </div>
            </div>
        </div>

        <div class="debug-section collapsible">
            <h4 onclick="toggleSection(this)">
                <span>üëã ÈÄ≤Â†¥ÂàóË°®</span>
                <span class="collapse-icon">‚ñº</span>
            </h4>
            <div class="section-content">
                <div class="video-list compact" id="entryList">
                    <div class="empty-list">ËºâÂÖ•‰∏≠...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊèêÁ§∫ -->
    <div class="debug-hint" id="debugHint">Êåâ Tab ÈçµÈñãÂïüË™øË©¶Èù¢Êùø</div>

    <!-- Âè≥ÈçµÈÅ∏ÂñÆ -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="toggleWheelVisibility()">
            <span class="checkmark" id="wheelCheck">‚úì</span>
            <span>È°ØÁ§∫ËΩâÁõ§</span>
        </div>
        <div class="context-menu-item" onclick="toggleGiftboxVisibility()">
            <span class="checkmark" id="giftboxCheck">‚úì</span>
            <span>È°ØÁ§∫Áõ≤Áõí</span>
        </div>
        <div class="context-menu-item" onclick="toggleGiftboxAutoHide()">
            <span class="checkmark" id="giftboxAutoHideCheck"></span>
            <span>Áõ≤ÁõíËá™ÂãïÈö±Ëóè</span>
        </div>
        <div class="context-menu-item" onclick="toggleVideoVisibility()">
            <span class="checkmark" id="videoCheck">‚úì</span>
            <span>È°ØÁ§∫ÂΩ±Áâá</span>
        </div>
        <div class="context-menu-item" onclick="toggleDebugPanel()">
            <span class="checkmark" id="debugCheck"></span>
            <span>ÈñãÂïüË™øË©¶Èù¢Êùø</span>
        </div>
    </div>

    <!-- ÂÖÉÁ¥†Âè≥ÈçµÈÅ∏ÂñÆ (ÂúñÂ±§ÊéßÂà∂) -->
    <div class="context-menu" id="elementContextMenu">
        <div class="context-menu-header" id="elementMenuTitle">ÂÖÉÁ¥†ÊéßÂà∂</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="moveLayerToTop()">
            <span class="menu-icon">‚¨ÜÔ∏è</span>
            <span>ÁßªÂà∞ÊúÄ‰∏äÂ±§</span>
        </div>
        <div class="context-menu-item" onclick="moveLayerUp()">
            <span class="menu-icon">üîº</span>
            <span>‰∏äÁßª‰∏ÄÂ±§</span>
        </div>
        <div class="context-menu-item" onclick="moveLayerDown()">
            <span class="menu-icon">üîΩ</span>
            <span>‰∏ãÁßª‰∏ÄÂ±§</span>
        </div>
        <div class="context-menu-item" onclick="moveLayerToBottom()">
            <span class="menu-icon">‚¨áÔ∏è</span>
            <span>ÁßªÂà∞ÊúÄ‰∏ãÂ±§</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="hideCurrentElement()">
            <span class="menu-icon">üëÅÔ∏è</span>
            <span>Èö±ËóèÊ≠§ÂÖÉÁ¥†</span>
        </div>
    </div>

    <script>
        // === Ë™øË©¶Ë®≠ÂÆö (ÂïÜÁî®ÁâàÊú¨Ë´ãË®≠ÁÇ∫ false) ===
        const DEBUG_MODE = false;
        const debugLog = (...args) => { if (DEBUG_MODE) console.log(...args); };

        // === ÂÖ®ÂüüËÆäÊï∏ ===
        let wheelOptions = [];
        let giftboxOptions = [];
        let videoGifts = [];
        let wheelAngle = 0;
        let wheelVisible = true;
        let giftboxVisible = true;
        let giftboxAutoHide = false;  // Áõ≤ÁõíËá™ÂãïÈö±ËóèÊ®°Âºè
        let videoVisible = true;
        let wheelModuleEnabled = true;  // ËΩâÁõ§Ê®°ÁµÑÊòØÂê¶ÂïüÁî®
        let giftboxModuleEnabled = false;  // Áõ≤ÁõíÊ®°ÁµÑÊòØÂê¶ÂïüÁî®
        let isSpinning = false;
        let isGiftboxOpening = false;
        let debugPanelVisible = false;

        // ÂΩ±ÁâáÂÆπÂô®Ë≥áÊñô (ÊØèÂÄãÂΩ±Áâá‰∏ÄÂÄãÂÆπÂô®)
        let videoContainers = {};  // { index: { visible, width, height, left, top } }

        // ÂêÑÂÆπÂô®ÁöÑÊí≠ÊîæÁãÄÊÖã
        let containerPlayingState = {};  // { index: { isPlaying, queue, wasHidden } }

        // ÊØèÂÄãÂΩ±ÁâáÂÆπÂô®ÁöÑË£ÅÂàáÁãÄÊÖã
        let videoCropState = {};  // { index: { cropLeft, cropTop, originalWidth, originalHeight } }

        // ÂÑ≤Â≠òÁöÑ‰ΩçÁΩÆË≥áÊñôÔºàÂæûÈÖçÁΩÆËºâÂÖ•Ôºâ
        let savedPositions = null;

        // === ÂàùÂßãÂåñ ===
        document.addEventListener('DOMContentLoaded', async () => {
            await waitForPywebview();

            // 1. ÂÖàËºâÂÖ•ÂÑ≤Â≠òÁöÑ‰ΩçÁΩÆË≥áÊñô
            savedPositions = await loadSavedPositions();

            // 2. ËºâÂÖ•ËΩâÁõ§ÈÅ∏È†Ö„ÄÅÁõ≤ÁõíÈÅ∏È†Ö„ÄÅÂΩ±ÁâáÂàóË°®ÂíåÈÄ≤Â†¥ÂàóË°®
            await loadWheelOptions();
            await loadGiftboxOptions();
            await loadVideoGifts();  // ÈÄôË£°ÊúÉÁîüÊàêÂÆπÂô®‰∏¶Â•óÁî®‰ΩçÁΩÆ
            await loadEntryList();   // ËºâÂÖ•ÈÄ≤Â†¥ÊïàÊûúÂàóË°®

            // 3. Â•óÁî®ËΩâÁõ§„ÄÅÁõ≤Áõí„ÄÅÈÄ≤Â†¥ÊñáÂ≠ó„ÄÅÈÄ≤Â†¥ÂΩ±Áâá„ÄÅÈö®Ê©üÂΩ±Áâá‰ΩçÁΩÆ
            applyWheelPosition();
            applyGiftboxPosition();
            applyEntryTextPosition();
            applyEntryVideoPosition();
            applyRandomVideoPosition();
            applyDuckPositions();

            // ËºâÂÖ•ÂàùÂßã‰øùÂ∫ïË®àÊï∏
            if (window.pywebview && window.pywebview.api) {
                try {
                    const pityData = await pywebview.api.get_pity_counter();
                    if (pityData) {
                        updatePityCounter(pityData);
                    }
                } catch (e) {
                    console.error('ËºâÂÖ•‰øùÂ∫ïË®àÊï∏Â§±Êïó:', e);
                }

                // ËºâÂÖ•ÂàùÂßãÊéíË°åÊ¶ú
                try {
                    const lbData = await pywebview.api.get_leaderboard();
                    if (lbData) {
                        updateLeaderboard(lbData);
                    }
                } catch (e) {
                    console.error('ËºâÂÖ•ÊéíË°åÊ¶úÂ§±Êïó:', e);
                }
            }

            // 4. Ê™¢Êü•Ê®°ÁµÑÁãÄÊÖã
            await loadModuleStatus();

            // 5. ÂàùÂßãÂåñÂÖ∂‰ªñÂäüËÉΩ
            drawWheel();
            initDraggable();
            initResizable();
            initContextMenu();
            applyElementZIndexes();  // Â•óÁî®ÂÑ≤Â≠òÁöÑÂúñÂ±§È†ÜÂ∫è
            initMessageListener();
            initKeyboardShortcuts();
            showHint();

            // 3ÁßíÂæåËá™ÂãïÈö±ËóèË¶ñÁ™óÊéßÂà∂ÂàóÔºà‰ΩÜÊªëÈº†Áßª‰∏äÂéªÈÇÑÊòØÊúÉÈ°ØÁ§∫Ôºâ
            setTimeout(() => {
                const controls = document.getElementById('windowControls');
                if (controls) {
                    controls.classList.add('auto-hide');
                }
            }, 3000);

            // ÁßªÈô§ÂàùÂßãÂåñÁãÄÊÖãÔºåÈ°ØÁ§∫ÊâÄÊúâÂ∑≤ÈÖçÁΩÆÁöÑÂÖÉÁ¥†
            requestAnimationFrame(() => {
                document.body.classList.remove('initializing');
            });

            // Âª∂ÈÅ≤ÈáçÊñ∞ËºâÂÖ•Á∏ÆÂúñ
            setTimeout(() => {
                debugLog('[ÂàùÂßãÂåñ] ÂÆåÊàêÔºåÈáçËºâÁ∏ÆÂúñ');
                reloadAllThumbnails();
            }, 500);
        });

        // ËºâÂÖ•ÂÑ≤Â≠òÁöÑ‰ΩçÁΩÆË≥áÊñô
        async function loadSavedPositions() {
            try {
                if (window.pywebview && window.pywebview.api) {
                    const positions = await pywebview.api.get_greenscreen_positions();
                    console.log('[‰ΩçÁΩÆ] ËºâÂÖ•ÂÑ≤Â≠òË≥áÊñô:', positions ? 'ÊúâË≥áÊñô' : 'ÁÑ°Ë≥áÊñô');
                    return positions || null;
                }
            } catch (e) {
                console.error('[‰ΩçÁΩÆ] ËºâÂÖ•Â§±Êïó:', e);
            }
            return null;
        }

        // Â•óÁî®ËΩâÁõ§‰ΩçÁΩÆ
        function applyWheelPosition() {
            if (!savedPositions || !savedPositions.wheel) {
                console.log('[ËΩâÁõ§] ‰ΩøÁî®È†êË®≠‰ΩçÁΩÆ');
                return;
            }

            const wheel = document.getElementById('wheelContainer');
            const canvas = document.getElementById('wheelCanvas');
            const data = savedPositions.wheel;

            // Â•óÁî®Â∞∫ÂØ∏Âíå‰ΩçÁΩÆ
            const w = Math.max(50, data.width || 350);
            const h = Math.max(50, data.height || 350);
            wheel.style.width = w + 'px';
            wheel.style.height = h + 'px';
            wheel.style.left = (data.left || 0) + 'px';
            wheel.style.top = (data.top || 150) + 'px';
            wheel.style.transform = 'none';
            canvas.width = w;
            canvas.height = h;

            // Â•óÁî®È°ØÁ§∫ÁãÄÊÖã
            if (data.visible === false) {
                wheelVisible = false;
                setElementVisible(wheel, false);
                document.getElementById('wheelCheck').textContent = '';
                document.getElementById('toggleWheel').classList.remove('active');
            } else {
                wheelVisible = true;
                setElementVisible(wheel, true);
                document.getElementById('wheelCheck').textContent = '‚úì';
                document.getElementById('toggleWheel').classList.add('active');
            }

            console.log('[ËΩâÁõ§] Â∑≤Â•óÁî®‰ΩçÁΩÆ:', w, 'x', h, 'È°ØÁ§∫:', wheelVisible);
        }

        // ÈÄöÁî®ÁöÑÈ°ØÁ§∫/Èö±ËóèÂáΩÊï∏
        function setElementVisible(el, visible) {
            if (visible) {
                el.classList.remove('hidden');
                el.style.display = 'block';
                el.style.visibility = 'visible';
                el.style.opacity = '1';
            } else {
                el.classList.add('hidden');
                el.style.display = 'none';
                el.style.visibility = 'hidden';
                el.style.opacity = '0';
            }
        }

        // Â•óÁî®Áõ≤Áõí‰ΩçÁΩÆ
        function applyGiftboxPosition() {
            const giftbox = document.getElementById('giftboxContainer');
            if (!giftbox) return;

            if (savedPositions && savedPositions.giftbox) {
                const data = savedPositions.giftbox;
                const w = Math.max(50, data.width || 200);
                const h = Math.max(50, data.height || 200);
                giftbox.style.width = w + 'px';
                giftbox.style.height = h + 'px';
                giftbox.style.left = (data.left || 0) + 'px';
                giftbox.style.top = (data.top || 150) + 'px';
                giftbox.style.right = 'auto';
                giftbox.style.transform = 'none';

                if (data.visible === false) {
                    giftboxVisible = false;
                    setElementVisible(giftbox, false);
                    document.getElementById('giftboxCheck').textContent = '';
                    document.getElementById('toggleGiftbox').classList.remove('active');
                } else {
                    giftboxVisible = true;
                    setElementVisible(giftbox, true);
                    document.getElementById('giftboxCheck').textContent = '‚úì';
                    document.getElementById('toggleGiftbox').classList.add('active');
                }

                // Ëá™ÂãïÈö±ËóèÊ®°Âºè
                if (data.autoHide === true) {
                    giftboxAutoHide = true;
                    giftbox.classList.add('auto-hidden');
                    document.getElementById('giftboxAutoHideCheck').textContent = '‚úì';
                    document.getElementById('toggleGiftboxAutoHide').classList.add('active');
                } else {
                    giftboxAutoHide = false;
                    giftbox.classList.remove('auto-hidden');
                    document.getElementById('giftboxAutoHideCheck').textContent = '';
                    document.getElementById('toggleGiftboxAutoHide').classList.remove('active');
                }

                console.log('[Áõ≤Áõí] Â∑≤Â•óÁî®‰ΩçÁΩÆ:', w, 'x', h, 'È°ØÁ§∫:', giftboxVisible, 'Ëá™ÂãïÈö±Ëóè:', giftboxAutoHide);
            } else {
                console.log('[Áõ≤Áõí] ‰ΩøÁî®È†êË®≠‰ΩçÁΩÆ');
                giftbox.style.right = '50px';
                giftbox.style.left = 'auto';
            }
        }

        // Â•óÁî®ÈÄ≤Â†¥ÊñáÂ≠ó‰ΩçÁΩÆ
        function applyEntryTextPosition() {
            const entryText = document.getElementById('entryTextContainer');
            if (!entryText) return;

            if (savedPositions && savedPositions.entryText) {
                const data = savedPositions.entryText;
                entryText.style.left = (data.left || 0) + 'px';
                entryText.style.top = (data.top || 50) + 'px';
                entryText.style.transform = 'none';
                console.log('[ÈÄ≤Â†¥ÊñáÂ≠ó] Â∑≤Â•óÁî®‰ΩçÁΩÆ:', data.left, ',', data.top);
            } else {
                console.log('[ÈÄ≤Â†¥ÊñáÂ≠ó] ‰ΩøÁî®È†êË®≠‰ΩçÁΩÆ');
                // È†êË®≠ÁΩÆ‰∏≠
                entryText.style.left = '50%';
                entryText.style.top = '50px';
                entryText.style.transform = 'translateX(-50%)';
            }
        }

        function applyEntryVideoPosition() {
            const entryVideo = document.getElementById('entryVideoContainer');
            if (!entryVideo) return;

            if (savedPositions && savedPositions.entryVideo) {
                const data = savedPositions.entryVideo;
                entryVideo.style.width = (data.width || 400) + 'px';
                entryVideo.style.height = (data.height || 300) + 'px';
                entryVideo.style.left = (data.left || 100) + 'px';
                entryVideo.style.top = (data.top || 100) + 'px';

                // Ë®≠ÂÆöÈ°ØÁ§∫ÁãÄÊÖã
                entryVideoVisible = data.visible || false;
                setElementVisible(entryVideo, entryVideoVisible);
                document.getElementById('toggleEntryVideo')?.classList.toggle('active', entryVideoVisible);

                // Êõ¥Êñ∞ÈÄ≤Â†¥ÂàóË°®‰∏≠ÁöÑÊåâÈàïÁãÄÊÖã
                updateEntryVisibilityButtons();

                console.log('[ÈÄ≤Â†¥ÂΩ±Áâá] Â∑≤Â•óÁî®‰ΩçÁΩÆ:', data);
            } else {
                console.log('[ÈÄ≤Â†¥ÂΩ±Áâá] ‰ΩøÁî®È†êË®≠‰ΩçÁΩÆ');
                entryVideo.style.width = '400px';
                entryVideo.style.height = '300px';
                entryVideo.style.left = '100px';
                entryVideo.style.top = '100px';
                setElementVisible(entryVideo, false);
            }
        }

        // Â•óÁî®Èö®Ê©üÂΩ±Áâá‰ΩçÁΩÆ
        function applyRandomVideoPosition() {
            const randomVideo = document.getElementById('randomVideoContainer');
            if (!randomVideo) return;

            if (savedPositions && savedPositions.randomVideo) {
                const data = savedPositions.randomVideo;
                randomVideo.style.width = (data.width || 300) + 'px';
                randomVideo.style.height = (data.height || 200) + 'px';
                randomVideo.style.left = (data.left || 50) + 'px';
                randomVideo.style.top = (data.top || 400) + 'px';

                // Ë®≠ÂÆöÈ°ØÁ§∫ÁãÄÊÖã
                randomVideoVisible = data.visible !== false;
                if (!randomVideoVisible) {
                    randomVideo.classList.add('hidden');
                } else {
                    randomVideo.classList.remove('hidden');
                }

                // Êõ¥Êñ∞Ë™øË©¶Èù¢ÊùøÁöÑÈñãÈóúÁãÄÊÖã
                document.getElementById('toggleRandomVideo')?.classList.toggle('active', randomVideoVisible);

                console.log('[Èö®Ê©üÂΩ±Áâá] Â∑≤Â•óÁî®‰ΩçÁΩÆ:', data);
            } else {
                console.log('[Èö®Ê©üÂΩ±Áâá] ‰ΩøÁî®È†êË®≠‰ΩçÁΩÆ');
                randomVideo.style.width = '300px';
                randomVideo.style.height = '200px';
                randomVideo.style.left = '50px';
                randomVideo.style.top = '400px';
            }
        }

        // Â•óÁî®Á∏ÆÊîæÂÖßÂÆπÁöÑÊØî‰æãÔºàÁ≠âÊØî‰æãÁ∏ÆÊîæÔºåÁΩÆ‰∏≠È°ØÁ§∫Ôºâ
        function applyScalableBoxScale(elem, width, height) {
            if (!elem || !elem.classList.contains('scalable-box')) return;
            const content = elem.querySelector('.scalable-content');
            if (!content) return;

            // ÂèñÂæóÂü∫Á§éÂ∞∫ÂØ∏ÔºàÁî®ÊñºË®àÁÆóÁ∏ÆÊîæÊØî‰æãÔºâ
            const baseWidth = parseInt(elem.dataset.baseWidth) || 200;
            const baseHeight = parseInt(elem.dataset.baseHeight) || 100;

            // ÂÖàÈáçÁΩÆ transform ‰ª•ÂèñÂæóÁúüÂØ¶ÂÖßÂÆπÂ∞∫ÂØ∏
            content.style.transform = 'translate(-50%, -50%)';

            // ÂèñÂæóÂØ¶ÈöõÂÖßÂÆπÂ∞∫ÂØ∏ÔºàÊúÉÊ†πÊìöÊñáÂ≠óËá™ÂãïÊãâÈï∑Ôºâ
            let contentWidth = content.offsetWidth;
            let contentHeight = content.offsetHeight;

            // Â¶ÇÊûúÂÖÉÁ¥†Èö±ËóèÊôÇ offset ÁÇ∫ 0Ôºå‰ΩøÁî®Âü∫Á§éÂ∞∫ÂØ∏‰ΩúÁÇ∫ÂèÉËÄÉ
            if (contentWidth <= 0) contentWidth = baseWidth;
            if (contentHeight <= 0) contentHeight = baseHeight;

            // Ë®àÁÆóÁ∏ÆÊîæÊØî‰æãÔºàÂèñËºÉÂ∞èÂÄº‰ª•Á¢∫‰øùÂÆåÊï¥È°ØÁ§∫Ôºâ
            const scaleX = width / contentWidth;
            const scaleY = height / contentHeight;
            const scale = Math.min(scaleX, scaleY);

            // Á¢∫‰øù scale ÊòØÊúâÊïàÂÄº
            if (!isFinite(scale) || scale <= 0) {
                content.style.transform = 'translate(-50%, -50%) scale(1)';
                return;
            }

            // ÁΩÆ‰∏≠ + Á∏ÆÊîæ
            content.style.transform = `translate(-50%, -50%) scale(${scale})`;
        }

        // Â•óÁî®ÊäìÈ¥®Â≠ê‰ΩçÁΩÆ
        function applyDuckPositions() {
            const duckVideo = document.getElementById('duckVideoContainer');
            const duckCounter = document.getElementById('duckCounterBox');

            // ÊäìÈ¥®Â≠êÂΩ±ÁâáÂÆπÂô®
            if (duckVideo) {
                if (savedPositions && savedPositions.duckVideo) {
                    const data = savedPositions.duckVideo;
                    duckVideo.style.width = (data.width || 300) + 'px';
                    duckVideo.style.height = (data.height || 200) + 'px';
                    duckVideo.style.left = (data.left || 400) + 'px';
                    duckVideo.style.top = (data.top || 400) + 'px';

                    duckVideoVisible = data.visible !== false;
                    if (!duckVideoVisible) {
                        duckVideo.classList.add('hidden');
                    } else {
                        duckVideo.classList.remove('hidden');
                    }
                    document.getElementById('toggleDuckVideo')?.classList.toggle('active', duckVideoVisible);
                    console.log('[ÊäìÈ¥®Â≠êÂΩ±Áâá] Â∑≤Â•óÁî®‰ΩçÁΩÆ:', data);
                } else {
                    console.log('[ÊäìÈ¥®Â≠êÂΩ±Áâá] ‰ΩøÁî®È†êË®≠‰ΩçÁΩÆ');
                }
            }

            // È¥®Â≠êË®àÊï∏È°ØÁ§∫
            if (duckCounter) {
                if (savedPositions && savedPositions.duckCounter) {
                    const data = savedPositions.duckCounter;
                    const w = data.width || 200;
                    const h = data.height || 100;
                    const l = data.left || 50;
                    const t = data.top || 50;

                    duckCounter.style.width = w + 'px';
                    duckCounter.style.height = h + 'px';
                    duckCounter.style.left = l + 'px';
                    duckCounter.style.top = t + 'px';

                    // Êõ¥Êñ∞Á∑©Â≠ò
                    scalableBoxCache.duckCounterBox = { width: w, height: h, left: l, top: t };

                    // Â•óÁî®Á∏ÆÊîæ
                    applyScalableBoxScale(duckCounter, w, h);

                    duckCounterVisible = data.visible !== false;
                    if (!duckCounterVisible) {
                        duckCounter.classList.add('hidden');
                    } else {
                        duckCounter.classList.remove('hidden');
                    }
                    document.getElementById('toggleDuckCounter')?.classList.toggle('active', duckCounterVisible);
                    console.log('[È¥®Â≠êË®àÊï∏] Â∑≤Â•óÁî®‰ΩçÁΩÆ:', data);
                } else {
                    // Ë®≠ÁΩÆÈ†êË®≠ÂÄºÂà∞ styleÔºàÁ¢∫‰øù‰øùÂ≠òÊôÇËÉΩËÆÄÂèñÔºâ
                    duckCounter.style.width = '200px';
                    duckCounter.style.height = '100px';
                    duckCounter.style.left = '50px';
                    duckCounter.style.top = '50px';
                    // Á∑©Â≠ò‰ΩøÁî®È†êË®≠ÂÄºÔºàÂ∑≤Âú®ËÅ≤ÊòéÊôÇË®≠ÂÆöÔºâ
                    // È†êË®≠Á∏ÆÊîæÔºàscale = 1Ôºâ
                    applyScalableBoxScale(duckCounter, 200, 100);
                    console.log('[È¥®Â≠êË®àÊï∏] ‰ΩøÁî®È†êË®≠‰ΩçÁΩÆ');
                }
            }

            // ‰øùÂ∫ïË®àÊï∏È°ØÁ§∫
            const pityCounter = document.getElementById('pityCounterBox');
            if (pityCounter) {
                if (savedPositions && savedPositions.pityCounter) {
                    const data = savedPositions.pityCounter;
                    const w = data.width || 180;
                    const h = data.height || 80;
                    const l = data.left || 50;
                    const t = data.top || 170;

                    pityCounter.style.width = w + 'px';
                    pityCounter.style.height = h + 'px';
                    pityCounter.style.left = l + 'px';
                    pityCounter.style.top = t + 'px';

                    // Êõ¥Êñ∞Á∑©Â≠ò
                    scalableBoxCache.pityCounterBox = { width: w, height: h, left: l, top: t };

                    // Â•óÁî®Á∏ÆÊîæ
                    applyScalableBoxScale(pityCounter, w, h);

                    pityCounterVisible = data.visible !== false;
                    if (!pityCounterVisible) {
                        pityCounter.classList.add('hidden');
                    } else {
                        pityCounter.classList.remove('hidden');
                    }
                    document.getElementById('togglePityCounter')?.classList.toggle('active', pityCounterVisible);
                    console.log('[‰øùÂ∫ïË®àÊï∏] Â∑≤Â•óÁî®‰ΩçÁΩÆ:', data);
                } else {
                    // Ë®≠ÁΩÆÈ†êË®≠ÂÄºÂà∞ styleÔºàÁ¢∫‰øù‰øùÂ≠òÊôÇËÉΩËÆÄÂèñÔºâ
                    pityCounter.style.width = '180px';
                    pityCounter.style.height = '80px';
                    pityCounter.style.left = '50px';
                    pityCounter.style.top = '170px';
                    // Á∑©Â≠ò‰ΩøÁî®È†êË®≠ÂÄºÔºàÂ∑≤Âú®ËÅ≤ÊòéÊôÇË®≠ÂÆöÔºâ
                    // È†êË®≠Á∏ÆÊîæÔºàscale = 1Ôºâ
                    applyScalableBoxScale(pityCounter, 180, 80);
                    console.log('[‰øùÂ∫ïË®àÊï∏] ‰ΩøÁî®È†êË®≠‰ΩçÁΩÆ');
                }
            }

            // ÊéíË°åÊ¶úÈ°ØÁ§∫
            const leaderboard = document.getElementById('leaderboardBox');
            if (leaderboard) {
                if (savedPositions && savedPositions.leaderboard) {
                    const data = savedPositions.leaderboard;
                    const w = data.width || 320;
                    const h = data.height || 100;
                    const l = data.left || 50;
                    const t = data.top || 300;

                    leaderboard.style.width = w + 'px';
                    leaderboard.style.height = h + 'px';
                    leaderboard.style.left = l + 'px';
                    leaderboard.style.top = t + 'px';

                    // Êõ¥Êñ∞Á∑©Â≠ò
                    scalableBoxCache.leaderboardBox = { width: w, height: h, left: l, top: t };

                    // Â•óÁî®Á∏ÆÊîæ
                    applyScalableBoxScale(leaderboard, w, h);

                    leaderboardVisible = data.visible !== false;
                    if (!leaderboardVisible) {
                        leaderboard.classList.add('hidden');
                    } else {
                        leaderboard.classList.remove('hidden');
                    }
                    document.getElementById('toggleLeaderboard')?.classList.toggle('active', leaderboardVisible);
                    console.log('[ÊéíË°åÊ¶ú] Â∑≤Â•óÁî®‰ΩçÁΩÆ:', data);
                } else {
                    // Ë®≠ÁΩÆÈ†êË®≠ÂÄºÂà∞ styleÔºàÁ¢∫‰øù‰øùÂ≠òÊôÇËÉΩËÆÄÂèñÔºâ
                    leaderboard.style.width = '320px';
                    leaderboard.style.height = '100px';
                    leaderboard.style.left = '50px';
                    leaderboard.style.top = '300px';
                    // Á∑©Â≠ò‰ΩøÁî®È†êË®≠ÂÄºÔºàÂ∑≤Âú®ËÅ≤ÊòéÊôÇË®≠ÂÆöÔºâ
                    // È†êË®≠Á∏ÆÊîæ
                    applyScalableBoxScale(leaderboard, 320, 100);
                    console.log('[ÊéíË°åÊ¶ú] ‰ΩøÁî®È†êË®≠‰ΩçÁΩÆ');
                }
            }

            // Á¶ÆÁâ©ÂúñÈ°ØÁ§∫
            const giftImageDisplay = document.getElementById('giftImageDisplay');
            if (giftImageDisplay) {
                if (savedPositions && savedPositions.giftImage) {
                    const data = savedPositions.giftImage;
                    // Â•óÁî®Â∞∫ÂØ∏
                    if (data.width !== undefined && data.width > 0) {
                        giftImageDisplay.style.width = data.width + 'px';
                    }
                    if (data.height !== undefined && data.height > 0) {
                        giftImageDisplay.style.height = data.height + 'px';
                    }
                    // Â•óÁî®‰ΩçÁΩÆ
                    if (data.left !== undefined) giftImageDisplay.style.left = data.left + 'px';
                    if (data.top !== undefined) giftImageDisplay.style.top = data.top + 'px';
                    // Á¶ÆÁâ©Âúñ‰ΩøÁî® transform ÁΩÆ‰∏≠ÔºåÈúÄË¶ÅÁßªÈô§ÁΩÆ‰∏≠ÊïàÊûúÊâçËÉΩ‰ΩøÁî®Ëá™ÂÆöÁæ©‰ΩçÁΩÆ
                    if (data.left !== undefined || data.top !== undefined) {
                        giftImageDisplay.style.transform = 'none';
                    }
                    // ‰øùÂ≠òÂéüÂßãÂ∞∫ÂØ∏Âà∞ datasetÔºàÁî®ÊñºÂæåÁ∫åÁ∏ÆÊîæË®àÁÆóÔºâ
                    if (data.originalWidth > 0) {
                        giftImageDisplay.dataset.originalWidth = data.originalWidth;
                    }
                    if (data.originalHeight > 0) {
                        giftImageDisplay.dataset.originalHeight = data.originalHeight;
                    }
                    // Â¶ÇÊûúÊúâ‰øùÂ≠òÁöÑÁ¶ÆÁâ©ÂúñË≥áÊñôÔºåÊÅ¢Âæ©ÂÖßÂÆπ
                    if (data.data && data.visible) {
                        // Âª∂ÈÅ≤Âü∑Ë°å‰ª•Á¢∫‰øùÂáΩÊï∏Â∑≤ÂÆöÁæ©
                        setTimeout(() => {
                            showGiftImageOnGreenScreen(data.data);
                            // ÊÅ¢Âæ©Á∏ÆÊîæ
                            const wrapper = giftImageDisplay.querySelector('.gift-image-wrapper');
                            if (wrapper && data.originalWidth > 0 && data.originalHeight > 0 && data.width > 0 && data.height > 0) {
                                const scaleX = data.width / data.originalWidth;
                                const scaleY = data.height / data.originalHeight;
                                const scale = Math.min(scaleX, scaleY);
                                wrapper.style.transform = `scale(${scale})`;
                            }
                        }, 100);
                    }
                    console.log('[Á¶ÆÁâ©Âúñ] Â∑≤Â•óÁî®‰ΩçÁΩÆ:', data);
                }
            }
        }

        // ËºâÂÖ•Áõ≤ÁõíÈÅ∏È†Ö
        async function loadGiftboxOptions() {
            try {
                if (window.pywebview && window.pywebview.api) {
                    giftboxOptions = await pywebview.api.get_giftbox_options();
                } else {
                    giftboxOptions = [
                        { name: 'Â§ßÁçé', color: '#ffd93d', weight: 1 },
                        { name: '‰∏≠Áçé', color: '#4ecca3', weight: 2 },
                        { name: 'Â∞èÁçé', color: '#00d9ff', weight: 3 },
                        { name: 'Ë¨ùË¨ùÂèÉËàá', color: '#e94560', weight: 4 }
                    ];
                }
            } catch (e) {
                giftboxOptions = [
                    { name: 'Â§ßÁçé', color: '#ffd93d', weight: 1 },
                    { name: '‰∏≠Áçé', color: '#4ecca3', weight: 2 },
                    { name: 'Â∞èÁçé', color: '#00d9ff', weight: 3 },
                    { name: 'Ë¨ùË¨ùÂèÉËàá', color: '#e94560', weight: 4 }
                ];
            }
        }

        // ËºâÂÖ•Ê®°ÁµÑÁãÄÊÖãÔºà‰∏ªÊéßÂè∞ÁöÑÊ®°ÁµÑÈñãÈóúÔºâ
        async function loadModuleStatus() {
            try {
                if (window.pywebview && window.pywebview.api) {
                    const status = await pywebview.api.get_module_status();

                    wheelModuleEnabled = status.wheel_enabled;
                    giftboxModuleEnabled = status.giftbox_enabled;
                    updateWheelTestButton();
                    updateGiftboxTestButton();

                    // Â¶ÇÊûú‰∏ªÊéßÂè∞ÈóúÈñâ‰∫ÜËΩâÁõ§Ê®°ÁµÑÔºåÂº∑Âà∂Èö±Ëóè
                    if (!status.wheel_enabled) {
                        wheelVisible = false;
                        setElementVisible(document.getElementById('wheelContainer'), false);
                        document.getElementById('wheelCheck').textContent = '';
                        document.getElementById('toggleWheel').classList.remove('active');
                    }

                    // Ê†πÊìöÁõ≤ÁõíÊ®°ÁµÑÁãÄÊÖãË®≠ÂÆöÂèØË¶ãÊÄß
                    if (status.giftbox_enabled) {
                        giftboxVisible = true;
                        setElementVisible(document.getElementById('giftboxContainer'), true);
                        document.getElementById('giftboxCheck').textContent = '‚úì';
                        document.getElementById('toggleGiftbox').classList.add('active');
                    } else {
                        giftboxVisible = false;
                        setElementVisible(document.getElementById('giftboxContainer'), false);
                        document.getElementById('giftboxCheck').textContent = '';
                        document.getElementById('toggleGiftbox').classList.remove('active');
                    }

                    // Â¶ÇÊûú‰∏ªÊéßÂè∞ÈóúÈñâ‰∫ÜÂΩ±ÁâáÊ®°ÁµÑÔºåÂº∑Âà∂Èö±ËóèÊâÄÊúâÂΩ±ÁâáÂÆπÂô®
                    if (!status.video_enabled) {
                        videoVisible = false;
                        document.querySelectorAll('.video-container').forEach(vc => {
                            setElementVisible(vc, false);
                        });
                        document.getElementById('videoCheck').textContent = '';
                        document.getElementById('toggleVideo').classList.remove('active');
                    }
                }
            } catch (e) {
                console.error('[Ê®°ÁµÑÁãÄÊÖã] ËºâÂÖ•Â§±Êïó:', e);
            }
        }

        // ËºâÂÖ•ÂΩ±ÁâáÂàóË°®‰∏¶ÁîüÊàêÂÆπÂô®
        async function loadVideoGifts() {
            try {
                if (window.pywebview && window.pywebview.api) {
                    // ‰ΩøÁî®Áï∂ÂâçÂ†¥ÊôØÁöÑÂΩ±ÁâáË®≠ÂÆö
                    const activeScene = await pywebview.api.get_active_scene();
                    videoGifts = (activeScene && activeScene.video_gifts) || [];
                    renderVideoList();
                    generateVideoContainers();
                }
            } catch (e) {
                console.error('ËºâÂÖ•ÂΩ±ÁâáÂàóË°®Â§±Êïó:', e);
                document.getElementById('videoList').innerHTML = '<div class="empty-list">ËºâÂÖ•Â§±Êïó</div>';
            }
        }

        // ÁîüÊàêÂΩ±ÁâáÂÆπÂô®
        function generateVideoContainers() {
            const area = document.getElementById('videoContainersArea');
            area.innerHTML = '';

            // Âæû savedPositions ÂèñÂæóÂΩ±ÁâáÂÆπÂô®Ë≥áÊñô
            const savedVideoData = (savedPositions && savedPositions.videoContainers) || {};

            videoGifts.forEach((gift, index) => {
                if (!gift.video_path) return;

                // ÂèñÂæóÂÑ≤Â≠òÁöÑË≥áÊñô
                const saved = savedVideoData[index] || {};

                // Ë®àÁÆóÂÆπÂô®Â±¨ÊÄßÔºàÂÑ™ÂÖà‰ΩøÁî®ÂÑ≤Â≠òÁöÑÂÄºÔºâ
                const width = Math.max(50, saved.width || 300);
                const height = Math.max(50, saved.height || 200);
                const left = saved.left ?? (50 + (index % 3) * 320);
                const top = saved.top ?? (100 + Math.floor(index / 3) * 220);
                const visible = (saved.visible !== false) && (gift.visible !== false);

                // Ë£ÅÂàáÁãÄÊÖã
                const cropLeft = saved.cropLeft || 0;
                const cropTop = saved.cropTop || 0;
                const originalWidth = saved.originalWidth || width;
                const originalHeight = saved.originalHeight || height;

                // ÂÑ≤Â≠òÂà∞ videoContainers ‰æõÂæåÁ∫å‰ΩøÁî®
                videoContainers[index] = {
                    visible, width, height, left, top,
                    cropLeft, cropTop, originalWidth, originalHeight
                };

                // ÂÑ≤Â≠òË£ÅÂàáÁãÄÊÖã
                videoCropState[index] = { cropLeft, cropTop, originalWidth, originalHeight };

                console.log(`[ÂÆπÂô® ${index}] Â∞∫ÂØ∏:${width}x${height} ‰ΩçÁΩÆ:(${left},${top}) È°ØÁ§∫:${visible} Ë£ÅÂàá:(${cropLeft},${cropTop}) ÂéüÂßã:${originalWidth}x${originalHeight}`);

                // Âª∫Á´ãÂÆπÂô®ÂÖÉÁ¥†
                const container = document.createElement('div');
                container.className = 'draggable video-container';
                container.id = `videoContainer_${index}`;
                container.dataset.index = index;
                container.style.width = width + 'px';
                container.style.height = height + 'px';
                container.style.left = left + 'px';
                container.style.top = top + 'px';

                // ÊòéÁ¢∫Ë®≠ÂÆöÈ°ØÁ§∫ÁãÄÊÖã
                setElementVisible(container, visible);

                container.innerHTML = `
                    <video class="thumbnail-video" muted preload="metadata" src="${formatVideoPath(gift.video_path)}"></video>
                    <video class="video-player"></video>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle n"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle sw"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle se"></div>
                `;

                area.appendChild(container);

                // Ë®≠ÂÆöÁ∏ÆÂúñÂíåÂΩ±ÁâáÁöÑË£ÅÂàáÊ®£Âºè
                const thumbnail = container.querySelector('.thumbnail-video');
                const player = container.querySelector('.video-player');

                thumbnail.style.width = originalWidth + 'px';
                thumbnail.style.height = originalHeight + 'px';
                thumbnail.style.left = -cropLeft + 'px';
                thumbnail.style.top = -cropTop + 'px';
                thumbnail.style.position = 'absolute';

                player.style.width = originalWidth + 'px';
                player.style.height = originalHeight + 'px';
                player.style.left = -cropLeft + 'px';
                player.style.top = -cropTop + 'px';
                player.style.position = 'absolute';

                // Ë®≠ÂÆöÁ∏ÆÂúñËºâÂÖ•‰∫ã‰ª∂
                thumbnail.onloadedmetadata = () => {
                    console.log(`[Á∏ÆÂúñ] ÂÆπÂô® ${index} ËºâÂÖ•ÊàêÂäü`);
                    try { thumbnail.currentTime = 1; } catch (e) {}
                };
                thumbnail.onerror = (e) => {
                    console.error(`[Á∏ÆÂúñ] ÂÆπÂô® ${index} ËºâÂÖ•Â§±Êïó:`, thumbnail.src, e);
                    thumbnail.style.display = 'none';
                    container.style.background = 'rgba(255, 0, 0, 0.3)';
                };
            });

            // ÈáçÊñ∞ÂàùÂßãÂåñÊãñÊõ≥ÂíåÁ∏ÆÊîæ
            initDraggable();
            initResizable();

            // Â•óÁî®ÂÑ≤Â≠òÁöÑÂúñÂ±§È†ÜÂ∫èÂà∞ÂΩ±ÁâáÂÆπÂô®
            if (savedPositions && savedPositions.elementZIndexes) {
                document.querySelectorAll('.video-container').forEach(vc => {
                    const key = vc.dataset.index;
                    if (savedPositions.elementZIndexes[key]) {
                        vc.style.zIndex = savedPositions.elementZIndexes[key];
                        elementZIndexes[key] = savedPositions.elementZIndexes[key];
                    }
                });
            }
        }

        // Ê∏≤ÊüìÂΩ±ÁâáÂàóË°®
        function renderVideoList() {
            const container = document.getElementById('videoList');

            if (videoGifts.length === 0) {
                container.innerHTML = '<div class="empty-list">Â∞öÁÑ°ÂΩ±ÁâáË®≠ÂÆö<br><small>Ë´ãÂú®‰∏ªÊéßÂè∞Êñ∞Â¢ûÂΩ±ÁâáËß∏Áôº</small></div>';
                return;
            }

            const typeLabels = { gift: 'Á¶ÆÁâ©', chat: 'ÂΩàÂπï', like: 'ÈªûËÆö' };

            container.innerHTML = videoGifts.map((gift, index) => {
                const isVisible = gift.visible !== false;
                const videoPath = gift.video_path || '';

                return `
                    <div class="video-item ${!isVisible ? 'hidden-item' : ''}" data-index="${index}">
                        <div class="video-thumbnail">
                            ${videoPath ? `<video src="${formatVideoPath(videoPath)}" muted preload="metadata" onloadedmetadata="this.currentTime=1" onerror="console.error('[ÂàóË°®Á∏ÆÂúñ] ËºâÂÖ•Â§±Êïó:', this.src); this.parentElement.innerHTML='<div class=\\'no-video\\'>‚ùå</div>'"></video>` : '<div class="no-video">üé¨</div>'}
                        </div>
                        <div class="video-info">
                            <div class="video-name">${gift.name || 'Êú™ÂëΩÂêç'}</div>
                            <div class="video-type">${typeLabels[gift.trigger_type] || 'Á¶ÆÁâ©'}</div>
                        </div>
                        <div class="video-actions">
                            <button class="debug-btn small" onclick="testVideoByIndex(${index})">‚ñ∂Ô∏è Ê∏¨Ë©¶</button>
                            <button class="debug-btn small ${isVisible ? 'secondary' : 'danger'}" onclick="toggleVideoGiftVisible(${index})">
                                ${isVisible ? 'üëÅÔ∏è È°ØÁ§∫' : 'üö´ Èö±Ëóè'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Ê†ºÂºèÂåñÂΩ±ÁâáË∑ØÂæë - ‰ΩøÁî®Êú¨Âú∞Ê™îÊ°à‰º∫ÊúçÂô®
        const FILE_SERVER_PORT = 18888;

        function formatVideoPath(path) {
            if (!path) return '';
            // ‰ΩøÁî®Êú¨Âú∞‰º∫ÊúçÂô®Êèê‰æõÂΩ±Áâá (Ê≥®ÊÑè: /media Ë∑ØÂæë)
            return `http://127.0.0.1:${FILE_SERVER_PORT}/media?path=${encodeURIComponent(path)}`;
        }

        // Ê∏¨Ë©¶ÂñÆÂÄãÂΩ±Áâá
        async function testVideoByIndex(index) {
            const gift = videoGifts[index];
            if (!gift || !gift.video_path) return;

            triggerVideoInContainer(index, {
                path: gift.video_path,
                speed: gift.video_speed || 1.0,
                volume: gift.video_volume || 100,
                seconds: gift.video_seconds || 0,
                repeat: 1
            });
        }

        // Âú®ÊåáÂÆöÂÆπÂô®Êí≠ÊîæÂΩ±Áâá
        function triggerVideoInContainer(index, videoData) {
            console.log(`[DEBUG] triggerVideoInContainer Ë¢´ÂëºÂè´: index=${index}, path=${videoData.path}, count=${videoData.count || 1}`);

            const container = document.getElementById(`videoContainer_${index}`);
            if (!container) {
                console.error(`[ERROR] Êâæ‰∏çÂà∞ÂΩ±ÁâáÂÆπÂô®: videoContainer_${index}`);
                // ÂàóÂá∫ÊâÄÊúâÁèæÊúâÂÆπÂô®
                const allContainers = document.querySelectorAll('.video-container');
                console.log(`[DEBUG] ÁèæÊúâÂÆπÂô®Êï∏Èáè: ${allContainers.length}`);
                allContainers.forEach(c => console.log(`  - ${c.id}`));
                return;
            }

            console.log(`[DEBUG] ÊâæÂà∞ÂÆπÂô®: ${container.id}, Â∞∫ÂØ∏: ${container.offsetWidth}x${container.offsetHeight}`);

            // ÂàùÂßãÂåñÂÆπÂô®ÁãÄÊÖã
            if (!containerPlayingState[index]) {
                containerPlayingState[index] = { isPlaying: false, queue: [], wasHidden: false };
            }

            const state = containerPlayingState[index];

            // Ê™¢Êü•ÂÆπÂô®ÊòØÂê¶Ë¢´Èö±ËóèÔºåÂ¶ÇÊûúÊòØÁöÑË©±Ë®òÈåÑ‰∏¶Êö´ÊôÇÈ°ØÁ§∫
            if (container.classList.contains('hidden') && !state.isPlaying) {
                state.wasHidden = true;
                // Êö´ÊôÇÈ°ØÁ§∫ÂÆπÂô®
                container.classList.remove('hidden');
                container.style.display = 'block';
                container.style.visibility = 'visible';
                container.style.opacity = '1';
                console.log(`ÂÆπÂô® [${index}] ÂéüÊú¨Èö±ËóèÔºåÊö´ÊôÇÈ°ØÁ§∫‰ª•Êí≠ÊîæÂΩ±Áâá`);
            }

            // Ê†πÊìö count Âä†ÂÖ•‰ΩáÂàóÔºàÈÄÅÂπæÂÄãÁ¶ÆÁâ©Â∞±Êí≠ÊîæÂπæÊ¨°Ôºâ
            const playCount = Math.min(videoData.count || 1, 100);  // ÊúÄÂ§ö 100 Ê¨°ÔºåÈÅøÂÖçÈÅéÂ§ö
            const priority = videoData.priority || 1;  // È†êË®≠ÂÑ™ÂÖàÁ¥ö 1

            for (let i = 0; i < playCount; i++) {
                const newItem = {...videoData, count: 1, priority: priority};

                // Ê†πÊìöÂÑ™ÂÖàÁ¥öÊèíÂÖ•‰ΩáÂàóÔºàÊï∏Â≠óË∂äÂ§ßÂÑ™ÂÖàÁ¥öË∂äÈ´òÔºåÊéíË∂äÂâçÈù¢Ôºâ
                let inserted = false;
                for (let j = 0; j < state.queue.length; j++) {
                    if (priority > (state.queue[j].priority || 1)) {
                        state.queue.splice(j, 0, newItem);
                        inserted = true;
                        break;
                    }
                }
                if (!inserted) {
                    state.queue.push(newItem);
                }
            }
            console.log(`[DEBUG] Âä†ÂÖ•‰ΩáÂàó ${playCount} Ê¨° (ÂÑ™ÂÖàÁ¥ö: ${priority})ÔºåÁõÆÂâç‰ΩáÂàóÈï∑Â∫¶: ${state.queue.length}`);

            // Â¶ÇÊûúÊúâÂº∑Âà∂ÊèíÈöä‰∏îÊ≠£Âú®Êí≠ÊîæÔºåÂÅúÊ≠¢Áï∂ÂâçÊí≠Êîæ
            if (videoData.force_interrupt && state.isPlaying) {
                stopVideoInContainer(index);
            }

            playNextVideoInContainer(index);
        }

        // Êí≠ÊîæÂÆπÂô®‰∏≠ÁöÑ‰∏ã‰∏ÄÂÄãÂΩ±Áâá
        function playNextVideoInContainer(index) {
            const state = containerPlayingState[index];
            if (!state || state.isPlaying || state.queue.length === 0) return;

            const container = document.getElementById(`videoContainer_${index}`);
            if (!container) {
                console.error(`Êâæ‰∏çÂà∞ÂÆπÂô®: videoContainer_${index}`);
                return;
            }

            const data = state.queue.shift();
            if (!data.path) {
                playNextVideoInContainer(index);
                return;
            }

            state.isPlaying = true;

            const videoPlayer = container.querySelector('.video-player');
            const thumbnail = container.querySelector('.thumbnail-video');
            const videoSrc = formatVideoPath(data.path);

            console.log(`Ê∫ñÂÇôÊí≠ÊîæÂΩ±Áâá [${index}]:`, videoSrc);

            // Ê∏ÖÈô§ËàäÁöÑ‰∫ã‰ª∂
            videoPlayer.onloadedmetadata = null;
            videoPlayer.oncanplay = null;
            videoPlayer.onended = null;
            videoPlayer.onerror = null;
            videoPlayer.onloadeddata = null;

            let currentRepeat = 0;
            const maxRepeat = data.repeat || 1;
            let hasStarted = false;

            const startPlayback = () => {
                if (hasStarted) return;
                hasStarted = true;

                console.log(`[DEBUG] ÈñãÂßãÊí≠ÊîæÂΩ±Áâá [${index}]`);
                console.log(`[DEBUG] ÂÆπÂô®ÁãÄÊÖã: display=${container.style.display}, visibility=${container.style.visibility}, hidden=${container.classList.contains('hidden')}`);

                // Á¢∫‰øùÂÆπÂô®ÂèØË¶ã
                if (container.classList.contains('hidden')) {
                    container.classList.remove('hidden');
                    container.style.display = 'block';
                    container.style.visibility = 'visible';
                    container.style.opacity = '1';
                }

                // Á¢∫‰øùÂÆπÂô®Êúâ playing class
                container.classList.add('playing');
                console.log(`[DEBUG] ÂÆπÂô® playing class Â∑≤Ê∑ªÂä†: ${container.classList.contains('playing')}`);

                // Èö±ËóèÁ∏ÆÂúñ
                if (thumbnail) {
                    thumbnail.style.display = 'none';
                    thumbnail.style.visibility = 'hidden';
                }

                // Á¢∫‰øùÂΩ±ÁâáÊí≠ÊîæÂô®È°ØÁ§∫
                videoPlayer.style.display = 'block';
                videoPlayer.style.visibility = 'visible';
                videoPlayer.style.opacity = '1';
                videoPlayer.style.zIndex = '999';
                console.log(`[DEBUG] Êí≠ÊîæÂô®Ê®£ÂºèÂ∑≤Ë®≠ÁΩÆ: display=${videoPlayer.style.display}, visibility=${videoPlayer.style.visibility}`);

                // Á¢∫‰øùÊí≠ÊîæÂô®ÊúâÊ≠£Á¢∫ÁöÑÂ∞∫ÂØ∏Âíå‰ΩçÁΩÆÔºàÁπºÊâøË£ÅÂàáÁãÄÊÖãÔºâ
                const cropState = videoCropState[index];
                let playerWidth = container.offsetWidth || 300;
                let playerHeight = container.offsetHeight || 200;
                let playerLeft = 0;
                let playerTop = 0;

                if (cropState && cropState.originalWidth > 50 && cropState.originalHeight > 50) {
                    playerWidth = cropState.originalWidth;
                    playerHeight = cropState.originalHeight;
                    playerLeft = -(cropState.cropLeft || 0);
                    playerTop = -(cropState.cropTop || 0);
                }

                console.log(`[DEBUG] Êí≠ÊîæÂΩ±Áâá [${index}] Â∞∫ÂØ∏: ${playerWidth}x${playerHeight}, ÂÅèÁßª: ${playerLeft},${playerTop}`);

                videoPlayer.style.position = 'absolute';
                videoPlayer.style.width = playerWidth + 'px';
                videoPlayer.style.height = playerHeight + 'px';
                videoPlayer.style.left = playerLeft + 'px';
                videoPlayer.style.top = playerTop + 'px';

                if (data.seconds > 0) {
                    setTimeout(() => {
                        if (state.isPlaying) {
                            videoPlayer.pause();
                            handleVideoEndInContainer(index);
                        }
                    }, data.seconds * 1000);
                }

                videoPlayer.play().then(() => {
                    console.log(`ÂΩ±ÁâáÊí≠Êîæ‰∏≠ [${index}]`);
                }).catch((err) => {
                    console.error(`ÂΩ±ÁâáÊí≠ÊîæÂ§±Êïó [${index}]:`, err);
                    handleVideoEndInContainer(index);
                });
            };

            videoPlayer.onloadedmetadata = () => {
                console.log(`ÂΩ±Áâá metadata Â∑≤ËºâÂÖ• [${index}]`);
                startPlayback();
            };

            videoPlayer.onloadeddata = () => {
                console.log(`ÂΩ±ÁâáË≥áÊñôÂ∑≤ËºâÂÖ• [${index}]`);
                startPlayback();
            };

            videoPlayer.oncanplay = () => {
                console.log(`ÂΩ±ÁâáÂèØÊí≠Êîæ [${index}]`);
                startPlayback();
            };

            videoPlayer.onended = () => {
                console.log(`ÂΩ±ÁâáÊí≠ÊîæÁµêÊùü [${index}]`);
                currentRepeat++;
                if (currentRepeat < maxRepeat) {
                    videoPlayer.currentTime = 0;
                    videoPlayer.play();
                } else {
                    handleVideoEndInContainer(index);
                }
            };

            videoPlayer.onerror = (e) => {
                console.error(`ÂΩ±ÁâáËºâÂÖ•ÈåØË™§ [${index}]:`, e);
                handleVideoEndInContainer(index, true);  // ÂÇ≥ÈÅû isError = true
            };

            // Ë®≠ÂÆöÂΩ±ÁâáÊ∫ê
            videoPlayer.src = videoSrc;
            videoPlayer.playbackRate = data.speed || 1.0;
            videoPlayer.volume = (data.volume || 100) / 100;
            videoPlayer.muted = false;
            videoPlayer.load();

            // ÂÇôÁî®ÔºöÂ¶ÇÊûú 1 ÁßíÂæåÈÇÑÊ≤íÈñãÂßãÊí≠ÊîæÔºåÂº∑Âà∂ÂòóË©¶
            setTimeout(() => {
                if (!hasStarted && state.isPlaying) {
                    console.log(`Âº∑Âà∂ÂòóË©¶Êí≠Êîæ [${index}]`);
                    startPlayback();
                }
            }, 1000);
        }

        // ËôïÁêÜÂÆπÂô®ÂΩ±ÁâáÁµêÊùü
        function handleVideoEndInContainer(index, isError = false) {
            const state = containerPlayingState[index];
            if (!state) return;

            // Èò≤Ê≠¢ÈáçË§áËß∏Áôº
            if (!state.isPlaying) return;
            state.isPlaying = false;

            const container = document.getElementById(`videoContainer_${index}`);
            if (container) {
                container.classList.remove('playing');

                // Èö±ËóèÊí≠ÊîæÂô®ÔºåÈ°ØÁ§∫Á∏ÆÂúñ
                const videoPlayer = container.querySelector('.video-player');
                const thumbnail = container.querySelector('.thumbnail-video');

                if (videoPlayer) {
                    // ÂÖàÊ∏ÖÈô§ÊâÄÊúâ‰∫ã‰ª∂ÔºåÈò≤Ê≠¢ src='' Ëß∏Áôº onerror
                    videoPlayer.onloadedmetadata = null;
                    videoPlayer.onloadeddata = null;
                    videoPlayer.oncanplay = null;
                    videoPlayer.onended = null;
                    videoPlayer.onerror = null;

                    videoPlayer.pause();
                    videoPlayer.removeAttribute('src');
                    videoPlayer.load();  // ÈáçÁΩÆÂΩ±ÁâáÂÖÉÁ¥†
                    videoPlayer.style.display = 'none';
                }

                if (thumbnail) {
                    // ÂÆåÊï¥ÈáçÁΩÆÁ∏ÆÂúñÈ°ØÁ§∫ÁãÄÊÖã
                    thumbnail.style.display = 'block';
                    thumbnail.style.visibility = 'visible';
                    thumbnail.style.opacity = '1';

                    // ÈáçÊñ∞Ë®≠ÂÆö currentTime ‰ª•È°ØÁ§∫Á∏ÆÂúñÁï´Èù¢
                    // ÔºàÊí≠ÊîæÂô®ÂèØËÉΩÂΩ±Èüø‰∫ÜÁ∏ÆÂúñÁöÑÊôÇÈñì‰ΩçÁΩÆÔºâ
                    try {
                        if (thumbnail.readyState >= 1) {
                            thumbnail.currentTime = 1;
                        } else {
                            // Â¶ÇÊûúÁ∏ÆÂúñÂ∞öÊú™ËºâÂÖ•ÔºåÈáçÊñ∞ËºâÂÖ•
                            const src = thumbnail.src;
                            if (src) {
                                thumbnail.onloadedmetadata = () => {
                                    thumbnail.currentTime = 1;
                                };
                                thumbnail.load();
                            }
                        }
                    } catch (e) {
                        console.warn(`[WARN] ÈáçÁΩÆÁ∏ÆÂúñÊôÇÈñìÂ§±Êïó [${index}]:`, e);
                    }
                }
            }

            console.log(`ÂΩ±ÁâáÂÆπÂô® [${index}] Êí≠ÊîæÂÆåÊàê${isError ? ' (ÁôºÁîüÈåØË™§)' : ''}`);

            // Â¶ÇÊûúÊòØÈåØË™§ÔºåÊ∏ÖÁ©∫‰ΩáÂàóÈÅøÂÖçÁÑ°ÈôêÈáçË©¶
            if (isError) {
                state.queue = [];
            }

            // Ê™¢Êü•‰ΩáÂàóÊòØÂê¶ÈÇÑÊúâÂΩ±Áâá
            if (state.queue.length > 0) {
                // ÈÇÑÊúâÂΩ±ÁâáË¶ÅÊí≠ÊîæÔºåÂª∂ÈÅ≤‰∏Ä‰∏ãÂÜçÊí≠Êîæ
                setTimeout(() => playNextVideoInContainer(index), 100);
            } else {
                // ‰ΩáÂàóÂ∑≤Á©∫ÔºåÂ¶ÇÊûúÂéüÊú¨ÊòØÈö±ËóèÁöÑÔºåÊÅ¢Âæ©Èö±ËóèÁãÄÊÖã
                if (state.wasHidden && container) {
                    container.classList.add('hidden');
                    container.style.display = 'none';
                    container.style.visibility = 'hidden';
                    container.style.opacity = '0';
                    console.log(`ÂÆπÂô® [${index}] Êí≠ÊîæÂÆåÊàêÔºåÊÅ¢Âæ©Èö±ËóèÁãÄÊÖã`);
                }
                // ÈáçÁΩÆ wasHidden ÁãÄÊÖã
                state.wasHidden = false;
            }
        }

        // ÂÅúÊ≠¢ÂÆπÂô®‰∏≠ÁöÑÂΩ±Áâá
        function stopVideoInContainer(index) {
            const container = document.getElementById(`videoContainer_${index}`);
            if (!container) return;

            const videoPlayer = container.querySelector('.video-player');
            const thumbnail = container.querySelector('.thumbnail-video');

            if (videoPlayer) {
                // ÂÖàÊ∏ÖÈô§ÊâÄÊúâ‰∫ã‰ª∂
                videoPlayer.onloadedmetadata = null;
                videoPlayer.onloadeddata = null;
                videoPlayer.oncanplay = null;
                videoPlayer.onended = null;
                videoPlayer.onerror = null;

                videoPlayer.pause();
                videoPlayer.removeAttribute('src');
                videoPlayer.load();
                videoPlayer.style.display = 'none';
            }

            if (thumbnail) {
                // ÂÆåÊï¥ÈáçÁΩÆÁ∏ÆÂúñÈ°ØÁ§∫ÁãÄÊÖã
                thumbnail.style.display = 'block';
                thumbnail.style.visibility = 'visible';
                thumbnail.style.opacity = '1';

                // ÈáçÊñ∞Ë®≠ÂÆö currentTime ‰ª•È°ØÁ§∫Á∏ÆÂúñÁï´Èù¢
                try {
                    if (thumbnail.readyState >= 1) {
                        thumbnail.currentTime = 1;
                    }
                } catch (e) {
                    console.warn(`[WARN] ÂÅúÊ≠¢ÊôÇÈáçÁΩÆÁ∏ÆÂúñÊôÇÈñìÂ§±Êïó [${index}]:`, e);
                }
            }

            container.classList.remove('playing');

            const state = containerPlayingState[index];
            if (state) {
                state.isPlaying = false;
                // ÂÅúÊ≠¢ÊôÇ‰∏çÊÅ¢Âæ©Èö±ËóèÁãÄÊÖãÔºàÂõ†ÁÇ∫ÊòØÂº∑Âà∂‰∏≠Êñ∑ÔºåÊúÉÁ´ãÂç≥Êí≠Êîæ‰∏ã‰∏ÄÂÄãÔºâ
            }
        }

        // ÂàáÊèõÂΩ±ÁâáÈ°ØÁ§∫/Èö±Ëóè
        async function toggleVideoGiftVisible(index) {
            if (!videoGifts[index]) return;

            const gift = videoGifts[index];
            gift.visible = gift.visible === false ? true : false;

            // Êõ¥Êñ∞ÂÆπÂô®ÁãÄÊÖã
            if (videoContainers[index]) {
                videoContainers[index].visible = gift.visible;
            }

            // Êõ¥Êñ∞Á∂†Âπï‰∏äÁöÑÂÆπÂô®
            const container = document.getElementById(`videoContainer_${index}`);
            if (container) {
                setElementVisible(container, gift.visible);
            }

            // ÈáçË¶ÅÔºöÂÖà‰øùÂ≠òÁï∂ÂâçÊâÄÊúâÂÆπÂô®ÁöÑ‰ΩçÁΩÆÂíåË£ÅÂàáÁãÄÊÖã
            await savePositions();

            try {
                if (window.pywebview && window.pywebview.api) {
                    // Ê®ôË®òÈÄôÊòØÂÉÖÂèØË¶ãÊÄßÊõ¥Êñ∞Ôºå‰∏çÈúÄË¶ÅÈáçÊñ∞ÁîüÊàêÂÆπÂô®
                    window._skipContainerRegeneration = true;
                    // ‰ΩøÁî®Â†¥ÊôØ API Êõ¥Êñ∞ÂΩ±ÁâáË®≠ÂÆö
                    const scenes = await pywebview.api.get_scenes();
                    const activeSceneId = scenes.activeSceneId || 'default';
                    await pywebview.api.update_scene_video_gifts(activeSceneId, videoGifts);
                    // Âª∂ÈÅ≤ÈáçÁΩÆÊ®ôË®òÔºåÁ¢∫‰øù configUpdated ‰∫ã‰ª∂Â∑≤ËôïÁêÜ
                    setTimeout(() => { window._skipContainerRegeneration = false; }, 100);
                }
            } catch (e) {
                console.error('Êõ¥Êñ∞Â§±Êïó:', e);
                window._skipContainerRegeneration = false;
            }

            renderVideoList();
        }

        function waitForPywebview() {
            return new Promise((resolve) => {
                // Ê™¢Êü• API ÊòØÂê¶ÂÆåÂÖ®ÂèØÁî®ÔºàÂåÖÊã¨ÂÖ∑È´îÊñπÊ≥ïÔºâ
                const checkApi = () => {
                    if (window.pywebview && window.pywebview.api &&
                        typeof window.pywebview.api.get_greenscreen_positions === 'function') {
                        console.log('[DEBUG] pywebview API Â∑≤Â∞±Á∑í');
                        resolve();
                        return true;
                    }
                    return false;
                };

                if (checkApi()) return;

                // Áõ£ËÅΩ pywebviewready ‰∫ã‰ª∂
                window.addEventListener('pywebviewready', () => {
                    // ‰∫ã‰ª∂Ëß∏ÁôºÂæå‰ªçÈúÄÁ≠âÂæÖ API ÊñπÊ≥ïÁ∂ÅÂÆö
                    let attempts = 0;
                    const waitInterval = setInterval(() => {
                        attempts++;
                        if (checkApi() || attempts > 50) {
                            clearInterval(waitInterval);
                            if (attempts > 50) {
                                console.warn('[WARN] Á≠âÂæÖ pywebview API Ë∂ÖÊôÇ');
                                resolve();
                            }
                        }
                    }, 100);
                });

                // ÂÇôÁî®ÔºöËº™Ë©¢Ê™¢Êü•
                let pollAttempts = 0;
                const pollInterval = setInterval(() => {
                    pollAttempts++;
                    if (checkApi() || pollAttempts > 50) {
                        clearInterval(pollInterval);
                        if (pollAttempts > 50) {
                            console.warn('[WARN] Ëº™Ë©¢Á≠âÂæÖ pywebview API Ë∂ÖÊôÇ');
                            resolve();
                        }
                    }
                }, 100);
            });
        }

        // === Ë¶ñÁ™óÊéßÂà∂ ===
        function closeWindow() {
            if (window.electronAPI && window.electronAPI.closeGreenScreen) {
                window.electronAPI.closeGreenScreen();
            } else {
                window.close();
            }
        }

        function minimizeWindow() {
            if (window.electronAPI && window.electronAPI.minimizeGreenScreen) {
                window.electronAPI.minimizeGreenScreen();
            }
        }

        function toggleMaximize() {
            if (window.electronAPI && window.electronAPI.toggleMaximizeGreenScreen) {
                window.electronAPI.toggleMaximizeGreenScreen();
            }
        }

        // È°ØÁ§∫ÊèêÁ§∫
        function showHint() {
            const hint = document.getElementById('debugHint');
            hint.classList.add('visible');
            setTimeout(() => hint.classList.remove('visible'), 3000);
        }

        // ÈçµÁõ§Âø´Êç∑Èçµ
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    toggleDebugPanel();
                }
            });
        }

        // ÂàáÊèõË™øË©¶Èù¢Êùø
        function toggleDebugPanel() {
            debugPanelVisible = !debugPanelVisible;
            const panel = document.getElementById('debugPanel');
            const check = document.getElementById('debugCheck');
            panel.classList.toggle('visible', debugPanelVisible);
            check.textContent = debugPanelVisible ? '‚úì' : '';

            if (debugPanelVisible) {
                document.body.classList.add('debug-mode');
                // Âè™Êõ¥Êñ∞ÂàóË°®Ôºå‰∏çÈáçÊñ∞ÁîüÊàêÂÆπÂô®
                refreshVideoListOnly();
            } else {
                document.body.classList.remove('debug-mode');
            }
        }

        // ÂàáÊèõÂèØÊäòÁñäÂçÄÂ°ä
        function toggleSection(header) {
            const section = header.parentElement;
            section.classList.toggle('collapsed');
        }

        // Âè™Êõ¥Êñ∞ÂΩ±ÁâáÂàóË°® UIÔºå‰∏çÈáçÊñ∞ÁîüÊàêÂÆπÂô®
        async function refreshVideoListOnly() {
            try {
                if (window.pywebview && window.pywebview.api) {
                    // ‰ΩøÁî®Áï∂ÂâçÂ†¥ÊôØÁöÑÂΩ±ÁâáË®≠ÂÆö
                    const activeScene = await pywebview.api.get_active_scene();
                    videoGifts = (activeScene && activeScene.video_gifts) || [];
                    renderVideoList();
                }
            } catch (e) {
                console.error('Êõ¥Êñ∞ÂΩ±ÁâáÂàóË°®Â§±Êïó:', e);
            }
        }

        // Áõ£ËÅΩË®äÊÅØ
        function initMessageListener() {
            console.log('=== ÂàùÂßãÂåñ‰∫ã‰ª∂Áõ£ËÅΩÂô® ===');

            // Áõ£ËÅΩ‰æÜËá™ Electron ‰∏ªÈÄ≤Á®ãÁöÑ‰∫ã‰ª∂
            if (window.electronAPI && window.electronAPI.onGreenScreenEvent) {
                console.log('Ë®≠ÂÆö electronAPI ‰∫ã‰ª∂Áõ£ËÅΩ');
                window.electronAPI.onGreenScreenEvent((event, data) => {
                    console.log('Êî∂Âà∞‰∏ªÈÄ≤Á®ã‰∫ã‰ª∂:', event, data);
                    // Ê¥æÁôºÂ∞çÊáâÁöÑËá™ÂÆöÁæ©‰∫ã‰ª∂
                    window.dispatchEvent(new CustomEvent(event, { detail: data }));
                });
            } else {
                console.warn('electronAPI.onGreenScreenEvent ‰∏çÂèØÁî®');
            }

            // Áõ£ËÅΩÈÖçÁΩÆÊõ¥Êñ∞ - Âç≥ÊôÇÂêåÊ≠•‰∏çÈúÄÈáçÈñã
            // ÈÖçÁΩÆÊõ¥Êñ∞ÁØÄÊµÅÔºàÈÅøÂÖçÈ†ªÁπÅÊõ¥Êñ∞ÈÄ†ÊàêÂç°È†ìÔºâ
            let configUpdateTimer = null;
            if (window.electronAPI && window.electronAPI.onConfigUpdate) {
                console.log('Ë®≠ÂÆöÈÖçÁΩÆÊõ¥Êñ∞Áõ£ËÅΩ');
                window.electronAPI.onConfigUpdate(async (config) => {
                    // ‰ΩøÁî®ÁØÄÊµÅÔºå300ms ÂÖßÂè™ËôïÁêÜÊúÄÂæå‰∏ÄÊ¨°
                    if (configUpdateTimer) clearTimeout(configUpdateTimer);
                    configUpdateTimer = setTimeout(async () => {
                        console.log('[ÈÖçÁΩÆÊõ¥Êñ∞] Êî∂Âà∞ÈÖçÁΩÆËÆäÊõ¥ÔºåÂç≥ÊôÇÂêåÊ≠•...');
                        // ÈáçÊñ∞ËºâÂÖ•ÈÄ≤Â†¥ÂàóË°®
                        await loadEntryList();
                        // ÈáçÊñ∞ËºâÂÖ•ÂΩ±ÁâáÂàóË°®
                        await loadVideoGifts();
                        // ÈáçÊñ∞ËºâÂÖ•ËΩâÁõ§ÈÅ∏È†Ö
                        await loadWheelOptions();
                        // ÈáçÊñ∞ËºâÂÖ•Áõ≤ÁõíÈÅ∏È†Ö
                        await loadGiftboxOptions();
                        console.log('[ÈÖçÁΩÆÊõ¥Êñ∞] ÂêåÊ≠•ÂÆåÊàê');
                    }, 300);
                });
            }

            window.addEventListener('triggerWheel', (event) => {
                const data = event.detail;
                console.log('Êî∂Âà∞ËΩâÁõ§‰∫ã‰ª∂:', data);
                triggerWheel(data.spins);
            });

            window.addEventListener('triggerVideo', (event) => {
                const data = event.detail;
                console.log('Êî∂Âà∞ÂΩ±Áâá‰∫ã‰ª∂:', data);
                triggerVideo(data);
            });

            // ÈÄ≤Â†¥ÊïàÊûú‰∫ã‰ª∂
            window.addEventListener('triggerEntry', (event) => {
                const data = event.detail;
                console.log('Êî∂Âà∞ÈÄ≤Â†¥‰∫ã‰ª∂:', data);
                triggerEntry(data);
            });

            // Áõ≤Áõí‰∫ã‰ª∂
            window.addEventListener('triggerGiftbox', (event) => {
                const data = event.detail;
                console.log('Êî∂Âà∞Áõ≤Áõí‰∫ã‰ª∂:', data);
                triggerGiftbox(data.opens);
            });

            // ÊäìÈ¥®Â≠êÂΩ±Áâá‰∫ã‰ª∂
            window.addEventListener('triggerDuckVideo', (event) => {
                playDuckVideo(event.detail);
            });

            // È¥®Â≠êË®àÊï∏Êõ¥Êñ∞‰∫ã‰ª∂
            window.addEventListener('updateDuckCount', (event) => {
                updateDuckCounter(event.detail.count);
            });

            // ‰øùÂ∫ïË®àÊï∏Êõ¥Êñ∞‰∫ã‰ª∂
            window.addEventListener('updatePityCounter', (event) => {
                updatePityCounter(event.detail);
            });

            // ÊéíË°åÊ¶úÊõ¥Êñ∞‰∫ã‰ª∂ÔºàÈùûÊäìÈ¥®Â≠ê‰æÜÊ∫êÁöÑÊõ¥Êñ∞ÔºåÂ¶ÇÊâãÂãïË™øÊï¥Ôºâ
            window.addEventListener('updateLeaderboard', (event) => {
                // Â¶ÇÊûú‰∏çÊòØÊäìÈ¥®Â≠êÂΩ±ÁâáÊí≠Êîæ‰∏≠ÔºåÁõ¥Êé•Êõ¥Êñ∞
                if (!duckVideoPlaying) {
                    updateLeaderboard(event.detail);
                }
                // ÊäìÈ¥®Â≠êÊúüÈñìÁöÑÊéíË°åÊ¶úÊõ¥Êñ∞Áî± triggerDuckVideo ‰∫ã‰ª∂ÂÖßÁöÑ leaderboardData ËôïÁêÜ
            });

            // ÈáåÁ®ãÁ¢ëÊÖ∂Á•ù‰∫ã‰ª∂
            window.addEventListener('triggerMilestone', (event) => {
                triggerMilestoneCelebration(event.detail);
            });

            // Á¶ÆÁâ©ÂúñÈ°ØÁ§∫‰∫ã‰ª∂
            window.addEventListener('showGiftImage', (event) => {
                showGiftImageOnGreenScreen(event.detail);
            });

            // Á¶ÆÁâ©ÂúñÈö±Ëóè‰∫ã‰ª∂
            window.addEventListener('hideGiftImage', () => {
                hideGiftImage();
            });

            // Á¶ÆÁâ©ÂúñÂåØÂá∫‰∫ã‰ª∂
            window.addEventListener('exportGiftImage', (event) => {
                exportGiftImageToFile(event.detail);
            });

            // ÂÖ®ÂüüÊ∏¨Ë©¶ÂáΩÊï∏ - ÂèØÂæûÊéßÂà∂Âè∞ÂëºÂè´
            window.testTriggerVideo = function(index) {
                console.log('Ê∏¨Ë©¶Ëß∏ÁôºÂΩ±Áâá:', index);
                if (videoGifts[index]) {
                    triggerVideoInContainer(index, {
                        path: videoGifts[index].video_path,
                        speed: 1.0,
                        volume: 100,
                        seconds: 0,
                        repeat: 1
                    });
                }
            };

            console.log('‰∫ã‰ª∂Áõ£ËÅΩÂô®Â∑≤Ë®ªÂÜäÔºåvideoGifts:', videoGifts);

            // Áõ£ËÅΩÊ®°ÁµÑÁãÄÊÖãËÆäÂåñ
            window.addEventListener('moduleStatusChanged', (event) => {
                const data = event.detail;
                console.log('Ê®°ÁµÑÁãÄÊÖãËÆäÂåñ:', data);

                if (data.module === 'wheel') {
                    wheelModuleEnabled = data.enabled;
                    updateWheelTestButton();

                    const wc = document.getElementById('wheelContainer');
                    if (data.enabled) {
                        wheelVisible = true;
                        wc.classList.remove('hidden');
                        wc.style.display = 'block';
                        document.getElementById('wheelCheck').textContent = '‚úì';
                        document.getElementById('toggleWheel').classList.add('active');
                    } else {
                        wheelVisible = false;
                        wc.classList.add('hidden');
                        wc.style.display = 'none';
                        document.getElementById('wheelCheck').textContent = '';
                        document.getElementById('toggleWheel').classList.remove('active');
                    }
                }

                if (data.module === 'giftbox') {
                    giftboxModuleEnabled = data.enabled;
                    updateGiftboxTestButton();

                    const gc = document.getElementById('giftboxContainer');
                    if (data.enabled) {
                        giftboxVisible = true;
                        gc.classList.remove('hidden');
                        gc.style.display = 'block';
                        document.getElementById('giftboxCheck').textContent = '‚úì';
                        document.getElementById('toggleGiftbox').classList.add('active');
                    } else {
                        giftboxVisible = false;
                        gc.classList.add('hidden');
                        gc.style.display = 'none';
                        document.getElementById('giftboxCheck').textContent = '';
                        document.getElementById('toggleGiftbox').classList.remove('active');
                    }
                }

                if (data.module === 'video') {
                    if (data.enabled) {
                        videoVisible = true;
                        document.querySelectorAll('.video-container').forEach(vc => {
                            const idx = vc.dataset.index;
                            // Âè™È°ØÁ§∫Êú™Ë¢´ÂñÆÁç®Èö±ËóèÁöÑÂÆπÂô®
                            if (videoGifts[idx]?.visible !== false) {
                                vc.classList.remove('hidden');
                                vc.style.display = 'block';
                                vc.style.visibility = 'visible';
                                vc.style.opacity = '1';
                            }
                        });
                        document.getElementById('videoCheck').textContent = '‚úì';
                        document.getElementById('toggleVideo').classList.add('active');
                    } else {
                        videoVisible = false;
                        document.querySelectorAll('.video-container').forEach(vc => {
                            vc.classList.add('hidden');
                            vc.style.display = 'none';
                            vc.style.visibility = 'hidden';
                            vc.style.opacity = '0';
                        });
                        document.getElementById('videoCheck').textContent = '';
                        document.getElementById('toggleVideo').classList.remove('active');
                    }
                }
            });

            // Áõ£ËÅØÈÖçÁΩÆÊõ¥Êñ∞
            window.addEventListener('configUpdated', async () => {
                console.log('[DEBUG] Êî∂Âà∞ configUpdated ‰∫ã‰ª∂');

                // Â¶ÇÊûúÊòØÂÉÖÂèØË¶ãÊÄßÊõ¥Êñ∞ÔºåË∑≥ÈÅéÂÆπÂô®ÈáçÊñ∞ÁîüÊàê
                if (window._skipContainerRegeneration) {
                    console.log('[DEBUG] Ë∑≥ÈÅéÂÆπÂô®ÈáçÊñ∞ÁîüÊàêÔºàÂÉÖÂèØË¶ãÊÄßÊõ¥Êñ∞Ôºâ');
                    // Âè™Êõ¥Êñ∞ÂΩ±ÁâáÂàóË°® UIÔºå‰∏çÈáçÊñ∞ÁîüÊàêÂÆπÂô®
                    await refreshVideoListOnly();
                    return;
                }

                // ‰øùÂ≠òÁï∂ÂâçÂÆπÂô®‰ΩçÁΩÆÂà∞ savedPositionsÔºåÈÅøÂÖçÈáçÊñ∞ÁîüÊàêÊôÇ‰ΩçÁΩÆË¢´ÈáçÁΩÆ
                if (savedPositions) {
                    // Âæû DOM Âíå videoCropState Êî∂ÈõÜÊúÄÊñ∞ÁãÄÊÖã
                    const currentVideoData = {};
                    document.querySelectorAll('.video-container').forEach(vc => {
                        const idx = parseInt(vc.dataset.index);
                        const crop = videoCropState[idx] || {};
                        const cached = videoContainers[idx] || {};

                        currentVideoData[idx] = {
                            width: vc.offsetWidth || parseInt(vc.style.width) || cached.width || 300,
                            height: vc.offsetHeight || parseInt(vc.style.height) || cached.height || 200,
                            left: vc.offsetLeft || parseInt(vc.style.left) || cached.left || 0,
                            top: vc.offsetTop || parseInt(vc.style.top) || cached.top || 0,
                            visible: !vc.classList.contains('hidden'),
                            cropLeft: crop.cropLeft || 0,
                            cropTop: crop.cropTop || 0,
                            originalWidth: crop.originalWidth || cached.originalWidth || vc.offsetWidth || 300,
                            originalHeight: crop.originalHeight || cached.originalHeight || vc.offsetHeight || 200
                        };
                        console.log(`[DEBUG] ÂÆπÂô® ${idx} ÁãÄÊÖã:`, currentVideoData[idx]);
                    });

                    // Êõ¥Êñ∞ videoContainers Âíå savedPositions
                    Object.assign(videoContainers, currentVideoData);
                    savedPositions.videoContainers = currentVideoData;
                    console.log('[DEBUG] Â∑≤‰øùÂ≠òÁï∂ÂâçÂÆπÂô®‰ΩçÁΩÆÂíåË£ÅÂàáÁãÄÊÖãÂà∞ savedPositions');
                }

                console.log('[DEBUG] ÈáçÊñ∞ËºâÂÖ•ÂΩ±ÁâáË®≠ÂÆö');
                await loadVideoGifts();
                // Âª∂ÈÅ≤ÂæåÈáçÊñ∞ËºâÂÖ•Á∏ÆÂúñÔºåÁ¢∫‰øù DOM Â∑≤Êõ¥Êñ∞
                setTimeout(() => {
                    console.log('[DEBUG] Âª∂ÈÅ≤ÈáçËºâÁ∏ÆÂúñ');
                    reloadAllThumbnails();
                }, 300);
            });

            window.addEventListener('message', (event) => {
                const data = event.data;
                if (!data || !data.type) return;

                if (data.type === 'wheel') {
                    triggerWheel(data.spins);
                } else if (data.type === 'video') {
                    triggerVideo(data);
                }
            });
        }

        async function loadWheelOptions() {
            try {
                if (window.pywebview && window.pywebview.api) {
                    wheelOptions = await pywebview.api.get_wheel_options();
                } else {
                    wheelOptions = [
                        { name: 'ÈÅ∏È†ÖA', color: '#e94560', weight: 1 },
                        { name: 'ÈÅ∏È†ÖB', color: '#4ecca3', weight: 1 },
                        { name: 'ÈÅ∏È†ÖC', color: '#00d9ff', weight: 1 },
                        { name: 'ÈÅ∏È†ÖD', color: '#ffd93d', weight: 1 }
                    ];
                }
            } catch (e) {
                wheelOptions = [
                    { name: 'ÈÅ∏È†ÖA', color: '#e94560', weight: 1 },
                    { name: 'ÈÅ∏È†ÖB', color: '#4ecca3', weight: 1 },
                    { name: 'ÈÅ∏È†ÖC', color: '#00d9ff', weight: 1 },
                    { name: 'ÈÅ∏È†ÖD', color: '#ffd93d', weight: 1 }
                ];
            }
        }

        // === È°ØÁ§∫ÊéßÂà∂ ===
        function toggleWheelVisibility() {
            wheelVisible = !wheelVisible;
            setElementVisible(document.getElementById('wheelContainer'), wheelVisible);
            document.getElementById('wheelCheck').textContent = wheelVisible ? '‚úì' : '';
            document.getElementById('toggleWheel').classList.toggle('active', wheelVisible);
            savePositions();
        }

        function toggleGiftboxVisibility() {
            giftboxVisible = !giftboxVisible;
            setElementVisible(document.getElementById('giftboxContainer'), giftboxVisible);
            document.getElementById('giftboxCheck').textContent = giftboxVisible ? '‚úì' : '';
            document.getElementById('toggleGiftbox').classList.toggle('active', giftboxVisible);
            savePositions();
        }

        function toggleGiftboxAutoHide() {
            giftboxAutoHide = !giftboxAutoHide;
            const container = document.getElementById('giftboxContainer');
            container.classList.toggle('auto-hidden', giftboxAutoHide);
            document.getElementById('giftboxAutoHideCheck').textContent = giftboxAutoHide ? '‚úì' : '';
            document.getElementById('toggleGiftboxAutoHide').classList.toggle('active', giftboxAutoHide);
            savePositions();
        }

        function toggleVideoVisibility() {
            videoVisible = !videoVisible;
            document.querySelectorAll('.video-container').forEach(vc => {
                const idx = parseInt(vc.dataset.index);
                // Âè™È°ØÁ§∫Êú™Ë¢´ÂñÆÁç®Èö±ËóèÁöÑÂÆπÂô®
                const shouldShow = videoVisible && (videoGifts[idx]?.visible !== false);
                setElementVisible(vc, shouldShow);
            });
            document.getElementById('videoCheck').textContent = videoVisible ? '‚úì' : '';
            document.getElementById('toggleVideo').classList.toggle('active', videoVisible);
            savePositions();
        }

        // ÈÄ≤Â†¥ÂΩ±ÁâáÂÆπÂô®Áõ∏Èóú
        let entryVideoVisible = false;
        let entryList = [];

        function toggleEntryVideoVisibility() {
            entryVideoVisible = !entryVideoVisible;
            const container = document.getElementById('entryVideoContainer');
            if (container) {
                setElementVisible(container, entryVideoVisible);
            }
            document.getElementById('toggleEntryVideo').classList.toggle('active', entryVideoVisible);

            // Êõ¥Êñ∞ÊâÄÊúâÈÄ≤Â†¥ÂàóË°®‰∏≠ÁöÑÈ°ØÁ§∫/Èö±ËóèÊåâÈàïÁãÄÊÖã
            updateEntryVisibilityButtons();

            savePositions();
        }

        // Êõ¥Êñ∞ÊâÄÊúâÈÄ≤Â†¥ÊïàÊûúÁöÑÈ°ØÁ§∫/Èö±ËóèÊåâÈàïÁãÄÊÖãÔºàÊ†πÊìöÂêÑËá™ÁöÑ enabled ÁãÄÊÖãÔºâ
        async function updateEntryVisibilityButtons() {
            // Êõ¥Êñ∞Â∞àÂ±¨ÈÄ≤Â†¥ÁöÑÊåâÈàï
            entryList.forEach((entry, index) => {
                const enabled = entry.enabled !== false;
                const item = document.getElementById(`entryItem_${index}`);
                const btn = document.getElementById(`entryVisBtn_${index}`);
                if (item) {
                    item.classList.toggle('hidden-item', !enabled);
                }
                if (btn) {
                    btn.className = `debug-btn small ${enabled ? 'secondary' : 'danger'}`;
                    btn.innerHTML = enabled ? 'üëÅÔ∏è' : 'üö´';
                }
            });

            // Êõ¥Êñ∞ÂÖ®Â±ÄÈÄ≤Â†¥ÁöÑÊåâÈàï
            try {
                const config = await pywebview.api.get_config();
                const entryConfig = config.entry_config || {};
                const globalEnabled = entryConfig.enabled !== false;
                const item = document.getElementById('entryItem_global');
                const btn = document.getElementById('entryVisBtn_global');
                if (item) {
                    item.classList.toggle('hidden-item', !globalEnabled);
                }
                if (btn) {
                    btn.className = `debug-btn small ${globalEnabled ? 'secondary' : 'danger'}`;
                    btn.innerHTML = globalEnabled ? 'üëÅÔ∏è' : 'üö´';
                }
            } catch (e) {
                // ÂøΩÁï•ÈåØË™§
            }
        }

        // === Âø´ÈÄüÈö±Ëóè/È°ØÁ§∫ÂÖ®ÈÉ® ===
        function hideAllElements() {
            // Èö±ËóèËΩâÁõ§
            wheelVisible = false;
            setElementVisible(document.getElementById('wheelContainer'), false);
            document.getElementById('wheelCheck').textContent = '';
            document.getElementById('toggleWheel').classList.remove('active');

            // Èö±ËóèÁõ≤Áõí
            giftboxVisible = false;
            setElementVisible(document.getElementById('giftboxContainer'), false);
            document.getElementById('giftboxCheck').textContent = '';
            document.getElementById('toggleGiftbox').classList.remove('active');

            // Èö±ËóèÂΩ±ÁâáÂÆπÂô®
            videoVisible = false;
            document.querySelectorAll('.video-container').forEach(vc => {
                setElementVisible(vc, false);
            });
            document.getElementById('videoCheck').textContent = '';
            document.getElementById('toggleVideo').classList.remove('active');

            // Èö±ËóèÈÄ≤Â†¥ÂΩ±ÁâáÂÆπÂô®
            entryVideoVisible = false;
            const entryContainer = document.getElementById('entryVideoContainer');
            if (entryContainer) {
                setElementVisible(entryContainer, false);
            }
            document.getElementById('toggleEntryVideo').classList.remove('active');
            updateEntryVisibilityButtons();

            savePositions();
            debugLog('ÊâÄÊúâÂÖÉÁ¥†Â∑≤Èö±Ëóè');
        }

        function showAllElements() {
            // È°ØÁ§∫ËΩâÁõ§
            wheelVisible = true;
            setElementVisible(document.getElementById('wheelContainer'), true);
            document.getElementById('wheelCheck').textContent = '‚úì';
            document.getElementById('toggleWheel').classList.add('active');

            // È°ØÁ§∫Áõ≤Áõí
            giftboxVisible = true;
            setElementVisible(document.getElementById('giftboxContainer'), true);
            document.getElementById('giftboxCheck').textContent = '‚úì';
            document.getElementById('toggleGiftbox').classList.add('active');

            // È°ØÁ§∫ÂΩ±ÁâáÂÆπÂô®
            videoVisible = true;
            document.querySelectorAll('.video-container').forEach(vc => {
                const idx = parseInt(vc.dataset.index);
                const shouldShow = videoGifts[idx]?.visible !== false;
                setElementVisible(vc, shouldShow);
            });
            document.getElementById('videoCheck').textContent = '‚úì';
            document.getElementById('toggleVideo').classList.add('active');

            // È°ØÁ§∫ÈÄ≤Â†¥ÂΩ±ÁâáÂÆπÂô®
            entryVideoVisible = true;
            const entryContainer = document.getElementById('entryVideoContainer');
            if (entryContainer) {
                setElementVisible(entryContainer, true);
            }
            document.getElementById('toggleEntryVideo').classList.add('active');
            updateEntryVisibilityButtons();

            savePositions();
            debugLog('ÊâÄÊúâÂÖÉÁ¥†Â∑≤È°ØÁ§∫');
        }

        async function loadEntryList() {
            try {
                const config = await pywebview.api.get_config();
                entryList = config.entry_list || [];
                const entryConfig = config.entry_config || {};

                const container = document.getElementById('entryList');
                if (!container) return;

                if (entryList.length === 0 && !entryConfig.media_path) {
                    container.innerHTML = '<div class="empty-list">Â∞öÊú™Ë®≠ÂÆöÈÄ≤Â†¥ÊïàÊûú</div>';
                    return;
                }

                let html = '';

                // È°ØÁ§∫Â∞àÂ±¨ÈÄ≤Â†¥ÂàóË°®
                entryList.forEach((entry, index) => {
                    if (!entry.media_path) return;
                    const isVideo = /\.(mp4|avi|mov|mkv|webm)$/i.test(entry.media_path);
                    const enabled = entry.enabled !== false;
                    html += `
                        <div class="video-item ${enabled ? '' : 'hidden-item'}" id="entryItem_${index}">
                            <div class="video-thumbnail">
                                ${isVideo
                                    ? `<video src="${formatVideoPath(entry.media_path)}" muted preload="metadata"></video>`
                                    : `<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#333;color:#fff;">üéµ</div>`
                                }
                            </div>
                            <div class="video-info">
                                <div class="video-name">üë§ ${entry.username || 'Êú™ÂëΩÂêç'}</div>
                                <div class="video-type">${entry.media_path.split('\\').pop()}</div>
                            </div>
                            <div class="video-actions">
                                <button class="debug-btn small" onclick="testEntryByIndex(${index})">‚ñ∂Ô∏è</button>
                                <button class="debug-btn small ${enabled ? 'secondary' : 'danger'}" onclick="toggleEntryEnabled(${index})" id="entryVisBtn_${index}">
                                    ${enabled ? 'üëÅÔ∏è' : 'üö´'}
                                </button>
                            </div>
                        </div>
                    `;
                });

                // È°ØÁ§∫ÂÖ®Â±ÄÈÄ≤Â†¥ÔºàÂ¶ÇÊûúÊúâË®≠ÂÆöÔºâ
                if (entryConfig.media_path) {
                    const isVideo = /\.(mp4|avi|mov|mkv|webm)$/i.test(entryConfig.media_path);
                    const enabled = entryConfig.enabled !== false;
                    html += `
                        <div class="video-item ${enabled ? '' : 'hidden-item'}" id="entryItem_global">
                            <div class="video-thumbnail">
                                ${isVideo
                                    ? `<video src="${formatVideoPath(entryConfig.media_path)}" muted preload="metadata"></video>`
                                    : `<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#333;color:#fff;">üéµ</div>`
                                }
                            </div>
                            <div class="video-info">
                                <div class="video-name">üåê ÂÖ®Â±ÄÈÄ≤Â†¥</div>
                                <div class="video-type">${entryConfig.media_path.split('\\').pop()}</div>
                            </div>
                            <div class="video-actions">
                                <button class="debug-btn small" onclick="testGlobalEntry()">‚ñ∂Ô∏è</button>
                                <button class="debug-btn small ${enabled ? 'secondary' : 'danger'}" onclick="toggleGlobalEntryEnabled()" id="entryVisBtn_global">
                                    ${enabled ? 'üëÅÔ∏è' : 'üö´'}
                                </button>
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html || '<div class="empty-list">Â∞öÊú™Ë®≠ÂÆöÈÄ≤Â†¥ÊïàÊûú</div>';

                // Êõ¥Êñ∞ÈÄ≤Â†¥Á∏ÆÂúñ
                updateEntryThumbnail();
            } catch (e) {
                console.error('[ÈÄ≤Â†¥ÂàóË°®] ËºâÂÖ•Â§±Êïó:', e);
            }
        }

        // ÂàáÊèõÂñÆÂÄãÈÄ≤Â†¥È†ÖÁõÆÁöÑÂïüÁî®ÁãÄÊÖã
        async function toggleEntryEnabled(index) {
            if (!entryList[index]) return;

            const currentEnabled = entryList[index].enabled !== false;
            const newEnabled = !currentEnabled;

            // Êõ¥Êñ∞Êú¨Âú∞ÁãÄÊÖã
            entryList[index].enabled = newEnabled;

            // Êõ¥Êñ∞ UI
            const item = document.getElementById(`entryItem_${index}`);
            const btn = document.getElementById(`entryVisBtn_${index}`);
            if (item) {
                item.classList.toggle('hidden-item', !newEnabled);
            }
            if (btn) {
                btn.className = `debug-btn small ${newEnabled ? 'secondary' : 'danger'}`;
                btn.innerHTML = newEnabled ? 'üëÅÔ∏è' : 'üö´';
            }

            // ‰øùÂ≠òÂà∞ÈÖçÁΩÆ
            try {
                await pywebview.api.update_config({ entry_list: entryList });
                console.log(`[ÈÄ≤Â†¥] ${entryList[index].username} ${newEnabled ? 'Â∑≤ÂïüÁî®' : 'Â∑≤ÂÅúÁî®'}`);
            } catch (e) {
                console.error('[ÈÄ≤Â†¥] Êõ¥Êñ∞ÈÖçÁΩÆÂ§±Êïó:', e);
            }
        }

        // ÂàáÊèõÂÖ®Â±ÄÈÄ≤Â†¥ÁöÑÂïüÁî®ÁãÄÊÖã
        async function toggleGlobalEntryEnabled() {
            try {
                const config = await pywebview.api.get_config();
                const entryConfig = config.entry_config || {};
                const currentEnabled = entryConfig.enabled !== false;
                const newEnabled = !currentEnabled;

                // Êõ¥Êñ∞ÈÖçÁΩÆ
                entryConfig.enabled = newEnabled;
                await pywebview.api.update_config({ entry_config: entryConfig });

                // Êõ¥Êñ∞ UI
                const item = document.getElementById('entryItem_global');
                const btn = document.getElementById('entryVisBtn_global');
                if (item) {
                    item.classList.toggle('hidden-item', !newEnabled);
                }
                if (btn) {
                    btn.className = `debug-btn small ${newEnabled ? 'secondary' : 'danger'}`;
                    btn.innerHTML = newEnabled ? 'üëÅÔ∏è' : 'üö´';
                }

                console.log(`[ÈÄ≤Â†¥] ÂÖ®Â±ÄÈÄ≤Â†¥ ${newEnabled ? 'Â∑≤ÂïüÁî®' : 'Â∑≤ÂÅúÁî®'}`);
            } catch (e) {
                console.error('[ÈÄ≤Â†¥] Êõ¥Êñ∞ÂÖ®Â±ÄÈÖçÁΩÆÂ§±Êïó:', e);
            }
        }

        function updateEntryThumbnail() {
            const thumbnail = document.getElementById('entryThumbnail');
            if (!thumbnail) return;

            // ‰ΩøÁî®Á¨¨‰∏ÄÂÄãÂ∞àÂ±¨ÈÄ≤Â†¥ÊàñÂÖ®Â±ÄÈÄ≤Â†¥ÁöÑÂΩ±Áâá‰ΩúÁÇ∫Á∏ÆÂúñ
            let videoPath = '';
            for (const entry of entryList) {
                if (entry.media_path && /\.(mp4|avi|mov|mkv|webm)$/i.test(entry.media_path)) {
                    videoPath = entry.media_path;
                    break;
                }
            }

            if (videoPath) {
                thumbnail.src = formatVideoPath(videoPath);
            }
        }

        async function testEntryByIndex(index) {
            if (!entryList[index]) return;
            const entry = entryList[index];
            const isAudio = /\.(mp3|wav|ogg|m4a|aac)$/i.test(entry.media_path);

            triggerEntry({
                username: entry.username || 'Ê∏¨Ë©¶Áî®Êà∂',
                level: 30,
                path: entry.media_path,
                volume: entry.volume || 100,
                force_interrupt: entry.force_interrupt !== false,
                is_audio: isAudio,
                show_text: entry.show_text || false,
                text: entry.text || '',
                text_size: entry.text_size || 48,
                text_color: entry.text_color || '#ffffff',
                text_duration: entry.text_duration || 5,
                is_specific: true
            });
        }

        async function testGlobalEntry() {
            const config = await pywebview.api.get_config();
            const entry = config.entry_config || {};
            if (!entry.media_path) return;

            const isAudio = /\.(mp3|wav|ogg|m4a|aac)$/i.test(entry.media_path);
            triggerEntry({
                username: 'Ê∏¨Ë©¶Áî®Êà∂',
                level: 0,
                path: entry.media_path,
                volume: entry.volume || 100,
                force_interrupt: entry.force_interrupt !== false,
                is_audio: isAudio,
                show_text: false,
                is_specific: false
            });
        }

        // ‰øùÂ≠ò‰ΩçÁΩÆÂíåÁãÄÊÖãÔºà‰ΩøÁî® API ‰øùÂ≠òÂà∞ÈÖçÁΩÆÊñá‰ª∂ÔºåÁ¢∫‰øùÊåÅ‰πÖÂåñÔºâ
        // ‰øùÂ≠òÊâÄÊúâ‰ΩçÁΩÆÂíåÁãÄÊÖã
        // ÁØÄÊµÅÁâàÊú¨ÁöÑ savePositionsÔºàÈÅøÂÖçÈ†ªÁπÅË™øÁî®ÈÄ†ÊàêÂç°È†ìÔºâ
        let savePositionsTimer = null;
        function savePositionsDebounced() {
            if (savePositionsTimer) clearTimeout(savePositionsTimer);
            savePositionsTimer = setTimeout(() => {
                savePositions();
            }, 300);
        }

        async function savePositions() {
            const wheel = document.getElementById('wheelContainer');
            const giftbox = document.getElementById('giftboxContainer');
            const entryText = document.getElementById('entryTextContainer');
            const entryVideo = document.getElementById('entryVideoContainer');
            const randomVideo = document.getElementById('randomVideoContainer');
            const duckVideo = document.getElementById('duckVideoContainer');
            const duckCounter = document.getElementById('duckCounterBox');
            const pityCounter = document.getElementById('pityCounterBox');
            const leaderboard = document.getElementById('leaderboardBox');
            const giftImageDisplay = document.getElementById('giftImageDisplay');

            // Êî∂ÈõÜÂΩ±ÁâáÂÆπÂô®Ë≥áÊñô
            const videoData = {};
            document.querySelectorAll('.video-container').forEach(vc => {
                const idx = parseInt(vc.dataset.index);
                const cached = videoContainers[idx] || {};
                const crop = videoCropState[idx] || {};

                // ÂèñÂæóÂ∞∫ÂØ∏ÔºàÈö±ËóèÊôÇÂèØËÉΩÊòØ0ÔºåÁî® style ÊàñÂø´ÂèñÂÄºÔºâ
                let w = vc.offsetWidth || parseInt(vc.style.width) || cached.width || 300;
                let h = vc.offsetHeight || parseInt(vc.style.height) || cached.height || 200;

                videoData[idx] = {
                    width: Math.max(50, w),
                    height: Math.max(50, h),
                    left: vc.offsetLeft || parseInt(vc.style.left) || cached.left || 0,
                    top: vc.offsetTop || parseInt(vc.style.top) || cached.top || 0,
                    visible: !vc.classList.contains('hidden'),
                    cropLeft: crop.cropLeft || 0,
                    cropTop: crop.cropTop || 0,
                    originalWidth: crop.originalWidth || w,
                    originalHeight: crop.originalHeight || h
                };
            });

            // ËºîÂä©ÂáΩÊï∏ÔºöÂèØÈù†Âú∞ÂèñÂæóÂÖÉÁ¥†Â∞∫ÂØ∏ÔºàÂç≥‰ΩøÈö±ËóèÔºâ
            function getElementDimensions(el, defaultW, defaultH) {
                if (!el) return { width: defaultW, height: defaultH, left: 0, top: 0 };

                // Â∞çÊñº scalable-box ÂÖÉÁ¥†ÔºåÂÑ™ÂÖà‰ΩøÁî®Á∑©Â≠ò
                if (el.classList.contains('scalable-box') && scalableBoxCache[el.id]) {
                    const cached = scalableBoxCache[el.id];
                    console.log(`[getElementDimensions] ‰ΩøÁî®Á∑©Â≠ò: ${el.id}`, cached);
                    return {
                        width: cached.width,
                        height: cached.height,
                        left: cached.left,
                        top: cached.top
                    };
                }

                // ÂÑ™ÂÖà‰ΩøÁî® style ÂÄºÔºàÈö±ËóèÊôÇ offset ÊúÉÊòØ 0Ôºâ
                // Ê≥®ÊÑèÔºöparseInt ÂèØËÉΩËøîÂõû NaNÔºåÈúÄË¶ÅÊòéÁ¢∫Ê™¢Êü•
                const styleW = parseInt(el.style.width);
                const styleH = parseInt(el.style.height);
                const styleL = parseInt(el.style.left);
                const styleT = parseInt(el.style.top);

                // ‰ΩøÁî® isNaN Ê™¢Êü•ÔºåÈÅøÂÖç NaN || 0 ÁöÑÂïèÈ°å
                const w = !isNaN(styleW) && styleW > 0 ? styleW : (el.offsetWidth > 0 ? el.offsetWidth : defaultW);
                const h = !isNaN(styleH) && styleH > 0 ? styleH : (el.offsetHeight > 0 ? el.offsetHeight : defaultH);
                const l = !isNaN(styleL) ? styleL : (el.offsetLeft || 0);
                const t = !isNaN(styleT) ? styleT : (el.offsetTop || 0);

                return {
                    width: Math.max(50, w),
                    height: Math.max(50, h),
                    left: l,
                    top: t
                };
            }

            // ÁµÑÂêàÂÆåÊï¥Ë≥áÊñô
            const wheelDim = getElementDimensions(wheel, 350, 350);
            const giftboxDim = getElementDimensions(giftbox, 200, 200);
            const entryVideoDim = getElementDimensions(entryVideo, 400, 300);
            const randomVideoDim = getElementDimensions(randomVideo, 300, 200);
            const duckVideoDim = getElementDimensions(duckVideo, 300, 200);
            const duckCounterDim = getElementDimensions(duckCounter, 200, 100);
            const pityCounterDim = getElementDimensions(pityCounter, 180, 80);
            const leaderboardDim = getElementDimensions(leaderboard, 320, 100);
            const giftImageDim = getElementDimensions(giftImageDisplay, 300, 200);

            const positions = {
                wheel: {
                    width: wheelDim.width,
                    height: wheelDim.height,
                    left: wheelDim.left,
                    top: wheelDim.top || 150,
                    visible: wheelVisible
                },
                giftbox: {
                    width: giftboxDim.width,
                    height: giftboxDim.height,
                    left: giftboxDim.left,
                    top: giftboxDim.top || 150,
                    visible: giftboxVisible,
                    autoHide: giftboxAutoHide
                },
                entryText: {
                    left: entryText ? (parseInt(entryText.style.left) || entryText.offsetLeft || 0) : 0,
                    top: entryText ? (parseInt(entryText.style.top) || entryText.offsetTop || 50) : 50
                },
                entryVideo: {
                    width: entryVideoDim.width,
                    height: entryVideoDim.height,
                    left: entryVideoDim.left || 100,
                    top: entryVideoDim.top || 100,
                    visible: entryVideoVisible
                },
                randomVideo: {
                    width: randomVideoDim.width,
                    height: randomVideoDim.height,
                    left: randomVideoDim.left || 50,
                    top: randomVideoDim.top || 400,
                    visible: randomVideoVisible
                },
                duckVideo: {
                    width: duckVideoDim.width,
                    height: duckVideoDim.height,
                    left: duckVideoDim.left || 400,
                    top: duckVideoDim.top || 400,
                    visible: duckVideoVisible
                },
                duckCounter: {
                    width: duckCounterDim.width,
                    height: duckCounterDim.height,
                    left: duckCounterDim.left || 50,
                    top: duckCounterDim.top || 50,
                    visible: duckCounterVisible
                },
                pityCounter: {
                    width: pityCounterDim.width,
                    height: pityCounterDim.height,
                    left: pityCounterDim.left || 50,
                    top: pityCounterDim.top || 170,
                    visible: pityCounterVisible
                },
                leaderboard: {
                    width: leaderboardDim.width,
                    height: leaderboardDim.height,
                    left: leaderboardDim.left || 50,
                    top: leaderboardDim.top || 300,
                    visible: leaderboardVisible
                },
                giftImage: {
                    width: giftImageDim.width,
                    height: giftImageDim.height,
                    left: giftImageDim.left,
                    top: giftImageDim.top,
                    visible: giftImageVisible,
                    // ‰øùÂ≠òÂéüÂßãÂÖßÂÆπÂ∞∫ÂØ∏ÔºàÁî®ÊñºË®àÁÆóÁ∏ÆÊîæÊØî‰æãÔºâ
                    originalWidth: giftImageDisplay ? (parseInt(giftImageDisplay.dataset.originalWidth) || 0) : 0,
                    originalHeight: giftImageDisplay ? (parseInt(giftImageDisplay.dataset.originalHeight) || 0) : 0,
                    // ‰øùÂ≠òÁ¶ÆÁâ©ÂúñË≥áÊñôÔºàÁî®ÊñºÊÅ¢Âæ©Ôºâ
                    data: giftImageData
                },
                videoContainers: videoData,
                videoModuleVisible: videoVisible,
                elementZIndexes: elementZIndexes  // ‰øùÂ≠òÂúñÂ±§È†ÜÂ∫è
            };

            // ‰øùÂ≠òÂà∞ÈÖçÁΩÆÊñá‰ª∂
            try {
                if (window.pywebview && window.pywebview.api) {
                    await pywebview.api.save_greenscreen_positions(positions);
                    // ÂêåÊ≠•Êõ¥Êñ∞ savedPositionsÔºåÁ¢∫‰øù‰∏ãÊ¨°ÈáçÊñ∞ÁîüÊàêÂÆπÂô®ÊôÇ‰ΩçÁΩÆÊ≠£Á¢∫
                    savedPositions = positions;
                    console.log('[‰øùÂ≠ò] Á∂†Âπï‰ΩçÁΩÆÂ∑≤‰øùÂ≠ò');
                }
            } catch (e) {
                console.error('[‰øùÂ≠ò] Â§±Êïó:', e);
            }
        }

        // (Â∑≤ÁßªÈô§ - ‰ΩçÁΩÆÁèæÂú®Âú® applyWheelPosition Âíå generateVideoContainers ‰∏≠Áõ¥Êé•Â•óÁî®)

        // === Ê∏¨Ë©¶ÂäüËÉΩ ===
        function updateWheelTestButton() {
            const btn = document.getElementById('testWheelBtn');
            if (btn) {
                btn.disabled = !wheelModuleEnabled;
                btn.textContent = wheelModuleEnabled ? 'üé° Ê∏¨Ë©¶ËΩâÁõ§' : 'üé° Ê®°ÁµÑÂ∑≤ÈóúÈñâ';
            }
        }

        function updateGiftboxTestButton() {
            const btn = document.getElementById('testGiftboxBtn');
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'üéÅ Ê∏¨Ë©¶Áõ≤Áõí';
            }
        }

        function testGiftboxOpen() {
            console.log('[Áõ≤ÁõíÊ∏¨Ë©¶] Ëß∏Áôº');
            triggerGiftbox(1);
        }

        function testEntryText() {
            console.log('[ÈÄ≤Â†¥ÊñáÂ≠óÊ∏¨Ë©¶] Ëß∏Áôº');
            showEntryText({
                username: 'Ê∏¨Ë©¶Áî®Êà∂',
                text: 'Ê≠°Ëøé {name} ÈÄ≤ÂÖ•Áõ¥Êí≠ÈñìÔºÅ',
                text_size: 48,
                text_color: '#ffffff',
                text_duration: 5
            });
        }

        async function testEntryVideo() {
            console.log('[ÈÄ≤Â†¥ÂΩ±ÁâáÊ∏¨Ë©¶] Ëß∏Áôº');
            try {
                // ÂæûÈÖçÁΩÆÁç≤ÂèñÈÄ≤Â†¥ÂàóË°®
                const config = await pywebview.api.get_config();
                const entryList = config.entry_list || [];
                const entryConfig = config.entry_config || {};

                // ÂÑ™ÂÖà‰ΩøÁî®Â∞àÂ±¨ÈÄ≤Â†¥ÂàóË°®‰∏≠ÁöÑÁ¨¨‰∏ÄÂÄã
                let testEntry = null;
                if (entryList.length > 0 && entryList[0].media_path) {
                    testEntry = entryList[0];
                } else if (entryConfig.media_path) {
                    testEntry = entryConfig;
                }

                if (!testEntry || !testEntry.media_path) {
                    alert('Ê≤íÊúâË®≠ÂÆöÈÄ≤Â†¥ÊïàÊûúÔºÅË´ãÂÖàÂú®‰∏ª‰ªãÈù¢Ë®≠ÂÆöÈÄ≤Â†¥Â™íÈ´î„ÄÇ');
                    return;
                }

                const isAudio = /\.(mp3|wav|ogg|m4a|aac)$/i.test(testEntry.media_path);

                triggerEntry({
                    username: 'Ê∏¨Ë©¶Áî®Êà∂',
                    level: 30,
                    path: testEntry.media_path,
                    volume: testEntry.volume || 100,
                    force_interrupt: testEntry.force_interrupt !== false,
                    is_audio: isAudio,
                    show_text: testEntry.show_text || false,
                    text: testEntry.text || '',
                    text_size: testEntry.text_size || 48,
                    text_color: testEntry.text_color || '#ffffff',
                    text_duration: testEntry.text_duration || 5,
                    is_specific: true
                });
            } catch (e) {
                console.error('[ÈÄ≤Â†¥ÂΩ±ÁâáÊ∏¨Ë©¶] ÈåØË™§:', e);
                alert('Ê∏¨Ë©¶Â§±Êïó: ' + e.message);
            }
        }

        // === Á¶ÆÁâ©ÂúñÈ°ØÁ§∫ÂäüËÉΩ ===
        let giftImageVisible = false;
        let giftImageData = null;  // ‰øùÂ≠òÁ¶ÆÁâ©ÂúñË≥áÊñôÁî®ÊñºÊÅ¢Âæ©

        function showGiftImageOnGreenScreen(data) {
            // ‰øùÂ≠òË≥áÊñô‰ª•‰æøÊÅ¢Âæ©
            giftImageData = data;
            console.log('[Á¶ÆÁâ©Âúñ] È°ØÁ§∫', data);
            const container = document.getElementById('giftImageDisplay');
            const content = document.getElementById('giftImageContent');
            if (!container || !content) return;

            const { items, settings } = data;
            if (!items || items.length === 0) {
                container.style.display = 'none';
                giftImageVisible = false;
                return;
            }

            // ËÉåÊôØÊ®£Âºè
            let bgStyle = '';
            if (settings.bgType === 'transparent') {
                bgStyle = 'background: transparent;';
            } else if (settings.bgType === 'gradient') {
                bgStyle = `background: linear-gradient(135deg, ${settings.bgColor}, ${settings.bgColor2});`;
            } else {
                bgStyle = `background: ${settings.bgColor};`;
            }

            // ÊñáÂ≠óÊ®£Âºè
            const textStyle = `
                font-size: ${settings.fontSize}px;
                color: ${settings.fontColor};
                font-weight: ${settings.fontBold ? 'bold' : 'normal'};
                ${settings.textShadow ? 'text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);' : ''}
            `;

            // ÂúñÁ§∫‰ΩçÁΩÆÊ®£Âºè
            const itemFlexDirection = settings.iconPosition === 'right' ? 'row-reverse' : 'row';

            content.style.cssText = `
                ${bgStyle}
                padding: ${settings.padding}px;
                gap: ${settings.gap}px;
                grid-template-columns: repeat(${settings.columns}, 1fr);
                ${settings.rounded ? 'border-radius: 16px;' : ''}
            `;

            content.innerHTML = items.map(item => `
                <div class="gift-image-grid-item" style="flex-direction: ${itemFlexDirection};">
                    ${item.iconUrl
                        ? `<img src="${item.iconUrl}" style="width: ${settings.iconSize}px; height: ${settings.iconSize}px;" onerror="this.style.display='none'">`
                        : `<div style="width: ${settings.iconSize}px; height: ${settings.iconSize}px; display: flex; align-items: center; justify-content: center; font-size: ${settings.iconSize * 0.6}px;">üéÅ</div>`
                    }
                    <span class="gift-label" style="${textStyle} font-family: '${item.font || 'Microsoft JhengHei'}', sans-serif;">${escapeHtmlGs(item.name)}</span>
                </div>
            `).join('');

            container.style.display = 'block';
            giftImageVisible = true;

            // ‰ΩøÁî® requestAnimationFrame Á≠âÂæÖÂÖßÂÆπÊ∏≤ÊüìÂÆåÊàêÂæå‰øùÂ≠òÂéüÂßãÂ∞∫ÂØ∏
            const wrapper = container.querySelector('.gift-image-wrapper');
            if (wrapper) {
                // ÈáçÁΩÆÁ∏ÆÊîæ‰ª•ÂèñÂæóÁúüÂØ¶Â∞∫ÂØ∏
                wrapper.style.transform = 'none';
            }
            requestAnimationFrame(() => {
                // ‰øùÂ≠òÂéüÂßãÂ∞∫ÂØ∏Âà∞ dataset
                const origW = content.offsetWidth || content.scrollWidth || 300;
                const origH = content.offsetHeight || content.scrollHeight || 200;
                container.dataset.originalWidth = origW;
                container.dataset.originalHeight = origH;

                // Â¶ÇÊûúÂÆπÂô®ÊúâËá™Ë®ÇÂ∞∫ÂØ∏ÔºåÂ•óÁî®Á∏ÆÊîæ
                const containerW = parseInt(container.style.width);
                const containerH = parseInt(container.style.height);
                if (wrapper && containerW > 0 && containerH > 0) {
                    const scaleX = containerW / origW;
                    const scaleY = containerH / origH;
                    const scale = Math.min(scaleX, scaleY);
                    wrapper.style.transform = `scale(${scale})`;
                }

                savePositionsDebounced();
            });
        }

        function hideGiftImage() {
            const container = document.getElementById('giftImageDisplay');
            if (container) {
                container.style.display = 'none';
                giftImageVisible = false;
                giftImageData = null;  // Ê∏ÖÈô§Ë≥áÊñô
                savePositionsDebounced();  // ‰øùÂ≠òÁãÄÊÖã
            }
        }

        function toggleGiftImageVisible() {
            if (giftImageVisible) {
                hideGiftImage();
            } else {
                // Â¶ÇÊûúË¶ÅÈ°ØÁ§∫‰ΩÜÊ≤íÊúâÂÖßÂÆπÔºåÊèêÁ§∫Áî®Êà∂
                const content = document.getElementById('giftImageContent');
                if (!content || !content.innerHTML) {
                    console.log('[Á¶ÆÁâ©Âúñ] Â∞öÁÑ°ÂÖßÂÆπÔºåË´ãÂæû‰∏ª‰ªãÈù¢ÁôºÈÄÅ');
                    return;
                }
                document.getElementById('giftImageDisplay').style.display = 'block';
                giftImageVisible = true;
            }
            savePositionsDebounced();
        }

        async function exportGiftImageToFile(data) {
            console.log('[Á¶ÆÁâ©Âúñ] ÂåØÂá∫', data);
            const { items, settings, savePath } = data;
            if (!items || items.length === 0) return;

            // ÂâµÂª∫‰∏ÄÂÄãËá®ÊôÇÁöÑ canvas ‰æÜÁπ™Ë£ΩÁ¶ÆÁâ©Âúñ
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const columns = settings.columns || 3;
            const gap = settings.gap || 20;
            const iconSize = settings.iconSize || 64;
            const padding = settings.padding || 30;
            const fontSize = settings.fontSize || 24;

            // Ë®àÁÆóÊñáÂ≠óÊúÄÂ§ßÂØ¨Â∫¶ÔºàËÄÉÊÖÆÊØèÂÄãÈ†ÖÁõÆÁöÑÂ≠óÈ´îÔºâ
            let maxTextWidth = 0;
            items.forEach(item => {
                const itemFont = item.font || 'Microsoft JhengHei';
                ctx.font = `${settings.fontBold ? 'bold' : 'normal'} ${fontSize}px '${itemFont}', sans-serif`;
                const w = ctx.measureText(item.name).width;
                if (w > maxTextWidth) maxTextWidth = w;
            });

            const itemWidth = iconSize + 12 + maxTextWidth + 20;
            const itemHeight = Math.max(iconSize, fontSize + 10);
            const rows = Math.ceil(items.length / columns);

            const canvasWidth = padding * 2 + columns * itemWidth + (columns - 1) * gap;
            const canvasHeight = padding * 2 + rows * itemHeight + (rows - 1) * gap;

            canvas.width = canvasWidth;
            canvas.height = canvasHeight;

            // ËÉåÊôØ
            if (settings.bgType === 'gradient') {
                const gradient = ctx.createLinearGradient(0, 0, canvasWidth, canvasHeight);
                gradient.addColorStop(0, settings.bgColor);
                gradient.addColorStop(1, settings.bgColor2);
                ctx.fillStyle = gradient;
            } else if (settings.bgType !== 'transparent') {
                ctx.fillStyle = settings.bgColor;
            }

            if (settings.bgType !== 'transparent') {
                if (settings.rounded) {
                    roundRect(ctx, 0, 0, canvasWidth, canvasHeight, 16);
                    ctx.fill();
                } else {
                    ctx.fillRect(0, 0, canvasWidth, canvasHeight);
                }
            }

            // ËºâÂÖ•ÊâÄÊúâÂúñÁâá
            const loadImage = (url) => {
                return new Promise((resolve) => {
                    if (!url) {
                        resolve(null);
                        return;
                    }
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => resolve(img);
                    img.onerror = () => resolve(null);
                    img.src = url;
                });
            };

            const images = await Promise.all(items.map(item => loadImage(item.iconUrl)));

            // Áπ™Ë£ΩÊØèÂÄãÁ¶ÆÁâ©
            ctx.fillStyle = settings.fontColor;
            ctx.textBaseline = 'middle';

            if (settings.textShadow) {
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
            }

            items.forEach((item, i) => {
                const col = i % columns;
                const row = Math.floor(i / columns);
                const x = padding + col * (itemWidth + gap);
                const y = padding + row * (itemHeight + gap);

                // Áπ™Ë£ΩÂúñÁ§∫
                const img = images[i];
                if (img) {
                    ctx.drawImage(img, x, y + (itemHeight - iconSize) / 2, iconSize, iconSize);
                } else {
                    // Áπ™Ë£ΩÈ†êË®≠ÂúñÁ§∫
                    ctx.save();
                    ctx.font = `${iconSize * 0.6}px sans-serif`;
                    ctx.fillText('üéÅ', x + iconSize / 4, y + itemHeight / 2);
                    ctx.restore();
                }

                // Áπ™Ë£ΩÊñáÂ≠óÔºà‰ΩøÁî®ÊØèÂÄãÈ†ÖÁõÆËá™Â∑±ÁöÑÂ≠óÈ´îÔºâ
                const itemFont = item.font || 'Microsoft JhengHei';
                ctx.font = `${settings.fontBold ? 'bold' : 'normal'} ${fontSize}px '${itemFont}', sans-serif`;
                ctx.fillStyle = settings.fontColor;
                ctx.fillText(item.name, x + iconSize + 12, y + itemHeight / 2);
            });

            // ÂåØÂá∫ÁÇ∫ÂúñÁâá‰∏¶‰øùÂ≠ò
            const dataUrl = canvas.toDataURL('image/png');
            // ÈÄöÁü•‰∏ªÈÄ≤Á®ã‰øùÂ≠òÊñá‰ª∂
            if (window.electronAPI && savePath) {
                // ÁôºÈÄÅ base64 Êï∏ÊìöÂà∞‰∏ªÈÄ≤Á®ã‰øùÂ≠ò
                const base64Data = dataUrl.replace(/^data:image\/png;base64,/, '');
                try {
                    await window.electronAPI.saveExportedImage(savePath, base64Data);
                    console.log('[Á¶ÆÁâ©Âúñ] Â∑≤ÂåØÂá∫Âà∞:', savePath);
                } catch (e) {
                    console.error('[Á¶ÆÁâ©Âúñ] ÂåØÂá∫Â§±Êïó:', e);
                }
            }
        }

        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        // === Áõ≤ÁõíÂäüËÉΩ ===
        function triggerGiftbox(opens) {
            console.log('[Áõ≤Áõí] Ëß∏ÁôºÔºåÈÅ∏È†ÖÊï∏Èáè:', giftboxOptions.length, 'Ê≠£Âú®ÈñãÁõí:', isGiftboxOpening);

            if (isGiftboxOpening) {
                console.log('[Áõ≤Áõí] Ê≠£Âú®ÈñãÁõí‰∏≠ÔºåÂøΩÁï•');
                return;
            }

            // Â¶ÇÊûúÊ≤íÊúâÈÅ∏È†ÖÔºå‰ΩøÁî®È†êË®≠ÈÅ∏È†ÖÈÄ≤Ë°åÊ∏¨Ë©¶
            if (giftboxOptions.length === 0) {
                console.log('[Áõ≤Áõí] Ê≤íÊúâÈÅ∏È†ÖÔºå‰ΩøÁî®È†êË®≠');
                giftboxOptions = [
                    { name: 'Â§ßÁçé', color: '#ffd93d', weight: 1 },
                    { name: '‰∏≠Áçé', color: '#4ecca3', weight: 2 },
                    { name: 'Â∞èÁçé', color: '#00d9ff', weight: 3 }
                ];
            }

            isGiftboxOpening = true;
            const container = document.getElementById('giftboxContainer');
            const box = document.getElementById('giftboxBox');
            const resultEl = document.getElementById('giftboxResult');
            const confettiEl = document.getElementById('giftboxConfetti');
            const countdownEl = document.getElementById('giftboxCountdown');
            const videoContainer = document.getElementById('giftboxVideoContainer');
            const videoEl = document.getElementById('giftboxVideo');

            // Âº∑Âà∂È°ØÁ§∫Áõ≤ÁõíÂÆπÂô®
            container.classList.remove('hidden');
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.opacity = '1';
            console.log('[Áõ≤Áõí] Âº∑Âà∂È°ØÁ§∫ÂÆπÂô®');

            // Â¶ÇÊûúÊòØËá™ÂãïÈö±ËóèÊ®°ÂºèÔºåÂÖàÈ°ØÁ§∫Áõ≤Áõí
            if (giftboxAutoHide) {
                // Ê∏ÖÈô§Âº∑Âà∂Èö±ËóèÁöÑ inline style
                container.style.opacity = '';
                container.style.visibility = '';
                container.style.pointerEvents = '';
                container.classList.add('triggered');
            }

            // Èö®Ê©üÈÅ∏ÊìáÁµêÊûúÔºàÊ†πÊìöÊ¨äÈáçÔºâ
            const totalWeight = giftboxOptions.reduce((sum, opt) => sum + (opt.weight || 1), 0);
            let random = Math.random() * totalWeight;
            let selectedOption = giftboxOptions[0];
            for (const opt of giftboxOptions) {
                random -= (opt.weight || 1);
                if (random <= 0) {
                    selectedOption = opt;
                    break;
                }
            }

            // ÈñãÁõíÂãïÁï´
            box.classList.add('opening');

            // ÂâµÂª∫ÂΩ©Â∏∂ÊïàÊûúÔºàÂÖàÊ∫ñÂÇôÂ•ΩÔºå‰ΩÜ‰∏çÂïüÂãïÔºâ
            confettiEl.innerHTML = '';
            const colors = ['#e94560', '#4ecca3', '#ffd93d', '#00d9ff', '#ff6b9d'];
            for (let i = 0; i < 20; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                piece.style.left = Math.random() * 100 + '%';
                piece.style.animationDelay = Math.random() * 0.5 + 's';
                piece.style.animationDuration = (1 + Math.random()) + 's';
                confettiEl.appendChild(piece);
            }

            // 0.3ÁßíÂæåÈñãÂßãÊªæÂãïÂãïÁï´
            setTimeout(() => {
                box.classList.add('rolling');

                // ÊªæÂãïÂèÉÊï∏
                let currentIndex = 0;
                let interval = 50;  // ÂàùÂßãÈÄüÂ∫¶ÔºàÊØ´ÁßíÔºâ
                const maxInterval = 400;  // ÊúÄÊÖ¢ÈÄüÂ∫¶
                const acceleration = 1.15;  // Ê∏õÈÄü‰øÇÊï∏
                const minSpins = 15;  // ÊúÄÂ∞ëÊªæÂãïÊ¨°Êï∏
                let spinCount = 0;

                // ÊâæÂà∞ÈÅ∏‰∏≠ÈÅ∏È†ÖÁöÑÁ¥¢Âºï
                const selectedIndex = giftboxOptions.indexOf(selectedOption);

                const spin = () => {
                    // È°ØÁ§∫Áï∂ÂâçÈÅ∏È†ÖÔºàÈáçÁΩÆÂãïÁï´Ôºâ
                    const currentOption = giftboxOptions[currentIndex];
                    resultEl.style.animation = 'none';
                    void resultEl.offsetWidth;  // Âº∑Âà∂ÈáçÁπ™
                    resultEl.style.animation = '';
                    resultEl.textContent = currentOption.name;
                    resultEl.style.backgroundColor = currentOption.color || '#4ecca3';

                    // ÁßªÂãïÂà∞‰∏ã‰∏ÄÂÄãÈÅ∏È†Ö
                    currentIndex = (currentIndex + 1) % giftboxOptions.length;
                    spinCount++;

                    // Ê∏õÈÄü
                    interval = Math.min(interval * acceleration, maxInterval);

                    // Âà§Êñ∑ÊòØÂê¶ÂÅúÊ≠¢ÔºöÂ∑≤Á∂ìËΩâÂ§†‰∫ÜÔºåÈÄüÂ∫¶Â§†ÊÖ¢Ôºå‰∏îÂÅúÂú®ÈÅ∏‰∏≠ÁöÑÈÅ∏È†Ö‰∏ä
                    if (spinCount >= minSpins && interval >= maxInterval &&
                        currentIndex === (selectedIndex + 1) % giftboxOptions.length) {
                        // ÂÅúÊ≠¢ÊªæÂãïÔºåÈ°ØÁ§∫ÊúÄÁµÇÁµêÊûú
                        resultEl.textContent = selectedOption.name;
                        resultEl.style.backgroundColor = selectedOption.color || '#4ecca3';

                        // ÂàáÊèõÂà∞È°ØÁ§∫ÁµêÊûúÁãÄÊÖã
                        box.classList.remove('rolling');
                        box.classList.add('showing-result');

                        // ÂïüÂãïÂΩ©Â∏∂ÂãïÁï´
                        confettiEl.querySelectorAll('.confetti-piece').forEach(piece => {
                            piece.style.animation = `confetti-fall ${1 + Math.random()}s ease-out forwards`;
                        });

                        console.log('Áõ≤ÁõíÁµêÊûú:', selectedOption.name);

                        // ÊªæÂãïÂÆåÊàêÂæåÔºåÂ¶ÇÊûúÊúâÂΩ±ÁâáË®≠ÂÆöÔºåÂïüÂãïÂÄíÊï∏Ë®àÊôÇ
                        if (selectedOption.video_path) {
                            // Âª∂ÈÅ≤0.5ÁßíËÆìÁµêÊûúÂΩàË∑≥ÂãïÁï´ÂÆåÊàêÔºåÂÜçÈñãÂßãÂÄíÊï∏
                            setTimeout(() => {
                                startGiftboxCountdown(selectedOption);
                            }, 500);
                        } else {
                            // Ê≤íÊúâÂΩ±ÁâáÔºå3ÁßíÂæåÈáçÁΩÆ
                            setTimeout(() => {
                                resetGiftbox();
                            }, 3000);
                        }
                    } else {
                        // ÁπºÁ∫åÊªæÂãï
                        setTimeout(spin, interval);
                    }
                };

                // ÈñãÂßãÊªæÂãï
                spin();
            }, 300);
        }

        // Áõ≤ÁõíÂÄíÊï∏Ë®àÊôÇ
        function startGiftboxCountdown(option) {
            const countdownEl = document.getElementById('giftboxCountdown');
            let count = 3;

            const doCountdown = () => {
                countdownEl.textContent = count;
                countdownEl.classList.remove('active');
                // Âº∑Âà∂ÈáçÁπ™‰ª•ÈáçÊñ∞Ëß∏ÁôºÂãïÁï´
                void countdownEl.offsetWidth;
                countdownEl.classList.add('active');

                if (count > 1) {
                    count--;
                    setTimeout(doCountdown, 1000);
                } else {
                    // ÂÄíÊï∏ÂÆåÊàêÔºåÊí≠ÊîæÂΩ±Áâá
                    setTimeout(() => {
                        countdownEl.classList.remove('active');
                        playGiftboxVideo(option);
                    }, 1000);
                }
            };

            doCountdown();
        }

        // Êí≠ÊîæÁõ≤ÁõíÂΩ±Áâá
        function playGiftboxVideo(option) {
            const box = document.getElementById('giftboxBox');
            const videoContainer = document.getElementById('giftboxVideoContainer');
            const videoEl = document.getElementById('giftboxVideo');

            // Èö±ËóèÁõíÂ≠êÔºåÈ°ØÁ§∫ÂΩ±Áâá
            box.style.display = 'none';
            videoContainer.classList.add('active');

            // Ë®≠ÂÆöÂΩ±Áâá
            const videoSrc = formatVideoPath(option.video_path);
            videoEl.src = videoSrc;
            videoEl.volume = (option.video_volume || 100) / 100;
            videoEl.muted = false;

            // Ë®≠ÂÆöÊí≠ÊîæÊôÇÈï∑ÈôêÂà∂
            const videoSeconds = option.video_seconds || 0;
            let playTimeout = null;

            videoEl.onloadeddata = () => {
                videoEl.play().then(() => {
                    console.log('Áõ≤ÁõíÂΩ±ÁâáÈñãÂßãÊí≠Êîæ');

                    if (videoSeconds > 0) {
                        playTimeout = setTimeout(() => {
                            videoEl.pause();
                            endGiftboxVideo();
                        }, videoSeconds * 1000);
                    }
                }).catch(e => {
                    console.error('Áõ≤ÁõíÂΩ±ÁâáÊí≠ÊîæÂ§±Êïó:', e);
                    endGiftboxVideo();
                });
            };

            videoEl.onended = () => {
                if (playTimeout) clearTimeout(playTimeout);
                endGiftboxVideo();
            };

            videoEl.onerror = () => {
                console.error('Áõ≤ÁõíÂΩ±ÁâáËºâÂÖ•ÈåØË™§');
                endGiftboxVideo();
            };

            videoEl.load();
        }

        // ÁµêÊùüÁõ≤ÁõíÂΩ±ÁâáÊí≠Êîæ
        function endGiftboxVideo() {
            console.log('[Áõ≤Áõí] ÂΩ±ÁâáÁµêÊùüÔºåÈñãÂßãÈáçÁΩÆ');
            const videoContainer = document.getElementById('giftboxVideoContainer');
            const videoEl = document.getElementById('giftboxVideo');
            const box = document.getElementById('giftboxBox');

            videoEl.pause();
            videoEl.removeAttribute('src');
            videoEl.load();
            videoContainer.classList.remove('active');
            box.style.display = '';

            resetGiftbox();
        }

        // ÈáçÁΩÆÁõ≤ÁõíÁãÄÊÖã
        function resetGiftbox() {
            const container = document.getElementById('giftboxContainer');
            const box = document.getElementById('giftboxBox');
            const confettiEl = document.getElementById('giftboxConfetti');
            const resultEl = document.getElementById('giftboxResult');
            const countdownEl = document.getElementById('giftboxCountdown');
            const videoContainer = document.getElementById('giftboxVideoContainer');
            const videoEl = document.getElementById('giftboxVideo');

            box.classList.remove('opening', 'rolling', 'showing-result');
            box.style.display = '';
            confettiEl.innerHTML = '';

            // ÈáçÁΩÆÂΩ±ÁâáÂÆπÂô®
            videoContainer.classList.remove('active');
            videoEl.pause();
            videoEl.removeAttribute('src');

            // ÈáçÁΩÆÁµêÊûúÂíåÂÄíÊï∏È°ØÁ§∫
            resultEl.textContent = '';
            resultEl.style.animation = '';
            resultEl.style.backgroundColor = '';
            countdownEl.classList.remove('active');
            countdownEl.textContent = '3';

            // Â¶ÇÊûúÊòØËá™ÂãïÈö±ËóèÊ®°ÂºèÔºåÈö±ËóèÁõ≤Áõí
            if (giftboxAutoHide) {
                console.log('[Áõ≤Áõí] Ëá™ÂãïÈö±Ëóè - Âº∑Âà∂Èö±Ëóè');
                container.classList.remove('triggered');
                // Âº∑Âà∂Èö±Ëóè
                container.style.opacity = '0';
                container.style.visibility = 'hidden';
                container.style.pointerEvents = 'none';
            }

            isGiftboxOpening = false;
            console.log('[Áõ≤Áõí] Â∑≤ÈáçÁΩÆ');
        }

        // ÈáçÊñ∞ËºâÂÖ•ÊâÄÊúâÁ∏ÆÂúñ
        function reloadAllThumbnails() {
            console.log('[DEBUG] ÈáçÊñ∞ËºâÂÖ•ÊâÄÊúâÁ∏ÆÂúñ');

            document.querySelectorAll('.video-container').forEach((container, i) => {
                const thumbnail = container.querySelector('.thumbnail-video');
                if (!thumbnail) return;

                const idx = container.dataset.index;
                const src = thumbnail.src || thumbnail.getAttribute('src');

                console.log(`[DEBUG] ÈáçÊñ∞ËºâÂÖ•Á∏ÆÂúñ [${idx}], src=${src ? src.substring(0, 80) : 'empty'}`);

                if (!src || src === 'undefined' || src === '') {
                    console.warn(`[WARN] Á∏ÆÂúñ [${idx}] Ê≤íÊúâÊúâÊïàÁöÑ src`);
                    container.style.background = 'rgba(255, 165, 0, 0.3)';  // Ê©ôËâ≤Ë°®Á§∫ÁÑ° src
                    return;
                }

                // ÈáçÁΩÆÂÆπÂô®ËÉåÊôØÔºàÂ¶ÇÊûú‰πãÂâçÈ°ØÁ§∫ÈåØË™§Ôºâ
                container.style.background = 'rgba(0, 0, 0, 0.3)';
                thumbnail.style.display = 'block';
                thumbnail.style.visibility = 'visible';
                thumbnail.style.opacity = '1';

                // Ê∏ÖÈô§Ëàä‰∫ã‰ª∂
                thumbnail.onloadedmetadata = null;
                thumbnail.onloadeddata = null;
                thumbnail.onerror = null;
                thumbnail.oncanplay = null;

                // Âº∑Âà∂ÈáçÊñ∞ËºâÂÖ•
                thumbnail.removeAttribute('src');

                // Ë®≠ÂÆö‰∫ã‰ª∂ËôïÁêÜ
                thumbnail.onloadedmetadata = () => {
                    console.log(`[DEBUG] Á∏ÆÂúñÈáçËºâ metadata ÊàêÂäü [${idx}], readyState=${thumbnail.readyState}`);
                    try {
                        thumbnail.currentTime = 1;
                    } catch (e) {
                        console.warn(`[WARN] Ë®≠ÂÆöÁ∏ÆÂúñÊôÇÈñìÂ§±Êïó [${idx}]:`, e);
                    }
                };

                thumbnail.onloadeddata = () => {
                    console.log(`[DEBUG] Á∏ÆÂúñÈáçËºâ data ÊàêÂäü [${idx}], readyState=${thumbnail.readyState}, currentTime=${thumbnail.currentTime}`);
                    if (thumbnail.currentTime === 0) {
                        try {
                            thumbnail.currentTime = 1;
                        } catch (e) {
                            console.warn(`[WARN] Ë®≠ÂÆöÁ∏ÆÂúñÊôÇÈñìÂ§±Êïó (loadeddata) [${idx}]:`, e);
                        }
                    }
                };

                thumbnail.oncanplay = () => {
                    console.log(`[DEBUG] Á∏ÆÂúñÂèØÊí≠Êîæ [${idx}], currentTime=${thumbnail.currentTime}`);
                };

                thumbnail.onerror = (e) => {
                    console.error(`[ERROR] Á∏ÆÂúñÈáçËºâÂ§±Êïó [${idx}]:`, e, thumbnail.error);
                    thumbnail.style.display = 'none';
                    container.style.background = 'rgba(255, 0, 0, 0.3)';
                };

                // ÈáçÊñ∞Ë®≠ÂÆö src ‰∏¶ËºâÂÖ•
                setTimeout(() => {
                    console.log(`[DEBUG] Ë®≠ÂÆöÁ∏ÆÂúñ src [${idx}]`);
                    thumbnail.src = src;
                    thumbnail.load();
                }, 50 * i);  // ÈåØÈñãËºâÂÖ•ÊôÇÈñì
            });

            console.log('[DEBUG] Á∏ÆÂúñÈáçËºâÂ∑≤Ëß∏Áôº');
        }

        // ÈáçÁΩÆÊâÄÊúâË£ÅÂàáÁãÄÊÖã
        async function resetAllCropStates() {
            console.log('[DEBUG] ÈáçÁΩÆÊâÄÊúâË£ÅÂàáÁãÄÊÖã');

            // ÈáçÁΩÆÊØèÂÄãÂÆπÂô®
            document.querySelectorAll('.video-container').forEach(vc => {
                const idx = vc.dataset.index;
                const width = 300;
                const height = 200;

                // ÈáçÁΩÆË£ÅÂàáÁãÄÊÖã
                videoCropState[idx] = {
                    cropLeft: 0,
                    cropTop: 0,
                    originalWidth: width,
                    originalHeight: height
                };

                // Êõ¥Êñ∞ÂÆπÂô®Â∞∫ÂØ∏
                vc.style.width = width + 'px';
                vc.style.height = height + 'px';

                // ÈáçÁΩÆÁ∏ÆÂúñÂíåÊí≠ÊîæÂô®
                const thumbnail = vc.querySelector('.thumbnail-video');
                const player = vc.querySelector('.video-player');

                if (thumbnail) {
                    thumbnail.style.width = width + 'px';
                    thumbnail.style.height = height + 'px';
                    thumbnail.style.left = '0px';
                    thumbnail.style.top = '0px';
                }
                if (player) {
                    player.style.width = width + 'px';
                    player.style.height = height + 'px';
                    player.style.left = '0px';
                    player.style.top = '0px';
                }

                // Êõ¥Êñ∞ÂÆπÂô®Ë≥áÊñô
                if (videoContainers[idx]) {
                    videoContainers[idx].width = width;
                    videoContainers[idx].height = height;
                    videoContainers[idx].cropLeft = 0;
                    videoContainers[idx].cropTop = 0;
                    videoContainers[idx].originalWidth = width;
                    videoContainers[idx].originalHeight = height;
                }
            });

            // ‰øùÂ≠òÂà∞ÈÖçÁΩÆÊñá‰ª∂
            await savePositions();
            console.log('[DEBUG] Ë£ÅÂàáÁãÄÊÖãÂ∑≤ÈáçÁΩÆ‰∏¶‰øùÂ≠ò');
            alert('Ë£ÅÂàáÁãÄÊÖãÂ∑≤ÈáçÁΩÆÔºÅ');
        }

        function testWheelSpin() {
            if (!wheelModuleEnabled) return;
            triggerWheel(1);
        }

        // === ËΩâÁõ§Áπ™Ë£Ω ===
        function drawWheel() {
            const canvas = document.getElementById('wheelCanvas');
            const ctx = canvas.getContext('2d');
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const radius = Math.max(10, Math.min(cx, cy) - 15);

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (wheelOptions.length === 0 || radius < 10) return;

            const totalWeight = wheelOptions.reduce((sum, opt) => sum + opt.weight, 0);
            let startAngle = (wheelAngle * Math.PI / 180);

            wheelOptions.forEach(opt => {
                const sweep = (2 * Math.PI * opt.weight / totalWeight);

                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.arc(cx, cy, radius, startAngle, startAngle + sweep);
                ctx.closePath();
                ctx.fillStyle = opt.color;
                ctx.fill();

                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.lineWidth = 2;
                ctx.stroke();

                const textAngle = startAngle + sweep / 2;
                const textRadius = radius * 0.65;
                const textX = cx + textRadius * Math.cos(textAngle);
                const textY = cy + textRadius * Math.sin(textAngle);

                ctx.save();
                ctx.translate(textX, textY);
                ctx.rotate(textAngle + Math.PI / 2);
                ctx.fillStyle = '#000';
                ctx.font = `bold ${Math.max(12, radius / 12)}px Microsoft JhengHei`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(opt.name, 0, 0);
                ctx.restore();

                startAngle += sweep;
            });

            // ‰∏≠ÂøÉÂúì
            ctx.beginPath();
            ctx.arc(cx, cy, radius * 0.1, 0, Math.PI * 2);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 3;
            ctx.stroke();

            // ÊåáÈáù
            const pointerSize = radius * 0.12;
            ctx.beginPath();
            ctx.moveTo(cx - pointerSize, 10);
            ctx.lineTo(cx + pointerSize, 10);
            ctx.lineTo(cx, 10 + pointerSize * 2);
            ctx.closePath();
            ctx.fillStyle = '#e94560';
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // === ËΩâÁõ§ÂãïÁï´ ===
        function triggerWheel(spins) {
            if (isSpinning) return;
            spinWheel(spins);
        }

        function spinWheel(spins) {
            if (isSpinning || wheelOptions.length === 0) return;

            isSpinning = true;

            const startAngle = wheelAngle;
            const extraSpins = 5 + Math.floor(Math.random() * 3);
            const targetAngle = startAngle + 360 * extraSpins + Math.random() * 360;
            const duration = 4000;
            const startTime = Date.now();

            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                wheelAngle = startAngle + (targetAngle - startAngle) * eased;

                drawWheel();

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    isSpinning = false;
                    wheelAngle = wheelAngle % 360;
                    const result = getWheelResult();
                    console.log('ËΩâÁõ§ÁµêÊûú:', result);
                }
            }

            requestAnimationFrame(animate);
        }

        function getWheelResult() {
            const pointerAngle = (270 - wheelAngle % 360 + 360) % 360;
            const totalWeight = wheelOptions.reduce((sum, opt) => sum + opt.weight, 0);

            let cumAngle = 0;
            for (const opt of wheelOptions) {
                const optAngle = 360 * opt.weight / totalWeight;
                if (pointerAngle >= cumAngle && pointerAngle < cumAngle + optAngle) {
                    return opt;
                }
                cumAngle += optAngle;
            }
            return wheelOptions[0];
        }

        // === ÂΩ±ÁâáÊí≠Êîæ ===
        // Ê†πÊìöÂΩ±ÁâáË∑ØÂæëÊâæÂà∞Â∞çÊáâÁöÑÂÆπÂô®‰∏¶Êí≠Êîæ
        function triggerVideo(videoData) {
            if (!videoData.path) return;

            // ÊâæÂà∞Â∞çÊáâÁöÑÂÆπÂô® (Ê†πÊìöË∑ØÂæëÂåπÈÖç)
            let foundIndex = -1;
            for (let i = 0; i < videoGifts.length; i++) {
                if (videoGifts[i].video_path === videoData.path) {
                    foundIndex = i;
                    break;
                }
            }

            // Â¶ÇÊûúÊâæ‰∏çÂà∞Â∞çÊáâÂÆπÂô®Ôºà‰æãÂ¶ÇÈö®Ê©üÂΩ±ÁâáÔºâÔºå‰ΩøÁî®Â∞àÁî®Èö®Ê©üÂΩ±ÁâáÂÆπÂô®
            if (foundIndex === -1) {
                console.log('[Èö®Ê©üÂΩ±Áâá] ‰ΩøÁî®Â∞àÁî®ÂÆπÂô®Êí≠Êîæ:', videoData.path);
                playRandomVideo(videoData);
                return;
            }

            // ‰ΩøÁî®Â∞çÊáâÂÆπÂô®Êí≠Êîæ
            triggerVideoInContainer(foundIndex, videoData);
        }

        // Èö®Ê©üÂΩ±ÁâáÊí≠ÊîæÁãÄÊÖã
        let randomVideoQueue = [];
        let randomVideoPlaying = false;
        let randomVideoVisible = true;

        // ÂàùÂßãÂåñÈö®Ê©üÂΩ±ÁâáÂÆπÂô®‰ΩçÁΩÆ
        function initRandomVideoContainer() {
            const container = document.getElementById('randomVideoContainer');
            if (!container) return;

            // Âæû‰øùÂ≠òÁöÑ‰ΩçÁΩÆËºâÂÖ•
            const saved = savedPositions.randomVideo || {};
            container.style.width = (saved.width || 300) + 'px';
            container.style.height = (saved.height || 200) + 'px';
            container.style.left = (saved.left || 50) + 'px';
            container.style.top = (saved.top || 400) + 'px';
            randomVideoVisible = saved.visible !== false;

            if (!randomVideoVisible) {
                container.classList.add('hidden');
            }

            console.log('[Èö®Ê©üÂΩ±Áâá] ÂÆπÂô®ÂàùÂßãÂåñÂÆåÊàê');
        }

        // Êí≠ÊîæÈö®Ê©üÂΩ±ÁâáÔºà‰ΩøÁî®Â∞àÁî®ÂÆπÂô®Ôºâ
        function playRandomVideo(videoData) {
            // Âä†ÂÖ•‰ΩáÂàó
            const playCount = Math.min(videoData.count || 1, 100);
            for (let i = 0; i < playCount; i++) {
                randomVideoQueue.push({...videoData, count: 1});
            }
            console.log(`[Èö®Ê©üÂΩ±Áâá] Âä†ÂÖ•‰ΩáÂàóÔºåÁõÆÂâçÈï∑Â∫¶: ${randomVideoQueue.length}`);

            // Â¶ÇÊûúÂº∑Âà∂ÊèíÈöä‰∏îÊ≠£Âú®Êí≠ÊîæÔºåÂÅúÊ≠¢Áï∂ÂâçÊí≠Êîæ
            if (videoData.force_interrupt && randomVideoPlaying) {
                stopRandomVideo();
            }

            playNextRandomVideo();
        }

        // Êí≠Êîæ‰∏ã‰∏ÄÂÄãÈö®Ê©üÂΩ±Áâá
        async function playNextRandomVideo() {
            if (randomVideoPlaying || randomVideoQueue.length === 0) return;

            const container = document.getElementById('randomVideoContainer');
            const video = document.getElementById('randomVideoPlayer');
            if (!container || !video) {
                console.error('[Èö®Ê©üÂΩ±Áâá] Êâæ‰∏çÂà∞Â∞àÁî®ÂÆπÂô®');
                return;
            }

            const data = randomVideoQueue.shift();
            if (!data.path) {
                playNextRandomVideo();
                return;
            }

            randomVideoPlaying = true;
            console.log('[Èö®Ê©üÂΩ±Áâá] ÈñãÂßãÊí≠Êîæ:', data.path);

            // ÂèñÂæóÂ™íÈ´î URL
            let videoUrl = data.path;
            if (window.pywebview && window.pywebview.api) {
                try {
                    videoUrl = await pywebview.api.get_media_url(data.path);
                } catch (e) {
                    console.error('[Èö®Ê©üÂΩ±Áâá] ÂèñÂæó URL Â§±Êïó:', e);
                }
            }

            // Ë®≠ÂÆöÂΩ±Áâá
            video.src = videoUrl;
            video.playbackRate = data.speed || 1;
            video.volume = (data.volume || 100) / 100;
            video.currentTime = 0;

            // È°ØÁ§∫ÂÆπÂô®‰∏¶Ê®ôË®òÊí≠Êîæ‰∏≠
            container.classList.remove('hidden');
            container.classList.add('playing');

            // ËôïÁêÜÈáçË§áÊí≠Êîæ
            let currentRepeat = 0;
            const maxRepeat = data.repeat || 1;
            const maxSeconds = data.seconds || 0;

            const onEnded = () => {
                currentRepeat++;
                if (currentRepeat < maxRepeat) {
                    video.currentTime = 0;
                    video.play();
                } else {
                    finishRandomVideo();
                }
            };

            const finishRandomVideo = () => {
                video.onended = null;
                video.ontimeupdate = null;
                video.onerror = null;
                // ÈáãÊîæÂΩ±ÁâáË®òÊÜ∂È´î
                video.src = '';
                video.load();
                container.classList.remove('playing');
                // Â¶ÇÊûúÂéüÊú¨ÊòØÈö±ËóèÁöÑÔºåÊÅ¢Âæ©Èö±Ëóè
                if (!randomVideoVisible) {
                    container.classList.add('hidden');
                }
                randomVideoPlaying = false;
                console.log('[Èö®Ê©üÂΩ±Áâá] Êí≠ÊîæÂÆåÊàê');
                playNextRandomVideo();
            };

            video.onended = onEnded;

            // Â¶ÇÊûúË®≠ÂÆö‰∫ÜÁßíÊï∏ÈôêÂà∂
            if (maxSeconds > 0) {
                video.ontimeupdate = () => {
                    if (video.currentTime >= maxSeconds) {
                        currentRepeat++;
                        if (currentRepeat < maxRepeat) {
                            video.currentTime = 0;
                        } else {
                            finishRandomVideo();
                        }
                    }
                };
            }

            video.onerror = (e) => {
                console.error('[Èö®Ê©üÂΩ±Áâá] Êí≠ÊîæÈåØË™§:', e);
                finishRandomVideo();
            };

            try {
                await video.play();
            } catch (e) {
                console.error('[Èö®Ê©üÂΩ±Áâá] Êí≠ÊîæÂ§±Êïó:', e);
                finishRandomVideo();
            }
        }

        // ÂÅúÊ≠¢Èö®Ê©üÂΩ±Áâá
        function stopRandomVideo() {
            const container = document.getElementById('randomVideoContainer');
            const video = document.getElementById('randomVideoPlayer');
            if (video) {
                video.pause();
                video.onended = null;
                video.ontimeupdate = null;
                video.onerror = null;
                // ÈáãÊîæÂΩ±ÁâáË®òÊÜ∂È´î
                video.src = '';
                video.load();
            }
            if (container) {
                container.classList.remove('playing');
                if (!randomVideoVisible) {
                    container.classList.add('hidden');
                }
            }
            randomVideoPlaying = false;
        }

        // ÂàáÊèõÈö®Ê©üÂΩ±ÁâáÂÆπÂô®È°ØÁ§∫
        function toggleRandomVideoVisible() {
            const container = document.getElementById('randomVideoContainer');
            if (!container) return;

            randomVideoVisible = !randomVideoVisible;
            if (randomVideoVisible) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
            savePositions();
            return randomVideoVisible;
        }

        // === ÊäìÈ¥®Â≠êÊ®°ÁµÑ ===
        let duckVideoPlaying = false;
        let duckVideoVisible = true;
        let duckCounterVisible = true;
        let pendingDuckAmount = 0;  // Á≠âÂæÖÂΩ±ÁâáÊí≠ÂÆåÂæåË¶ÅÂä†ÁöÑÈ¥®Â≠êÊï∏Èáè
        let pendingDuckUsername = '';  // ÊäìÂà∞È¥®Â≠êÁöÑÁî®Êà∂Âêç
        let pendingPityData = null;  // Á≠âÂæÖÂΩ±ÁâáÊí≠ÂÆåÂæåË¶ÅÊõ¥Êñ∞ÁöÑ‰øùÂ∫ïË≥áÊñô
        let duckVideoQueue = [];  // ÊäìÈ¥®Â≠êÂΩ±Áâá‰ΩáÂàó
        let pendingLeaderboardData = null;  // Áï∂ÂâçÂΩ±ÁâáÊí≠ÂÆåÂæåË¶ÅÊõ¥Êñ∞ÁöÑÊéíË°åÊ¶úË≥áÊñô
        let pendingMilestoneData = null;  // Áï∂ÂâçÂΩ±ÁâáÊí≠ÂÆåÂæåË¶ÅËß∏ÁôºÁöÑÈáåÁ®ãÁ¢ë

        // Êí≠ÊîæÊäìÈ¥®Â≠êÂΩ±Áâá
        async function playDuckVideo(videoData) {
            // Â¶ÇÊûúÊ≠£Âú®Êí≠ÊîæÔºåÂä†ÂÖ•‰ΩáÂàó
            if (duckVideoPlaying) {
                duckVideoQueue.push(videoData);
                return;
            }
            await playDuckVideoNow(videoData);
        }

        // Á´ãÂç≥Êí≠ÊîæÊäìÈ¥®Â≠êÂΩ±Áâá
        async function playDuckVideoNow(videoData) {
            // Á´ãÂç≥Ë®≠ÂÆöÊí≠Êîæ‰∏≠ÁãÄÊÖãÔºåÈò≤Ê≠¢Á´∂ÊÖãÊ¢ù‰ª∂ÔºàÂøÖÈ†àÂú®‰ªª‰Ωï await ‰πãÂâçÔºâ
            duckVideoPlaying = true;

            const container = document.getElementById('duckVideoContainer');
            const video = document.getElementById('duckVideoPlayer');

            if (!container || !video) {
                duckVideoPlaying = false;
                playNextDuckVideo();
                return;
            }

            // ÂÑ≤Â≠òÂæÖÂä†ÁöÑÈ¥®Â≠êÊï∏ÈáèÔºàÂΩ±ÁâáÊí≠ÂÆåÂæåÊâçÂä†Ôºâ
            pendingDuckAmount = videoData.caught ? (videoData.duckAmount || 0) : 0;
            pendingDuckUsername = videoData.username || '';
            // ÂÑ≤Â≠ò‰øùÂ∫ïË≥áÊñôÔºàÂΩ±ÁâáÊí≠ÂÆåÂæåÊâçÊõ¥Êñ∞ UIÔºâ
            if (videoData.pityEnabled) {
                pendingPityData = {
                    current: videoData.pityCounter,
                    threshold: videoData.pityThreshold,
                    thresholdJackpot: videoData.pityThresholdJackpot
                };
            } else {
                pendingPityData = null;
            }
            // ÂÑ≤Â≠òÊéíË°åÊ¶úË≥áÊñôÔºàÂΩ±ÁâáÊí≠ÂÆåÂæåÊõ¥Êñ∞Ôºâ
            pendingLeaderboardData = videoData.leaderboardData || null;
            // ÂÑ≤Â≠òÈáåÁ®ãÁ¢ëË≥áÊñôÔºàÂΩ±ÁâáÊí≠ÂÆåÂæåËß∏ÁôºÔºâ
            pendingMilestoneData = videoData.milestoneData || null;

            try {
                // ÂèñÂæóÂ™íÈ´î URL
                let videoUrl = videoData.path;
                if (window.pywebview && window.pywebview.api) {
                    videoUrl = await window.pywebview.api.get_media_url(videoData.path);
                }

                // ÂÖàÊ∏ÖÁ©∫ËàäÂΩ±ÁâáÊ∫ê‰ª•ÈáãÊîæË®òÊÜ∂È´î
                video.pause();
                video.removeAttribute('src');
                video.load();

                // Á≠âÂæÖ‰∏ÄÂπÄÁ¢∫‰øùÊ∏ÖÁêÜÂÆåÊàê
                await new Promise(r => requestAnimationFrame(r));

                // Ë®≠ÂÆöÂΩ±Áâá
                video.src = videoUrl;
                video.playbackRate = videoData.speed || 1;
                video.volume = (videoData.volume || 100) / 100;
                video.muted = false;

                // Á≠âÂæÖÂΩ±ÁâáËºâÂÖ•ÂÆåÊàêÂÜçÊí≠ÊîæÔºàÊ∏õÂ∞ëÂç°È†ìÔºâ
                await new Promise((resolve, reject) => {
                    const onCanPlay = () => {
                        video.removeEventListener('canplaythrough', onCanPlay);
                        video.removeEventListener('error', onError);
                        resolve();
                    };
                    const onError = () => {
                        video.removeEventListener('canplaythrough', onCanPlay);
                        video.removeEventListener('error', onError);
                        reject();
                    };
                    video.addEventListener('canplaythrough', onCanPlay);
                    video.addEventListener('error', onError);
                    video.load();
                    // Ë∂ÖÊôÇ‰øùË≠∑
                    setTimeout(resolve, 5000);
                });

                // ‰ΩøÁî® requestAnimationFrame Á¢∫‰øùÂú®‰∏ã‰∏ÄÂπÄÈ°ØÁ§∫
                await new Promise(r => requestAnimationFrame(r));

                // È°ØÁ§∫ÂÆπÂô®‰∏¶Êí≠Êîæ
                container.classList.remove('hidden');
                container.classList.add('playing');

                // ËôïÁêÜÊí≠ÊîæÁµêÊùü
                const onEnded = () => {
                    finishDuckVideo();
                };

                // Â¶ÇÊûúÊúâÊôÇÈñìÈôêÂà∂
                if (videoData.seconds > 0) {
                    setTimeout(() => {
                        if (duckVideoPlaying) {
                            finishDuckVideo();
                        }
                    }, videoData.seconds * 1000);
                }

                video.onended = onEnded;
                video.onerror = () => {
                    finishDuckVideo();
                };

                await video.play();
            } catch (e) {
                console.error('Duck video playback error:', e);
                finishDuckVideo();
            }
        }

        // ÁµêÊùüÊäìÈ¥®Â≠êÂΩ±Áâá
        async function finishDuckVideo() {
            const container = document.getElementById('duckVideoContainer');
            const video = document.getElementById('duckVideoPlayer');

            if (video) {
                video.pause();
                video.onended = null;
                video.onerror = null;
                video.oncanplay = null;
                video.oncanplaythrough = null;
                // ÂæπÂ∫ïÈáãÊîæÂΩ±ÁâáË®òÊÜ∂È´î
                video.removeAttribute('src');
                video.load();
                // ‰ΩøÁî® requestAnimationFrame Á¢∫‰øùÊ∏ÖÁêÜÂÆåÊàê
                await new Promise(r => requestAnimationFrame(r));
            }
            if (container) {
                container.classList.remove('playing');
                if (!duckVideoVisible) {
                    container.classList.add('hidden');
                }
            }

            // ÂÖàÊçïÁç≤Áï∂ÂâçÁöÑÊï∏ÊìöÔºåÁÑ∂ÂæåÈáçÁΩÆÔºàÈÅøÂÖçÁ´∂ÊÖãÊ¢ù‰ª∂Ôºâ
            const amountToAdd = pendingDuckAmount;
            const pityData = pendingPityData;
            const leaderboardData = pendingLeaderboardData;
            const milestoneData = pendingMilestoneData;
            pendingDuckAmount = 0;
            pendingDuckUsername = '';
            pendingPityData = null;
            pendingLeaderboardData = null;
            pendingMilestoneData = null;

            // ÂΩ±ÁâáÊí≠ÂÆåÂæåÊâçÂ¢ûÂä†È¥®Â≠êÊï∏Èáè
            if (amountToAdd > 0) {
                try {
                    await window.pywebview.api.add_duck(amountToAdd);
                } catch (e) {
                    // ÂøΩÁï•ÈåØË™§
                }
            }

            // ÂΩ±ÁâáÊí≠ÂÆåÂæåÊâçÊõ¥Êñ∞‰øùÂ∫ïÈÄ≤Â∫¶ÔºàÁ∂†ÂπïÊú¨Âú∞ UI + ÈÄöÁü•‰∏ªË¶ñÁ™óÔºâ
            if (pityData) {
                updatePityCounter(pityData);
                // ÈÄöÁü•‰∏ªË¶ñÁ™óÊõ¥Êñ∞‰øùÂ∫ïÈÄ≤Â∫¶
                try {
                    await window.pywebview.api.notify_pity_update();
                } catch (e) {
                    // ÂøΩÁï•ÈåØË™§
                }
            }

            // ÂΩ±ÁâáÊí≠ÂÆåÂæåÊâçÊõ¥Êñ∞ÊéíË°åÊ¶ú
            if (leaderboardData) {
                console.log('[ÊéíË°åÊ¶ú] ÂΩ±ÁâáÊí≠ÂÆåÔºåÊõ¥Êñ∞ÊéíË°åÊ¶ú');
                updateLeaderboard(leaderboardData);
            }

            // ÂΩ±ÁâáÊí≠ÂÆåÂæåÊâçËß∏ÁôºÈáåÁ®ãÁ¢ë
            if (milestoneData) {
                console.log('[ÈáåÁ®ãÁ¢ë] ÂΩ±ÁâáÊí≠ÂÆåÔºåËß∏ÁôºÈáåÁ®ãÁ¢ë:', milestoneData.type);
                triggerMilestoneCelebration(milestoneData);
            }

            // ÂÖ®ÈÉ®ËôïÁêÜÂÆåÊàêÂæåÊâçË®≠ÁÇ∫ falseÔºåÁ¢∫‰øùÊñ∞‰∫ã‰ª∂ÊúÉË¢´Ê≠£Á¢∫ÊéíÈöä
            duckVideoPlaying = false;

            // Êí≠Êîæ‰ΩáÂàó‰∏≠ÁöÑ‰∏ã‰∏ÄÂÄãÂΩ±Áâá
            playNextDuckVideo();
        }

        // Êí≠Êîæ‰ΩáÂàó‰∏≠ÁöÑ‰∏ã‰∏ÄÂÄãÊäìÈ¥®Â≠êÂΩ±Áâá
        function playNextDuckVideo() {
            if (duckVideoQueue.length > 0) {
                const nextVideo = duckVideoQueue.shift();
                playDuckVideoNow(nextVideo);
            } else {
                // ÈÄöÁü•‰∏ªÈÄ≤Á®ãËôïÁêÜ‰∏ã‰∏ÄÂÄã
                try {
                    window.pywebview.api.notify_duck_video_finished();
                } catch (e) {
                    // ÂøΩÁï•ÈåØË™§
                }
            }
        }

        // Êõ¥Êñ∞È¥®Â≠êË®àÊï∏
        let lastDuckCount = 0;
        function updateDuckCounter(count) {
            const counterValue = document.getElementById('duckCounterValue');
            const counterAdd = document.getElementById('duckCounterAdd');
            const counterBox = document.getElementById('duckCounterBox');

            if (counterValue) {
                // Ë®àÁÆóÂ¢ûÂä†ÁöÑÊï∏Èáè
                const diff = count - lastDuckCount;

                // Â¶ÇÊûúÂ¢ûÂä†‰∫ÜÈ¥®Â≠êÔºåÈ°ØÁ§∫ +X ÂãïÁï´
                if (diff > 0 && counterAdd) {
                    counterAdd.textContent = `+${diff}`;
                    counterAdd.classList.remove('show');
                    // Âº∑Âà∂ÈáçÁπ™‰ª•ÈáçÊñ∞Ëß∏ÁôºÂãïÁï´
                    void counterAdd.offsetWidth;
                    counterAdd.classList.add('show');
                }

                counterValue.textContent = count;
                // Ê∑ªÂä†ÂãïÁï´ÊïàÊûú
                counterValue.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    counterValue.style.transform = 'scale(1)';
                }, 200);

                lastDuckCount = count;
            }
        }

        // ÂàáÊèõÈ¥®Â≠êÂΩ±ÁâáÂÆπÂô®È°ØÁ§∫
        function toggleDuckVideoVisible() {
            const container = document.getElementById('duckVideoContainer');
            if (!container) return;

            duckVideoVisible = !duckVideoVisible;
            if (duckVideoVisible) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
            savePositions();
            return duckVideoVisible;
        }

        // ÂàáÊèõÈ¥®Â≠êË®àÊï∏È°ØÁ§∫
        function toggleDuckCounterVisible() {
            const container = document.getElementById('duckCounterBox');
            if (!container) return;

            duckCounterVisible = !duckCounterVisible;
            if (duckCounterVisible) {
                // ÂÖàÂ•óÁî®Â∞∫ÂØ∏ÔºàÂú®È°ØÁ§∫‰πãÂâçÔºâ
                if (scalableBoxCache.duckCounterBox) {
                    const cached = scalableBoxCache.duckCounterBox;
                    container.style.width = cached.width + 'px';
                    container.style.height = cached.height + 'px';
                    container.style.left = cached.left + 'px';
                    container.style.top = cached.top + 'px';
                }
                // ÂÖàÁî® visibility:hidden È°ØÁ§∫Ôºà‰Ωî‰Ωç‰ΩÜ‰∏çÂèØË¶ãÔºâ‰ª•‰æøË®àÁÆóÂ∞∫ÂØ∏
                container.style.visibility = 'hidden';
                container.classList.remove('hidden');
                // ‰∏ã‰∏ÄÂπÄÂÜçÂ•óÁî®Á∏ÆÊîæ‰∏¶È°ØÁ§∫
                requestAnimationFrame(() => {
                    if (scalableBoxCache.duckCounterBox) {
                        const cached = scalableBoxCache.duckCounterBox;
                        applyScalableBoxScale(container, cached.width, cached.height);
                    }
                    container.style.visibility = 'visible';
                });
            } else {
                container.classList.add('hidden');
            }
            savePositions();
            return duckCounterVisible;
        }

        // ‰øùÂ∫ïË®àÊï∏È°ØÁ§∫
        let pityCounterVisible = false;

        // scalable-box ÂÖÉÁ¥†Â∞∫ÂØ∏Á∑©Â≠òÔºàËß£Ê±∫Èö±ËóèÊôÇÁÑ°Ê≥ïËÆÄÂèñÂ∞∫ÂØ∏ÁöÑÂïèÈ°åÔºâ
        const scalableBoxCache = {
            pityCounterBox: { width: 180, height: 80, left: 50, top: 170 },
            duckCounterBox: { width: 200, height: 100, left: 50, top: 50 },
            leaderboardBox: { width: 320, height: 100, left: 50, top: 300 }
        };

        function updatePityCounter(data) {
            const counterValue = document.getElementById('pityCounterValue');
            const counterStage = document.getElementById('pityCounterStage');
            const counterBox = document.getElementById('pityCounterBox');

            if (!counterValue) return;

            const current = data.current || 0;
            const t1 = data.threshold || 1000;
            const t2 = data.thresholdJackpot || 2000;

            // Ê±∫ÂÆöÈ°ØÁ§∫Âì™‰∏ÄÂ±§
            if (current >= t1) {
                // Â∑≤ÈÅéÁ¨¨‰∏ÄÂ±§ÔºåÈ°ØÁ§∫ÁµÇÊ•µ‰øùÂ∫ïÈÄ≤Â∫¶
                counterValue.textContent = `${current} / ${t2}`;
                counterValue.classList.add('stage2');
                if (counterStage) counterStage.textContent = 'üî• Ë°ùÂà∫ÁµÇÊ•µ‰øùÂ∫ïÔºÅ';
            } else {
                counterValue.textContent = `${current} / ${t1}`;
                counterValue.classList.remove('stage2');
                if (current >= t1 * 0.9) {
                    if (counterStage) counterStage.textContent = 'Âç≥Â∞áËß∏Áôº‰øùÂ∫ïÔºÅ';
                } else if (current >= t1 * 0.7) {
                    if (counterStage) counterStage.textContent = 'Êé•Ëøë‰øùÂ∫ï‰∏≠...';
                } else {
                    if (counterStage) counterStage.textContent = '';
                }
            }

            // Ê∑ªÂä†ÂãïÁï´ÊïàÊûú
            counterValue.style.transform = 'scale(1.1)';
            setTimeout(() => {
                counterValue.style.transform = 'scale(1)';
            }, 200);
        }

        // ÂàáÊèõ‰øùÂ∫ïË®àÊï∏È°ØÁ§∫
        function togglePityCounterVisible() {
            const container = document.getElementById('pityCounterBox');
            if (!container) return;

            pityCounterVisible = !pityCounterVisible;
            if (pityCounterVisible) {
                // ÂÖàÂ•óÁî®Â∞∫ÂØ∏ÔºàÂú®È°ØÁ§∫‰πãÂâçÔºâ
                if (scalableBoxCache.pityCounterBox) {
                    const cached = scalableBoxCache.pityCounterBox;
                    container.style.width = cached.width + 'px';
                    container.style.height = cached.height + 'px';
                    container.style.left = cached.left + 'px';
                    container.style.top = cached.top + 'px';
                }
                // ÂÖàÁî® visibility:hidden È°ØÁ§∫Ôºà‰Ωî‰Ωç‰ΩÜ‰∏çÂèØË¶ãÔºâ‰ª•‰æøË®àÁÆóÂ∞∫ÂØ∏
                container.style.visibility = 'hidden';
                container.classList.remove('hidden');
                // ‰∏ã‰∏ÄÂπÄÂÜçÂ•óÁî®Á∏ÆÊîæ‰∏¶È°ØÁ§∫
                requestAnimationFrame(() => {
                    if (scalableBoxCache.pityCounterBox) {
                        const cached = scalableBoxCache.pityCounterBox;
                        applyScalableBoxScale(container, cached.width, cached.height);
                    }
                    container.style.visibility = 'visible';
                });
            } else {
                container.classList.add('hidden');
            }
            savePositions();
            return pityCounterVisible;
        }

        // === ÊéíË°åÊ¶ú ===
        let leaderboardVisible = false;
        let leaderboardData = { totalRanking: [], singleHighest: [] };

        // ÂàáÊèõÊéíË°åÊ¶úÈ°ØÁ§∫
        function toggleLeaderboardVisible() {
            const container = document.getElementById('leaderboardBox');
            if (!container) return;

            leaderboardVisible = !leaderboardVisible;
            if (leaderboardVisible) {
                // ÂÖàÂ•óÁî®Â∞∫ÂØ∏ÔºàÂú®È°ØÁ§∫‰πãÂâçÔºâ
                if (scalableBoxCache.leaderboardBox) {
                    const cached = scalableBoxCache.leaderboardBox;
                    container.style.width = cached.width + 'px';
                    container.style.height = cached.height + 'px';
                    container.style.left = cached.left + 'px';
                    container.style.top = cached.top + 'px';
                }
                // ÂÖàÁî® visibility:hidden È°ØÁ§∫Ôºà‰Ωî‰Ωç‰ΩÜ‰∏çÂèØË¶ãÔºâ‰ª•‰æøË®àÁÆóÂ∞∫ÂØ∏
                container.style.visibility = 'hidden';
                container.classList.remove('hidden');
                // ‰∏ã‰∏ÄÂπÄÂÜçÂ•óÁî®Á∏ÆÊîæ‰∏¶È°ØÁ§∫
                requestAnimationFrame(() => {
                    if (scalableBoxCache.leaderboardBox) {
                        const cached = scalableBoxCache.leaderboardBox;
                        applyScalableBoxScale(container, cached.width, cached.height);
                    }
                    container.style.visibility = 'visible';
                });
            } else {
                container.classList.add('hidden');
            }
            savePositions();
            return leaderboardVisible;
        }

        // Êõ¥Êñ∞ÊéíË°åÊ¶ú
        let lastLeaderboardState = { totalDucks: 0, singleAmount: 0, totalUser: '', singleUser: '' };

        function updateLeaderboard(data) {
            if (!data) return;
            leaderboardData = data;

            // Ê∏≤ÊüìÊéíË°åÊ¶úÔºàÁ¥ØË®àÁ¨¨‰∏ÄÂêç + ÂñÆÊ¨°ÊúÄÈ´òÔºâ
            const simpleList = document.getElementById('gsLeaderboardSimple');
            if (simpleList) {
                const totalItem = data.totalRanking && data.totalRanking.length > 0 ? data.totalRanking[0] : null;
                const singleItem = data.singleHighest && data.singleHighest.length > 0 ? data.singleHighest[0] : null;

                // Ê™¢Êü•ÊòØÂê¶ÊúâËÆäÂåñ
                const newTotalDucks = totalItem ? totalItem.totalDucks : 0;
                const newSingleAmount = singleItem ? singleItem.amount : 0;
                const newTotalUser = totalItem ? (totalItem.uniqueId || totalItem.nickname) : '';
                const newSingleUser = singleItem ? (singleItem.uniqueId || singleItem.nickname) : '';

                const totalChanged = newTotalDucks !== lastLeaderboardState.totalDucks || newTotalUser !== lastLeaderboardState.totalUser;
                const singleChanged = newSingleAmount !== lastLeaderboardState.singleAmount || newSingleUser !== lastLeaderboardState.singleUser;

                // Êõ¥Êñ∞ÁãÄÊÖã
                lastLeaderboardState = { totalDucks: newTotalDucks, singleAmount: newSingleAmount, totalUser: newTotalUser, singleUser: newSingleUser };

                simpleList.innerHTML = `
                    <div class="lb-row${totalChanged ? ' updating' : ''}">
                        <span class="lb-icon gold">üëë</span>
                        ${totalItem && totalItem.avatar
                            ? `<img class="lb-avatar-mini gold-border" src="${totalItem.avatar}" onerror="this.outerHTML='<div class=\\'lb-avatar-mini gold-border placeholder\\'>ü¶Ü</div>'">`
                            : '<div class="lb-avatar-mini gold-border placeholder">ü¶Ü</div>'
                        }
                        <span class="lb-name">${totalItem ? escapeHtmlGs(totalItem.nickname || totalItem.name) : '---'}</span>
                        <span class="lb-value gold">${totalItem ? totalItem.totalDucks.toLocaleString() : 0}ü¶Ü</span>
                    </div>
                    <div class="lb-row${singleChanged ? ' updating' : ''}">
                        <span class="lb-icon purple">‚≠ê</span>
                        ${singleItem && singleItem.avatar
                            ? `<img class="lb-avatar-mini purple-border" src="${singleItem.avatar}" onerror="this.outerHTML='<div class=\\'lb-avatar-mini purple-border placeholder\\'>ü¶Ü</div>'">`
                            : '<div class="lb-avatar-mini purple-border placeholder">ü¶Ü</div>'
                        }
                        <span class="lb-name">${singleItem ? escapeHtmlGs(singleItem.nickname || singleItem.name) : '---'}</span>
                        <span class="lb-value purple">${singleItem ? singleItem.amount.toLocaleString() : 0}ü¶Ü</span>
                    </div>
                `;
            }
        }

        // HTML ËΩâÁæ©
        function escapeHtmlGs(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // === ÈáåÁ®ãÁ¢ëÊÖ∂Á•ù ===
        let milestoneTimeout = null;

        async function triggerMilestoneCelebration(data) {
            console.log('[ÈáåÁ®ãÁ¢ë] Ëß∏ÁôºÊÖ∂Á•ù:', data);

            const overlay = document.getElementById('milestoneOverlay');
            const video = document.getElementById('milestoneVideo');
            const badge = document.getElementById('milestoneBadge');
            const avatar = document.getElementById('milestoneAvatar');
            const name = document.getElementById('milestoneName');
            const amount = document.getElementById('milestoneAmount');

            if (!overlay || !video) return;

            // Ê∏ÖÈô§‰πãÂâçÁöÑË®àÊôÇÂô®
            if (milestoneTimeout) {
                clearTimeout(milestoneTimeout);
                milestoneTimeout = null;
            }

            // Ë®≠ÂÆöÂÖßÂÆπ
            if (data.type === 'total') {
                badge.textContent = 'üèÜ Á¥ØË®àÁ¨¨‰∏Ä';
            } else {
                badge.textContent = 'üéØ ÂñÆÊ¨°ÊúÄÈ´ò';
            }

            name.textContent = data.nickname || 'Êú™Áü•Áî®Êà∂';
            amount.textContent = (data.amount || 0).toLocaleString();

            // Ë®≠ÂÆöÈ†≠ÂÉè
            if (data.avatar) {
                avatar.src = data.avatar;
                avatar.classList.remove('placeholder');
                avatar.style.display = 'block';
                avatar.onerror = () => {
                    avatar.style.display = 'none';
                    // ÂâµÂª∫‰∏ÄÂÄã‰Ωî‰ΩçÁ¨¶
                    const placeholder = document.createElement('div');
                    placeholder.className = 'milestone-avatar placeholder';
                    placeholder.textContent = 'ü¶Ü';
                    avatar.parentNode.insertBefore(placeholder, avatar);
                };
            } else {
                avatar.style.display = 'none';
                // Ê™¢Êü•ÊòØÂê¶Â∑≤Êúâ‰Ωî‰ΩçÁ¨¶
                const existingPlaceholder = overlay.querySelector('.milestone-avatar.placeholder');
                if (!existingPlaceholder) {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'milestone-avatar placeholder';
                    placeholder.textContent = 'ü¶Ü';
                    avatar.parentNode.insertBefore(placeholder, avatar);
                }
            }

            // Ë®≠ÂÆöÂΩ±Áâá
            if (data.videoPath) {
                try {
                    const mediaUrl = await pywebview.api.get_media_url(data.videoPath);
                    video.src = mediaUrl;
                    video.currentTime = 0;
                    video.play().catch(e => console.error('[ÈáåÁ®ãÁ¢ë] ÂΩ±ÁâáÊí≠ÊîæÂ§±Êïó:', e));
                } catch (e) {
                    console.error('[ÈáåÁ®ãÁ¢ë] Áç≤ÂèñÂΩ±ÁâáURLÂ§±Êïó:', e);
                }
            }

            // È°ØÁ§∫Ë¶ÜËìãÂ±§
            overlay.classList.add('active');

            // ÂΩ±ÁâáÁµêÊùüÊàñË∂ÖÊôÇÂæåÈö±ËóèÔºàÊúÄÂ§öÈ°ØÁ§∫ 15 ÁßíÔºâ
            const hideOverlay = () => {
                overlay.classList.remove('active');
                video.pause();
                video.src = '';
                // ÁßªÈô§ÂèØËÉΩÁöÑ‰Ωî‰ΩçÁ¨¶
                const placeholder = overlay.querySelector('.milestone-avatar.placeholder');
                if (placeholder) {
                    placeholder.remove();
                }
            };

            video.onended = hideOverlay;
            milestoneTimeout = setTimeout(hideOverlay, 15000);
        }

        // === ÈÄ≤Â†¥ÊïàÊûú ===
        let entryPlaying = false;

        function triggerEntry(data) {
            console.log('[ENTRY] Ëß∏ÁôºÈÄ≤Â†¥ÊïàÊûú:', data);

            // Ê±∫ÂÆö‰ΩøÁî®Âì™ÂÄãÂÆπÂô®ÔºàÁ∏ÆÂúñÂÆπÂô®ÊàñÂÖ®Â±èÂÆπÂô®Ôºâ
            const useSmallContainer = entryVideoVisible && !data.is_audio;

            const fullContainer = document.getElementById('entryContainer');
            const fullVideo = document.getElementById('entryVideo');
            const audio = document.getElementById('entryAudio');

            const smallContainer = document.getElementById('entryVideoContainer');
            const smallPlayer = document.getElementById('entryPlayer');
            const smallAudio = document.getElementById('entryPlayerAudio');

            // Â¶ÇÊûúË®≠ÂÆöÂº∑Âà∂‰∏≠Êñ∑ÔºåÂÖàÂÅúÊ≠¢ÊâÄÊúâÂÖ∂‰ªñÂΩ±Áâá
            if (data.force_interrupt) {
                console.log('[ENTRY] Âº∑Âà∂‰∏≠Êñ∑ÂÖ∂‰ªñÊí≠Êîæ');
                // ÂÅúÊ≠¢ÊâÄÊúâÂΩ±ÁâáÂÆπÂô®
                document.querySelectorAll('.video-container').forEach(vc => {
                    const idx = vc.dataset.index;
                    if (idx !== undefined) {
                        stopVideoInContainer(parseInt(idx));
                    }
                });
            }

            // Ê∫ñÂÇôÂΩ±ÁâáË∑ØÂæë
            const videoSrc = formatVideoPath(data.path);

            if (data.is_audio) {
                // Èü≥ÊïàÊ®°Âºè - ‰ΩøÁî®Á∏ÆÂúñÂÆπÂô®ÁöÑ audio ÊàñÂÖ®Â±èÂÆπÂô®ÁöÑ audio
                const targetAudio = entryVideoVisible ? smallAudio : audio;
                if (!targetAudio) {
                    console.error('[ENTRY] Êâæ‰∏çÂà∞Èü≥Ë®äÂÖÉÁ¥†');
                    return;
                }
                targetAudio.src = videoSrc;
                targetAudio.volume = (data.volume || 100) / 100;
                targetAudio.onended = () => {
                    console.log('[ENTRY] Èü≥ÊïàÊí≠ÊîæÁµêÊùü');
                    entryPlaying = false;
                };
                targetAudio.onerror = (e) => {
                    console.error('[ENTRY] Èü≥ÊïàÊí≠ÊîæÈåØË™§:', e);
                    entryPlaying = false;
                };
                targetAudio.play().catch(e => {
                    console.error('[ENTRY] Èü≥ÊïàÊí≠ÊîæÂ§±Êïó:', e);
                });
                entryPlaying = true;
            } else if (useSmallContainer && smallContainer && smallPlayer) {
                // ÂΩ±ÁâáÊ®°Âºè - Âú®Á∏ÆÂúñÂÆπÂô®‰∏≠Êí≠Êîæ
                console.log('[ENTRY] ‰ΩøÁî®Á∏ÆÂúñÂÆπÂô®Êí≠Êîæ');
                smallPlayer.src = videoSrc;
                smallPlayer.volume = (data.volume || 100) / 100;
                smallPlayer.muted = false;

                smallPlayer.onloadedmetadata = () => {
                    console.log('[ENTRY] ÂΩ±ÁâáÂ∑≤ËºâÂÖ•ÔºàÁ∏ÆÂúñÂÆπÂô®Ôºâ');
                };

                smallPlayer.onended = () => {
                    console.log('[ENTRY] ÂΩ±ÁâáÊí≠ÊîæÁµêÊùüÔºàÁ∏ÆÂúñÂÆπÂô®Ôºâ');
                    smallContainer.classList.remove('playing');
                    smallPlayer.src = '';
                    entryPlaying = false;
                };

                smallPlayer.onerror = (e) => {
                    console.error('[ENTRY] ÂΩ±ÁâáÊí≠ÊîæÈåØË™§ÔºàÁ∏ÆÂúñÂÆπÂô®Ôºâ:', e);
                    smallContainer.classList.remove('playing');
                    smallPlayer.src = '';
                    entryPlaying = false;
                };

                // È°ØÁ§∫ÂÆπÂô®‰∏¶Êí≠Êîæ
                smallContainer.classList.add('playing');
                entryPlaying = true;

                smallPlayer.play().then(() => {
                    console.log('[ENTRY] ÂΩ±ÁâáÈñãÂßãÊí≠ÊîæÔºàÁ∏ÆÂúñÂÆπÂô®Ôºâ');
                }).catch(e => {
                    console.error('[ENTRY] ÂΩ±ÁâáÊí≠ÊîæÂ§±ÊïóÔºàÁ∏ÆÂúñÂÆπÂô®Ôºâ:', e);
                    smallContainer.classList.remove('playing');
                    entryPlaying = false;
                });
            } else {
                // ÂΩ±ÁâáÊ®°Âºè - ÂÖ®Â±èÈ°ØÁ§∫
                if (!fullContainer || !fullVideo) {
                    console.error('[ENTRY] Êâæ‰∏çÂà∞ÂÖ®Â±èÈÄ≤Â†¥ÂÆπÂô®');
                    return;
                }
                fullVideo.src = videoSrc;
                fullVideo.volume = (data.volume || 100) / 100;
                fullVideo.muted = false;

                fullVideo.onloadedmetadata = () => {
                    console.log('[ENTRY] ÂΩ±ÁâáÂ∑≤ËºâÂÖ•');
                };

                fullVideo.onended = () => {
                    console.log('[ENTRY] ÂΩ±ÁâáÊí≠ÊîæÁµêÊùü');
                    fullContainer.classList.remove('active');
                    fullVideo.src = '';
                    entryPlaying = false;
                };

                fullVideo.onerror = (e) => {
                    console.error('[ENTRY] ÂΩ±ÁâáÊí≠ÊîæÈåØË™§:', e);
                    fullContainer.classList.remove('active');
                    fullVideo.src = '';
                    entryPlaying = false;
                };

                // È°ØÁ§∫ÂÆπÂô®‰∏¶Êí≠Êîæ
                fullContainer.classList.add('active');
                entryPlaying = true;

                fullVideo.play().then(() => {
                    console.log('[ENTRY] ÂΩ±ÁâáÈñãÂßãÊí≠Êîæ');
                }).catch(e => {
                    console.error('[ENTRY] ÂΩ±ÁâáÊí≠ÊîæÂ§±Êïó:', e);
                    fullContainer.classList.remove('active');
                    entryPlaying = false;
                });
            }

            // È°ØÁ§∫ÈÄ≤Â†¥ÊñáÂ≠ó
            if (data.show_text && data.text) {
                showEntryText(data);
            }
        }

        // ÈÄ≤Â†¥ÊñáÂ≠óË®àÊôÇÂô®
        let entryTextTimer = null;

        function showEntryText(data) {
            const textContainer = document.getElementById('entryTextContainer');
            const textElement = document.getElementById('entryText');

            if (!textContainer || !textElement) return;

            // Ê∏ÖÈô§‰πãÂâçÁöÑË®àÊôÇÂô®
            if (entryTextTimer) {
                clearTimeout(entryTextTimer);
                entryTextTimer = null;
            }

            // ÊõøÊèõ {name} ÁÇ∫Áî®Êà∂Âêç
            const displayText = (data.text || '').replace(/\{name\}/g, data.username || '');

            // Ë®≠ÂÆöÊñáÂ≠óÊ®£Âºè
            textElement.textContent = displayText;
            textElement.style.fontSize = (data.text_size || 48) + 'px';
            textElement.style.color = data.text_color || '#ffffff';
            textElement.classList.remove('fade-out');

            // È°ØÁ§∫ÂÆπÂô®
            textContainer.classList.remove('hidden');

            // Ë®≠ÂÆöËá™ÂãïÈö±Ëóè
            const duration = (data.text_duration || 5) * 1000;
            entryTextTimer = setTimeout(() => {
                hideEntryText();
            }, duration);

            console.log('[ENTRY] È°ØÁ§∫ÈÄ≤Â†¥ÊñáÂ≠ó:', displayText);
        }

        function hideEntryText() {
            const textContainer = document.getElementById('entryTextContainer');
            const textElement = document.getElementById('entryText');

            if (!textElement) return;

            // Ê∑ªÂä†Ê∑°Âá∫ÂãïÁï´
            textElement.classList.add('fade-out');

            // ÂãïÁï´ÁµêÊùüÂæåÈö±Ëóè
            setTimeout(() => {
                if (textContainer) {
                    textContainer.classList.add('hidden');
                }
                textElement.classList.remove('fade-out');
            }, 500);
        }

        // ÂÅúÊ≠¢ÈÄ≤Â†¥ÊïàÊûú
        function stopEntry() {
            const container = document.getElementById('entryContainer');
            const video = document.getElementById('entryVideo');
            const audio = document.getElementById('entryAudio');

            if (video) {
                video.pause();
                video.src = '';
            }
            if (audio) {
                audio.pause();
                audio.src = '';
            }
            if (container) {
                container.classList.remove('active');
            }
            entryPlaying = false;
        }

        // === ÊãñÊõ≥ÂäüËÉΩ ===
        let dragState = { active: false, elem: null, offsetX: 0, offsetY: 0 };

        function initDraggable() {
            const draggables = document.querySelectorAll('.draggable');

            draggables.forEach(elem => {
                // ÁßªÈô§ËàäÁöÑÁõ£ËÅΩÂô®ÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
                elem.removeEventListener('mousedown', handleDragStart);
                elem.addEventListener('mousedown', handleDragStart);
            });
        }

        function handleDragStart(e) {
            if (e.button !== 0) return;
            if (e.target.classList.contains('resize-handle')) return;

            const elem = e.currentTarget;

            // ÂèñÂæóÂÖÉÁ¥†‰ΩçÁΩÆÔºàÂÑ™ÂÖà‰ΩøÁî® style ÂÄºÔºåÈÅøÂÖçÈö±ËóèÊôÇ offset ÁÇ∫ 0Ôºâ
            let elemLeft = elem.offsetLeft;
            let elemTop = elem.offsetTop;

            // Â¶ÇÊûúÊòØ scalable-box ‰∏îÊúâÁ∑©Â≠òÔºå‰ΩøÁî®Á∑©Â≠òÂÄº
            if (elem.classList.contains('scalable-box') && scalableBoxCache[elem.id]) {
                const cached = scalableBoxCache[elem.id];
                if (elemLeft <= 0 && cached.left > 0) elemLeft = cached.left;
                if (elemTop <= 0 && cached.top > 0) elemTop = cached.top;
            }

            // Â¶ÇÊûúÈÇÑÊòØ 0ÔºåÂòóË©¶Âæû style ÂèñÂæó
            if (elemLeft <= 0) elemLeft = parseInt(elem.style.left) || 0;
            if (elemTop <= 0) elemTop = parseInt(elem.style.top) || 0;

            dragState.active = true;
            dragState.elem = elem;
            dragState.offsetX = e.clientX - elemLeft;
            dragState.offsetY = e.clientY - elemTop;
            elem.style.transform = 'none';
            e.preventDefault();
        }

        // ÂÖ®ÂüüÊãñÊõ≥‰∫ã‰ª∂ÔºàÂè™Ë®ªÂÜä‰∏ÄÊ¨°Ôºâ
        document.addEventListener('mousemove', (e) => {
            if (!dragState.active || !dragState.elem) return;
            dragState.elem.style.left = (e.clientX - dragState.offsetX) + 'px';
            dragState.elem.style.top = (e.clientY - dragState.offsetY) + 'px';
        });

        document.addEventListener('mouseup', () => {
            if (dragState.active) {
                const elem = dragState.elem;

                // Êõ¥Êñ∞ scalable-box Á∑©Â≠òÁöÑ‰ΩçÁΩÆ
                if (elem && elem.classList.contains('scalable-box') && scalableBoxCache[elem.id]) {
                    scalableBoxCache[elem.id].left = parseInt(elem.style.left) || 0;
                    scalableBoxCache[elem.id].top = parseInt(elem.style.top) || 0;
                    console.log(`[ScalableBox] ÊãñÂãïÂæåÁ∑©Â≠òÊõ¥Êñ∞: ${elem.id}`, scalableBoxCache[elem.id]);
                }

                dragState.active = false;
                dragState.elem = null;
                savePositionsDebounced();
            }
        });

        // === Á∏ÆÊîæÂäüËÉΩÔºà8ÂÄãÊñπÂêëÔºâ ===
        let resizeState = {
            active: false,
            elem: null,
            direction: '',
            startX: 0, startY: 0,
            startWidth: 0, startHeight: 0,
            startLeft: 0, startTop: 0,
            // Ë£ÅÂàáÁî®
            videoIndex: -1,
            startCropLeft: 0,
            startCropTop: 0,
            originalWidth: 0,
            originalHeight: 0
        };

        function initResizable() {
            const draggables = document.querySelectorAll('.draggable');

            draggables.forEach(elem => {
                const handles = elem.querySelectorAll('.resize-handle');

                handles.forEach(handle => {
                    // ÁßªÈô§ËàäÁöÑÁõ£ËÅΩÂô®
                    handle.removeEventListener('mousedown', handleResizeStart);
                    handle.addEventListener('mousedown', handleResizeStart);
                });
            });
        }

        function handleResizeStart(e) {
            e.stopPropagation();
            e.preventDefault();

            const handle = e.currentTarget;
            const elem = handle.parentElement;

            // ÂèñÂæóÊñπÂêë
            let direction = '';
            const classes = handle.className.split(' ');
            for (const c of classes) {
                if (['nw', 'n', 'ne', 'w', 'e', 'sw', 's', 'se'].includes(c)) {
                    direction = c;
                    break;
                }
            }

            resizeState.active = true;
            resizeState.elem = elem;
            resizeState.direction = direction;
            resizeState.startX = e.clientX;
            resizeState.startY = e.clientY;

            // ÂèñÂæóÂÖÉÁ¥†Â∞∫ÂØ∏ÔºàÂÑ™ÂÖà‰ΩøÁî® style ÂÄºÔºåÈÅøÂÖçÈö±ËóèÊôÇ offset ÁÇ∫ 0Ôºâ
            let startWidth = elem.offsetWidth;
            let startHeight = elem.offsetHeight;
            let startLeft = elem.offsetLeft;
            let startTop = elem.offsetTop;

            // Â¶ÇÊûúÊòØ scalable-box ‰∏îÊúâÁ∑©Â≠òÔºå‰ΩøÁî®Á∑©Â≠òÂÄº
            if (elem.classList.contains('scalable-box') && scalableBoxCache[elem.id]) {
                const cached = scalableBoxCache[elem.id];
                if (startWidth <= 0) startWidth = cached.width;
                if (startHeight <= 0) startHeight = cached.height;
                if (startLeft <= 0 && cached.left > 0) startLeft = cached.left;
                if (startTop <= 0 && cached.top > 0) startTop = cached.top;
            }

            // Â¶ÇÊûúÈÇÑÊòØ 0ÔºåÂòóË©¶Âæû style ÂèñÂæó
            if (startWidth <= 0) startWidth = parseInt(elem.style.width) || 100;
            if (startHeight <= 0) startHeight = parseInt(elem.style.height) || 100;
            if (startLeft <= 0) startLeft = parseInt(elem.style.left) || 0;
            if (startTop <= 0) startTop = parseInt(elem.style.top) || 0;

            resizeState.startWidth = startWidth;
            resizeState.startHeight = startHeight;
            resizeState.startLeft = startLeft;
            resizeState.startTop = startTop;
            elem.style.transform = 'none';

            // Á∏ÆÊîæÊ°ÜÔºöÂÑ≤Â≠òÂÖßÂÆπÁöÑÂØ¶ÈöõÂ∞∫ÂØ∏
            if (elem.classList.contains('scalable-box')) {
                const content = elem.querySelector('.scalable-content');
                if (content) {
                    // Êö´ÊôÇÈáçÁΩÆ transform ‰ª•ÂèñÂæóÁúüÂØ¶Â∞∫ÂØ∏
                    content.style.transform = 'translate(-50%, -50%)';
                    let contentW = content.offsetWidth;
                    let contentH = content.offsetHeight;

                    // Â¶ÇÊûúÂÖßÂÆπÂ∞∫ÂØ∏ÁÇ∫ 0Ôºå‰ΩøÁî®Âü∫Á§éÂ∞∫ÂØ∏
                    if (contentW <= 0) contentW = parseInt(elem.dataset.baseWidth) || 200;
                    if (contentH <= 0) contentH = parseInt(elem.dataset.baseHeight) || 100;

                    resizeState.contentWidth = contentW;
                    resizeState.contentHeight = contentH;
                }
            }

            // Á¶ÆÁâ©ÂúñÔºöÂÑ≤Â≠òÂÖßÂÆπÁöÑÂØ¶ÈöõÂ∞∫ÂØ∏
            if (elem.id === 'giftImageDisplay') {
                const wrapper = elem.querySelector('.gift-image-wrapper');
                const content = elem.querySelector('.gift-image-content');
                if (wrapper && content) {
                    // Êö´ÊôÇÈáçÁΩÆ transform ‰ª•ÂèñÂæóÁúüÂØ¶Â∞∫ÂØ∏
                    const prevTransform = wrapper.style.transform;
                    wrapper.style.transform = 'none';
                    // ‰ΩøÁî® content ÁöÑÂ∞∫ÂØ∏ÔºàÂõ†ÁÇ∫ wrapper ÊòØ inline-block ÊúÉËá™ÂãïË™øÊï¥Ôºâ
                    resizeState.giftImageOrigWidth = content.offsetWidth || content.scrollWidth || 300;
                    resizeState.giftImageOrigHeight = content.offsetHeight || content.scrollHeight || 200;
                    wrapper.style.transform = prevTransform;
                }
            }

            // ÂΩ±ÁâáÂÆπÂô®ÁöÑË£ÅÂàáÁãÄÊÖã
            if (elem.classList.contains('video-container')) {
                const idx = parseInt(elem.dataset.index);
                resizeState.videoIndex = idx;

                // ÂàùÂßãÂåñË£ÅÂàáÁãÄÊÖã
                if (!videoCropState[idx]) {
                    videoCropState[idx] = {
                        cropLeft: 0,
                        cropTop: 0,
                        originalWidth: elem.offsetWidth,
                        originalHeight: elem.offsetHeight
                    };
                }

                resizeState.startCropLeft = videoCropState[idx].cropLeft;
                resizeState.startCropTop = videoCropState[idx].cropTop;
                resizeState.originalWidth = videoCropState[idx].originalWidth;
                resizeState.originalHeight = videoCropState[idx].originalHeight;
            } else {
                resizeState.videoIndex = -1;
            }
        }

        // ÂÖ®ÂüüÁ∏ÆÊîæ‰∫ã‰ª∂ÔºàÂè™Ë®ªÂÜä‰∏ÄÊ¨°Ôºâ
        document.addEventListener('mousemove', (e) => {
            if (!resizeState.active || !resizeState.elem) return;

            const deltaX = e.clientX - resizeState.startX;
            const deltaY = e.clientY - resizeState.startY;
            const direction = resizeState.direction;
            const elem = resizeState.elem;

            let newWidth = resizeState.startWidth;
            let newHeight = resizeState.startHeight;
            let newLeft = resizeState.startLeft;
            let newTop = resizeState.startTop;

            const isVideoContainer = elem.classList.contains('video-container');
            const isSingleSide = ['w', 'e', 'n', 's'].includes(direction);

            if (isVideoContainer && isSingleSide) {
                // ÂΩ±ÁâáÂÆπÂô®ÁöÑÂñÆÈÇäË™øÊï¥ = Ë£ÅÂàáÊ®°Âºè
                const idx = resizeState.videoIndex;
                const cropState = videoCropState[idx];
                const thumbnail = elem.querySelector('.thumbnail-video');
                const player = elem.querySelector('.video-player');

                if (direction === 'e') {
                    // Âè≥ÈÇäË£ÅÂàá
                    newWidth = Math.max(50, resizeState.startWidth + deltaX);
                    newWidth = Math.min(newWidth, resizeState.originalWidth - cropState.cropLeft);
                }
                if (direction === 'w') {
                    // Â∑¶ÈÇäË£ÅÂàá
                    const newCropLeft = Math.max(0, Math.min(resizeState.startCropLeft + deltaX, resizeState.originalWidth - 50));
                    cropState.cropLeft = newCropLeft;
                    newWidth = Math.max(50, resizeState.startWidth - deltaX);
                    newWidth = Math.min(newWidth, resizeState.originalWidth - newCropLeft);
                    newLeft = resizeState.startLeft + deltaX;

                    if (thumbnail) thumbnail.style.left = -newCropLeft + 'px';
                    if (player) player.style.left = -newCropLeft + 'px';
                }
                if (direction === 's') {
                    // ‰∏ãÈÇäË£ÅÂàá
                    newHeight = Math.max(50, resizeState.startHeight + deltaY);
                    newHeight = Math.min(newHeight, resizeState.originalHeight - cropState.cropTop);
                }
                if (direction === 'n') {
                    // ‰∏äÈÇäË£ÅÂàá
                    const newCropTop = Math.max(0, Math.min(resizeState.startCropTop + deltaY, resizeState.originalHeight - 50));
                    cropState.cropTop = newCropTop;
                    newHeight = Math.max(50, resizeState.startHeight - deltaY);
                    newHeight = Math.min(newHeight, resizeState.originalHeight - newCropTop);
                    newTop = resizeState.startTop + deltaY;

                    if (thumbnail) thumbnail.style.top = -newCropTop + 'px';
                    if (player) player.style.top = -newCropTop + 'px';
                }
            } else {
                // ‰∏ÄËà¨Á∏ÆÊîæÊ®°Âºè
                const isCorner = ['nw', 'ne', 'sw', 'se'].includes(direction);

                if (isCorner) {
                    // ÂõõÂÄãËßíËêΩÔºöÁ≠âÊØî‰æãÁ∏ÆÊîæ
                    const aspectRatio = resizeState.startWidth / resizeState.startHeight;

                    // Ê†πÊìöÊªëÈº†ÁßªÂãïÊñπÂêëÊ±∫ÂÆöÁ∏ÆÊîæÂü∫Ê∫ñ
                    let scale;
                    if (direction === 'se') {
                        // Âè≥‰∏ãËßíÔºöÂèñËºÉÂ§ßÁöÑÁ∏ÆÊîæÂÄº
                        const scaleX = (resizeState.startWidth + deltaX) / resizeState.startWidth;
                        const scaleY = (resizeState.startHeight + deltaY) / resizeState.startHeight;
                        scale = Math.max(scaleX, scaleY);
                        newWidth = Math.max(50, resizeState.startWidth * scale);
                        newHeight = Math.max(50, newWidth / aspectRatio);
                    } else if (direction === 'sw') {
                        // Â∑¶‰∏ãËßí
                        const scaleX = (resizeState.startWidth - deltaX) / resizeState.startWidth;
                        const scaleY = (resizeState.startHeight + deltaY) / resizeState.startHeight;
                        scale = Math.max(scaleX, scaleY);
                        newWidth = Math.max(50, resizeState.startWidth * scale);
                        newHeight = Math.max(50, newWidth / aspectRatio);
                        newLeft = resizeState.startLeft + resizeState.startWidth - newWidth;
                    } else if (direction === 'ne') {
                        // Âè≥‰∏äËßí
                        const scaleX = (resizeState.startWidth + deltaX) / resizeState.startWidth;
                        const scaleY = (resizeState.startHeight - deltaY) / resizeState.startHeight;
                        scale = Math.max(scaleX, scaleY);
                        newWidth = Math.max(50, resizeState.startWidth * scale);
                        newHeight = Math.max(50, newWidth / aspectRatio);
                        newTop = resizeState.startTop + resizeState.startHeight - newHeight;
                    } else if (direction === 'nw') {
                        // Â∑¶‰∏äËßí
                        const scaleX = (resizeState.startWidth - deltaX) / resizeState.startWidth;
                        const scaleY = (resizeState.startHeight - deltaY) / resizeState.startHeight;
                        scale = Math.max(scaleX, scaleY);
                        newWidth = Math.max(50, resizeState.startWidth * scale);
                        newHeight = Math.max(50, newWidth / aspectRatio);
                        newLeft = resizeState.startLeft + resizeState.startWidth - newWidth;
                        newTop = resizeState.startTop + resizeState.startHeight - newHeight;
                    }
                } else {
                    // ÂõõÂÄãÈÇäÔºöÂñÆÂêëÁ∏ÆÊîæ
                    if (direction === 'e') {
                        newWidth = Math.max(50, resizeState.startWidth + deltaX);
                    }
                    if (direction === 'w') {
                        newWidth = Math.max(50, resizeState.startWidth - deltaX);
                        newLeft = resizeState.startLeft + deltaX;
                        if (newWidth <= 50) newLeft = resizeState.startLeft + resizeState.startWidth - 50;
                    }
                    if (direction === 's') {
                        newHeight = Math.max(50, resizeState.startHeight + deltaY);
                    }
                    if (direction === 'n') {
                        newHeight = Math.max(50, resizeState.startHeight - deltaY);
                        newTop = resizeState.startTop + deltaY;
                        if (newHeight <= 50) newTop = resizeState.startTop + resizeState.startHeight - 50;
                    }
                }

                // ÂΩ±ÁâáÂÆπÂô®ËßíËêΩË™øÊï¥ÊôÇÔºåÊõ¥Êñ∞ÂéüÂßãÂ∞∫ÂØ∏‰∏¶ÈáçÁΩÆË£ÅÂàá
                if (isVideoContainer) {
                    const idx = resizeState.videoIndex;
                    videoCropState[idx] = {
                        cropLeft: 0,
                        cropTop: 0,
                        originalWidth: newWidth,
                        originalHeight: newHeight
                    };

                    const thumbnail = elem.querySelector('.thumbnail-video');
                    const player = elem.querySelector('.video-player');
                    if (thumbnail) {
                        thumbnail.style.left = '0px';
                        thumbnail.style.top = '0px';
                        thumbnail.style.width = newWidth + 'px';
                        thumbnail.style.height = newHeight + 'px';
                    }
                    if (player) {
                        player.style.left = '0px';
                        player.style.top = '0px';
                        player.style.width = newWidth + 'px';
                        player.style.height = newHeight + 'px';
                    }
                }
            }

            // ËΩâÁõ§‰øùÊåÅÊ≠£ÊñπÂΩ¢
            if (elem.id === 'wheelContainer') {
                const size = Math.max(newWidth, newHeight);
                newWidth = size;
                newHeight = size;
            }

            elem.style.width = newWidth + 'px';
            elem.style.height = newHeight + 'px';
            elem.style.left = newLeft + 'px';
            elem.style.top = newTop + 'px';

            // Êõ¥Êñ∞ËΩâÁõ§ canvas
            if (elem.id === 'wheelContainer') {
                const canvas = document.getElementById('wheelCanvas');
                canvas.width = newWidth;
                canvas.height = newHeight;
                drawWheel();
            }

            // Á∏ÆÊîæÂÖßÂÆπÔºàÈ¥®Â≠êË®àÊï∏„ÄÅ‰øùÂ∫ïË®àÊï∏Á≠âÔºâ
            if (elem.classList.contains('scalable-box')) {
                const content = elem.querySelector('.scalable-content');
                const contentWidth = resizeState.contentWidth || 200;
                const contentHeight = resizeState.contentHeight || 100;

                if (content) {
                    // Ë®àÁÆóÁ∏ÆÊîæÊØî‰æãÔºàÂèñËºÉÂ∞èÂÄºÁ¢∫‰øùÂÆåÊï¥È°ØÁ§∫Ôºâ
                    const scaleX = newWidth / contentWidth;
                    const scaleY = newHeight / contentHeight;
                    const scale = Math.min(scaleX, scaleY);
                    // ÁΩÆ‰∏≠ + Á∏ÆÊîæ
                    content.style.transform = `translate(-50%, -50%) scale(${scale})`;
                }

                // Êõ¥Êñ∞Á∑©Â≠ò
                if (scalableBoxCache[elem.id]) {
                    scalableBoxCache[elem.id] = {
                        width: newWidth,
                        height: newHeight,
                        left: newLeft,
                        top: newTop
                    };
                    console.log(`[ScalableBox] Á∑©Â≠òÊõ¥Êñ∞: ${elem.id}`, scalableBoxCache[elem.id]);
                }
            }

            // Á¶ÆÁâ©ÂúñÁ∏ÆÊîæÂÖßÂÆπ
            if (elem.id === 'giftImageDisplay') {
                const wrapper = elem.querySelector('.gift-image-wrapper');
                if (wrapper) {
                    // ÂèñÂæóÂÖßÂÆπÂéüÂßãÂ∞∫ÂØ∏ÔºàÂÑ≤Â≠òÂú® resizeState Êàñ‰ΩøÁî®Áï∂ÂâçÂ∞∫ÂØ∏Ôºâ
                    const origW = resizeState.giftImageOrigWidth || 300;
                    const origH = resizeState.giftImageOrigHeight || 200;
                    // Ë®àÁÆóÁ∏ÆÊîæÊØî‰æã
                    const scaleX = newWidth / origW;
                    const scaleY = newHeight / origH;
                    const scale = Math.min(scaleX, scaleY);
                    wrapper.style.transform = `scale(${scale})`;
                    // ÂÑ≤Â≠òÁï∂ÂâçÁ∏ÆÊîæÊØî‰æãÂà∞ÂÆπÂô®ÁöÑ dataset
                    elem.dataset.currentScale = scale;
                }
            }
        });

        document.addEventListener('mouseup', () => {
            if (resizeState.active) {
                resizeState.active = false;
                resizeState.elem = null;
                savePositionsDebounced();
            }
        });

        // === Âè≥ÈçµÈÅ∏ÂñÆ ===
        let currentContextElement = null;  // Áï∂ÂâçÂè≥ÈçµÈªûÊìäÁöÑÂÖÉÁ¥†
        let baseZIndex = 10;  // Âü∫Á§é z-index
        let elementZIndexes = {};  // ÂÑ≤Â≠òÂêÑÂÖÉÁ¥†ÁöÑ z-index

        function initContextMenu() {
            const menu = document.getElementById('contextMenu');
            const elementMenu = document.getElementById('elementContextMenu');

            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();

                // Èö±ËóèÊâÄÊúâÈÅ∏ÂñÆ
                menu.classList.remove('visible');
                elementMenu.classList.remove('visible');

                // Ê™¢Êü•ÊòØÂê¶ÈªûÊìä‰∫ÜÂèØË™øÊï¥ÂúñÂ±§ÁöÑÂÖÉÁ¥†
                const draggable = e.target.closest('.draggable');

                if (draggable) {
                    // ÂÖÉÁ¥†Âè≥ÈçµÈÅ∏ÂñÆ
                    currentContextElement = draggable;
                    const title = getElementTitle(draggable);
                    document.getElementById('elementMenuTitle').textContent = title;
                    elementMenu.style.left = e.clientX + 'px';
                    elementMenu.style.top = e.clientY + 'px';
                    elementMenu.classList.add('visible');
                } else {
                    // ‰∏ÄËà¨Âè≥ÈçµÈÅ∏ÂñÆ
                    menu.style.left = e.clientX + 'px';
                    menu.style.top = e.clientY + 'px';
                    menu.classList.add('visible');
                }
            });

            document.addEventListener('click', () => {
                menu.classList.remove('visible');
                elementMenu.classList.remove('visible');
            });
        }

        // Â•óÁî®ÂÑ≤Â≠òÁöÑÂúñÂ±§È†ÜÂ∫è
        function applyElementZIndexes() {
            if (!savedPositions || !savedPositions.elementZIndexes) {
                console.log('[ÂúñÂ±§] ÁÑ°ÂÑ≤Â≠òÁöÑÂúñÂ±§È†ÜÂ∫è');
                return;
            }

            // ÊÅ¢Âæ© elementZIndexes Ë≥áÊñô
            elementZIndexes = { ...savedPositions.elementZIndexes };

            // Â•óÁî®Âà∞ÊâÄÊúâÂÖÉÁ¥†
            getAllDraggables().forEach(elem => {
                const key = elem.id || elem.dataset.index;
                if (elementZIndexes[key]) {
                    elem.style.zIndex = elementZIndexes[key];
                }
            });

            console.log('[ÂúñÂ±§] Â∑≤Â•óÁî®ÂÑ≤Â≠òÁöÑÂúñÂ±§È†ÜÂ∫è:', Object.keys(elementZIndexes).length, 'ÂÄãÂÖÉÁ¥†');
        }

        function getElementTitle(elem) {
            if (elem.id === 'wheelContainer') return 'üé° ËΩâÁõ§';
            if (elem.id === 'giftboxContainer') return 'üéÅ Áõ≤Áõí';
            if (elem.id === 'entryTextContainer') return 'üëã ÈÄ≤Â†¥ÊñáÂ≠ó';
            if (elem.id === 'entryVideoContainer') return 'üé¨ ÈÄ≤Â†¥ÂΩ±Áâá';
            if (elem.id === 'randomVideoContainer') return 'üé≤ Èö®Ê©üÂΩ±Áâá';
            if (elem.id === 'duckVideoContainer') return 'ü¶Ü ÊäìÈ¥®ÂΩ±Áâá';
            if (elem.id === 'duckCounterContainer') return 'üî¢ È¥®Â≠êË®àÊï∏';
            if (elem.id === 'pityCounterContainer') return 'üé∞ ‰øùÂ∫ïË®àÊï∏';
            if (elem.id === 'leaderboardContainer') return 'üèÜ ÊéíË°åÊ¶ú';
            if (elem.classList.contains('video-container')) {
                const idx = elem.dataset.index;
                const gift = videoGifts[idx];
                return `üé¨ ${gift?.display_name || gift?.name || 'ÂΩ±Áâá ' + idx}`;
            }
            return 'ÂÖÉÁ¥†';
        }

        function getAllDraggables() {
            return Array.from(document.querySelectorAll('.draggable'));
        }

        function getElementZIndex(elem) {
            const key = elem.id || elem.dataset.index;
            return elementZIndexes[key] || parseInt(elem.style.zIndex) || baseZIndex;
        }

        function setElementZIndex(elem, zIndex) {
            const key = elem.id || elem.dataset.index;
            elementZIndexes[key] = zIndex;
            elem.style.zIndex = zIndex;
            savePositions();
        }

        function moveLayerToTop() {
            if (!currentContextElement) return;
            const maxZ = Math.max(...getAllDraggables().map(el => getElementZIndex(el)));
            setElementZIndex(currentContextElement, maxZ + 1);
        }

        function moveLayerUp() {
            if (!currentContextElement) return;
            const currentZ = getElementZIndex(currentContextElement);
            setElementZIndex(currentContextElement, currentZ + 1);
        }

        function moveLayerDown() {
            if (!currentContextElement) return;
            const currentZ = getElementZIndex(currentContextElement);
            setElementZIndex(currentContextElement, Math.max(1, currentZ - 1));
        }

        function moveLayerToBottom() {
            if (!currentContextElement) return;
            const minZ = Math.min(...getAllDraggables().map(el => getElementZIndex(el)));
            setElementZIndex(currentContextElement, Math.max(1, minZ - 1));
        }

        function hideCurrentElement() {
            if (!currentContextElement) return;

            // Ê†πÊìöÂÖÉÁ¥†È°ûÂûãË™øÁî®Â∞çÊáâÁöÑÈö±ËóèÂáΩÊï∏
            if (currentContextElement.id === 'wheelContainer') {
                if (wheelVisible) toggleWheelVisibility();
            } else if (currentContextElement.id === 'giftboxContainer') {
                if (giftboxVisible) toggleGiftboxVisibility();
            } else if (currentContextElement.id === 'entryVideoContainer') {
                if (entryVideoVisible) toggleEntryVideoVisibility();
            } else if (currentContextElement.classList.contains('video-container')) {
                const idx = parseInt(currentContextElement.dataset.index);
                if (videoGifts[idx]?.visible !== false) {
                    toggleVideoGiftVisible(idx);
                }
            } else {
                // Áõ¥Êé•Èö±Ëóè
                setElementVisible(currentContextElement, false);
            }
        }

        // Êö¥Èú≤Áµ¶Â§ñÈÉ®ÁöÑÂáΩÊï∏
        window.triggerWheel = triggerWheel;
        window.triggerVideo = triggerVideo;
        window.triggerVideoInContainer = triggerVideoInContainer;
        window.playRandomVideo = playRandomVideo;
        window.stopRandomVideo = stopRandomVideo;
        window.toggleRandomVideoVisible = toggleRandomVideoVisible;
        window.playDuckVideo = playDuckVideo;
        window.finishDuckVideo = finishDuckVideo;
        window.updateDuckCounter = updateDuckCounter;
        window.toggleDuckVideoVisible = toggleDuckVideoVisible;
        window.toggleDuckCounterVisible = toggleDuckCounterVisible;
        window.updatePityCounter = updatePityCounter;
        window.triggerMilestoneCelebration = triggerMilestoneCelebration;
        window.togglePityCounterVisible = togglePityCounterVisible;
    </script>
</body>
</html>
