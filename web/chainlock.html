<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>é–éˆå°æŠ—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            background: rgba(0, 0, 0, 0.1);
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            cursor: none;
        }

        /* é–éˆå°æŠ—è¦†è“‹å±¤ */
        .chain-battle-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        /* é–éˆé‚Šæ¡†å‹•ç•« */
        .chain-border {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 8px solid #ff6b35;
            animation: chainPulse 0.5s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes chainPulse {
            0%, 100% { border-color: #ff6b35; box-shadow: inset 0 0 50px rgba(255, 107, 53, 0.3); }
            50% { border-color: #ff4500; box-shadow: inset 0 0 80px rgba(255, 69, 0, 0.5); }
        }

        /* å››è§’é–éˆåœ–ç¤º */
        .chain-corner {
            position: absolute;
            font-size: 60px;
            animation: chainShake 0.3s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(255, 107, 53, 0.8));
        }

        .chain-corner.tl { top: 20px; left: 20px; }
        .chain-corner.tr { top: 20px; right: 20px; }
        .chain-corner.bl { bottom: 20px; left: 20px; }
        .chain-corner.br { bottom: 20px; right: 20px; }

        @keyframes chainShake {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        /* è¨ˆæ•¸å™¨å®¹å™¨ */
        .chain-counter-container {
            text-align: center;
            padding: 40px 80px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            border: 4px solid #ff6b35;
            box-shadow: 0 0 40px rgba(255, 107, 53, 0.5);
        }

        .chain-title {
            font-size: 36px;
            color: #ff6b35;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.8);
            font-family: "Microsoft YaHei", sans-serif;
            white-space: nowrap;
        }

        .chain-counter {
            font-size: 120px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
            transition: transform 0.1s, color 0.1s;
            font-family: "Microsoft YaHei", sans-serif;
        }

        .chain-counter.adding {
            transform: scale(1.2);
            color: #ff4500;
        }

        .chain-counter.removing {
            transform: scale(0.9);
            color: #3b82f6;
        }

        .chain-hint {
            font-size: 24px;
            color: #aaa;
            margin-top: 20px;
            font-family: "Microsoft YaHei", sans-serif;
            white-space: nowrap;
        }

        .chain-hint .key {
            display: inline-block;
            background: #333;
            padding: 5px 20px;
            border-radius: 8px;
            border: 2px solid #555;
            color: #fff;
            font-weight: bold;
        }

        /* æ™è„«å‹•ç•« */
        .chain-battle-overlay.breaking .chain-border {
            animation: chainBreak 0.5s ease-out forwards;
        }

        .chain-battle-overlay.breaking .chain-corner {
            animation: chainFlyAway 0.5s ease-out forwards;
        }

        @keyframes chainBreak {
            0% { opacity: 1; }
            100% { opacity: 0; border-width: 0; }
        }

        @keyframes chainFlyAway {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(2) rotate(180deg); }
        }

        /* å‹åˆ©æ•ˆæœ */
        .chain-battle-overlay.victory .chain-counter-container {
            border-color: #ef4444;
            box-shadow: 0 0 60px rgba(239, 68, 68, 0.8);
        }

        .chain-victory {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #ef4444;
            text-shadow: 0 0 30px rgba(239, 68, 68, 0.8);
            animation: victoryPop 0.5s ease-out;
            font-family: "Microsoft YaHei", sans-serif;
            white-space: nowrap;
        }

        .chain-battle-overlay.victory .chain-victory {
            display: block;
        }

        .chain-battle-overlay.victory .chain-counter-container {
            display: none;
        }

        @keyframes victoryPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* é£„å‹•æ•¸å­—å®¹å™¨ */
        .floating-numbers {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        /* é£„å‹•æ•¸å­— */
        .floating-number {
            position: absolute;
            font-size: 48px;
            font-weight: bold;
            font-family: "Microsoft YaHei", sans-serif;
            text-shadow: 0 0 20px currentColor, 0 2px 4px rgba(0,0,0,0.5);
            animation: floatUp 1.5s ease-out forwards;
            white-space: nowrap;
        }

        .floating-number.add {
            color: #ff4500;
        }

        .floating-number.remove {
            color: #3b82f6;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(-60px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-120px) scale(0.8);
            }
        }
    </style>
</head>
<body>
    <!-- éŸ³æ•ˆ -->
    <audio id="soundLock" src="sounds/chain_lock.mp3" preload="auto"></audio>
    <audio id="soundRattle" src="sounds/chain_rattle.mp3" preload="auto"></audio>
    <audio id="soundVictory" src="sounds/chain_victory.mp3" preload="auto"></audio>

    <div class="chain-battle-overlay" id="chainBattleOverlay">
        <div class="chain-border"></div>
        <div class="chain-corner tl">â›“ï¸</div>
        <div class="chain-corner tr">â›“ï¸</div>
        <div class="chain-corner bl">â›“ï¸</div>
        <div class="chain-corner br">â›“ï¸</div>
        <div class="chain-counter-container">
            <div class="chain-title">â›“ï¸ é–éˆå°æŠ— â›“ï¸</div>
            <div class="chain-counter" id="chainCounter">0</div>
            <div class="chain-hint">ä¸»æ’­æŒ‰ <span class="key">ç©ºç™½éµ</span> æ™è„«ï¼</div>
        </div>
        <div class="chain-victory">ğŸ‰ æ™è„«æˆåŠŸï¼</div>
        <div class="floating-numbers" id="floatingNumbers"></div>
    </div>

    <script>
        let chainCount = 0;
        let chainBattleActive = false;
        let chainPaused = false;  // æŠ“é´¨å­å½±ç‰‡æ’­æ”¾ä¸­æš«åœ
        let lastClickTime = 0;    // ä¸Šæ¬¡é»æ“Šæ™‚é–“
        let clickCooldown = 100;  // é»æ“Šå†·å»æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰ï¼Œå¯å¾è¨­å®šæ›´æ–°

        // æ’­æ”¾éŸ³æ•ˆ
        function playSound(id) {
            const sound = document.getElementById(id);
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(() => {});  // å¿½ç•¥æ’­æ”¾éŒ¯èª¤
            }
        }

        // å•Ÿå‹•é–éˆå°æŠ—
        function startChainBattle(data = {}) {
            chainCount = data.amount || data.baseCount || 20;
            clickCooldown = data.click_cooldown ?? 100;  // æ›´æ–°å†·å»æ™‚é–“
            document.getElementById('chainCounter').textContent = chainCount;
            chainBattleActive = true;
            playSound('soundLock');  // æ’­æ”¾é–èµ·ä¾†éŸ³æ•ˆ
            console.log('[é–å®šè¦–çª—] é–éˆå°æŠ—å•Ÿå‹•ï¼Œæ•¸é‡:', chainCount, 'å†·å»:', clickCooldown, 'ms');
        }

        // å‰µå»ºé£„å‹•æ•¸å­—
        function createFloatingNumber(amount, isAdd) {
            const container = document.getElementById('floatingNumbers');
            const num = document.createElement('div');
            num.className = `floating-number ${isAdd ? 'add' : 'remove'}`;
            num.textContent = isAdd ? `+${amount}` : `-${amount}`;

            // éš¨æ©Ÿä½ç½®ï¼ˆåœ¨è¨ˆæ•¸å™¨å‘¨åœï¼‰
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const offsetX = (Math.random() - 0.5) * 200;  // -100 åˆ° +100
            const offsetY = (Math.random() - 0.5) * 100;  // -50 åˆ° +50

            num.style.left = `${centerX + offsetX}px`;
            num.style.top = `${centerY + offsetY + 50}px`;  // ç¨å¾®åä¸‹

            container.appendChild(num);

            // å‹•ç•«çµæŸå¾Œç§»é™¤å…ƒç´ 
            setTimeout(() => {
                num.remove();
            }, 1500);
        }

        // åŒæ­¥è¨ˆæ•¸
        function syncChainCount(data) {
            if (!chainBattleActive) return;

            chainCount = data.count;
            const counter = document.getElementById('chainCounter');
            counter.textContent = chainCount;

            if (data.action === 'add') {
                counter.classList.remove('removing');
                counter.classList.add('adding');
                setTimeout(() => counter.classList.remove('adding'), 300);
                // é¡¯ç¤ºé£„å‹•æ•¸å­—
                if (data.amount) {
                    createFloatingNumber(data.amount, true);
                }
            } else if (data.action === 'remove') {
                counter.classList.remove('adding');
                counter.classList.add('removing');
                setTimeout(() => counter.classList.remove('removing'), 100);
                // é¡¯ç¤ºé£„å‹•æ•¸å­—
                if (data.amount) {
                    createFloatingNumber(data.amount, false);
                }
            }
        }

        // å‹åˆ©å‹•ç•«
        function chainVictory() {
            if (!chainBattleActive) return;

            const overlay = document.getElementById('chainBattleOverlay');
            overlay.classList.add('breaking');
            playSound('soundVictory');  // æ’­æ”¾å‹åˆ©éŸ³æ•ˆ

            setTimeout(() => {
                overlay.classList.remove('breaking');
                overlay.classList.add('victory');
                chainBattleActive = false;
            }, 500);
        }

        // ç›£è¯ç©ºç™½éµ
        document.addEventListener('keydown', (e) => {
            // é˜»æ“‹æ‰€æœ‰æŒ‰éµ
            e.preventDefault();
            e.stopPropagation();

            // åªè™•ç†ç©ºç™½éµä¸”éé•·æŒ‰ï¼Œæš«åœä¸­ä¸è™•ç†
            if (e.code === 'Space' && chainBattleActive && !e.repeat && !chainPaused) {
                // æª¢æŸ¥å†·å»æ™‚é–“
                const now = Date.now();
                if (now - lastClickTime < clickCooldown) {
                    return;  // é‚„åœ¨å†·å»ä¸­
                }
                lastClickTime = now;

                playSound('soundRattle');  // æ’­æ”¾é–éˆå‹•éŸ³æ•ˆ
                if (window.pywebview && window.pywebview.api) {
                    pywebview.api.remove_chain_count(1);
                }
            }
        }, true);

        // é˜»æ“‹æ‰€æœ‰æ»‘é¼ äº‹ä»¶
        ['mousedown', 'mouseup', 'click', 'dblclick', 'contextmenu', 'wheel'].forEach(event => {
            document.addEventListener(event, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, true);
        });

        // ç›£è½ä¾†è‡ªä¸»é€²ç¨‹çš„äº‹ä»¶
        if (window.electronAPI) {
            window.electronAPI.onGreenScreenEvent((event, data) => {
                console.log('[é–å®šè¦–çª—] æ”¶åˆ°äº‹ä»¶:', event, data);
                switch (event) {
                    case 'startChainBattle':
                        startChainBattle(data);
                        break;
                    case 'syncChainCount':
                        syncChainCount(data);
                        break;
                    case 'chainVictory':
                        chainVictory();
                        break;
                    case 'chainPause':
                        chainPaused = true;
                        console.log('[é–å®šè¦–çª—] é–éˆæš«åœï¼ˆæŠ“é´¨å­ä¸­ï¼‰');
                        break;
                    case 'chainResume':
                        chainPaused = false;
                        console.log('[é–å®šè¦–çª—] é–éˆæ¢å¾©');
                        break;
                }
            });
        }

        // æš´éœ²å‡½æ•¸çµ¦å¤–éƒ¨
        window.startChainBattle = startChainBattle;
        window.syncChainCount = syncChainCount;
        window.chainVictory = chainVictory;
    </script>
</body>
</html>
