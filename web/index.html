<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok 直播互動系統</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app">
        <!-- 側邊欄 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">🎮</span>
                    <span class="logo-text">TikTok Live</span>
                </div>
                <div class="status-badge" id="statusBadge">
                    <span class="status-dot"></span>
                    <span class="status-text">離線</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">模組</div>
                    <button class="nav-item active" data-panel="wheel">
                        <span class="nav-icon">🎡</span>
                        <span class="nav-label">轉盤</span>
                        <label class="mini-switch" onclick="event.stopPropagation()">
                            <input type="checkbox" id="wheelEnabled" checked>
                            <span class="mini-slider"></span>
                        </label>
                    </button>
                    <button class="nav-item" data-panel="video">
                        <span class="nav-icon">🎬</span>
                        <span class="nav-label">影片</span>
                        <label class="mini-switch" onclick="event.stopPropagation()">
                            <input type="checkbox" id="videoEnabled" checked>
                            <span class="mini-slider"></span>
                        </label>
                    </button>
                    <button class="nav-item" data-panel="entry">
                        <span class="nav-icon">👋</span>
                        <span class="nav-label">進場</span>
                        <label class="mini-switch" onclick="event.stopPropagation()">
                            <input type="checkbox" id="entryEnabled">
                            <span class="mini-slider"></span>
                        </label>
                    </button>
                    <button class="nav-item" data-panel="giftbox">
                        <span class="nav-icon">🎁</span>
                        <span class="nav-label">盲盒</span>
                        <label class="mini-switch" onclick="event.stopPropagation()">
                            <input type="checkbox" id="giftboxEnabled">
                            <span class="mini-slider"></span>
                        </label>
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">工具</div>
                    <button class="nav-item" data-panel="logs">
                        <span class="nav-icon">📋</span>
                        <span class="nav-label">日誌</span>
                    </button>
                    <button class="nav-item" data-panel="settings">
                        <span class="nav-icon">⚙️</span>
                        <span class="nav-label">設定</span>
                    </button>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="sidebar-btn btn-connect" id="connectBtn" onclick="toggleConnection()">
                    <span class="btn-icon">🔌</span>
                    <span class="btn-text">連接 TikTok</span>
                </button>
                <div class="sidebar-btn-group">
                    <button class="sidebar-btn btn-tool" onclick="openGreenScreen('landscape')" title="橫向綠幕">
                        🖥️
                    </button>
                    <button class="sidebar-btn btn-tool" onclick="openGreenScreen('portrait')" title="直向綠幕">
                        📱
                    </button>
                    <button class="sidebar-btn btn-tool" onclick="showSimulateDialog()" title="模擬送禮">
                        🎁
                    </button>
                </div>
            </div>
        </aside>

        <!-- 主內容區 -->
        <main class="main-content">
            <!-- 轉盤面板 -->
            <div class="panel active" id="panel-wheel">
                <div class="panel-header">
                    <h2>🎡 轉盤模組</h2>
                    <p>收到指定禮物時觸發轉盤抽獎</p>
                </div>
                <div class="panel-body">
                    <div class="panel-grid">
                        <div class="panel-section">
                            <div class="section-header">
                                <h3>觸發禮物</h3>
                                <button class="btn btn-primary btn-sm" onclick="showAddWheelGiftDialog()">+ 新增</button>
                            </div>
                            <div class="list-container" id="wheelGiftList">
                                <div class="list-empty">尚無設定</div>
                            </div>
                        </div>
                        <div class="panel-section">
                            <div class="section-header">
                                <h3>轉盤選項</h3>
                                <button class="btn btn-primary btn-sm" onclick="showAddWheelOptionDialog()">+ 新增</button>
                            </div>
                            <div class="list-container" id="wheelOptionList">
                                <div class="list-empty">尚無設定</div>
                            </div>
                            <div class="hint-box">
                                <span>💡</span> 權重越大，中獎機率越高
                            </div>
                        </div>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="testWheel()">🎯 測試轉盤</button>
                    </div>
                </div>
            </div>

            <!-- 影片面板 -->
            <div class="panel" id="panel-video">
                <div class="panel-header">
                    <h2>🎬 影片模組</h2>
                    <p>收到禮物/彈幕/點讚時播放影片</p>
                </div>
                <div class="panel-body">
                    <div class="section-header">
                        <h3>觸發設定</h3>
                        <button class="btn btn-primary btn-sm" onclick="showAddVideoGiftDialog()">+ 新增</button>
                    </div>
                    <div class="list-container list-full" id="videoGiftList">
                        <div class="list-empty">尚無設定</div>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="testVideo()">▶️ 測試影片</button>
                    </div>
                </div>
            </div>

            <!-- 進場面板 -->
            <div class="panel" id="panel-entry">
                <div class="panel-header">
                    <h2>👋 進場模組</h2>
                    <p>有人進入直播間時播放影片或音效</p>
                </div>
                <div class="panel-body">
                    <div class="section-header">
                        <h3>進場用戶列表</h3>
                        <button class="btn btn-primary btn-sm" onclick="showAddEntryDialog()">+ 新增</button>
                    </div>
                    <div class="list-container" id="entryList">
                        <div class="list-empty">尚未設定進場用戶</div>
                    </div>

                    <div class="section-header" style="margin-top: 24px;">
                        <h3>🔍 高等級用戶查詢 (Lv20+)</h3>
                        <span class="user-count-badge" id="highLevelUserCount">0 人</span>
                    </div>
                    <div class="search-section">
                        <div class="search-row">
                            <select id="accountSelector" class="form-input" style="max-width: 180px;" onchange="onAccountChange()">
                                <option value="">-- 選擇帳號 --</option>
                            </select>
                            <button class="btn btn-secondary btn-sm" onclick="refreshAccountList()" title="重新整理">🔄</button>
                        </div>
                        <div class="search-row">
                            <input type="text" id="userSearchInput" class="form-input" placeholder="輸入名稱搜尋..." onkeyup="if(event.key==='Enter') searchUsers()">
                            <button class="btn btn-primary btn-sm" onclick="searchUsers()">搜尋</button>
                            <button class="btn btn-secondary btn-sm" onclick="searchUsers('')">全部</button>
                            <button class="btn btn-danger btn-sm" onclick="clearHighLevelUsers()">清空</button>
                        </div>
                        <div class="search-results" id="userSearchResults">
                            <div class="search-hint">連接後，高等級用戶會自動記錄</div>
                        </div>
                    </div>

                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="testEntryEffect()">▶️ 測試效果</button>
                    </div>
                </div>
            </div>

            <!-- 盲盒面板 -->
            <div class="panel" id="panel-giftbox">
                <div class="panel-header">
                    <h2>🎁 盲盒模組</h2>
                    <p>收到指定禮物時觸發盲盒抽獎</p>
                </div>
                <div class="panel-body">
                    <div class="panel-grid">
                        <div class="panel-section">
                            <div class="section-header">
                                <h3>觸發禮物</h3>
                                <button class="btn btn-primary btn-sm" onclick="showAddGiftboxGiftDialog()">+ 新增</button>
                            </div>
                            <div class="list-container" id="giftboxGiftList">
                                <div class="list-empty">尚無設定</div>
                            </div>
                        </div>
                        <div class="panel-section">
                            <div class="section-header">
                                <h3>盲盒選項</h3>
                                <button class="btn btn-primary btn-sm" onclick="showAddGiftboxOptionDialog()">+ 新增</button>
                            </div>
                            <div class="list-container" id="giftboxOptionList">
                                <div class="list-empty">尚無設定</div>
                            </div>
                            <div class="hint-box">
                                <span>💡</span> 權重越大，中獎機率越高
                            </div>
                        </div>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="testGiftbox()">🎁 測試盲盒</button>
                    </div>
                </div>
            </div>

            <!-- 日誌面板 -->
            <div class="panel" id="panel-logs">
                <div class="panel-header">
                    <h2>📋 即時日誌</h2>
                    <p>查看系統運行狀態和事件</p>
                </div>
                <div class="panel-body">
                    <div class="log-filters">
                        <label class="log-filter-item">
                            <input type="checkbox" id="filterChat" checked>
                            <span>💬 聊天</span>
                        </label>
                        <label class="log-filter-item">
                            <input type="checkbox" id="filterGift" checked>
                            <span>🎁 禮物</span>
                        </label>
                        <label class="log-filter-item">
                            <input type="checkbox" id="filterLike" checked>
                            <span>❤️ 點讚</span>
                        </label>
                        <label class="log-filter-item">
                            <input type="checkbox" id="filterEntry" checked>
                            <span>👋 進場</span>
                        </label>
                        <label class="log-filter-item">
                            <input type="checkbox" id="filterFollow" checked>
                            <span>➕ 關注</span>
                        </label>
                        <label class="log-filter-item">
                            <input type="checkbox" id="filterOther" checked>
                            <span>📝 其他</span>
                        </label>
                    </div>
                    <div class="log-container-full">
                        <div class="log-content" id="logContent">
                            <div class="log-item">系統已就緒，等待連接...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 設定面板 -->
            <div class="panel" id="panel-settings">
                <div class="panel-header">
                    <h2>⚙️ 系統設定</h2>
                    <p>配置連接和顯示選項</p>
                </div>
                <div class="panel-body">
                    <div class="settings-card">
                        <h3>🔗 連接設定</h3>
                        <div class="form-group">
                            <label>TikTok 用戶名</label>
                            <input type="text" id="tiktokUsernameInput" class="form-input" placeholder="例如: example_user">
                            <small class="form-hint">輸入要監控的直播間用戶名（@ 後面的 ID）</small>
                        </div>
                        <div class="form-group">
                            <label>Eulerstream API Key</label>
                            <input type="password" id="apiKeyInput" class="form-input" placeholder="euler_xxxxxxxx...">
                            <small class="form-hint">從 <a href="https://www.eulerstream.com" target="_blank">eulerstream.com</a> 取得</small>
                        </div>
                        <div class="form-group">
                            <label>WebSocket 埠號</label>
                            <input type="number" id="portInput" class="form-input small" value="10010">
                        </div>
                    </div>

                    <div class="settings-card">
                        <h3>🖥️ 顯示設定</h3>
                        <label class="checkbox-label">
                            <input type="checkbox" id="autoOpenGreenScreen">
                            <span>連接時自動開啟綠幕視窗</span>
                        </label>
                    </div>

                    <div class="settings-card">
                        <h3>🌐 語言設定</h3>
                        <div class="form-group">
                            <label>介面語言</label>
                            <select id="languageSelect" class="form-input" onchange="changeLanguage(this.value)">
                                <option value="zh-TW">繁體中文</option>
                                <option value="zh-CN">简体中文</option>
                            </select>
                        </div>
                    </div>

                    <div class="panel-actions">
                        <button class="btn btn-primary" onclick="saveSettings()">💾 儲存設定</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 對話框遮罩 -->
    <div class="dialog-overlay" id="dialogOverlay" onclick="closeAllDialogs()"></div>

    <!-- 轉盤禮物編輯對話框 -->
    <div class="dialog" id="wheelGiftDialog">
        <div class="dialog-header">
            <h3 id="wheelGiftDialogTitle">新增轉盤觸發</h3>
            <button class="dialog-close" onclick="closeDialog('wheelGiftDialog')">&times;</button>
        </div>
        <div class="dialog-content">
            <input type="hidden" id="wheelGiftEditIndex" value="-1">
            <div class="form-group">
                <label>禮物名稱</label>
                <input type="text" id="wheelGiftName" class="form-input" placeholder="例如: Rose">
            </div>
            <div class="form-group">
                <label>轉盤次數 (每個禮物)</label>
                <input type="number" id="wheelGiftSpins" class="form-input small" value="1" min="1">
            </div>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-secondary" onclick="closeDialog('wheelGiftDialog')">取消</button>
            <button class="btn btn-primary" onclick="saveWheelGift()">儲存</button>
        </div>
    </div>

    <!-- 轉盤選項編輯對話框 -->
    <div class="dialog" id="wheelOptionDialog">
        <div class="dialog-header">
            <h3 id="wheelOptionDialogTitle">新增轉盤選項</h3>
            <button class="dialog-close" onclick="closeDialog('wheelOptionDialog')">&times;</button>
        </div>
        <div class="dialog-content">
            <input type="hidden" id="wheelOptionEditIndex" value="-1">
            <div class="form-group">
                <label>選項名稱</label>
                <input type="text" id="optionName" class="form-input" placeholder="例如: 選項A">
            </div>
            <div class="form-group">
                <label>顏色</label>
                <input type="color" id="optionColor" class="form-input color-input" value="#4ecca3">
            </div>
            <div class="form-group">
                <label>權重</label>
                <input type="number" id="optionWeight" class="form-input small" value="1" min="1">
            </div>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-secondary" onclick="closeDialog('wheelOptionDialog')">取消</button>
            <button class="btn btn-primary" onclick="saveWheelOption()">儲存</button>
        </div>
    </div>

    <!-- 影片觸發編輯對話框 -->
    <div class="dialog" id="videoGiftDialog">
        <div class="dialog-header">
            <h3 id="videoGiftDialogTitle">新增影片觸發</h3>
            <button class="dialog-close" onclick="closeDialog('videoGiftDialog')">&times;</button>
        </div>
        <div class="dialog-content">
            <input type="hidden" id="videoGiftEditIndex" value="-1">
            <div class="form-group">
                <label>名稱</label>
                <input type="text" id="videoGiftName" class="form-input" placeholder="例如: Rose">
            </div>
            <div class="form-group">
                <label>觸發方式</label>
                <select id="videoTriggerType" class="form-input" onchange="toggleVideoTriggerOptions()">
                    <option value="gift">禮物</option>
                    <option value="chat">彈幕關鍵字</option>
                    <option value="like">點讚</option>
                </select>
            </div>
            <div class="form-group" id="videoKeywordGroup" style="display:none">
                <label>彈幕關鍵字</label>
                <input type="text" id="videoTriggerKeyword" class="form-input" placeholder="觸發的關鍵字">
            </div>
            <div class="form-group">
                <label>影片路徑</label>
                <div class="input-with-btn">
                    <input type="text" id="videoPath" class="form-input" placeholder="選擇影片檔案">
                    <button class="btn btn-sm" onclick="selectVideoFile()">瀏覽</button>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>優先級 (1-10)</label>
                    <input type="number" id="videoPriority" class="form-input small" value="1" min="1" max="10">
                </div>
                <div class="form-group">
                    <label>重複次數</label>
                    <input type="number" id="videoRepeat" class="form-input small" value="1" min="1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>播放秒數 (0=完整)</label>
                    <input type="number" id="videoSeconds" class="form-input small" value="0" min="0" step="0.5">
                </div>
                <div class="form-group">
                    <label>播放倍率</label>
                    <input type="number" id="videoSpeed" class="form-input small" value="1.0" min="0.1" max="4" step="0.1">
                </div>
            </div>
            <div class="form-group">
                <label>音量</label>
                <div class="range-group">
                    <input type="range" id="videoVolume" class="form-range" value="100" min="0" max="100">
                    <span id="volumeValue">100%</span>
                </div>
            </div>
            <label class="checkbox-label">
                <input type="checkbox" id="forceInterrupt">
                <span>強制插隊 (中斷當前播放)</span>
            </label>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-secondary" onclick="closeDialog('videoGiftDialog')">取消</button>
            <button class="btn btn-primary" onclick="saveVideoGift()">儲存</button>
        </div>
    </div>

    <!-- 進場用戶編輯對話框 -->
    <div class="dialog" id="entryEditDialog">
        <div class="dialog-header">
            <h3 id="entryEditDialogTitle">新增進場用戶</h3>
            <button class="dialog-close" onclick="closeDialog('entryEditDialog')">&times;</button>
        </div>
        <div class="dialog-content">
            <input type="hidden" id="entryEditIndex" value="-1">
            <div class="form-group">
                <label>用戶名稱或 ID</label>
                <input type="text" id="entryUsername" class="form-input" placeholder="例如：老公 或 yyue97342bf">
            </div>
            <div class="form-group">
                <label>媒體檔案</label>
                <div class="input-with-btn">
                    <input type="text" id="entryMediaPath" class="form-input" readonly placeholder="選擇影片或音效...">
                    <button class="btn btn-sm" onclick="selectEntryMedia()">瀏覽</button>
                </div>
                <small class="form-hint" id="entryMediaTypeHint">支援 MP4/AVI/MOV 或 MP3/WAV/OGG</small>
            </div>
            <div class="form-group">
                <label>音量</label>
                <div class="range-group">
                    <input type="range" id="entryVolume" class="form-range" min="0" max="100" value="100">
                    <span id="entryVolumeLabel">100%</span>
                </div>
            </div>
            <div class="form-group">
                <label>冷卻時間（秒）</label>
                <input type="number" id="entryCooldown" class="form-input small" value="300" min="0">
            </div>
            <label class="checkbox-label">
                <input type="checkbox" id="entryForceInterrupt" checked>
                <span>強制中斷其他播放</span>
            </label>
            <label class="checkbox-label" style="margin-top: 10px;">
                <input type="checkbox" id="entryShowText" onchange="toggleEntryTextSettings()">
                <span>顯示進場文字</span>
            </label>
            <div id="entryTextSettings" style="display: none; margin-top: 15px;">
                <div class="form-group">
                    <label>進場文字</label>
                    <input type="text" id="entryText" class="form-input" placeholder="歡迎 {name} 進入直播間！">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>文字大小</label>
                        <input type="number" id="entryTextSize" class="form-input small" value="48" min="12" max="200">
                    </div>
                    <div class="form-group">
                        <label>文字顏色</label>
                        <input type="color" id="entryTextColor" class="form-input color-input" value="#ffffff">
                    </div>
                    <div class="form-group">
                        <label>顯示時間</label>
                        <input type="number" id="entryTextDuration" class="form-input small" value="5" min="1" max="30">
                    </div>
                </div>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-secondary" onclick="closeDialog('entryEditDialog')">取消</button>
            <button class="btn btn-primary" onclick="saveEntry()">儲存</button>
        </div>
    </div>

    <!-- 盲盒禮物編輯對話框 -->
    <div class="dialog" id="giftboxGiftDialog">
        <div class="dialog-header">
            <h3 id="giftboxGiftDialogTitle">新增盲盒觸發</h3>
            <button class="dialog-close" onclick="closeDialog('giftboxGiftDialog')">&times;</button>
        </div>
        <div class="dialog-content">
            <input type="hidden" id="giftboxGiftEditIndex" value="-1">
            <div class="form-group">
                <label>禮物名稱</label>
                <input type="text" id="giftboxGiftName" class="form-input" placeholder="例如: Rose">
            </div>
            <div class="form-group">
                <label>開盒次數 (每個禮物)</label>
                <input type="number" id="giftboxGiftCount" class="form-input small" value="1" min="1">
            </div>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-secondary" onclick="closeDialog('giftboxGiftDialog')">取消</button>
            <button class="btn btn-primary" onclick="saveGiftboxGift()">儲存</button>
        </div>
    </div>

    <!-- 盲盒選項編輯對話框 -->
    <div class="dialog" id="giftboxOptionDialog">
        <div class="dialog-header">
            <h3 id="giftboxOptionDialogTitle">新增盲盒選項</h3>
            <button class="dialog-close" onclick="closeDialog('giftboxOptionDialog')">&times;</button>
        </div>
        <div class="dialog-content">
            <input type="hidden" id="giftboxOptionEditIndex" value="-1">
            <div class="form-group">
                <label>選項名稱</label>
                <input type="text" id="giftboxOptionName" class="form-input" placeholder="例如: 大獎">
            </div>
            <div class="form-group">
                <label>顏色</label>
                <input type="color" id="giftboxOptionColor" class="form-input color-input" value="#ffd93d">
            </div>
            <div class="form-group">
                <label>權重</label>
                <input type="number" id="giftboxOptionWeight" class="form-input small" value="1" min="1">
            </div>
            <div class="form-group">
                <label>影片路徑 (可選)</label>
                <div class="input-with-btn">
                    <input type="text" id="giftboxOptionVideoPath" class="form-input" placeholder="選擇影片檔案">
                    <button class="btn btn-sm" onclick="selectGiftboxVideoFile()">瀏覽</button>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>播放秒數 (0=完整)</label>
                    <input type="number" id="giftboxOptionVideoSeconds" class="form-input small" value="0" min="0" step="0.5">
                </div>
                <div class="form-group">
                    <label>音量</label>
                    <div class="range-group">
                        <input type="range" id="giftboxOptionVideoVolume" class="form-range" value="100" min="0" max="100">
                        <span id="giftboxVolumeValue">100%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-secondary" onclick="closeDialog('giftboxOptionDialog')">取消</button>
            <button class="btn btn-primary" onclick="saveGiftboxOption()">儲存</button>
        </div>
    </div>

    <!-- 模擬送禮對話框 -->
    <div class="dialog" id="simulateDialog">
        <div class="dialog-header">
            <h3>🎁 模擬送禮</h3>
            <button class="dialog-close" onclick="closeDialog('simulateDialog')">&times;</button>
        </div>
        <div class="dialog-content">
            <div class="form-group">
                <label>用戶名稱</label>
                <input type="text" id="simUsername" class="form-input" value="測試用戶">
            </div>
            <div class="form-group">
                <label>禮物</label>
                <select id="simGift" class="form-input"></select>
            </div>
            <div class="form-group">
                <label>數量</label>
                <input type="number" id="simCount" class="form-input small" value="1" min="1">
            </div>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-secondary" onclick="closeDialog('simulateDialog')">取消</button>
            <button class="btn btn-primary" onclick="doSimulate()">送出</button>
        </div>
    </div>

    <script src="js/app.js"></script>
</body>
</html>
